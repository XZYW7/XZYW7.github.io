<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <title>
    【笔记】【百人计划】图形1.2.3 MVP矩阵运算 |
    
    XZYW7&#39;s Blog
  </title>
  <!-- Icon -->
  
    <link rel="shortcut icon" href="/favicon.ico">
    
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <main class="content">
    <section class="outer">
  <article id="post-TA/百人计划/图形1.2MVP矩阵运算" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h1 class="article-title" itemprop="name">
    【笔记】【百人计划】图形1.2.3 MVP矩阵运算
  </h1>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/07/22/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A21.2MVP%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97/" class="article-date">
  <time datetime="2022-07-21T19:16:53.000Z" itemprop="datePublished">2022-07-22</time>
</a>
      
    </div>
    

    
    
<div class="tocbot"></div>

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
        <h2 id="图形1-2MVP矩阵运算"><a href="#图形1-2MVP矩阵运算" class="headerlink" title="图形1.2MVP矩阵运算"></a>图形1.2MVP矩阵运算</h2><ul>
<li><p>MVP矩阵</p>
<ul>
<li>Model模型，View观察，Projection投影矩阵</li>
</ul>
</li>
<li><p>空间</p>
<ul>
<li>Local Space(Local Coordinate)</li>
<li>World Space(World Coordinate)</li>
<li>View&#x2F;Camera Space(View&#x2F;Camera Coordinate)</li>
<li>Clip Space(Clip Coordinate)</li>
<li>Screen Space(Screen Coordinate)</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220721144144034.png" alt="image-20220721144144034"></p>
<h3 id="M-模型空间-世界空间"><a href="#M-模型空间-世界空间" class="headerlink" title="M:模型空间-&gt;世界空间"></a><strong>M:模型空间-&gt;世界空间</strong></h3><p>对于模型本身来说，有自身的Local Space，当把模型放入世界空间场景去描述时，就需要把模型的局部坐标变换到世界坐标，这个变换用矩阵描述，就是Model矩阵</p>
<p>$M_{Model} &#x3D; M_TM_RM_S$</p>
<h4 id="平移Translation"><a href="#平移Translation" class="headerlink" title="平移Translation"></a><strong>平移Translation</strong></h4><p>Translation变换不是线性变换<br>$$<br>\begin{bmatrix}x’\y’ \end{bmatrix} &#x3D;\begin{bmatrix}a&amp;b\c&amp;d \end{bmatrix} \begin{bmatrix}x\y \end{bmatrix}+\begin{bmatrix}t_x\t_y \end{bmatrix}<br>$$</p>
<h5 id="齐次坐标"><a href="#齐次坐标" class="headerlink" title="齐次坐标"></a><strong>齐次坐标</strong></h5><p>$2D point &#x3D; (x,y,1)^T$</p>
<p>$2Dvector &#x3D; (x,y,0)^T$ （向量的平移不变性）<br>$$<br>\begin{bmatrix}{}x’\y’\1’ \end{bmatrix}{} &#x3D; \begin{bmatrix}{}1&amp;0&amp;t_x\0&amp;1&amp;t_y\0&amp;0&amp;1 \end{bmatrix}{}\cdot\begin{bmatrix}{}x\y\1 \end{bmatrix}{} &#x3D; \begin{bmatrix}{}x+t_x\y+t_y\1 \end{bmatrix}{}<br>$$<br>对于点 $(x,y,w)^T$ 的表达，与 $(x&#x2F;w,y&#x2F;w,1)^T,w\neq 0$  等价</p>
<h5 id="仿射变换"><a href="#仿射变换" class="headerlink" title="仿射变换"></a><strong>仿射变换</strong></h5><p>对于任何一种变换能够写成</p>
<p>Affine map &#x3D; linear map + translation<br>$$<br>\begin{bmatrix}x’\y’ \end{bmatrix} &#x3D;\begin{bmatrix}a&amp;b\c&amp;d \end{bmatrix} \begin{bmatrix}x\y \end{bmatrix}+\begin{bmatrix}t_x\t_y \end{bmatrix}<br>$$<br>表示仿射变换，使用齐次坐标可以表示成矩阵乘法<br>$$<br>\begin{bmatrix}{}x’\y’\1’ \end{bmatrix}{} &#x3D; \begin{bmatrix}{}a&amp;b&amp;t_x\c&amp;d&amp;t_y\0&amp;0&amp;1 \end{bmatrix}{}\cdot\begin{bmatrix}{}x\y\1 \end{bmatrix}{}<br>$$</p>
<h5 id="3维的平移矩阵"><a href="#3维的平移矩阵" class="headerlink" title="3维的平移矩阵"></a><strong>3维的平移矩阵</strong></h5><p>$$<br>T(t_x,t_y,t_z) &#x3D; \begin{bmatrix}1&amp;0&amp;0&amp;t_x\0&amp;1&amp;0&amp;t_y\0&amp;0&amp;1&amp;t_z\0&amp;0&amp;0&amp;1\end{bmatrix}<br>$$</p>
<h4 id="旋转Rotation"><a href="#旋转Rotation" class="headerlink" title="旋转Rotation"></a><strong>旋转Rotation</strong></h4><p>$$<br>R_x(\theta) &#x3D;\begin{bmatrix}1&amp;0&amp;0&amp;0<br>\0&amp;\cos\theta&amp;-\sin\theta&amp;0<br>\0&amp;\sin\theta&amp;\cos\theta&amp;0<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix},\<br>R_y(\theta) &#x3D;\begin{bmatrix}\cos\theta&amp;0&amp;\sin\theta&amp;0<br>\0&amp;1&amp;0&amp;0<br>\-\sin\theta&amp;0&amp;\cos\theta&amp;0<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix},\<br>R_z(\theta) &#x3D;\begin{bmatrix}\cos\theta&amp;0&amp;-\sin\theta&amp;0<br>\\sin\theta&amp;0&amp;\cos\theta&amp;0<br>\0&amp;0&amp;1&amp;0<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}<br>$$</p>
<p>旋转矩阵是正交的</p>
<p>接下来我们来说一说为什么绕y轴的旋转矩阵长得有点不一样。</p>
<p>这里是同一个右手坐标系，分别从x,z,y的方向来观察。</p>
<p>我们绕哪个轴旋转，哪个轴上的坐标就不变，这很明显，因此只需要观察剩下的两个轴所构成的平面。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220721180506988.png" alt="image-20220721180506988"></p>
<p>如ZOY,YOX平面，在右手坐标系下，和二维的YOX旋转是一样的。从Y到Z，从X到Y的顺序是一致的。</p>
<p>但是在以Y轴作为旋转轴的XOZ平面上，是相反的，因此旋转的角度也变成了相反数。</p>
<h5 id="任意旋转"><a href="#任意旋转" class="headerlink" title="任意旋转"></a>任意旋转</h5><p>对于任意一种旋转状态<br>$$<br>R_{xyz}(\alpha,\beta,\gamma)&#x3D;R_x(\alpha)R_y(\beta)R_z(\gamma)<br>$$<br>这就也就是欧拉角</p>
<p><strong>Rodrigues’ Rotation Formula罗德里格斯旋转公式</strong></p>
<p>给定任意旋转轴和旋转角度转化为对应的旋转矩阵。<br>$$<br>R(n,\alpha) &#x3D; \cos(\alpha)I+(1-\cos(\alpha))nn^T+\sin(\alpha)\begin{bmatrix}0&amp;-n_z&amp;n_y\n_z&amp;0&amp;-n_x\-n_y&amp;n_x&amp;0\end{bmatrix}<br>$$<br>如果想绕任意起点的轴，则与2D一样，先平移至原点，绕原点轴旋转，再平移回去。</p>
<h5 id="四元数"><a href="#四元数" class="headerlink" title="四元数"></a>四元数</h5><p>放一放吧</p>
<p>但是可以先放个参考资料</p>
<p><a target="_blank" rel="noopener" href="https://krasjet.github.io/quaternion/quaternion.pdf">quaternion.pdf (krasjet.github.io)</a></p>
<h4 id="缩放Scale"><a href="#缩放Scale" class="headerlink" title="缩放Scale"></a><strong>缩放Scale</strong></h4><p>$$<br>S &#x3D;\begin{bmatrix}s_x&amp;0&amp;0&amp;0<br>\0&amp;s_y&amp;0&amp;0<br>\0&amp;0&amp;s_z&amp;0<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}<br>$$</p>
<h4 id="Model变换顺序"><a href="#Model变换顺序" class="headerlink" title="Model变换顺序"></a><strong>Model变换顺序</strong></h4><center>
    <figure>
        <img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220721163348382.png" alt="image-20220721163348382"  style = "width:40%;display:inline;margin:0" />
        <img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220721163401296.png" alt="image-20220721163401296" style = "width:40%;display:inline;margin:0" />
    </figure>
</center>



<p>3维的仿射变换齐次坐标表示<br>$$<br>\begin{bmatrix}x’\y’\z’\1 \end{bmatrix} &#x3D;<br>\begin{bmatrix}a&amp;b&amp;c&amp;t_x<br>\d&amp;e&amp;f&amp;t_y<br>\g&amp;h&amp;i&amp;t_z<br>\0&amp;0&amp;0&amp;1 \end{bmatrix} \cdot\begin{bmatrix}x\y\z\1\end{bmatrix}<br>$$<br>对应的Affine map &#x3D; linear map + translation，<br>$$<br>\begin{bmatrix}x’\y’ \end{bmatrix} &#x3D;\begin{bmatrix}a&amp;b\c&amp;d \end{bmatrix} \begin{bmatrix}x\y \end{bmatrix}+\begin{bmatrix}t_x\t_y \end{bmatrix}<br>$$<br>translation的顺序是在最后的，因此一定要先进行线性变换，再进行平移</p>
<p>因此<br>$$<br>M_{model} &#x3D;M_{T}M_{R}M_{S}&#x3D;<br>\begin{bmatrix}1&amp;0&amp;0&amp;t_x\0&amp;1&amp;0&amp;t_y\0&amp;0&amp;1&amp;t_z\0&amp;0&amp;0&amp;1\end{bmatrix}<br>\begin{bmatrix}a&amp;b&amp;c&amp;0<br>\d&amp;e&amp;f&amp;0<br>\g&amp;h&amp;i&amp;0<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}<br>\begin{bmatrix}s_x&amp;0&amp;0&amp;0<br>\0&amp;s_y&amp;0&amp;0<br>\0&amp;0&amp;s_z&amp;0<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}<br>$$<br>其中旋转矩阵是任意旋转矩阵的组合</p>
<h3 id="V-世界空间-相机空间"><a href="#V-世界空间-相机空间" class="headerlink" title="V:世界空间-&gt;相机空间"></a><strong>V:世界空间-&gt;相机空间</strong></h3><p>经过Model矩阵的变换后，物体从模型空间变换到了世界空间的某个状态。在世界空间里的物体被人眼&#x2F;相机看到，相机要渲染出这张图像，就要以相机为中心来描述，那么就需要把世界空间的模型再变换到相机空间&#x2F;观察空间。这就是View矩阵。</p>
<p>变换过程：将摄像机和世界坐标重合（相机在世界空间的变换是先旋转，再平移）</p>
<ol>
<li>平移</li>
<li>旋转</li>
<li>（反转左右手坐标系：z分量取反）</li>
</ol>
<p>首先定义一个相机</p>
<ul>
<li>位置</li>
<li>观察方向Look-at&#x2F;gaze direction</li>
<li>向上方向Up direction</li>
</ul>
<p>让相机和物体保持相对位置，一起移动——与世界坐标重合，再旋转</p>
<p>这里的重合，我们需要让g(gaze)和Y（深度）轴重合，t(up)和Y重合，另一个方向和x轴重合。</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220721190933162.png" alt="image-20220721190933162" style="zoom:50%;" />

<p>对于相机位置$(x_e,y_e,z_e)$<br>$$<br>M_{view}&#x3D;R_{view}T_{view}\<br>T_{view}&#x3D;\begin{bmatrix}1&amp;0&amp;0&amp;-x_e\<br>0&amp;1&amp;0&amp;-y_e\<br>0&amp;0&amp;1&amp;-z_e\<br>0&amp;0&amp;0&amp;1<br>\end{bmatrix}<br>$$<br>而该如何旋转？直接求是不好求的，但是根据相机的坐标系我们可以知道<br>$$<br>R^{-1}<em>{view}&#x3D;\begin{bmatrix}<br>x</em>{g\times t} &amp;x_t&amp;x_{-g}&amp;0<br>\y_{g\times t}&amp;y_t&amp;y_{-g}&amp;0<br>\z_{g\times t}&amp;z_t&amp;z_{-g}&amp;0<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}<br>\<br>R_{view}&#x3D;(R^{-1}<em>{view})^T&#x3D;\begin{bmatrix}<br>x</em>{g\times t}&amp;y_{g\times t} &amp;z_{g\times t}&amp;0<br>\x_t&amp;y_t&amp;z_t&amp;0<br>\x_{-g}&amp;y_{-g}&amp;z_{-g}&amp;0<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}<br>\<br>$$<br>而这里对于g轴和z轴的方向统一问题，也就是左右手坐标系统一的问题，从上图可以看到，世界坐标仍然是右手系，但是相机空间定义的是左手系，指向世界空间z轴负方向。</p>
<p>Unity Shader入门精要中，世界空间是左手系，观察空间是右手系（Opengl）给出的解决方法是，最后再乘上一个negate z矩阵<br>$$<br>M_{view}&#x3D;M_{negate\ z}M_{view}\<br>M_{negate\ z}&#x3D;\begin{bmatrix}1&amp;0&amp;0&amp;0<br>\0&amp;1&amp;0&amp;0<br>\0&amp;0&amp;-1&amp;0<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}<br>$$<br>就是其实就是把z坐标取反，这也是101作业当中的处理方法，其实也就是上面为什么写-g。这种细节问题，使用引擎什么的一般不会用到，但是在自己写引擎的时候，就是必须需要注意的细节了。</p>
<h3 id="P-相机空间-齐次裁剪空间"><a href="#P-相机空间-齐次裁剪空间" class="headerlink" title="P:相机空间-&gt;齐次裁剪空间"></a><strong>P:相机空间-&gt;齐次裁剪空间</strong></h3><ol>
<li>不是真正的投影，为投影做准备</li>
<li>目的：判断定点是否在可见范围内</li>
<li>P矩阵：对xyz分量进行缩放，用w分量做范围值，如果x，y，z都在w范围内，那么该点在裁剪空间内</li>
</ol>
<ul>
<li>投影类型<ul>
<li>透视投影</li>
<li>正交投影</li>
</ul>
</li>
</ul>
<p>其实在这次回顾101的时候发现，闫老师早就把View Transformation和Projection Transformation放到一起，统称为Viewing（观测）Transformation（这是很有道理的，因为这个阶段并没有进行透视除法，还在三维空间当中，透视除法才是把三维“投影“到二维当中的过程）。</p>
<p>投影矩阵只是把View frustum（视锥体）中的六面体空间变换为一个单位立方体空间(Canonical Cube) $[-1,1]^3$。</p>
<ul>
<li>Viewing（观测） transformation<ul>
<li>View&#x2F;Camera（视图） transformation</li>
<li>Projection（投影） transformation<ul>
<li>Orthographic projection</li>
<li>Perspective projection</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="正交投影Orthographic-Projection"><a href="#正交投影Orthographic-Projection" class="headerlink" title="正交投影Orthographic Projection"></a>正交投影Orthographic Projection</h4><p>正交投影中的视锥变换定义$[l,r]\times[b,t]\times[f,n]-&gt;[-1,1]^3$</p>
<p>正交投影的变换形式可想而知，在x和y轴上需要进行缩放，在z轴上除了缩放还要进行一定的平移，使立方体中心移动到坐标原点。</p>
<p>101在这里的讲述更复杂也更通用的一步，是定义了视锥体和观察坐标系之间的关系</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220721200902778.png" alt="image-20220721200902778"></p>
<p>视锥近平面中心不在观察中心。目前我还没接触到过使用这种特性。但其实都是一样的</p>
<p>这样的话，我们需要先平移再缩放，很明显<br>$$<br>M_{ortho}&#x3D;\begin{bmatrix}<br>\frac{2}{r-l}&amp;0&amp;0&amp;0<br>\0&amp;\frac{2}{t-b}&amp;0&amp;0<br>\0&amp;0&amp;\frac{2}{n-f}&amp;0<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}<br>\begin{bmatrix}<br>1&amp;0&amp;0&amp;-\frac{r+l}{2}<br>\0&amp;1&amp;0&amp;-\frac{t+b}{2}<br>\0&amp;0&amp;1&amp;-\frac{n+f}{2}<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}&#x3D;\begin{bmatrix}<br>\frac{2}{r-l}&amp;0&amp;0&amp;\frac{r+l}{l-r}<br>\0&amp;\frac{2}{t-b}&amp;0&amp;\frac{t+b}{b-t}<br>\0&amp;0&amp;\frac{2}{n-f}&amp;\frac{n+f}{f-n}<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}<br>$$<br>那其实我们令相机在视锥体近平面中心轴线上，t&#x3D;-b&#x3D;size，r&#x3D;-l &#x3D;Aspect*size<br>$$<br>M_{ortho}&#x3D;\begin{bmatrix}<br>\frac{1}{Aspect\cdot Size}&amp;0&amp;0&amp;0<br>\0&amp;\frac{1}{size}&amp;0&amp;0<br>\0&amp;0&amp;\frac{2}{n-f}&amp;0<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}\begin{bmatrix}<br>1&amp;0&amp;0&amp;0<br>\0&amp;1&amp;0&amp;0<br>\0&amp;0&amp;1&amp;-\frac{n+f}{2}<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}\&#x3D;\begin{bmatrix}<br>\frac{1}{Aspect\cdot Size}&amp;0&amp;0&amp;0<br>\0&amp;\frac{1}{size}&amp;0&amp;0<br>\0&amp;0&amp;\frac{2}{n-f}&amp;-\frac{n+f}{n-f}<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}<br>$$<br>也就是入门精要里的结果</p>
<h4 id="透视投影Perspective-Projection"><a href="#透视投影Perspective-Projection" class="headerlink" title="透视投影Perspective Projection"></a>透视投影Perspective Projection</h4><p>思路是先将透视投影的Frustum挤压成长方体，然后进行正交投影</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220721232039529.png" alt="image-20220721232039529" style="zoom:80%;" />

<p>$M_{persp} &#x3D; M_{ortho}M_{persp\to ortho}$</p>
<p>对于Frustum中间一点(x,y,z)</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220721232239730.png" alt="image-20220721232239730" style="zoom:67%;" />




<p>$$<br>M_{p\to o}\begin{bmatrix}x\y\z\1\end{bmatrix}&#x3D;\begin{bmatrix}nx&#x2F;z\ny&#x2F;z\unknown\1\end{bmatrix}&#x3D;&gt;\begin{bmatrix}nx\ny\unknown\z\end{bmatrix}\<br>M_{p\to o}&#x3D;\begin{bmatrix}n&amp;0&amp;0&amp;0\0&amp;n&amp;0&amp;0\?&amp;?&amp;?&amp;?\0&amp;0&amp;1&amp;0\end{bmatrix}<br>$$<br>考虑</p>
<ul>
<li>近平面的点不会改变</li>
</ul>
<p>$$<br>M_{p\to o}\begin{bmatrix}x\y\n\1\end{bmatrix}&#x3D;<br>\begin{bmatrix}nx&#x2F;n\ny&#x2F;n\n\1\end{bmatrix}&#x3D;&gt;\begin{bmatrix}nx\ny\n^2\n\end{bmatrix}\<br>$$</p>
<p>对于第三行的计算<br>$$<br>[a,b,c,d][x,y,n,1]^T &#x3D; n^2\a&#x3D;b&#x3D;0<br>\cn+d&#x3D;n^2<br>$$</p>
<ul>
<li>远平面点的z值不变</li>
</ul>
<p>$$<br>[0,0,c,d][0,0,f,1]^T&#x3D;f^2<br>\cf+d &#x3D; f^2<br>$$</p>
<p>可以解得<br>$$<br>c&#x3D;n+f\d&#x3D;-nf<br>$$<br>即<br>$$<br>M_{p\to o}&#x3D;\begin{bmatrix}n&amp;0&amp;0&amp;0\0&amp;n&amp;0&amp;0\0&amp;0&amp;n+f&amp;-nf\0&amp;0&amp;1&amp;0\end{bmatrix}<br>\<br>M_p&#x3D;\begin{bmatrix}<br>\frac{2}{r-l}&amp;0&amp;0&amp;\frac{r+l}{l-r}<br>\0&amp;\frac{2}{t-b}&amp;0&amp;\frac{t+b}{b-t}<br>\0&amp;0&amp;\frac{2}{n-f}&amp;\frac{n+f}{f-n}<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}\begin{bmatrix}n&amp;0&amp;0&amp;0\0&amp;n&amp;0&amp;0\0&amp;0&amp;n+f&amp;-nf\0&amp;0&amp;1&amp;0\end{bmatrix}<br>&#x3D;\begin{bmatrix}<br>\frac{2n}{r-l}&amp;0&amp;\frac{r+l}{l-r}&amp;0<br>\0&amp;\frac{2n}{t-b}&amp;\frac{t+b}{b-t}&amp;0<br>\0&amp;0&amp;\frac{n+f}{n-f}&amp;\frac{2nf}{f-n}<br>\0&amp;0&amp;1&amp;0<br>\end{bmatrix}<br>$$<br>这个结果也正如虎书上的结果。</p>
<h4 id="对比与思考"><a href="#对比与思考" class="headerlink" title="对比与思考"></a>对比与思考</h4><p>但是这个时候问题来了，这个结果和Unity Shader入门精要上不一样……和一些其他地方的结果也不太一样……</p>
<p>最大的问题，都是出在四行三列和三行四列的符号上。</p>
<p>我们先继续考虑 $t&#x3D;-b&#x3D;size，r&#x3D;-l &#x3D;Aspect*size,\tan\frac{\theta}{2}&#x3D;\frac{t}{n}$，</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220722005643105.png" alt="image-20220722005643105" style="zoom:67%;" />




<p>$$<br>M_p&#x3D;\begin{bmatrix}<br>\frac{2n}{r-l}&amp;0&amp;\frac{r+l}{l-r}&amp;0<br>\0&amp;\frac{2n}{t-b}&amp;\frac{t+b}{b-t}&amp;0<br>\0&amp;0&amp;\frac{n+f}{n-f}&amp;\frac{2nf}{f-n}<br>\0&amp;0&amp;1&amp;0<br>\end{bmatrix}&#x3D;\begin{bmatrix}<br>\frac{n}{r}&amp;0&amp;0&amp;0<br>\0&amp;\frac{n}{t}&amp;0&amp;0<br>\0&amp;0&amp;\frac{n+f}{n-f}&amp;\frac{2nf}{f-n}<br>\0&amp;0&amp;1&amp;0<br>\end{bmatrix}\&#x3D;\begin{bmatrix}<br>-\frac{\cot\frac{\theta}{2}}{Aspect}&amp;0&amp;0&amp;0<br>\0&amp;-\cot\frac{\theta}{2}&amp;0&amp;0<br>\0&amp;0&amp;\frac{n+f}{n-f}&amp;\frac{2nf}{f-n}<br>\0&amp;0&amp;1&amp;0<br>\end{bmatrix}<br>$$<br>入门精要里和其它一些地方的结果是：<br>$$<br>\begin{bmatrix}<br>\frac{\cot\frac{\theta}{2}}{Aspect}&amp;0&amp;0&amp;0<br>\0&amp;\cot\frac{\theta}{2}&amp;0&amp;0<br>\0&amp;0&amp;\frac{near+far}{near-far}&amp;\frac{2nearfar}{near-far}<br>\0&amp;0&amp;-1&amp;0<br>\end{bmatrix}<br>$$<br>事实上，这和虎书后面给出的Opengl的投影矩阵结果是一样的。</p>
<p>那么造成差别的是在哪一步呢？</p>
<p>首先来看正交投影部分</p>
<ul>
<li>Result1</li>
</ul>
<p>$$<br>M_{ortho}&#x3D;\begin{bmatrix}<br>\frac{1}{Aspect\cdot Size}&amp;0&amp;0&amp;0<br>\0&amp;\frac{1}{size}&amp;0&amp;0<br>\0&amp;0&amp;\frac{2}{n-f}&amp;-\frac{n+f}{n-f}<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}<br>$$</p>
<ul>
<li>Result2</li>
</ul>
<p>$$<br>M_{ortho}&#x3D;\begin{bmatrix}<br>\frac{1}{Aspect\cdot Size}&amp;0&amp;0&amp;0<br>\0&amp;\frac{1}{size}&amp;0&amp;0<br>\0&amp;0&amp;\frac{2}{near-far}&amp;-\frac{near+far}{far-near}<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}<br>$$</p>
<p>一个比较坑的点是near&#x2F;far表示正值,n&#x2F;f表示坐标（负值），但是这不影响符号的相对差别。</p>
<p>即便把near&#x2F;far反过来，第三行整体就是反的了。</p>
<p>后来发现，unity&#x2F;opengl中希望这个frustum的近平面能够对应到立方体的-1，远平面对应到立方体的1。</p>
<p>但是虎书推到和闫老师的平移做法当中，是直接平移中点然后缩放，<strong>这就导致即便都是立方体，但是这里近平面对应的是1，远平面对应-1</strong></p>
<p>所以这里就出现了矛盾。</p>
<p>给第一个结果做一个z值矫正<br>$$<br>M_{ortho}&#x3D;\begin{bmatrix}<br>1&amp;0&amp;0&amp;0<br>\0&amp;1&amp;0&amp;0<br>\0&amp;0&amp;-1&amp;0<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}\begin{bmatrix}<br>\frac{1}{Aspect\cdot Size}&amp;0&amp;0&amp;0<br>\0&amp;\frac{1}{size}&amp;0&amp;0<br>\0&amp;0&amp;\frac{2}{n-f}&amp;-\frac{n+f}{n-f}<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}\&#x3D;\begin{bmatrix}<br>\frac{1}{Aspect\cdot Size}&amp;0&amp;0&amp;0<br>\0&amp;\frac{1}{size}&amp;0&amp;0<br>\0&amp;0&amp;\frac{2}{f-n}&amp;\frac{n+f}{n-f}<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}<br>$$<br>再考虑n和f的绝对值，就能得到unity&#x2F;opengl的正交投影结果了</p>
<p>我们带着这个结果往下看<br>$$<br>M_p&#x3D;\begin{bmatrix}<br>\frac{2}{r-l}&amp;0&amp;0&amp;\frac{r+l}{l-r}<br>\0&amp;\frac{2}{t-b}&amp;0&amp;\frac{t+b}{b-t}<br>\0&amp;0&amp;\frac{2}{f-n}&amp;\frac{n+f}{n-f}<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}\begin{bmatrix}n&amp;0&amp;0&amp;0\0&amp;n&amp;0&amp;0\0&amp;0&amp;n+f&amp;-nf\0&amp;0&amp;1&amp;0\end{bmatrix}<br>&#x3D;\begin{bmatrix}<br>\frac{2n}{r-l}&amp;0&amp;\frac{r+l}{l-r}&amp;0<br>\0&amp;\frac{2n}{t-b}&amp;\frac{t+b}{b-t}&amp;0<br>\0&amp;0&amp;\frac{n+f}{f-n}&amp;\frac{2nf}{n-f}<br>\0&amp;0&amp;1&amp;0<br>\end{bmatrix}<br>$$<br>和这篇文章的结果是一样的<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/463027517">https://zhuanlan.zhihu.com/p/463027517</a></p>
<p>$M_{p\to o}$计算中考虑n和f的绝对值也就是Unity&#x2F;opengl的结果。<br>$$<br>M_{p\to o}\begin{bmatrix}x\y\z\1\end{bmatrix}&#x3D;\begin{bmatrix}-|n|x&#x2F;z\-|n|y&#x2F;z\unknown\1\end{bmatrix}&#x3D;&gt;\begin{bmatrix}|n|x\|n|y\unknown\-z\end{bmatrix}\<br>M_{p\to o}&#x3D;\begin{bmatrix}|n|&amp;0&amp;0&amp;0\0&amp;|n|&amp;0&amp;0\?&amp;?&amp;?&amp;?\0&amp;0&amp;-1&amp;0\end{bmatrix}<br>$$<br>这样就构造出了-1</p>
<p>然后后面的计算就自然而然了。<br>$$<br>\footnotesize{M_{p\to o}\begin{bmatrix}x\y\z\1\end{bmatrix}&#x3D;\begin{bmatrix}-|n|x&#x2F;z\-|n|y&#x2F;z\unknown\1\end{bmatrix}&#x3D;&gt;\begin{bmatrix}|n|x\|n|y\unknown\-z\end{bmatrix}}\<br>M_{p\to o}&#x3D;\begin{bmatrix}|n|&amp;0&amp;0&amp;0\0&amp;|n|&amp;0&amp;0\0&amp;0&amp;|n|+|f|&amp;|n||f|\0&amp;0&amp;-1&amp;0\end{bmatrix}\<br>\footnotesize{M_p&#x3D;\begin{bmatrix}<br>\frac{1}{Aspect\cdot Size}&amp;0&amp;0&amp;0<br>\0&amp;\frac{1}{size}&amp;0&amp;0<br>\0&amp;0&amp;\frac{2}{near-far}&amp;\frac{near+far}{near-far}<br>\0&amp;0&amp;0&amp;1<br>\end{bmatrix}\begin{bmatrix}near&amp;0&amp;0&amp;0\0&amp;near&amp;0&amp;0\0&amp;0&amp;near+far&amp;nearfar\0&amp;0&amp;-1&amp;0\end{bmatrix}}<br>\\small{&#x3D;\begin{bmatrix}<br>\frac{\cot\frac{\theta}{2}}{Aspect}&amp;0&amp;0&amp;0<br>\0&amp;\cot\frac{\theta}{2}&amp;0&amp;0<br>\0&amp;0&amp;\frac{near+far}{near-far}&amp;\frac{2nearfar}{near-far}<br>\0&amp;0&amp;-1&amp;0<br>\end{bmatrix}}<br>$$<br>终于和入门精要的结果一致了。。。</p>
<p>总结一下，影响这些透视投影矩阵符号的两个因素</p>
<ul>
<li>near&#x2F;far是正值，n&#x2F;f是坐标</li>
<li>一部分将frustum近平面映射到-1，远平面映射到1；一部分则相反</li>
</ul>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p>[1]<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1M5411P7d3">https://www.bilibili.com/video/BV1M5411P7d3</a> 【技术美术百人计划】图形 1.2.3 MVP矩阵运算</p>
<p>[2]<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1X7411F744">https://www.bilibili.com/video/BV1X7411F744</a> GAMES101-现代计算机图形学入门-闫令琪</p>
<p>[3] Unity Shader 入门精要</p>
<p>[4] Fundamentals of Computer Graphics,4th</p>
<p>[5] <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/463027517">https://zhuanlan.zhihu.com/p/463027517</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/07/22/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A21.2MVP%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97/" data-id="cmfe9guiv002jewuh117c5mgs" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Computer-Graphics/" rel="tag">Computer Graphics</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/" rel="tag">百人计划</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>

    </footer>

  </div>

  
  
<nav class="article-nav">
  
  <a href="/2022/07/22/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A21.3%E7%BA%B9%E7%90%86%E7%9A%84%E7%A7%98%E5%AF%86/" class="article-nav-link">
    <strong class="article-nav-caption">Newer</strong>
    <div class="article-nav-title">
      
      【笔记】【百人计划】图形1.3 纹理
      
    </div>
  </a>
  
  
  <a href="/2022/07/20/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A21.1%E6%B8%B2%E6%9F%93%E6%B5%81%E6%B0%B4%E7%BA%BF/" class="article-nav-link">
    <strong class="article-nav-caption">Older</strong>
    <div class="article-nav-title">【笔记】【百人计划】图形1.1 渲染流水线</div>
  </a>
  
</nav>

  

  
  
  
  

</article>
</section>
    <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>XZYW7&#39;s Blog &copy; 2025</li>
      
        <li>
          
            <a href="https://beian.miit.gov.cn/" target="_blank"></a>
            
        </li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
    <p><ul class="list-inline">
  
  <li><i class="fe fe-smile-alt tooltip" data-tooltip="UV"></i> <span id="busuanzi_value_site_uv"></span></li>
  
  <li><i class="fe fe-bookmark tooltip" data-tooltip="PV"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul></p>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="XZYW7&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">Home</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">Gallery</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">About</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">Archives</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>





<script src="/js/tocbot.min.js"></script>


<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
  });
</script>



<script src="/js/ocean.js"></script>

</body>

</html>