<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <title>
    
    XZYW7&#39;s Blog
  </title>
  <!-- Icon -->
  
    <link rel="shortcut icon" href="/favicon.ico">
    
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <main class="content">
    <section class="jumbotron">
  <div class="video">
    
    <div class="video-frame">
      <img src="/images/ocean/overlay-hero.png" alt="Decorative image frame">
    </div>
    
    <div class="video-media">
      <video playsinline="" autoplay="" loop="" muted="" data-autoplay="" poster="/images/ocean/ocean.png"
        x5-video-player-type="h5">
        <source src="/images/ocean/ocean.mp4" type="video/mp4">
        <source src="/images/ocean/ocean.ogv" type="video/ogg">
        <source src="/images/ocean/ocean.webm" type="video/webm">
        <p>Your user agent does not support the HTML5 Video element.</p>
      </video>
      <div class="video-overlay"></div>
    </div>
    <div class="video-inner text-center text-white">
      <h1><a href="/">XZYW7&#39;s Blog</a></h1>
      <p></p>
      <div><img src="/images/hexo-inverted.svg" class="brand" alt="XZYW7&#39;s Blog"></div>
    </div>
    <div class="video-learn-more">
      <a class="anchor" href="#landingpage"><i class="fe fe-mouse"></i></a>
    </div>
  </div>
</section>
<div id="landingpage">
  <section class="outer">
  <article class="articles">
    
    <h1 class="page-type-title"></h1>
    
    
    <article id="post-TA/百人计划/图形2.7.2 GPU硬件架构概述" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/22/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.7.2%20GPU%E7%A1%AC%E4%BB%B6%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0/">【笔记】【百人计划】图形2.7.2 GPU硬件架构概述</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/22/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.7.2%20GPU%E7%A1%AC%E4%BB%B6%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0/" class="article-date">
  <time datetime="2022-08-22T10:08:26.000Z" itemprop="datePublished">2022-08-22</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a><strong>思考</strong></h4><p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220822162918576.png" alt="image-20220822162918576"></p>
        
          <p>
            <a class="article-more-link" href="/2022/08/22/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.7.2%20GPU%E7%A1%AC%E4%BB%B6%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0/">
              Read More...
            </a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/22/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.7.2%20GPU%E7%A1%AC%E4%BB%B6%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0/" data-id="cmfe9guj0003eewuh5k3obtaf" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Computer-Graphics/" rel="tag">Computer Graphics</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/" rel="tag">百人计划</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/百人计划/图形3.3曲面细分与几何着色器" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/22/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A23.3%E6%9B%B2%E9%9D%A2%E7%BB%86%E5%88%86%E4%B8%8E%E5%87%A0%E4%BD%95%E7%9D%80%E8%89%B2%E5%99%A8/"> 【笔记】【百人计划】图形3.3 曲面细分与几何着色器</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/22/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A23.3%E6%9B%B2%E9%9D%A2%E7%BB%86%E5%88%86%E4%B8%8E%E5%87%A0%E4%BD%95%E7%9D%80%E8%89%B2%E5%99%A8/" class="article-date">
  <time datetime="2022-08-22T04:40:14.000Z" itemprop="datePublished">2022-08-22</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h3 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a><strong>一、背景</strong></h3><h4 id="1-1应用"><a href="#1-1应用" class="headerlink" title="1.1应用"></a><strong>1.1应用</strong></h4><ul>
<li>曲面细分着色器<ul>
<li>海浪（曲面细分+顶点位移动画）</li>
<li>（交互）雪地（曲面细分+顶点位移）</li>
<li>置换贴图（曲面细分+顶点位移）</li>
</ul>
</li>
<li>几何着色器<ul>
<li>几何动画（几何图元）</li>
<li>草地等（与曲面细分着色器结合）</li>
</ul>
</li>
</ul>
<h4 id="1-2渲染管线"><a href="#1-2渲染管线" class="headerlink" title="1.2渲染管线"></a><strong>1.2渲染管线</strong></h4><ul>
<li>顶点着色器</li>
<li>曲面细分着色器<ul>
<li>细分控制着色器Hull Shader（TCS）</li>
<li>Tessellation Primitive Generator（不可编程）</li>
<li>细分计算着色器Domain Shader（TES）</li>
</ul>
</li>
<li>几何着色器</li>
<li>片元着色器</li>
</ul>
<h4 id="1-3曲面细分着色器"><a href="#1-3曲面细分着色器" class="headerlink" title="1.3曲面细分着色器"></a><strong>1.3曲面细分着色器</strong></h4><h5 id="1-3-1TESS的输入与输出"><a href="#1-3-1TESS的输入与输出" class="headerlink" title="1.3.1TESS的输入与输出"></a><strong>1.3.1TESS的输入与输出</strong></h5><ul>
<li><p>Hull Stage</p>
<ul>
<li>Hull function<ul>
<li>每个patch每个顶点运行一次</li>
<li>输入<ul>
<li>Patch，可以看成是多个顶点的集合，包含每个顶点的属性，可以指定一个Patch包含的顶点数以及自己的属性</li>
<li>Index，指定hull shader输出patch中的哪一个顶点</li>
</ul>
</li>
<li>输出patch内对应顶点</li>
</ul>
</li>
<li>Patch Constant Function<ul>
<li>输入Patch</li>
<li>每个patch运行一次</li>
<li>输出Tessellation Factor</li>
</ul>
</li>
<li>两个阶段是并行</li>
<li>功能<ul>
<li>将图元细分（三角形、矩形等）</li>
</ul>
</li>
<li>输出<ul>
<li>细分后的顶点数据</li>
</ul>
</li>
</ul>
</li>
<li><p>Tessellation Primitive Generator</p>
<ul>
<li>为新网格的所有顶点生成重心坐标</li>
</ul>
</li>
<li><p>Domain stage</p>
<ul>
<li>输入重心坐标、Patch</li>
<li>为细分后曲面的所有顶点运行一次</li>
<li>通常在顶点着色器的逻辑操作的部分，应该放在这里</li>
</ul>
</li>
<li><p>（Geometry Stage）</p>
</li>
</ul>
<h5 id="1-3-2HULL-shader参数"><a href="#1-3-2HULL-shader参数" class="headerlink" title="1.3.2HULL shader参数"></a><strong>1.3.2HULL shader参数</strong></h5><ul>
<li>Tessellation Factor<ul>
<li>决定将一条边分成几部分</li>
<li>equal_Spacing</li>
<li>fractional_even_spacing</li>
<li>fractional_odd_spacing</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220818002411909.png" alt="image-20220818002411909"></p>
<ul>
<li>Inner Tessellation Factor<ul>
<li>（与上面的参数是同一等级）将边等分后，向内延伸相交，直至内部没有交点。</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220818002434236.png" alt="image-20220818002434236"></p>
<h4 id="1-4几何着色器"><a href="#1-4几何着色器" class="headerlink" title="1.4几何着色器"></a><strong>1.4几何着色器</strong></h4><h5 id="1-4-1几何着色器的输入与输出"><a href="#1-4-1几何着色器的输入与输出" class="headerlink" title="1.4.1几何着色器的输入与输出"></a><strong>1.4.1几何着色器的输入与输出</strong></h5><ul>
<li>输入为图元（三角形、矩形、边）<ul>
<li>根据图元不同，shader中会出现对应不同数量的顶点</li>
</ul>
</li>
<li>输出同样为图元（一个或多个），需要自己从顶点构建，顺序很重要，同时定义最大输出的顶点数</li>
</ul>
<h3 id="二、曲面细分"><a href="#二、曲面细分" class="headerlink" title="二、曲面细分"></a><strong>二、曲面细分</strong></h3><ul>
<li>将一个Quad细分</li>
<li>与置换贴图结合<ul>
<li>注意使用置换贴图不在fs中，也是在domain shader中的vert函数进行的，GPU无法获取mipmap信息，需要使用tex2Dlod等来读取图片。</li>
<li>法线也需要重新计算</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> hull hullProgram</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> domain ds</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> vertex tessvert</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;UnityCG.cginc&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Tessellation.cginc&quot;</span></span></span><br><span class="line"></span><br><span class="line">...    </span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">VertexInput</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">VertexOutput</span>&#123;</span><br><span class="line">    float4 vertex: SV_POSITION;</span><br><span class="line">    float3 normal;</span><br><span class="line">    float3 tangent;</span><br><span class="line">    float2 uv;</span><br><span class="line">&#125;;</span><br><span class="line">    </span><br><span class="line"><span class="function">VertexOutput <span class="title">vert</span><span class="params">(VertexInput v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	VertexOutput o;</span><br><span class="line">    o.uv = <span class="built_in">TRANSFORM_TEX</span>(v.uv,_MainTex);</span><br><span class="line">    o.vertex = <span class="built_in">UnityObjectToClipPos</span>(v.vertex);</span><br><span class="line">    o.normal = v.normal;</span><br><span class="line">    o.tangent = v.tangent;</span><br><span class="line">&#125;<span class="comment">//顶点着色器的函数，但这里没有拿给顶点着色器，而是用来在DomainShader进行空间转换</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//只有在能够使用曲面细分着色器的平台才能使用</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> UNITY_CAN_COMPIE_TESSELLATION</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TessVertex</span> &#123;</span><br><span class="line">	float4 vertex: INTERNALTESSPOS;</span><br><span class="line">    float3 normal: NORMAL;</span><br><span class="line">    float4 tangent: TANGENT;</span><br><span class="line">    float2 uv: TEXCOORD0;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">OutputPatchConstant</span> &#123;<span class="comment">//不同的图元，该结构会有不同</span></span><br><span class="line">	<span class="type">float</span> edge[<span class="number">3</span>]: SV_TESSFACTOR;</span><br><span class="line">    <span class="type">float</span> inside: SV_INSIDETESSFACTOR;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">TessVertex <span class="title">tessvert</span><span class="params">(VertexInput v)</span></span>&#123;</span><br><span class="line">    TessVertex o;</span><br><span class="line">    o.vertex = v.vertex;</span><br><span class="line">    o.normal = v.normal;</span><br><span class="line">    o.tangent = v.tangent;</span><br><span class="line">    o.uv = v.uv;</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;<span class="comment">//顶点着色器，注意这里没有进行空间转换，而是在domianshader里进行的空间转换 </span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> _TessellationUniform;</span><br><span class="line"><span class="function">OutputPatchConstant <span class="title">hsconst</span><span class="params">(InputPatch&lt;TessVertex, <span class="number">3</span>&gt; patch)</span> </span>&#123;</span><br><span class="line">    OutputPatchConstant o;</span><br><span class="line">    o.edge[<span class="number">0</span>] = _TessellationUniform;</span><br><span class="line">    o.edge[<span class="number">1</span>] = _TessellationUniform;</span><br><span class="line">    o.edge[<span class="number">2</span>] = _TessellationUniform;</span><br><span class="line">    o.inside = _TessellationUniform;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义Hull shader的函数</span></span><br><span class="line">[<span class="built_in">UNITY_domian</span>(<span class="string">&quot;tri&quot;</span>)]<span class="comment">//指定图元</span></span><br><span class="line">[<span class="built_in">UNITY_partitioning</span>(<span class="string">&quot;fractional_odd&quot;</span>)]<span class="comment">//拆分edge的方式，equal_spacing等</span></span><br><span class="line">[<span class="built_in">UNITY_outputtopology</span>(<span class="string">&quot;triangl_cw&quot;</span>)]</span><br><span class="line">[<span class="built_in">UNITY_patchconstantfunc</span>(<span class="string">&quot;hsconst&quot;</span>)]<span class="comment">//指定patch const function。一个patch一共有三个点，但是这三个点都共用这个函数</span></span><br><span class="line">[<span class="built_in">UNITY_outputcontrolpoints</span>(<span class="number">3</span>)]<span class="comment">//不同图元会对应不同控制点</span></span><br><span class="line"><span class="function">TessVertex <span class="title">hullProgram</span><span class="params">(InputPatch&lt;TessVertex, <span class="number">3</span>&gt; patch, uint id : SV_OutputControlPointID)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> patch[id];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义Domian shader的函数</span></span><br><span class="line">[<span class="built_in">UNITY_domain</span>(<span class="string">&quot;tri&quot;</span>)]<span class="comment">//同样指定图元</span></span><br><span class="line"><span class="function">VertexOutput <span class="title">ds</span> <span class="params">(OutputPatchConstant tessFactors, <span class="type">const</span> OutputPatch&lt;TessVertex, <span class="number">3</span>&gt; patch, float3 bary : SV_DomainLocation)</span> </span>&#123;</span><br><span class="line"><span class="comment">//bary重心坐标</span></span><br><span class="line"><span class="comment">//计算模型空间位置</span></span><br><span class="line">    VertexInput v;</span><br><span class="line">    v.vertex = patch[<span class="number">0</span>].vertex*bary.x + patch[<span class="number">1</span>].vertex*bary.y + patch[<span class="number">2</span>].vertex*bary.z;</span><br><span class="line">    v.tangent = patch[<span class="number">0</span>].tangent*bary.x + patch[<span class="number">1</span>].tangent*bary.y + patch[<span class="number">2</span>].tangent*bary.z;</span><br><span class="line">    v.normal = patch[<span class="number">0</span>].normal*bary.x + patch[<span class="number">1</span>].normal*bary.y + patch[<span class="number">2</span>].normal*bary.z;</span><br><span class="line">    v.uv = patch[<span class="number">0</span>].uv*bary.x + patch[<span class="number">1</span>].uv*bary.y + patch[<span class="number">2</span>].uv*bary.z;</span><br><span class="line">    VertexOutput o = <span class="built_in">vert</span>(v);<span class="comment">//调用原本该在顶点着色器中的转换函数。</span></span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;<span class="comment">//这里才终于把顶点数据拿给下一阶段</span></span><br><span class="line"></span><br><span class="line">#ENDIF</span><br><span class="line"></span><br><span class="line">float4 frag...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="三、几何着色器"><a href="#三、几何着色器" class="headerlink" title="三、几何着色器"></a><strong>三、几何着色器</strong></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> geometry geo</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">VertexInput</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">VertexOutput</span>&#123;</span><br><span class="line">    float4 vertex: SV_POSITION;</span><br><span class="line">    float3 normal;</span><br><span class="line">    float3 tangent;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//注意这次的顶点着色器是vert函数，上次是tessvert,同样不做任何操作</span></span><br><span class="line">VertexOutput vert;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">geometryOutput</span>&#123;</span><br><span class="line">    float4 pos: SV_POSITION;</span><br><span class="line">    float2 uv: TEXCOORD0;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">geopetryOutput <span class="title">CreateGeoOutput</span><span class="params">(float3 pos, float2 uv)</span></span>&#123;</span><br><span class="line">    geometryOutput o;</span><br><span class="line">    o.pos = UnityObjectToClipPos;</span><br><span class="line">    o.uv = uv;</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;<span class="comment">//在几何着色器中完成空间转换，如果同时使用曲面细分和几何着色器，也要放到几何着色器来进行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="built_in">maxvertexcount</span>(<span class="number">3</span>)]</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">geo</span><span class="params">(triangle vertexOutput IN[<span class="number">3</span>]: SV_POSITION, inout TriangleStream&lt;geometryOutput&gt; triStream)</span></span>&#123;</span><br><span class="line">    <span class="type">float</span> pos = IN[<span class="number">0</span>].vertex;</span><br><span class="line">    <span class="type">float</span> vNormal = IN[<span class="number">0</span>].normal;</span><br><span class="line">    <span class="type">float</span> vTangent = IN[<span class="number">0</span>].tangent;</span><br><span class="line">    <span class="type">float</span> vBinormal = <span class="built_in">cross</span>(vNormal,vTangent)*vTangent.w;</span><br><span class="line">    </span><br><span class="line">    <span class="type">float</span> height = ...</span><br><span class="line">    <span class="type">float</span> width = ...</span><br><span class="line">        </span><br><span class="line">    ...</span><br><span class="line">    geometryOutput o;</span><br><span class="line">    triStream.<span class="built_in">Append</span>(<span class="built_in">CreatGeoOutput</span>(<span class="built_in">dosomething</span>(pos),<span class="built_in">dosomething</span>(uv));</span><br><span class="line">    triStream.<span class="built_in">Append</span>(<span class="built_in">CreatGeoOutput</span>(<span class="built_in">dosomething</span>(pos),<span class="built_in">dosomething</span>(uv));</span><br><span class="line">    triStream.<span class="built_in">Append</span>(<span class="built_in">CreatGeoOutput</span>(<span class="built_in">dosomething</span>(pos),<span class="built_in">dosomething</span>(uv));<span class="comment">//添加了一个新的三角形图元                            </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以添加更多图元，如：</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220818013037250.png" alt="image-20220818013037250" style="zoom:50%;" />



<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220818013127627.png" alt="image-20220818013127627"></p>
<p>三角形的构建是triStream自动完成的。（uv是自己计算的。）</p>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a><strong>作业</strong></h3><p>使用曲面细分、几何着色器做一些有意思的Demo</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/1661109050656-1661142579854.gif" alt="1661109050656"></p>
<p>看了一圈，基本上大家都是参考那两个教程，就不多写什么了。（做到这个效果还挺想复刻一下Clannad的片头的，说不定挺适合）</p>
<p>这里主要完成了基本的曲面细分-几何着色器多pass渲染带阴影和光照的草地-风的扰动。</p>
<p>事实上，几何着色器构建的图元会覆盖原来的三角形图元，原来的表面其实消失了。这里可以再加一个pass渲染。</p>
<p>并且地面pass可以不做细分来节省开销</p>
<p>还可以进一步处理的部分：</p>
<ul>
<li>基于距离的曲面细分</li>
<li>基于RT或物体位置的草地交互</li>
</ul>
<p>继续往后做这两个方向感觉就需要考虑偏向may佬说的在项目中整体方案的思路了。</p>
<p>暂时就放一放</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a><strong>参考资料</strong></h3><p>[1] <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1XX4y1A7Ns">https://www.bilibili.com/video/BV1XX4y1A7Ns</a></p>
<p>【技术美术百人计划】图形 3.3  曲面细分与几何着色器  大规模草渲染</p>
<p>[2] <a target="_blank" rel="noopener" href="https://catlikecoding.com/unity/tutorials/advanced-rendering/tessellation/">https://catlikecoding.com/unity/tutorials/advanced-rendering/tessellation/</a></p>
<p>[3] <a target="_blank" rel="noopener" href="https://roystan.net/articles/grass-shader.html">https://roystan.net/articles/grass-shader.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/22/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A23.3%E6%9B%B2%E9%9D%A2%E7%BB%86%E5%88%86%E4%B8%8E%E5%87%A0%E4%BD%95%E7%9D%80%E8%89%B2%E5%99%A8/" data-id="cmfe9guj3003yewuhe3jphy6w" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Computer-Graphics/" rel="tag">Computer Graphics</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/" rel="tag">百人计划</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/百人计划/图形3.2混合模式及剔除" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/21/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A23.2%E6%B7%B7%E5%90%88%E6%A8%A1%E5%BC%8F%E5%8F%8A%E5%89%94%E9%99%A4/">【笔记】【百人计划】图形3.2 混合模式及剔除</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/21/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A23.2%E6%B7%B7%E5%90%88%E6%A8%A1%E5%BC%8F%E5%8F%8A%E5%89%94%E9%99%A4/" class="article-date">
  <time datetime="2022-08-20T16:00:21.000Z" itemprop="datePublished">2022-08-21</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h3 id="一、什么是混合模式"><a href="#一、什么是混合模式" class="headerlink" title="一、什么是混合模式"></a>一、什么是混合模式</h3><ul>
<li>混合<ul>
<li>就是两种颜色混在一起。具体就是把某一像素位置原来的颜色和将要画上去的颜色，通过某种方式混在一起，从而实现新的效果</li>
</ul>
</li>
<li>透过红色玻璃看绿色玻璃<ul>
<li>可以先绘制绿色玻璃，再绘制红色玻璃。在绘制红色的时候，利用混合功能，把将要绘制上去的红色和原来的颜色（绿色）进行混合，于是得到新的颜色</li>
<li>也可以理解成，绿色首先对背景施加影响，无论红色玻璃存在与否，这个影响都是存在的，所以首先计算后面的绿色。然后再考虑前面的红色的影响。这也是我理解透明物体从后往前绘制的原理的一种方式。</li>
</ul>
</li>
</ul>
<p><strong>最终颜色&#x3D;Shader计算后的颜色值*源因子(SrcFactor)+累计颜色*目标因子(DstFactor)</strong></p>
<h3 id="二、混合模式的类型"><a href="#二、混合模式的类型" class="headerlink" title="二、混合模式的类型"></a>二、混合模式的类型</h3><p>PS中的混合模式</p>
<p><img src="/%E5%9B%BE%E5%BD%A23.2%20%E6%B7%B7%E5%90%88%E6%A8%A1%E5%BC%8F%E5%8F%8A%E5%89%94%E9%99%A4/image-20220817000953004.png" alt="image-20220817000953004"></p>
<h4 id="ShaderLab内的混合"><a href="#ShaderLab内的混合" class="headerlink" title="ShaderLab内的混合"></a>ShaderLab内的混合</h4><ol>
<li><p>如果颜色的某一分量超过1.0，则会被自动截取位1.0，不需要考虑越界的问题。</p>
</li>
<li><p>再所有着色器执行完毕，所有纹理都被应用，所有像素准备被呈现到屏幕之后，使用Blend命令来操作这些像素混合。</p>
</li>
<li><p>语法</p>
<table>
<thead>
<tr>
<th align="left">语法</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="left">Blend Off</td>
<td>关闭blend混合（默认）</td>
</tr>
<tr>
<td align="left">Blend SrcFactor DstFactor</td>
<td>配置并启动混合计算</td>
</tr>
<tr>
<td align="left">Blend SrcFactor DstFactor, SrcFactorA DstFactorA</td>
<td>同上，但是使用不同的要素来混合Alpha通道</td>
</tr>
<tr>
<td align="left">BlendOp Value</td>
<td>如果使用BlendOp命令，则混合操作将设置为该值。否则，混合操作默认为Add。</td>
</tr>
<tr>
<td align="left">BlendOp OpColor, OpAlpha</td>
<td>同上，但是使用不同的操作来处理alpha通道</td>
</tr>
<tr>
<td align="left">AlphaToMaskOn</td>
<td>常用于开启MSAA的地表植被的渲染</td>
</tr>
</tbody></table>
</li>
</ol>
<h4 id="Blend和BlendOp"><a href="#Blend和BlendOp" class="headerlink" title="Blend和BlendOp"></a>Blend和BlendOp</h4><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">finalValue = sourceFactor * sourceValue operation destinationFactor * destinationValue</span><br><span class="line"><span class="comment">//finalValue: GPU写入目标缓冲区的值</span></span><br><span class="line"><span class="comment">//sourceFactor: Blend命令中定义</span></span><br><span class="line"><span class="comment">//sourceValue: 片元着色器输出的值</span></span><br><span class="line"><span class="comment">//operation: 混合操作</span></span><br><span class="line"><span class="comment">//destinationFactor: Blend命令中定义</span></span><br><span class="line"><span class="comment">//destinationValue: 目标缓冲区现有值的值</span></span><br></pre></td></tr></table></figure>

<ul>
<li>可以写在Pass中或SubShader中(BlendOp在同一个代码块中还必须有一个Blend命令)</li>
<li>启用混合会禁用GPU上的一些优化（主要是隐藏表面去除Early-Z）</li>
</ul>
<h3 id="三、混合模式的实现方式"><a href="#三、混合模式的实现方式" class="headerlink" title="三、混合模式的实现方式"></a>三、混合模式的实现方式</h3><h4 id="Unity附带的Blend枚举"><a href="#Unity附带的Blend枚举" class="headerlink" title="Unity附带的Blend枚举"></a>Unity附带的Blend枚举</h4><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//混合模式</span></span><br><span class="line">[Enum(UnityEngine.Rendering.BlendOp)] _BlendOp (&quot;BlendOp&quot;, <span class="type">float</span>) = <span class="number">0</span></span><br><span class="line">[Enum(UnityEngine.Rendering.BlendMode)] _SrcBlend (&quot;SrcBlend&quot;, <span class="type">float</span>) = <span class="number">1</span></span><br><span class="line">[Enum(UnityEngine.Rendering.BlendMode)]</span><br><span class="line">_DstBlend (&quot;DstBlend&quot;, <span class="type">float</span>) = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//深度开关</span></span><br><span class="line"><span class="comment">//ZWriteMode没有内置，只有两种状态，也可以用Toogle</span></span><br><span class="line">[Enum(Off, <span class="number">0</span>, On, <span class="number">1</span>)] _ZWriteMode (&quot;ZWriteMode&quot;, <span class="type">float</span>) = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">SubShader&#123;</span><br><span class="line">    Tag &#123;&quot;RenderType&quot; = &quot;Transparent&quot; &quot;Queue&quot; = &quot;Transparent&quot;&#125;</span><br><span class="line">    ZWrite [_ZWriteMode]</span><br><span class="line">    Blend [_SrcBlend] [_DstBlend]</span><br><span class="line">    <span class="comment">//这部分定义是CPU阶段的渲染设置，并不传入shader，不用定义uniform</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Photoshop的Blend实现方式"><a href="#Photoshop的Blend实现方式" class="headerlink" title="Photoshop的Blend实现方式"></a>Photoshop的Blend实现方式</h4><p>自己查吧</p>
<ul>
<li>普通的Blend<ul>
<li>Blend SrcAlpha OneMinusSrcAlpha<ul>
<li>&#x2F;&#x2F;Alpha混合 Alpha Blending</li>
</ul>
</li>
</ul>
</li>
<li>变暗Darken<ul>
<li>BlendOp Min</li>
<li>Blend One One</li>
<li>min(当前颜色，缓存颜色)*1</li>
</ul>
</li>
<li>正片叠底<ul>
<li>Blend Discolors Zero</li>
<li>当前颜色*缓存颜色+缓存颜色*0</li>
</ul>
</li>
<li>滤色Screen<ul>
<li>Blend OneMinusDstColor One 或Blend One OneMinusSrcColor</li>
<li>Src*(1-Dst)+Dst*1 &#x3D; Src+Dst-Src*Dst</li>
<li>当前颜色*(1-缓存颜色)+缓存颜色*1 或 当前颜色*1 + 缓存颜色* (1-缓存颜色)</li>
</ul>
</li>
<li>变亮Lighten<ul>
<li>BlendOp Max</li>
<li>Blend One One</li>
<li>max(当前颜色，缓存颜色)</li>
</ul>
</li>
<li>线性减淡LinearDodge<ul>
<li>Blend One One</li>
<li>缓存颜色*1+当前颜色*1</li>
</ul>
</li>
<li>颜色加深ColorBurn<ul>
<li>高级Opengl混合</li>
<li>此模式目前仅在具有GL_KHR_blend_equation_advanced或GL_NV_blend_equation_advanced扩展支持的Opengl硬件上可用</li>
<li>1-（1-Dst）&#x2F;Src</li>
</ul>
</li>
<li>。。。</li>
</ul>
<h3 id="四、剔除的实现方式"><a href="#四、剔除的实现方式" class="headerlink" title="四、剔除的实现方式"></a>四、剔除的实现方式</h3><ul>
<li>法线剔除<ul>
<li>也称背面消隐，根据法线朝向判断哪个面被剔除掉，可以用来控制是否双面渲染</li>
<li>Cull + [Off, Front, Back]</li>
</ul>
</li>
<li>面裁切<ul>
<li>Clip函数会参数小于某像素点直接在片元阶段丢弃，常用于制作溶解，裁剪等效果</li>
<li>Clip();&#x2F;&#x2F;默认会切掉0.5的部分，或者使用if</li>
</ul>
</li>
</ul>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(input.posInObjectCoords.y &gt; <span class="number">0.5</span>) <span class="keyword">discard</span>;</span><br><span class="line"><span class="comment">//剔除模式</span></span><br><span class="line">[Enum(UnityEngine.Rendering.CullMode)] _CullMode (&quot;CullMode&quot;, <span class="type">float</span>) = <span class="number">2</span></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>开启双面渲染相当于绘制了两次</li>
<li>Clip函数在某些PowerVR的机型上效率低</li>
<li>面裁切Clip使用AlphaTest队列</li>
</ul>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><p>实现常用的混合模式，并设计使用界面</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p>[1] <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1sL4y1v7SS">https://www.bilibili.com/video/BV1sL4y1v7SS</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/21/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A23.2%E6%B7%B7%E5%90%88%E6%A8%A1%E5%BC%8F%E5%8F%8A%E5%89%94%E9%99%A4/" data-id="cmfe9guj2003rewuh59w72new" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Computer-Graphics/" rel="tag">Computer Graphics</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/" rel="tag">百人计划</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/" rel="tag">过程记录</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/OpenGL/C++ learning_04" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/20/TA/OpenGL/C++%20learning_04/">【笔记】Cherno C++ Tutorial note 04</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/20/TA/OpenGL/C++%20learning_04/" class="article-date">
  <time datetime="2022-08-20T09:31:33.000Z" itemprop="datePublished">2022-08-20</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h3 id="Unions"><a href="#Unions" class="headerlink" title="Unions"></a>Unions</h3><h3 id="Virtual-Destructors"><a href="#Virtual-Destructors" class="headerlink" title="Virtual Destructors"></a>Virtual Destructors</h3><h3 id="Casting"><a href="#Casting" class="headerlink" title="Casting"></a>Casting</h3><h3 id="Conditional-and-Action-Breakpoints"><a href="#Conditional-and-Action-Breakpoints" class="headerlink" title="Conditional and Action Breakpoints"></a>Conditional and Action Breakpoints</h3><h3 id="Safety-in-modern-C-and-how-to-teach-it"><a href="#Safety-in-modern-C-and-how-to-teach-it" class="headerlink" title="Safety in modern C++ and how to teach it"></a>Safety in modern C++ and how to teach it</h3><h3 id="Precompiled-Headers-in-C"><a href="#Precompiled-Headers-in-C" class="headerlink" title="Precompiled Headers in C++"></a>Precompiled Headers in C++</h3><p>在大型项目中预编译头（PCH）可能更常用。</p>
<p>获取头文件并转换到一种编译后的格式，这一编译器就可以直接使用，而不需要每次编译都读取</p>
<p>如STL，每次<code>#include&lt;vector&gt;</code>都需要读取整个头文件，vector的头文件也需要读取。</p>
<p>这样编译时间就会很长。并且每次都要重复编译。</p>
<p>因此预编译头就把一大堆头文件编译一次，处理成二进制格式，这样编译器就可以很快处理。</p>
<h4 id="Not-to-do"><a href="#Not-to-do" class="headerlink" title="Not to do"></a>Not to do</h4><p>预编译头重新构建也需要花时间，因此不要把经常改动的文件放进去，</p>
<p>因此预编译头常用于外部库。如STL，glfw</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">LOG</span>(<span class="string">&quot;Hello World&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//pch.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;funcitonal&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Data Stuctures</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stack&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;deque&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;array&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;set&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_set&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Windows API</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>那么如果不用预编译头的话，每次编译的中间文件都会把这一大堆头文件里的代码复制进去。（实测有接近4w行，就为了一个hello world）</p>
<p>所以只需要在做一个cpp文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//pch.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>在这个文件的C++属性中开启创建预编译头属性</p>
<p><img src="/C++%20learning_04/image-20230409164925404.png" alt="image-20230409164925404"></p>
<p>并在项目设置中同样位置设置成使用预编译头，并选择对应的头文件。</p>
<p><img src="/C++%20learning_04/image-20230409165118838.png" alt="image-20230409165118838"></p>
<p>那么就会在对应位置生成一个预编译头的输出文件</p>
<p>Cherno也演示了用g++如何使用预编译头。直接编译pch.h，会出现一个gch文件，这也就是预编译头的输出文件了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/20/TA/OpenGL/C++%20learning_04/" data-id="cmfe9guit0024ewuh5lnldddz" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/百人计划/图形3.1深度与模板测试" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/20/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A23.1%E6%B7%B1%E5%BA%A6%E4%B8%8E%E6%A8%A1%E6%9D%BF%E6%B5%8B%E8%AF%95/">【笔记】【百人计划】图形3.1 深度与模板测试</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/20/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A23.1%E6%B7%B1%E5%BA%A6%E4%B8%8E%E6%A8%A1%E6%9D%BF%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2022-08-19T16:00:21.000Z" itemprop="datePublished">2022-08-20</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="图形3-1-深度与模板测试"><a href="#图形3-1-深度与模板测试" class="headerlink" title="图形3.1 深度与模板测试"></a><strong>图形3.1 深度与模板测试</strong></h2><h3 id="一、模板测试Stencil-Test"><a href="#一、模板测试Stencil-Test" class="headerlink" title="一、模板测试Stencil Test"></a><strong>一、模板测试Stencil Test</strong></h3><p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220816182543699.png" alt="image-20220816182543699"></p>
<h4 id="1-1-渲染管线中的逐片元操作"><a href="#1-1-渲染管线中的逐片元操作" class="headerlink" title="1.1 渲染管线中的逐片元操作"></a><strong>1.1 渲染管线中的逐片元操作</strong></h4><ul>
<li>逐片元操作（可配置，不可编程）<ul>
<li>像素权限测试Pixel Ownership Test（屏幕窗口使用权限，如scene和game窗口区分）</li>
<li>裁剪测试Scissor Test（可以对渲染部分区域进行控制）</li>
<li>透明度测试Alpha Test（片元透明度大于阈值，则通过测试，否则剔除——只能实现不透明和全透明）</li>
<li>模板测试Stencil Test</li>
<li>深度测试Depth Test</li>
<li>混合Blending</li>
<li>Dithering</li>
<li>Logic Op</li>
</ul>
</li>
</ul>
<h4 id="1-2-模板测试理解"><a href="#1-2-模板测试理解" class="headerlink" title="1.2 模板测试理解"></a><strong>1.2 模板测试理解</strong></h4><ul>
<li>通过一定条件来判断是对该片元抛弃还是保留</li>
<li>模板缓冲区<ul>
<li>和颜色缓冲区、深度缓冲区类似</li>
<li>为屏幕上每个像素点保存一个uint8</li>
<li>可以用这个值与预先设定的参考值比较，根据结果来决定是否更新对应像素的颜色。</li>
<li>这个比较的过程被称为模板测试</li>
</ul>
</li>
<li>发生在透明度测试后，深度测试前</li>
<li>通过测试，则更新像素点，否则不更新语法表示</li>
</ul>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stencil&#123;</span><br><span class="line">    Ref referenceValue</span><br><span class="line">    ReadMask readMask</span><br><span class="line">    WriteMask writeMask</span><br><span class="line">    Comp comparisonFunction</span><br><span class="line">    Pass stencilOperation</span><br><span class="line">    Fail stencilOperation</span><br><span class="line">    ZFail stencilOperation<span class="comment">//模板测试通过了，但是深度测试没通过</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(referenceValue&amp;readMask comparisonFunction stencilBufferValue&amp;readMask)</span><br><span class="line">pass</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">discard</span></span><br></pre></td></tr></table></figure>

<h5 id="1-2-1-比较函数Comparison-Function"><a href="#1-2-1-比较函数Comparison-Function" class="headerlink" title="1.2.1 比较函数Comparison Function"></a><strong>1.2.1 比较函数Comparison Function</strong></h5><table>
<thead>
<tr>
<th align="center">Greater</th>
<th align="center">GEqual</th>
<th align="center">Less</th>
<th align="center">LEqual</th>
<th align="center">Equal</th>
<th align="center">NotEqual</th>
<th align="center">Always</th>
<th align="center">Never</th>
</tr>
</thead>
<tbody><tr>
<td align="center">$&gt;$</td>
<td align="center">$\geq$</td>
<td align="center">$&lt;$</td>
<td align="center">$\leq$</td>
<td align="center">$&#x3D;$</td>
<td align="center">$\neq$</td>
<td align="center">总是通过</td>
<td align="center">总是失败</td>
</tr>
</tbody></table>
<h5 id="1-2-2-模板（更新）操作stencilOperation"><a href="#1-2-2-模板（更新）操作stencilOperation" class="headerlink" title="1.2.2 模板（更新）操作stencilOperation"></a><strong>1.2.2 模板（更新）操作stencilOperation</strong></h5><table>
<thead>
<tr>
<th align="center">属性</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Keep</td>
<td align="center">保留当前缓冲内容，即stencilBufferValue不变</td>
</tr>
<tr>
<td align="center">Zero</td>
<td align="center">将0写入缓冲，即stencilBufferValue变为0</td>
</tr>
<tr>
<td align="center">Replace</td>
<td align="center">将参考值写入缓冲，即将stencilBufferValue赋值为referenceValue</td>
</tr>
<tr>
<td align="center">IncrSat</td>
<td align="center">stencilBufferValue加1，如果超过255，则保留为255</td>
</tr>
<tr>
<td align="center">DecrSat</td>
<td align="center">stencilBufferValue减1，如果小于0，则保留为0</td>
</tr>
<tr>
<td align="center">Invert</td>
<td align="center">将stencilBufferValue按位取反</td>
</tr>
<tr>
<td align="center">IncrWarp</td>
<td align="center">stencilBufferValue加1，如果超过255，则变成0（然后继续自增）</td>
</tr>
<tr>
<td align="center">DecrWarp</td>
<td align="center">stencilBufferValue减1，如果小于0，则变成255（然后继续自减）</td>
</tr>
</tbody></table>
<h4 id="1-3-总结"><a href="#1-3-总结" class="headerlink" title="1.3 总结"></a><strong>1.3 总结</strong></h4><ul>
<li><p>使用模板缓冲区最重要的两个值：当前模板缓冲值stencilBufferValue和模板参考值referenceValue</p>
</li>
<li><p>模板测试主要就是对这两个值使用特定的比较操作</p>
</li>
<li><p>模板测试之后要对模板缓冲区的值进行更新操作，Keep，Zero，Replace等</p>
</li>
<li><p>模板测试之后可以根据结果对模板缓冲区做不同的更新操作，比如测试成功操作pass，测试失败操作fail，深度测试失败Zfail，还有正对正面和背面精确更新操作PassBack，PassFront，FailBack等</p>
</li>
<li><p>应用</p>
<ul>
<li>描边<ul>
<li><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220816205437129.png" alt="image-20220816205437129"></li>
</ul>
</li>
<li>多边形填充<ul>
<li><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220816205429461.png" alt="image-20220816205429461"></li>
</ul>
</li>
<li>反射区域控制<ul>
<li><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220816205345560.png" alt="image-20220816205345560"></li>
</ul>
</li>
<li>Shadow Volume</li>
</ul>
</li>
</ul>
<h3 id="二、深度测试Depth-Test"><a href="#二、深度测试Depth-Test" class="headerlink" title="二、深度测试Depth Test"></a><strong>二、深度测试Depth Test</strong></h3><ul>
<li>一些特性</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220816205656742.png" alt="image-20220816205656742"></p>
<p>在这里面值得注意的是最后一张，greater的部分，绿色的部分消失了。这是因为蓝色外面的部分还没有渲染，是无穷远，greater的比较无法通过，就不被渲染。像这种涉及无穷远比较的，比如天空盒，要多注意深度测试的比较方式。</p>
<h4 id="2-1-渲染管线中的深度测试"><a href="#2-1-渲染管线中的深度测试" class="headerlink" title="2.1 渲染管线中的深度测试"></a><strong>2.1 渲染管线中的深度测试</strong></h4><blockquote>
<p>  Early-Z</p>
<p>  现在大部分的GPU都提供一个叫做提前深度测试(Early Depth Testing)的硬件特性。提前深度测试允许深度测试在片段着色器之前运行。只要我们清楚一个片段永远不会是可见的（它在其他物体之后），我们就能提前丢弃这个片段。</p>
<p>  片段着色器通常开销都是很大的，所以我们应该尽可能避免运行它们。当使用提前深度测试时，片段着色器的一个限制是你不能写入片段的深度值。如果一个片段着色器对它的深度值进行了写入，提前深度测试是不可能的。OpenGL不能提前知道深度值。</p>
<p>  ——LearnOpengl</p>
</blockquote>
<ul>
<li><p>（Early-Z）</p>
</li>
<li><p>片元着色器</p>
</li>
<li><p>逐片元操作（可配置，不可编程）</p>
<ul>
<li>像素权限测试Pixel Ownership Test（屏幕窗口使用权限，如scene和game窗口区分）</li>
<li>裁剪测试Scissor Test（可以对渲染部分区域进行控制）</li>
<li>透明度测试Alpha Test（片元透明度大于阈值，则通过测试，否则剔除——只能实现不透明和全透明）</li>
<li>模板测试Stencil Test</li>
<li>深度测试Depth Test</li>
<li>混合Blending</li>
<li>Dithering</li>
<li>Logic Op</li>
</ul>
</li>
</ul>
<h4 id="2-2-深度测试理解"><a href="#2-2-深度测试理解" class="headerlink" title="2.2 深度测试理解"></a><strong>2.2 深度测试理解</strong></h4><p>深度测试就是当前对象在屏幕（Frame Buffer）对应的像素点，将对象自身的深度值与该当前该像素点缓存的深度值进行比较，如果通过，本对象在该像素点才会将颜色写入颜色缓冲，否则不会写入。</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//深度缓冲区</span></span><br><span class="line"><span class="keyword">if</span>(ZWrite On &amp;&amp; (currentDepthValue ComparisonFunction DepthBufferValue))</span><br><span class="line">写入深度</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">忽略深度</span><br></pre></td></tr></table></figure>

<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//颜色缓冲区</span></span><br><span class="line"><span class="keyword">if</span>(currentDepthValue Comparison Function DepthBufferValue)</span><br><span class="line">写入颜色缓冲</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">不写入颜色缓冲</span><br></pre></td></tr></table></figure>

<ul>
<li>从发展角度理解<ul>
<li>控制渲染顺序<ul>
<li>画家算法</li>
<li>Z-Buffer算法</li>
</ul>
</li>
<li>控制Z-Buffer对深度的储存<ul>
<li>Z-Test</li>
<li>Z-Write</li>
</ul>
</li>
<li>控制不同类型物体渲染顺序<ul>
<li>透明物体</li>
<li>不透明物体</li>
<li>渲染队列</li>
</ul>
</li>
<li>减少overdraw<ul>
<li>Early-Z</li>
<li>Z-Cull</li>
<li>Z-check</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="2-2-1-深度缓冲区Z-Buffer"><a href="#2-2-1-深度缓冲区Z-Buffer" class="headerlink" title="2.2.1 深度缓冲区Z-Buffer"></a><strong>2.2.1 深度缓冲区Z-Buffer</strong></h5><p>深度缓冲就像颜色缓冲，在每个片段中储存了信息，并且和颜色缓冲一样拥有宽度和高度，深度缓冲是由窗口系统自动创建的，他会以16、24、32位float的形式储存深度值。在大部分系统中深度缓冲精度都是24位。（Z-Buffer中储存的是当前深度信息，对于每个像素储存一个深度值）</p>
<p>通过Z-Write和Z-Test来调用Z-Buffer，实现想要的渲染结果</p>
<h5 id="2-2-2-深度写入Z-Write"><a href="#2-2-2-深度写入Z-Write" class="headerlink" title="2.2.2 深度写入Z-Write"></a><strong>2.2.2 深度写入Z-Write</strong></h5><p>深度写入包括两种状态：Z-Write On 与Z-Write Off</p>
<p>当我们开启深度写入时，物体被渲染时，对应每个像素的深度都写入到深度缓冲区。反之，不会写入。但是物体写入深度，除了需要深度写入开启，还需要通过深度测试。</p>
<p>Z-Test分为通过和不通过两种情况，Z-Write分为开启和关闭两种情况，一共就是四种情况</p>
<table>
<thead>
<tr>
<th align="center">深度测试</th>
<th align="center">深度写入</th>
<th align="center">深度缓冲区</th>
<th align="center">颜色缓冲区</th>
</tr>
</thead>
<tbody><tr>
<td align="center">通过</td>
<td align="center">开启</td>
<td align="center">写入</td>
<td align="center">写入</td>
</tr>
<tr>
<td align="center">通过</td>
<td align="center">关闭</td>
<td align="center">不写入</td>
<td align="center">写入</td>
</tr>
<tr>
<td align="center">失败</td>
<td align="center">开启</td>
<td align="center">不写入</td>
<td align="center">不写入</td>
</tr>
<tr>
<td align="center">失败</td>
<td align="center">关闭</td>
<td align="center">不写入</td>
<td align="center">不写入</td>
</tr>
</tbody></table>
<p>这里顺便附上之前用Opengl做天空盒时对深度测试的理解。（现在看来glDepthMask就是开启深度写入，glDepthFunc就是比较函数，只有开启深度测试，深度写入才有用）可以根据上面的表格来更深入地理解下面的描述。</p>
<blockquote>
<p>  此外，还额外进行了天空盒的绘制，天空盒其实也就是先绘制一个立方体，然后将其z坐标取为w，使得在坐标归一化除以w时，z&#x3D;1位于无限远的位置，这样能够使得天空的面永远在无限远处。</p>
<p>  期间还需要对深度缓存进行一些操作。以下是我的理解。</p>
<p>  &#x2F;&#x2F;在不进行天空盒z&#x3D;w操作的基础上，我们先渲染一遍天空盒，并且在此期间关闭深度遮罩不写入深度缓存，渲染完毕后开启深度遮罩，渲染其他物体，此时，其他物体覆盖在天空盒上,正常渲染</p>
<p>  &#x2F;&#x2F;(是否写入深度缓存结果上也等同于是否进行深度测试，即可以关闭深度遮罩，也可以关闭深度测试)</p>
<p>   &#x2F;&#x2F;如果不关闭深度遮罩，天空盒深度将写入深度缓存，如果物体在天空盒后面，则被遮挡。</p>
<p>   &#x2F;&#x2F;理解测试：那么在不进行z&#x3D;w的时候，先绘制天空盒，不关闭深度遮罩，但是在绘制完天空盒之后，清除深度缓存，能正常绘制其他物体。测试正确。</p>
<p>   &#x2F;&#x2F;现在进行z&#x3D;w的操作，并且先渲染天空盒，采用关闭深度测试的方式，即便z&#x3D;1.0，也能正常渲染（未写入深度缓冲）。但是如果把天空盒放在最后渲染,天空盒将覆盖所有物体。</p>
<p>   &#x2F;&#x2F;如果是采用关闭深度遮罩的方式呢？只是不写入深度缓存，但实际上还是会进行深度测试，z&#x3D;1.0无法渲染天空盒，因为原本就是1，但如果用LEQUAL,则可以渲染天空盒（默认为LESS）</p>
<p>   &#x2F;&#x2F;实际上，天空盒深度值已经是1.0的情况，开启深度遮罩没有任何意义（开启深度遮罩只是为了避免天空盒深度小于其他物体的情况，1.0已经最大），渲染天空盒和物体的顺序也不会有影响</p>
<p>   &#x2F;&#x2F;但是，后渲染天空盒，保留深度测试，可以利用深度测试提升性能</p>
</blockquote>
<h5 id="2-2-3-比较函数Comparison-Function"><a href="#2-2-3-比较函数Comparison-Function" class="headerlink" title="2.2.3 比较函数Comparison Function"></a><strong>2.2.3 比较函数Comparison Function</strong></h5><table>
<thead>
<tr>
<th align="center">Greater</th>
<th align="center">GEqual</th>
<th align="center">Less</th>
<th align="center">LEqual</th>
<th align="center">Equal</th>
<th align="center">NotEqual</th>
<th align="center">Always</th>
<th align="center">Never</th>
</tr>
</thead>
<tbody><tr>
<td align="center">$&gt;$</td>
<td align="center">$\geq$</td>
<td align="center">$&lt;$</td>
<td align="center">$\leq$</td>
<td align="center">$&#x3D;$</td>
<td align="center">$\neq$</td>
<td align="center">总是通过</td>
<td align="center">总是失败</td>
</tr>
</tbody></table>
<h5 id="2-2-4-默认状态"><a href="#2-2-4-默认状态" class="headerlink" title="2.2.4 默认状态"></a><strong>2.2.4 默认状态</strong></h5><p>Z-Write On，Z-Test Lequal，深度缓存一开始为无穷大。（这些和Opengl是不一样的）</p>
<h4 id="2-3-渲染队列"><a href="#2-3-渲染队列" class="headerlink" title="2.3 渲染队列"></a><strong>2.3 渲染队列</strong></h4><h5 id="2-3-1-Unity中的渲染队列"><a href="#2-3-1-Unity中的渲染队列" class="headerlink" title="2.3.1 Unity中的渲染队列"></a><strong>2.3.1 Unity中的渲染队列</strong></h5><p>Unity中设置队列</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220816220946497.png" alt="image-20220816220946497"></p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tags &#123;&quot;Queue&quot; = &quot;Transparent&quot;&#125;<span class="comment">//默认是Geometry</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">渲染队列</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="center">Background（1000）</td>
<td>最早被渲染的物体的队列</td>
</tr>
<tr>
<td align="center">Geometry（2000）</td>
<td>不透明物体的渲染队列。大多数物体都应该是用该队列进行渲染（默认渲染队列）</td>
</tr>
<tr>
<td align="center">AlphaTest（2450）</td>
<td>有透明通道，需要进行AlphaTest的物体的队列，比在Geometry中更有效</td>
</tr>
<tr>
<td align="center">Transparent（3000）</td>
<td>半透明物体。一般是不写入深度的物体，Alpha Blend等的在该队列渲染</td>
</tr>
<tr>
<td align="center">Overlay（4000）</td>
<td>最后被渲染的物体。一般是覆盖效果，如镜头光晕，屏幕贴片。</td>
</tr>
</tbody></table>
<ul>
<li>渲染队列的物体排序：根据深度排序，深度小的在最前，深度大的在最后</li>
<li>不透明物体的渲染顺序：从前往后</li>
<li>透明物体的渲染顺序：从后往前（OverDraw）</li>
</ul>
<h5 id="2-3-2-Tips"><a href="#2-3-2-Tips" class="headerlink" title="2.3.2 Tips"></a><strong>2.3.2 Tips</strong></h5><p>多pass shader中，unity会选择所有pass里队列最靠前的作为物体的队列，然后根据pass的编写顺序逐pass执行</p>
<h4 id="2-4-Early-Z"><a href="#2-4-Early-Z" class="headerlink" title="2.4 Early-Z"></a><strong>2.4 Early-Z</strong></h4><p>传统的渲染管线中，Z-Test是在Blending阶段，这时的深度测试，所有对象都计算过了片元着色器。大量的计算是无用的。</p>
<p>现代GPU运用了Early-Z技术，在Vs和Fs之间，进行一次深度测试。如果深度测试失败，就不必进行片元着色器的计算。但是最终的Z-Test仍需进行，保证最终遮挡结果正确。前面一次主要是Z-Cull为了裁剪达到优化目的。后一次是Z-Check，为了检查。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220816221825445.png" alt="image-20220816221825445"></p>
<h4 id="2-5-深度值"><a href="#2-5-深度值" class="headerlink" title="2.5 深度值"></a><strong>2.5 深度值</strong></h4><p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220816222256273.png" alt="image-20220816222256273"></p>
<p>这个非线性深度也能够回答GAMES101中闫老师在投影矩阵那部分，讲frustum中间的点在投影矩阵之后是变远了还是变近了的问题。</p>
<blockquote>
<p>  要想有正确的投影性质，需要使用一个非线性的深度方程，它是与 1&#x2F;z  成正比的。它做的就是在z值很小的时候提供非常高的精度，而在z值很远的时候提供更少的精度。花时间想想这个：我们真的需要对1000单位远的深度值和只有1单位远的充满细节的物体使用相同的精度吗？线性方程并不会考虑这一点。</p>
<p>  由于非线性方程与 1&#x2F;z  成正比，在1.0和2.0之间的z值将会变换至1.0到0.5之间的深度值，这就是一个float提供给我们的一半精度了，这在z值很小的情况下提供了非常大的精度。在50.0和100.0之间的z值将会只占2%的float精度，这正是我们所需要的。这样的一个考虑了远近距离的方程是这样的：<br>  $$<br>  F_{depth}&#x3D;\frac{1&#x2F;z-1&#x2F;near}{1&#x2F;far-1&#x2F;near}<br>  $$</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/depth_non_linear_graph.png" alt="img"></p>
<h5 id="2-5-1-深度冲突Z-fighting"><a href="#2-5-1-深度冲突Z-fighting" class="headerlink" title="2.5.1 深度冲突Z-fighting"></a><strong>2.5.1 深度冲突Z-fighting</strong></h5><blockquote>
<p>  一个很常见的视觉错误会在两个平面或者三角形非常紧密地平行排列在一起时会发生，深度缓冲没有足够的精度来决定两个形状哪个在前面。结果就是这两个形状不断地在切换前后顺序，这会导致很奇怪的花纹。这个现象叫做深度冲突(Z-fighting)，因为它看起来像是这两个形状在争夺(Fight)谁该处于顶端。</p>
</blockquote>
<p>所以实际上z-fighting的问题还是精度的问题。</p>
<p>一般解决方法就是稍微移动一点，不要重合。Learnopengl里还基于深度储存的精度剔除，可以把近平面设置远一点。或者是用更大的精度来储存。（实际上永远不会有足够的精度来保证完全重合）</p>
<h4 id="2-6-总结"><a href="#2-6-总结" class="headerlink" title="2.6 总结"></a><strong>2.6 总结</strong></h4><ul>
<li>是用深度缓冲区最重要的两个值：当前深度缓冲currentDepthValue和深度缓冲值zbufferValue，并通过比较操作获取理想渲染结果</li>
<li>Unity中的渲染顺序：先渲染不透明物体（从前往后），再渲染透明物体（从后往前）</li>
<li>通过深度写入和深度测试组合控制半透明物体的渲染</li>
<li>引入Early-z技术后的深度测试渲染流程</li>
<li>深度缓冲区储存0-1的浮点值（非线性深度）</li>
<li>应用<ul>
<li>基于深度的着色（湖水）<ul>
<li>（摄像机到地面距离和湖水深度作比较，以差值比例控制着色）</li>
</ul>
</li>
<li>ShadowMap</li>
<li>透明物体、粒子渲染</li>
<li>透视X-ray效果</li>
<li>切边效果</li>
</ul>
</li>
</ul>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a><strong>作业</strong></h3><p><strong>根据课程内容，使用深度测试与模板测试做一些有意思的效果</strong></p>
<h4 id="模板测试-描边"><a href="#模板测试-描边" class="headerlink" title="模板测试-描边"></a><strong>模板测试-描边</strong></h4><p>正好撞见Unity的描边，我们就来试试模板测试的描边</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220819163419228.png" alt="image-20220819163419228"></p>
<p>我们来拆解一下这个效果</p>
<ul>
<li>2pass<ul>
<li>一个pass绘制物体<ul>
<li>写入一个模板值</li>
</ul>
</li>
<li>一个pass绘制物体法线外扩<ul>
<li>模板比较</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>现在问题就在于，如何进行法线外扩。</p>
<p><a target="_blank" rel="noopener" href="https://www.laowangomg.com/?p=712">https://www.laowangomg.com/?p=712</a></p>
<p>这篇文章总结的非常详细。</p>
<p>其实最重要的问题是，我们在什么时候进行法线外扩？从模型空间到齐次裁剪空间过程中，在哪一步？</p>
<p>问题在于，我们应该让法线如何外扩？对于模型上的所有顶点，沿法线方向移动距离s，这是模型空间、世界空间、相机空间的做法。这样做的问题在于，我们可以把这个距离看作都是世界空间的距离，在经过投影变换后，不同位置的尺度会发生变化，也就是说，导致描边不均匀。</p>
<p>上面的博客给出的办法是——在齐次裁剪空间进行法线外扩，并且我们可以忽略z轴上的变化。只考虑屏幕的xy方向。</p>
<p>但是在我的实践中发现了一个问题，就是其实描边的宽度还是会出现不一致。并且这和渲染窗口分辨率有关。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220819220901399.png" alt="image-20220819220901399"></p>
<p>于是我们就知道是怎么回事了：</p>
<p><strong>齐次裁剪空间时宽度一致的外扩尺度，经过视口变换后不再一致</strong>，但是我们肯定没有办法在视口变换的阶段处理顶点的位置，因此我们仍然需要进行改变。</p>
<p>我们要解决的核心问题是，让它在屏幕上能保持尺度的一致，其实，就是&#x3D;&#x3D;观察空间&#x3D;&#x3D;保持一致。</p>
<p>之前说在MVP空间的外扩都会导致投影后尺度变化。事实的确如此，在观察空间也会出现这个问题。</p>
<p>那么，在观察空间如何解决这一问题呢？我们可以借用裁剪空间的方法，只考虑屏幕上xy的变化，而忽略z的尺度变化。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">o.pos.xy += <span class="built_in">normalize</span>(vNormal.xy) * _OutLine;</span><br><span class="line"><span class="comment">//o.pos.xyz += normalize(vNormal.xyz) * _OutLine;</span></span><br></pre></td></tr></table></figure>

<p>我们可以看出使用XYZ和xy的细微差别，这也很好理解。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/1660921557672.gif" alt="1660921557672"></p>
<p>这里我还做了一项处理就是让描边的粗细不受距离的影响，或者说，距离增加，描边的粗细也应该增加。不然就会像这样</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220819222542483.png" alt="image-20220819222542483"></p>
<p>这应该如何处理呢？</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220819232155564.png" alt="image-20220819232155564"></p>
<p>我们的h1&#x2F;z1是由参数控制的，不妨令z1为1，则h1就等于</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">normalize</span>(o.pos.xy)*_OutLine</span><br></pre></td></tr></table></figure>

<p>那么要令距离z2的点在投影上和h1具有相同的高度，h2就很好求了。</p>
<p>这里还要注意，将z值取绝对值，我们只需要正值的计算。这样再调一调粗细的参数，效果和unity的描边效果就是基本一致的。</p>
<p>但是这种做法的局限性在于顶点法线，如果比较尖锐的顶点不是插值的法线的话，就会出现面片的分离。这就需要对模型法线进行处理，涉及到相应的工具制作。这也就是之后下一步工作的伏笔了。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/1660923128047.gif" alt="1660923128047"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Pass&#123;</span><br><span class="line"></span><br><span class="line">    Stencil&#123;</span><br><span class="line">        Ref <span class="number">0</span></span><br><span class="line">            Comp Equal</span><br><span class="line">    &#125;</span><br><span class="line">	Cull front</span><br><span class="line">    CGPROGRAM</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> _OutLine;</span><br><span class="line">    <span class="type">float</span> _Attenuation;</span><br><span class="line"></span><br><span class="line">    <span class="function">v2f <span class="title">vert</span><span class="params">(a2v v)</span> </span>&#123;</span><br><span class="line">        v2f o;</span><br><span class="line">        o.pos = <span class="built_in">mul</span>(UNITY_MATRIX_MV,v.vertex);</span><br><span class="line">        float3 vNormal = <span class="built_in">mul</span>((float3x3) UNITY_MATRIX_V, <span class="built_in">UnityObjectToWorldNormal</span>(v.normal));</span><br><span class="line">        o.pos.xy += <span class="built_in">normalize</span>(vNormal.xy) * _OutLine * <span class="built_in">abs</span>(o.pos.z);</span><br><span class="line">        o.pos = <span class="built_in">mul</span>(UNITY_MATRIX_P,o.pos);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function">fixed4 <span class="title">frag</span><span class="params">(v2f i)</span> : SV_Target &#123;</span></span><br><span class="line">        fixed4 color =<span class="built_in">fixed4</span>(<span class="number">1.0</span>,<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">1.0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">fixed4</span>(color);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> vertex vert</span></span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> fragment frag</span></span><br><span class="line"></span><br><span class="line">    ENDCG</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们为了防止描边被遮挡，也可做如下处理</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Stencil&#123;</span><br><span class="line">    Ref <span class="number">1</span></span><br><span class="line">        Comp Always</span><br><span class="line">        Pass replace</span><br><span class="line">        ZFail replace</span><br><span class="line">&#125;<span class="comment">//物体pass</span></span><br><span class="line"></span><br><span class="line">Stencil&#123;</span><br><span class="line">    Ref <span class="number">0</span></span><br><span class="line">        Comp Equal</span><br><span class="line">&#125;</span><br><span class="line">Cull front</span><br><span class="line">ZTest always<span class="comment">//描边pass</span></span><br></pre></td></tr></table></figure>



<h4 id="深度测试-遮挡透视"><a href="#深度测试-遮挡透视" class="headerlink" title="深度测试-遮挡透视"></a><strong>深度测试-遮挡透视</strong></h4><p>首先当然是做一个遮挡扫描效果。</p>
<p>我们来拆解下这个效果的组成</p>
<ul>
<li>遮挡物<ul>
<li>正常的</li>
</ul>
</li>
<li>被遮挡物<ul>
<li>多pass<ul>
<li>以正常部分的队列为物体渲染队列从前往后</li>
</ul>
</li>
<li>正常部分<ul>
<li>Geometry</li>
<li>开启深度测试LESS，开启深度写入</li>
</ul>
</li>
<li>遮挡部分<ul>
<li>Transparent</li>
<li>开启深度测试Greater，不写入深度</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>我们首先来写一下遮挡部分</p>
<p>在透明的处理上，顺便看了下3.2部分的混合，用正常的透明混合方法Blend SrcAlpha OneMinusSrcAlpha</p>
<p>当然也可以选择其他的（感觉差不太多）</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220817153223447.png" alt="image-20220817153223447" style="zoom:50%;" />

<h5 id="大问题"><a href="#大问题" class="headerlink" title="大问题"></a><strong>大问题</strong></h5><p>出现了一个大问题。为遮挡物赋予一些材质时，会导致渲染顺序出错。</p>
<p>正常来说，遮挡物和被遮挡物都会处于Geometry的渲染队列，并且遮挡物先渲染，再渲透明Pass，最后是非透明Pass这是非常合理的.</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220817211331779.png" alt="image-20220817211331779"></p>
<p>赋予某些材质后。</p>
<p>有些时候是正常的，有些时候，透明pass会在遮挡物之前渲染，导致透明物体被遮挡。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220817211349707.png" alt="image-20220817211349707"></p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220817211648337.png" alt="image-20220817211648337"></p>
<p>这还不是最麻烦的。在这个状态下，如果后退摄像机一点，这里两个透明物体中的其中一个被渲染出来了。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220817211717544.png" alt="image-20220817211717544"></p>
<p>如果再后退一点——透明物体都正常绘制了。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220817211752817.png" alt="image-20220817211752817"></p>
<p>**但是，这依然不是最麻烦的。**如果这个时候，再把摄像机后退一些会发生什么呢？</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220817211856345.png" alt="image-20220817211856345"></p>
<p>这就是我所感觉到的绝望。</p>
<p>解决方法我想到了很多。</p>
<ol>
<li>被遮挡物体物体两个Pass都放在了Geometry渲染。如果把两个Pass放在Geometry之后的其他Pass渲染，就没问题了。但要注意修改Tags的pass时，最好是subshader的pass，这样会比较稳定，如果只改两个Pass的tags，是不稳定的。</li>
<li>和上面的方法基本思想一样，做法刚好相反。就是一定要保证遮挡物在被遮挡物两个pass之前渲染，把遮挡物的队列设成Geometry-1（或者更前面）就好了。</li>
<li>换一个遮挡物的shader和材质。这个是比较麻烦的。因为，即便是一个原本能正常绘制的shader，在我完全复制所有代码以后，重新生成的材质，依然出现了上述问题。这就比较玄学了，这也是最头疼的部分。。。</li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/468122471%E7%94%A8%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95%EF%BC%8C%E6%8A%8A%E4%B8%A4%E4%B8%AApass%E5%88%86%E5%BC%80%E5%88%B0%E4%B8%A4%E4%B8%AAshader%EF%BC%8C%E7%94%A8UsePass%E7%9A%84%E6%96%B9%E6%B3%95%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%90%84%E8%87%AA%E7%9A%84subshader%E5%8F%AF%E4%BB%A5%E8%AE%BE%E7%BD%AE%E5%90%84%E8%87%AA%E7%9A%84Tag%E3%80%82%E7%BB%93%E6%9E%9C%E4%B9%9F%E6%98%AF%E6%AD%A3%E5%B8%B8%E7%9A%84%E3%80%82">https://zhuanlan.zhihu.com/p/468122471用这篇文章的处理方法，把两个pass分开到两个shader，用UsePass的方法，这样各自的subshader可以设置各自的Tag。结果也是正常的。</a></li>
</ol>
<p>但是，虽然这些方法能解决问题，我还是不知道为什么会出现这样的问题，以及，其实没有解决问题的根本——为什么在这些shader中渲染顺序会出错，不应该都是按深度排序的吗？</p>
<p>首先会考虑是否是z精度的问题？但是又怎么会随距离周期变化呢？</p>
<p>发现其实DepthPass顺序就错了，也就是说直接原因还是深度。但是为什么某些材质就没有这个问题了呢？并且SubShader和Pass的Tag也有影响。。。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220817213753109.png" alt="image-20220817213753109"></p>
<p><strong>又找到了一个绝妙的解决方法</strong></p>
<p>我直接重新做一个shader，然后用两次UsePass。。。当然，缺少原来CGINCLUDE的参数和属性，这一部分直接原样复制过去就行了。</p>
<p>果然能解决问题。</p>
<p>。。。但是令人崩溃的又来了。。。我继续把两个UsePass分别替换回原来的两个Pass的代码。。。竟然也是对的。。。问题是这样和原来的代码有啥区别。。。shader的名字的区别。。。为什么。。。已经麻了，就当是bug吧。</p>
<p>感觉跟unity的资源读取和shader编译的过程有一定关系。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhlabcd/p/11767018.html%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E5%87%BA%E7%8E%B0%E4%BA%86%E4%B8%80%E6%A0%B7%E7%9A%84%E7%8E%B0%E8%B1%A1%EF%BC%8C%E4%BD%86%E6%98%AF%E7%9C%8B%E8%B5%B7%E6%9D%A5%E5%8E%9F%E5%9B%A0%E4%B8%8D%E5%A4%AA%E4%B8%80%E6%A0%B7%EF%BC%8C%E4%B8%8D%E8%BF%87%E5%8F%AF%E8%83%BD%E6%9C%89%E4%B8%80%E5%AE%9A%E5%85%B1%E6%80%A7%E3%80%82">https://www.cnblogs.com/zhlabcd/p/11767018.html这篇文章出现了一样的现象，但是看起来原因不太一样，不过可能有一定共性。</a></p>
<p>背后的真正原因，只能有缘再解决了</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a><strong>参考资料</strong></h3><p>[1] <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Tb4y1C7Qa">https://www.bilibili.com/video/BV1Tb4y1C7Qa</a></p>
<p>【技术美术百人计划】图形 3.1 深度与模板测试  传送门效果示例</p>
<p>[2] <a target="_blank" rel="noopener" href="https://learnopengl-cn.github.io/04%20Advanced%20OpenGL/01%20Depth%20testing/">https://learnopengl-cn.github.io/04%20Advanced%20OpenGL/01%20Depth%20testing/</a></p>
<p>[3] <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/427742656">https://zhuanlan.zhihu.com/p/427742656</a></p>
<p>[4] <a target="_blank" rel="noopener" href="https://www.laowangomg.com/?p=712">https://www.laowangomg.com/?p=712</a></p>
<p>[5] <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/468122471">https://zhuanlan.zhihu.com/p/468122471</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/20/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A23.1%E6%B7%B1%E5%BA%A6%E4%B8%8E%E6%A8%A1%E6%9D%BF%E6%B5%8B%E8%AF%95/" data-id="cmfe9guj2003oewuh9z7x84m4" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Computer-Graphics/" rel="tag">Computer Graphics</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/" rel="tag">百人计划</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/" rel="tag">过程记录</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Maya/Python For Maya（OpenMaya）（四）" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/18/TA/Maya/Python%20For%20Maya%EF%BC%88OpenMaya%EF%BC%89%EF%BC%88%E5%9B%9B%EF%BC%89/">【笔记】【Maya工具】Python For Maya（OpenMaya）（四）Locator &amp; CallBack for IK</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/18/TA/Maya/Python%20For%20Maya%EF%BC%88OpenMaya%EF%BC%89%EF%BC%88%E5%9B%9B%EF%BC%89/" class="article-date">
  <time datetime="2022-08-18T10:54:18.000Z" itemprop="datePublished">2022-08-18</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="一、Creating-Custom-Locator"><a href="#一、Creating-Custom-Locator" class="headerlink" title="一、Creating Custom Locator"></a><strong>一、Creating Custom Locator</strong></h2><p>maya提供标准locator定位器，我们也可以自定义定位器</p>
<ol>
<li>Draw&#x2F;Define a shape(Opengl-function-&gt;MGLFunctionTable)</li>
<li>Define a Bounding Box?<ol>
<li>isBounded()</li>
</ol>
</li>
<li>Define size of Bounding Box(Size of the locator)<ol>
<li>boundingBox()</li>
</ol>
</li>
</ol>
<h3 id="1-1-Locators"><a href="#1-1-Locators" class="headerlink" title="1.1 Locators"></a><strong>1.1 Locators</strong></h3><ul>
<li><p>MPxLocatorNode</p>
<ul>
<li>draw()</li>
<li>isBounded()</li>
<li>boundingBox()</li>
</ul>
</li>
<li><p>MGLFunctionTable</p>
<ul>
<li>为OpenGL的api提供了包装器</li>
<li>我们不用自己进行实例化，只需要获取maya中的一个指针</li>
<li>MHardwareRenderer() &lt;&lt;OpenMaya Render\</li>
<li>ptr &#x3D; OpenMayaRender.MHardwareRenderer.theRenderer()</li>
<li>ptr link to HardwareRenderer<ul>
<li>glFunctionTable()-&gt;Opengl functions</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="1-2-实现结果"><a href="#1-2-实现结果" class="headerlink" title="1.2 实现结果"></a><strong>1.2 实现结果</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#locators.py</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> maya.OpenMaya <span class="keyword">as</span> OpenMaya</span><br><span class="line"><span class="keyword">import</span> maya.OpenMayaMPx <span class="keyword">as</span> OpenMayaMPx</span><br><span class="line"><span class="keyword">import</span> maya.OpenMayaRender <span class="keyword">as</span> OpenMayaRender</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nodeName = <span class="string">&quot;LeftFoot&quot;</span></span><br><span class="line">nodeId = OpenMaya.MTypeId(<span class="number">0x100fff</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ptr to gl function table</span></span><br><span class="line">glRenderer = OpenMayaRender.MHardwareRenderer.theRenderer()</span><br><span class="line">glFT = glRenderer.glFunctionTable()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LocatorNode</span>(OpenMayaMPx.MPxLocatorNode):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        OpenMayaMPx.MPxLocatorNode.__init__(<span class="variable language_">self</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute</span>(<span class="params">self, plug, dataBlock</span>):</span><br><span class="line">        <span class="keyword">return</span> OpenMaya.kUnknownParameter</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">draw</span>(<span class="params">self, view, path, style, status</span>):<span class="comment"># drawing View,dagpath,(wireframe...)</span></span><br><span class="line">        view.beginGL()<span class="comment">#这里的opengl依然是状态机</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Pushed current state</span></span><br><span class="line">        glFT.glPushAttrib(OpenMayaRender.MGL_CURRENT_BIT)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Enable blend mode(to enable transparency)</span></span><br><span class="line">        glFT.glEnable(OpenMayaRender.MGL_BLEND)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Defined Blend function</span></span><br><span class="line">        glFT.glBlendFunc(OpenMayaRender.MGL_SRC_ALPHA, OpenMayaRender.MGL_ONE_MINUS_SRC_ALPHA)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Define colors for different selection modes</span></span><br><span class="line">        <span class="keyword">if</span> status == view.kActive:</span><br><span class="line">            glFT.glColor4f(<span class="number">0.2</span>, <span class="number">0.5</span>, <span class="number">0.1</span>, <span class="number">0.3</span>)</span><br><span class="line">        <span class="keyword">elif</span> status == view.kLead:</span><br><span class="line">            glFT.glColor4f(<span class="number">0.5</span>, <span class="number">0.2</span>, <span class="number">0.1</span>, <span class="number">0.3</span>)</span><br><span class="line">        <span class="keyword">else</span>:<span class="comment"># status == view.kDormant:</span></span><br><span class="line">            glFT.glColor4f(<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Draw a shape</span></span><br><span class="line">        glFT.glBegin(OpenMayaRender.MGL_POLYGON)</span><br><span class="line">        glFT.glVertex3f(-<span class="number">0.031</span>, <span class="number">0.0</span>, -<span class="number">2.875</span>)</span><br><span class="line">        glFT.glVertex3f(-<span class="number">0.939</span>, <span class="number">0.1</span>, -<span class="number">2.370</span>)</span><br><span class="line">        glFT.glVertex3f(-<span class="number">1.175</span>, <span class="number">0.2</span>, -<span class="number">1.731</span>)</span><br><span class="line">        glFT.glVertex3f(-<span class="number">0.60</span>, <span class="number">0.3</span>, <span class="number">1.060</span>)</span><br><span class="line">        glFT.glVertex3f(<span class="number">0.473</span>, <span class="number">0.3</span>, <span class="number">1.026</span>)</span><br><span class="line">        glFT.glVertex3f(<span class="number">0.977</span>, <span class="number">0.2</span>,-<span class="number">1.731</span>)</span><br><span class="line">        glFT.glVertex3f(<span class="number">0.809</span>, <span class="number">0.1</span>, -<span class="number">2.337</span>)</span><br><span class="line">        glFT.glVertex3f(<span class="number">0.035</span>, <span class="number">0.0</span>, -<span class="number">2.807</span>)</span><br><span class="line">        glFT.glEnd()</span><br><span class="line"></span><br><span class="line">        glFT.glBegin(OpenMayaRender.MGL_POLYGON)</span><br><span class="line">        glFT.glVertex3f(-<span class="number">0.587</span>, <span class="number">0.3</span>, <span class="number">1.33</span>)</span><br><span class="line">        glFT.glVertex3f(<span class="number">0.442</span>, <span class="number">0.3</span>, <span class="number">1.33</span>)</span><br><span class="line">        glFT.glVertex3f(<span class="number">0.442</span>, <span class="number">0.3</span>, <span class="number">1.92</span>)</span><br><span class="line">        glFT.glVertex3f(<span class="number">0.230</span>, <span class="number">0.3</span>, <span class="number">2.24</span>)</span><br><span class="line">        glFT.glVertex3f(-<span class="number">0.442</span>, <span class="number">0.3</span>, <span class="number">2.25</span>)</span><br><span class="line">        glFT.glVertex3f(-<span class="number">0.635</span>, <span class="number">0.3</span>, <span class="number">1.92</span>)</span><br><span class="line">        glFT.glVertex3f(-<span class="number">0.567</span>, <span class="number">0.3</span>, <span class="number">1.35</span>)</span><br><span class="line">        </span><br><span class="line">        glFT.glEnd()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> status == view.kActive:</span><br><span class="line">            glFT.glColor4f(<span class="number">0.2</span>, <span class="number">0.5</span>, <span class="number">0.1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">elif</span> status == view.kLead:</span><br><span class="line">            glFT.glColor4f(<span class="number">0.5</span>, <span class="number">0.2</span>, <span class="number">0.1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:<span class="comment"># status == view.kDormant:</span></span><br><span class="line">            glFT.glColor4f(<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">1</span>)</span><br><span class="line">        view.drawText(<span class="string">&quot;Left Foot&quot;</span>, OpenMaya.MPoint(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>), view.kLeft)</span><br><span class="line">        <span class="comment"># Disable Blend mode</span></span><br><span class="line">        glFT.glDisable(OpenMayaRender.MGL_BLEND)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Restore the state</span></span><br><span class="line">        glFT.glPopAttrib()</span><br><span class="line"></span><br><span class="line">        view.endGL()</span><br><span class="line">             </span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nodeCreator</span>():</span><br><span class="line">    <span class="keyword">return</span> OpenMayaMPx.asMPxPtr(LocatorNode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nodeInitializer</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># 初始化,和maya pluginCommand是一样的</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initializePlugin</span>(<span class="params">mobject</span>):</span><br><span class="line">    mplugin = OpenMayaMPx.MFnPlugin(mobject)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mplugin.registerNode(nodeName, nodeId, nodeCreator, nodeInitializer, OpenMayaMPx.MPxNode.kLocatorNode)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sys.stderr.write(<span class="string">&quot;Failed to register node:&quot;</span> + nodeName)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uninitializePlugin</span>(<span class="params">mobject</span>):</span><br><span class="line">    mplugin = OpenMayaMPx.MFnPlugin(mobject)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mplugin.deregisterNode(nodeId)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sys.stderr.write(<span class="string">&quot;Failed to deregister node&quot;</span> + nodeName)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.cmds <span class="keyword">as</span> cmds</span><br><span class="line">cmds.loadPlugin(<span class="string">&quot;D:\\Autodesk\\plugin\\locators.py&quot;</span>)</span><br><span class="line">cmds.createNode(<span class="string">&quot;LeftFoot&quot;</span>)</span><br></pre></td></tr></table></figure>



<p>有组件，但是无显示，查阅api后发现，其实这个有给出例程，但是也是分了api1.0和api2.0版本的，教程写的大概是api1.0版本，1.0在maya2023、python3.9.3版本上大概不能使用，因此只能后面参考api2.0版的例程了。</p>
<p>而后面的IK部分也是完全无法使用了，需要学习新版本的api。只能笔记记录下思路</p>
<h2 id="二、Maya-Callbacks"><a href="#二、Maya-Callbacks" class="headerlink" title="二、Maya Callbacks"></a><strong>二、Maya Callbacks</strong></h2><p>回调是一种链接方式，链接特定事件的特定函数，并时刻关注这个函数的发生</p>
<p>回调允许我们针对特定的事件注册该函数（和java中的listener、Oracle中的Trigger相似）</p>
<p>OpenMaya中基于事件类别，对回调进行了分类</p>
<p>基类【MMessage】，其他回调的类都是这个基类的派生类callback(event, function)</p>
<h3 id="2-1-Message消息"><a href="#2-1-Message消息" class="headerlink" title="2.1 Message消息"></a><strong>2.1 Message消息</strong></h3><ul>
<li><p>Message[eg MAnim Message]</p>
</li>
<li><p>Message[eg MCommand Message]</p>
</li>
</ul>
<h3 id="2-2-Callback回调"><a href="#2-2-Callback回调" class="headerlink" title="2.2 Callback回调"></a><strong>2.2 Callback回调</strong></h3><ul>
<li><p>Removable</p>
</li>
<li><p>Id（callback create）</p>
</li>
<li><p>MAnim Message</p>
<ul>
<li>Animation Message Callback<ul>
<li>animation curve editing</li>
<li>keyframe editing</li>
<li>baked result change</li>
</ul>
</li>
</ul>
</li>
<li><p>MCommand Message</p>
<ul>
<li>Command Message Callback<ul>
<li>MEL command excution</li>
</ul>
</li>
</ul>
</li>
<li><p>MDG Message</p>
<ul>
<li>for Dependency Graph Message</li>
<li>Node added&#x2F;removed</li>
<li>Connection established&#x2F;removed</li>
</ul>
</li>
<li><p>MDAG Message</p>
<ul>
<li>for dependency Graph Message</li>
<li>(主要跟踪或检查dag节点的切换)</li>
<li>Parent&#x2F;child&#x2F;Instance&#x2F;added&#x2F;removed</li>
</ul>
</li>
<li><p>Event Message</p>
<ul>
<li>“script Job”</li>
<li><code>OpenMaya.MEventMessage.getEventNames()</code></li>
</ul>
</li>
<li><p>Lock Message</p>
<ul>
<li>for lock message</li>
<li>plug locked&#x2F;unlocked<ul>
<li>values cannot be changed</li>
</ul>
</li>
<li>Node locked&#x2F;unlocked<ul>
<li>cannot Re-parented&#x2F;Renamed&#x2F;deleted</li>
</ul>
</li>
</ul>
</li>
<li><p>Node Message</p>
<ul>
<li>for Dependency Node Message</li>
<li>Attribute added&#x2F;removed</li>
<li>plug of a Node is dirty</li>
<li>name of a Node is changed</li>
</ul>
</li>
<li><p>Scene Message</p>
<ul>
<li>Scene related Message</li>
<li>Before&#x2F;After<ul>
<li>New scene</li>
<li>Existing scene</li>
<li>Reference is loaded&#x2F;unloaded</li>
<li>Maya is initialized&#x2F;exist</li>
</ul>
</li>
</ul>
</li>
<li><p>Timer Message</p>
</li>
<li><p>UI Message</p>
</li>
<li><p>User-event message</p>
</li>
</ul>
<h2 id="三、Inverse-Forward-Kinematics-Solution"><a href="#三、Inverse-Forward-Kinematics-Solution" class="headerlink" title="三、Inverse-Forward Kinematics Solution"></a><strong>三、Inverse-Forward Kinematics Solution</strong></h2><p><strong>在这个插件中使用回调将IK和FK的功能结合起来</strong></p>
<ul>
<li><p>FK mode</p>
<ul>
<li>移动父节点，驱动子结点</li>
</ul>
</li>
<li><p>IK mode</p>
<ul>
<li>移动子节点，在约束的条件下，自动解算父节点位置</li>
</ul>
</li>
</ul>
<ol>
<li>在IK和FK中切换<ol>
<li>选择polar vector&#x2F;IK handle&#x2F;子结点关节时，IK mode</li>
<li>选择任意一个父节点关节时，FK mode</li>
</ol>
</li>
<li>施加约束</li>
</ol>
<p>Custom-Node (IK FK)&lt;-&gt; Event Callback &lt;-&gt; Selection Change</p>
<p>Custom-Node (delete)&lt;-&gt;DG Callback &lt;-&gt; addition&#x2F;creation&#x2F;deletion the DG nodes</p>
<h3 id="Creating-I-F-K-solution"><a href="#Creating-I-F-K-solution" class="headerlink" title="Creating I-F K solution"></a><strong>Creating I-F K solution</strong></h3><h4 id="Auto-IK-FK-Switching"><a href="#Auto-IK-FK-Switching" class="headerlink" title="Auto IK-FK Switching"></a><strong>Auto IK-FK Switching</strong></h4><ol>
<li>Find out which “Mode” we want to switch to</li>
<li>Find information of all seven objects of 3-joint chain IK-system</li>
<li>Perform operation based on the “Mode” we are at</li>
</ol>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220705144129456.png" alt="image-20220705144129456"></p>
<p>我这里暂时没有poleVectorControl</p>
<p>默认Mode &#x3D;FK(joint1,joint2)</p>
<ul>
<li>Mode &#x3D; IK<ol>
<li>IK -Handle selected</li>
<li>Joint3 selected</li>
<li>Pole-vectorcontrol selected</li>
</ol>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220705201445310.png" alt="image-20220705201445310"></p>
<ul>
<li><p>If Mode &#x3D; FK</p>
<ol>
<li>set ikBlend &#x3D; 0</li>
<li>set visibility of Pole Vector Control &#x3D; 0</li>
</ol>
</li>
<li><p>If Mode &#x3D; IK</p>
<ol>
<li>set ikBlend &#x3D; 1</li>
<li>snap Pole Vector Control to Joint2</li>
</ol>
</li>
<li><p>set attribute of IK handle to non-Keyable</p>
</li>
<li><p>ikBlend</p>
</li>
<li><p>ikBlend- non-Keyable</p>
</li>
<li><p>Add translation after snapping Pole Vector Control</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/18/TA/Maya/Python%20For%20Maya%EF%BC%88OpenMaya%EF%BC%89%EF%BC%88%E5%9B%9B%EF%BC%89/" data-id="cmfe9guiq001jewuhebyka92s" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Maya/" rel="tag">Maya</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Maya/Python For Maya（OpenMaya）（三）" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/18/TA/Maya/Python%20For%20Maya%EF%BC%88OpenMaya%EF%BC%89%EF%BC%88%E4%B8%89%EF%BC%89/">【笔记】【maya工具】Python For Maya（OpenMaya）（三）Structure of a Deformer</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/18/TA/Maya/Python%20For%20Maya%EF%BC%88OpenMaya%EF%BC%89%EF%BC%88%E4%B8%89%EF%BC%89/" class="article-date">
  <time datetime="2022-08-18T09:58:00.000Z" itemprop="datePublished">2022-08-18</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <p>这个案例最终复现失败了，还是因为教程太老了，版本对不上，有很多api已经有了很大的变化</p>
        
          <p>
            <a class="article-more-link" href="/2022/08/18/TA/Maya/Python%20For%20Maya%EF%BC%88OpenMaya%EF%BC%89%EF%BC%88%E4%B8%89%EF%BC%89/">
              Read More...
            </a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/18/TA/Maya/Python%20For%20Maya%EF%BC%88OpenMaya%EF%BC%89%EF%BC%88%E4%B8%89%EF%BC%89/" data-id="cmfe9guio001bewuh4rnadf3z" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Maya/" rel="tag">Maya</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Maya/Python For Maya（OpenMaya）（二）" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/18/TA/Maya/Python%20For%20Maya%EF%BC%88OpenMaya%EF%BC%89%EF%BC%88%E4%BA%8C%EF%BC%89/">【笔记】【Maya工具】Python For Maya（OpenMaya）（二）Dependency Graph</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/18/TA/Maya/Python%20For%20Maya%EF%BC%88OpenMaya%EF%BC%89%EF%BC%88%E4%BA%8C%EF%BC%89/" class="article-date">
  <time datetime="2022-08-18T09:48:35.000Z" itemprop="datePublished">2022-08-18</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="Dependency-Graph"><a href="#Dependency-Graph" class="headerlink" title="Dependency Graph"></a>Dependency Graph</h2><ul>
<li><p>Dirty Propagation</p>
</li>
<li><p>Push &amp; Pull Mechanism</p>
</li>
<li><p>Lazy Evaluation</p>
</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220704094816836.png" alt="image-20220704094816836" style="zoom:67%;" />

<h3 id="1-Dirty-Propagation"><a href="#1-Dirty-Propagation" class="headerlink" title="1. Dirty Propagation"></a><strong>1. Dirty Propagation</strong></h3><p>Dependency Graph Node</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220704095016592.png" alt="image-20220704095016592"></p>
<p>由有关联的输入、输出和对应的计算函数组成</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220704095141685.png" alt="image-20220704095141685" style="zoom:50%;" />

<p>输入节点传播到对应的输出节点（Dirty Propagation），直到叶节点</p>
<p>Updation Request（对节点属性产生影响的操作）</p>
<ul>
<li>View Port</li>
<li>Attribute Editor</li>
<li>Channel Box</li>
<li>getAttr</li>
</ul>
<p>反向传播</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220704095445679.png" alt="image-20220704095445679" style="zoom:50%;" />

<p>Clean Propagation</p>
<p>（不会对没有输出要求的节点进行Clean）</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220704095707170.png" alt="image-20220704095707170" style="zoom: 50%;" />

<p>注意涂色的是Attribute&#x2F;Plug，而不是Node本身</p>
<p>总结：</p>
<p>Dirty Propagation向一个方向传播直到叶节点，当出现Updation Request时，传播开始返回并检查哪些节点是Dirty的，最后到达Dirty的根节点时开始计算，设置Attribute&#x2F;Plug为Clean</p>
<h3 id="2-Push-Pull-Mechanism"><a href="#2-Push-Pull-Mechanism" class="headerlink" title="2. Push &amp; Pull Mechanism"></a><strong>2. Push &amp; Pull Mechanism</strong></h3><p>在Dirty Propagation中，Dirty的标记被push至一个方向直到最后（Pushed Dirty Message）。</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220704100117924.png" alt="image-20220704100117924" style="zoom:50%;" />

<h3 id="3-Lazy-Evaluation"><a href="#3-Lazy-Evaluation" class="headerlink" title="3. Lazy Evaluation"></a><strong>3. Lazy Evaluation</strong></h3><p>在Clean Propagation中会存在依然Dirty的节点。</p>
<p>Maya只更新或执行请求过的属性。</p>
<h3 id="4-Writing-Dependency-Graph-Custom-Node"><a href="#4-Writing-Dependency-Graph-Custom-Node" class="headerlink" title="4. Writing Dependency Graph&#x2F; Custom Node"></a><strong>4. Writing Dependency Graph&#x2F; Custom Node</strong></h3><h4 id="4-1-Dependency-Graph-Node"><a href="#4-1-Dependency-Graph-Node" class="headerlink" title="4.1 Dependency Graph Node"></a><strong>4.1 Dependency Graph Node</strong></h4><p>可以执行计算（DG-Node+Computation）</p>
<ul>
<li>DG-Node<ul>
<li><strong>Attribute</strong>（任何输入&#x2F;输出）<ul>
<li>Specialize Handle（<strong>Plug</strong>）</li>
</ul>
</li>
<li><strong>Data Block</strong><ul>
<li>Specialize Handle（<strong>Data Handle</strong>）</li>
<li>保存节点所有数据</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="4-2-建立一个DG-Node-Graph"><a href="#4-2-建立一个DG-Node-Graph" class="headerlink" title="4.2 建立一个DG-Node Graph"></a><strong>4.2 建立一个DG-Node Graph</strong></h4><p>建立一个DG-Node Graph和建立一个Maya command是很相似的</p>
<ul>
<li><p>command</p>
<ul>
<li>class PluginCommand</li>
<li>cmdCreators</li>
<li>initializePlugin</li>
<li>uninitializePlugin</li>
</ul>
</li>
<li><p>DG-Node</p>
<ul>
<li><p>class WheelNode</p>
<ul>
<li>_<em>init</em>_</li>
<li><del>doIt</del> compute</li>
</ul>
</li>
<li><p>Creator function</p>
</li>
<li><p>initialize function</p>
<ul>
<li><p>初始化节点所有属性</p>
<ul>
<li><p>MFn-Attribute使用函数集来创建属性</p>
</li>
<li><p>create Attribute(Create + set Properties)</p>
<ul>
<li><p>MFn-&gt;create attribute return mObj Handle</p>
</li>
<li><p>set Properties</p>
<ol>
<li><p>readable-&gt;source(输出节点只可读)</p>
</li>
<li><p>writable-&gt;destination[setAttr]</p>
</li>
<li><p>Storable-&gt;store with file(input)</p>
</li>
<li><p>Keyable -&gt;can be keyed or not</p>
</li>
</ol>
</li>
<li></li>
</ul>
</li>
<li><p>attach Attribute to the Node</p>
</li>
<li><p>Design circuitry</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>initializePlugin</p>
</li>
<li><p>uninitializePlugin</p>
</li>
</ul>
</li>
</ul>
<p>在这个案例中，我们会写一个插件，能够让一个小车（两个圆柱和一个平板组成），空间位置发生变化的时候，轮子也发生对应的旋转。<br>$$<br>rotate &#x3D; \frac{translate}{2\pi r}*(-360)<br>$$<br>Node Design</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220704102307567.png" alt="image-20220704102307567"></p>
<h4 id="4-3-完整流程"><a href="#4-3-完整流程" class="headerlink" title="4.3 完整流程"></a><strong>4.3 完整流程</strong></h4><p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220704112229490.png" alt="image-20220704112229490"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line">cmds.loadPlugin(<span class="string">r&quot;C:\Users\XZYW\文档\maya\2023\zh_CN\scripts\WheelNode.py&quot;</span>)</span><br><span class="line"></span><br><span class="line">cmds.createNode(<span class="string">&quot;WheelNode&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>来贴个官网上找到的案例</p>
<p><a target="_blank" rel="noopener" href="https://help.autodesk.com/view/MAYAUL/2023/CHS/?guid=Maya_SDK_py_ref_python_2api1_2py1_circle_node_8py_example_html">Maya 帮助 | Python API 2.0 Reference: python&#x2F;api1&#x2F;py1CircleNode.py | Autodesk</a></p>
<p><strong>完整代码</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-  </span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> maya.OpenMaya <span class="keyword">as</span> OpenMaya</span><br><span class="line"><span class="keyword">import</span> maya.OpenMayaMPx <span class="keyword">as</span> OpenMayaMPx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nodeName = <span class="string">&quot;WheelNode&quot;</span></span><br><span class="line">nodeId = OpenMaya.MTypeId(<span class="number">0x0008004c</span>)<span class="comment"># Id是唯一的，定义一个唯一的节点</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WheelNode</span>(OpenMayaMPx.MPxNode):<span class="comment"># 继承依赖关系图的类</span></span><br><span class="line">    inRadius = OpenMaya.MObject()<span class="comment"># 用于储存创建属性时mFn函数集返回的mObj</span></span><br><span class="line">    inTranslate = OpenMaya.MObject()</span><br><span class="line">    outRotate = OpenMaya.MObject()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        OpenMayaMPx.MPxNode.__init__(<span class="variable language_">self</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute</span>(<span class="params">self, plug, dataBlock</span>):<span class="comment"># 只要输入节点发生改变，maya就会调用compute函数,并且会</span></span><br><span class="line">                                      <span class="comment"># 发送outputNode,以及输入数据的数据块</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        rotate = translate / (2* 3.1416 * radius) * (-360)</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> plug == WheelNode.outRotate:<span class="comment"># 这个案例这里没用，但是对于多输出的复杂节点是需要的</span></span><br><span class="line">            dataHandleRadius = dataBlock.inputValue(WheelNode.inRadius)<span class="comment"># 这是一个返回的指针</span></span><br><span class="line">            dataHandleTranslate = dataBlock.inputValue(WheelNode.inTranslate)</span><br><span class="line">            </span><br><span class="line">            inRadiusVal = dataHandleRadius.asFloat()</span><br><span class="line">            inTranslateVal = dataHandleTranslate.asFloat()</span><br><span class="line">            outRotateVal = <span class="built_in">float</span>(inTranslateVal) / <span class="built_in">float</span>(<span class="number">2</span> * <span class="number">3.1416</span> * inRadiusVal) * (-<span class="number">360</span>)</span><br><span class="line">            </span><br><span class="line">            dataHandleRotate = dataBlock.outputValue(WheelNode.outRotate)</span><br><span class="line">            </span><br><span class="line">            dataHandleRotate.setFloat(outRotateVal)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 结束计算，设置clean</span></span><br><span class="line">            dataBlock.setClean(plug)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> OpenMaya.kUnknownParameter</span><br><span class="line">            </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nodeCreator</span>():</span><br><span class="line">    <span class="keyword">return</span> OpenMayaMPx.asMPxPtr(WheelNode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nodeInitializer</span>():</span><br><span class="line">    <span class="comment"># 1.创建一个Function set for numeric attribute</span></span><br><span class="line">    mFnAttr = OpenMaya.MFnNumericAttribute()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2.创建属性</span></span><br><span class="line">        <span class="comment"># Input Radius</span></span><br><span class="line">    WheelNode.inRadius = mFnAttr.create(<span class="string">&quot;radius&quot;</span>, <span class="string">&quot;r&quot;</span>,</span><br><span class="line">                   OpenMaya.MFnNumericData.kFloat, <span class="number">0.0</span>)<span class="comment"># longname, shortname,attrType,defaultValue</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># set properties</span></span><br><span class="line">    mFnAttr.setReadable(<span class="number">1</span>)<span class="comment"># bool</span></span><br><span class="line">    mFnAttr.setWritable(<span class="number">1</span>)</span><br><span class="line">    mFnAttr.setStorable(<span class="number">1</span>)</span><br><span class="line">    mFnAttr.setKeyable(<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># Input Translate</span></span><br><span class="line">    WheelNode.inTranslate = mFnAttr.create(<span class="string">&quot;translate&quot;</span>, <span class="string">&quot;t&quot;</span>,</span><br><span class="line">                   OpenMaya.MFnNumericData.kFloat, <span class="number">0.0</span>)</span><br><span class="line">    mFnAttr.setReadable(<span class="number">1</span>)<span class="comment"># bool</span></span><br><span class="line">    mFnAttr.setWritable(<span class="number">1</span>)</span><br><span class="line">    mFnAttr.setStorable(<span class="number">1</span>)</span><br><span class="line">    mFnAttr.setKeyable(<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># Output Rotation</span></span><br><span class="line">    WheelNode.outRotate = mFnAttr.create(<span class="string">&quot;rotate&quot;</span>, <span class="string">&quot;rot&quot;</span>,</span><br><span class="line">                   OpenMaya.MFnNumericData.kFloat)<span class="comment">#输出值是计算的，不用设默认值</span></span><br><span class="line">    mFnAttr.setReadable(<span class="number">1</span>)</span><br><span class="line">    mFnAttr.setWritable(<span class="number">0</span>)</span><br><span class="line">    mFnAttr.setStorable(<span class="number">0</span>)</span><br><span class="line">    mFnAttr.setKeyable(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3.attach Attribute to the Node</span></span><br><span class="line">    WheelNode.addAttribute(WheelNode.inRadius)</span><br><span class="line">    WheelNode.addAttribute(WheelNode.inTranslate)</span><br><span class="line">    WheelNode.addAttribute(WheelNode.outRotate)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4.Design the circuitry如何让maya知道节点之间的关系</span></span><br><span class="line">    WheelNode.attributeAffects(WheelNode.inRadius, WheelNode.outRotate)<span class="comment"># input,output</span></span><br><span class="line">    WheelNode.attributeAffects(WheelNode.inTranslate, WheelNode.outRotate)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># 初始化,和maya pluginCommand是一样的</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initializePlugin</span>(<span class="params">mobject</span>):</span><br><span class="line">    mplugin = OpenMayaMPx.MFnPlugin(mobject)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mplugin.registerNode(nodeName, nodeId, nodeCreator, nodeInitializer)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sys.stderr.write(<span class="string">&quot;Failed to register node:&quot;</span> + nodeName)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uninitializePlugin</span>(<span class="params">mobject</span>):</span><br><span class="line">    mplugin = OpenMayaMPx.MFnPlugin(mobject)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mplugin.deregisterNode(nodeId)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sys.stderr.write(<span class="string">&quot;Failed to deregister node&quot;</span> + nodeName)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/18/TA/Maya/Python%20For%20Maya%EF%BC%88OpenMaya%EF%BC%89%EF%BC%88%E4%BA%8C%EF%BC%89/" data-id="cmfe9guio0018ewuhbkqi7jj3" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Maya/" rel="tag">Maya</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Maya/Python For Maya（OpenMaya）（一）" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/18/TA/Maya/Python%20For%20Maya%EF%BC%88OpenMaya%EF%BC%89%EF%BC%88%E4%B8%80%EF%BC%89/">【笔记】【Maya工具】Python For Maya（OpenMaya）（一）API基础与插件</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/18/TA/Maya/Python%20For%20Maya%EF%BC%88OpenMaya%EF%BC%89%EF%BC%88%E4%B8%80%EF%BC%89/" class="article-date">
  <time datetime="2022-08-18T09:44:29.000Z" itemprop="datePublished">2022-08-18</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="Python-Programming-in-maya"><a href="#Python-Programming-in-maya" class="headerlink" title="Python Programming in maya"></a>Python Programming in maya</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.cmds <span class="keyword">as</span> cmd</span><br><span class="line">cmds.select(<span class="built_in">all</span>=<span class="literal">True</span>)</span><br><span class="line">cmds.delete()</span><br><span class="line"><span class="keyword">for</span> step <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    cmds.polyCube(w=<span class="number">10</span>,d=<span class="number">3</span>,h=<span class="number">0.5</span>)</span><br><span class="line">    cmds.move(<span class="number">3</span>,step*<span class="number">0.5</span>,<span class="number">0</span>)</span><br><span class="line">    cmds.xform(ws = <span class="literal">True</span>,rotatePivot=(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>))</span><br><span class="line">    cmds.rotate(<span class="number">0</span>,step*<span class="number">10</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-DAG——描述Maya中的功能节点："><a href="#1-DAG——描述Maya中的功能节点：" class="headerlink" title="1. DAG——描述Maya中的功能节点："></a><strong>1. DAG——描述Maya中的功能节点：</strong></h3><p>DAG（Directed Acyclic Graph有向无环图）</p>
<ul>
<li>Dag Node:Transform</li>
<li>Dag Node:Shape</li>
</ul>
<p>DG:Dependency Graph依赖图</p>
<p>DAG path，某个对象的DAG path描述从根节点到物体的完整查找路径</p>
<p>MObject（Model Object）</p>
<ul>
<li>maya.OpenMaya.MObject</li>
</ul>
<p>MSelectionList（选择的模型对象列表）</p>
<ul>
<li>maya.OpenMaya.MSelectionList<ul>
<li>创建一个选择列表</li>
<li>在选择列表中添加、移除对象</li>
<li>可遍历</li>
<li>etc</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.OpenMaya <span class="keyword">as</span> OpenMaya</span><br><span class="line">mSelectionList = OpenMaya.MSelectionList()</span><br><span class="line">mSelectionList.add(<span class="string">&quot;&lt;something_Name&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line">mDagPath = OpenMaya.MDagPath()</span><br><span class="line">mSelectionList.getDagPath(<span class="number">0</span>,mDagPath)<span class="comment">#返回0位置的path</span></span><br><span class="line"><span class="built_in">print</span>(mDagPath.fullPathName())</span><br><span class="line"></span><br><span class="line">mObj = OpenMaya.MObject()</span><br><span class="line">mSelectionList.getDependNode(<span class="number">0</span>,mObj)</span><br><span class="line"><span class="built_in">print</span>(mObj.apiTypeStr())<span class="comment">#kTransform</span></span><br></pre></td></tr></table></figure>



<h3 id="2-Traversing-Hyper-Graph-in-Maya-Scene"><a href="#2-Traversing-Hyper-Graph-in-Maya-Scene" class="headerlink" title="2. Traversing Hyper Graph in Maya Scene"></a><strong>2. Traversing Hyper Graph in Maya Scene</strong></h3><p>MFn &#x3D; Model Function Set</p>
<p>MFnMesh表示接收Mesh类型的函数集</p>
<ul>
<li>create</li>
<li>modify</li>
<li>retrave</li>
<li>add Edge\face,subdivision</li>
</ul>
<p>MFnDependencyNode：一组函数需要Dependency Node Type的数据，提供函数</p>
<ul>
<li>create（dependency graph）</li>
<li>modify（dependency graph）</li>
<li>retrave（dependency graph）</li>
</ul>
<p>可以通过MObj和MDagpath来提供到函数集的接口</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.OpenMaya <span class="keyword">as</span> OpenMaya</span><br><span class="line"><span class="comment"># Create a Selection List</span></span><br><span class="line">mSel = OpenMaya.MSelectionList()</span><br><span class="line">mSel.add(<span class="string">&quot;pPlane1&quot;</span>)</span><br><span class="line"><span class="comment"># Create MObject</span></span><br><span class="line">mObj = OpenMaya.MObject()</span><br><span class="line">mDagPath = OpenMaya.MDagPath()</span><br><span class="line"><span class="comment"># Request Dependency Node and DagPath of the Obj</span></span><br><span class="line">mSel.getDependNode(<span class="number">0</span>,mObj)</span><br><span class="line">mSel.getDagPath(<span class="number">0</span>,mDagPath)</span><br><span class="line"><span class="comment"># Create Mesh function set</span></span><br><span class="line">mFnMesh = OpenMaya.MFnMesh(mDagPath)<span class="comment">#可以用mObj和mDagpath两种</span></span><br><span class="line"><span class="built_in">print</span>(mFnMesh.fullPathName())<span class="comment">#|pPlane1|pPlaneShape1</span></span><br><span class="line"><span class="comment">#说明mFnMesh是在ShapeNode下运作的</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Dependency function set</span></span><br><span class="line">mFnDependNode = OpenMaya.MFnDependencyNode(mObj)<span class="comment">#只能用mObj</span></span><br><span class="line"><span class="built_in">print</span>(mFnDependNode.name())</span><br></pre></td></tr></table></figure>

<p>MPlug提供操作功能的类（操作Plug Type）</p>
<p>Plug：节点属性的接口</p>
<ul>
<li>create</li>
<li>modify</li>
<li>access（通过plug访问属性）</li>
</ul>
<ol>
<li><p>Network Plug: Dependency Node Plug</p>
</li>
<li><p>Non-Network Plug: User Defined Plug</p>
</li>
</ol>
<p>MPlugArray</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220627211430302.png" alt="image-20220627211430302" style="zoom: 33%;" />



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Get all the connections of a Shape node</span></span><br><span class="line">mPlugArray = OpenMaya.MPlugArray()</span><br><span class="line">mFnMesh.getConnections(mPlugArray)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(mPlugArray.length())<span class="comment">#2</span></span><br><span class="line"><span class="built_in">print</span>(mPlugArray[<span class="number">0</span>].name())<span class="comment">#pPlaneShape1.instObjGroups[0]</span></span><br><span class="line"><span class="built_in">print</span>(mPlugArray[<span class="number">1</span>].name())<span class="comment">#pPlaneShape1.inMesh</span></span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220627212637049.png" alt="image-20220627212637049" style="zoom: 33%;" />

<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220627212705325.png" alt="image-20220627212705325" style="zoom:33%;" />

<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220627213320170.png" alt="image-20220627213320170"></p>
<p>看看这个就知道是在干嘛了，我们的最终目的是操纵polyPlane1进行细分</p>
<p>通过pPlaneShape1的plug接口，就可以完成</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mPlugArray2 = OpenMaya.MPlugArray()</span><br><span class="line">mPlugArray[<span class="number">1</span>].connectedTo(mPlugArray2,<span class="literal">True</span>,<span class="literal">False</span>)<span class="comment">#后面这两个bool值不太明白</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(mPlugArray2.length())<span class="comment">#1</span></span><br><span class="line"><span class="comment">#len()不能用在这个对象上</span></span><br><span class="line"><span class="built_in">print</span>(mPlugArray2[<span class="number">0</span>].name())<span class="comment">#polyPlane1.output</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220627214040508.png" alt="image-20220627214040508"></p>
<p>完整代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.OpenMaya <span class="keyword">as</span> OpenMaya</span><br><span class="line"><span class="comment"># Create a Selection List</span></span><br><span class="line">mSel = OpenMaya.MSelectionList()</span><br><span class="line">mSel.add(<span class="string">&quot;pPlane1&quot;</span>)</span><br><span class="line"><span class="comment"># Create MObject</span></span><br><span class="line">mObj = OpenMaya.MObject()</span><br><span class="line">mDagPath = OpenMaya.MDagPath()</span><br><span class="line"><span class="comment"># Request Dependency Node and DagPath of the Obj</span></span><br><span class="line">mSel.getDependNode(<span class="number">0</span>,mObj)</span><br><span class="line">mSel.getDagPath(<span class="number">0</span>,mDagPath)</span><br><span class="line"><span class="comment"># Create Mesh function set</span></span><br><span class="line">mFnMesh = OpenMaya.MFnMesh(mDagPath)<span class="comment">#可以用mObj和mDagpath两种</span></span><br><span class="line"><span class="built_in">print</span>(mFnMesh.fullPathName())<span class="comment">#|pPlane1|pPlaneShape1</span></span><br><span class="line"><span class="comment">#说明mFnMesh是在ShapeNode下运作的</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Dependency function set</span></span><br><span class="line">mFnDependNode = OpenMaya.MFnDependencyNode(mObj)<span class="comment">#只能用mObj</span></span><br><span class="line"><span class="built_in">print</span>(mFnDependNode.name())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get all the connections of a Shape node</span></span><br><span class="line">mPlugArray = OpenMaya.MPlugArray()</span><br><span class="line">mFnMesh.getConnections(mPlugArray)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(mPlugArray.length())</span><br><span class="line"><span class="built_in">print</span>(mPlugArray[<span class="number">0</span>].name())</span><br><span class="line"><span class="built_in">print</span>(mPlugArray[<span class="number">1</span>].name())</span><br><span class="line"></span><br><span class="line">mPlugArray2 = OpenMaya.MPlugArray()</span><br><span class="line">mPlugArray[<span class="number">1</span>].connectedTo(mPlugArray2,<span class="literal">True</span>,<span class="literal">False</span>)<span class="comment">#后面这两个bool值不太明白</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(mPlugArray2.length())<span class="comment">#len()不能用在这个对象上</span></span><br><span class="line"><span class="built_in">print</span>(mPlugArray2[<span class="number">0</span>].name())</span><br><span class="line"></span><br><span class="line">mObj2 = mPlugArray2[<span class="number">0</span>].node()</span><br><span class="line">mFnDependNode2 = OpenMaya.MFnDependencyNode(mObj2)</span><br><span class="line"><span class="built_in">print</span>(mFnDependNode2.name())</span><br><span class="line"></span><br><span class="line">mPlug_width = mFnDependNode2.findPlug(<span class="string">&quot;width&quot;</span>)</span><br><span class="line">mPlug_height = mFnDependNode2.findPlug(<span class="string">&quot;height&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(mPlug_width.asInt(),mPlug_height.asInt())</span><br><span class="line"></span><br><span class="line">mPlug_subWidth = mFnDependNode2.findPlug(<span class="string">&quot;subdivisionsWidth&quot;</span>)</span><br><span class="line">mPlug_subHeight = mFnDependNode2.findPlug(<span class="string">&quot;subdivisionsHeight&quot;</span>)</span><br><span class="line"></span><br><span class="line">mPlug_subWidth.setInt(<span class="number">20</span>)</span><br><span class="line">mPlug_subHeight.setInt(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="3-Command-Communication-Flow"><a href="#3-Command-Communication-Flow" class="headerlink" title="3. Command Communication Flow"></a><strong>3. Command Communication Flow</strong></h3><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220627220119395.png" alt="image-20220627220119395" style="zoom:50%;" />

<ul>
<li>Command Plugin<ul>
<li>函数</li>
<li>初始化&#x2F;注册Initialization，Registration</li>
<li>Uninitialization&#x2F;De-registration</li>
</ul>
</li>
</ul>
<p>把东西注入到Maya core，就是注册</p>
<ul>
<li>命令插件编写基本流程<ul>
<li>定义一个类</li>
<li>创建一个实例</li>
<li>用一个指针指向这个实例</li>
<li>Maya获取这个指针</li>
</ul>
</li>
</ul>
<h3 id="4-Writing-command-plugin"><a href="#4-Writing-command-plugin" class="headerlink" title="4. Writing command plugin"></a><strong>4. Writing command plugin</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.OpenMaya <span class="keyword">as</span> OpenMaya</span><br><span class="line"><span class="keyword">import</span> maya.OpenMayaMPx <span class="keyword">as</span> OpenMayaMPx</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">commandName = <span class="string">&quot;pluginCommand&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">pluginCommand</span>(OpenMayaMPx.MPxCommand):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        OpenMayaMPx.MPxCommand.__init__(<span class="variable language_">self</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">doIt</span>(<span class="params">self,argList</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;doIt&quot;</span>)</span><br><span class="line"><span class="comment">#创建实例并添加指针</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmdCreator</span>():</span><br><span class="line">    <span class="keyword">return</span> OpenMayaMPx.asMPxPtr(pluginCommand())</span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initializePlugin</span>(<span class="params">mobject</span>):</span><br><span class="line">    mplugin = OpenMayaMPx.MFnPlugin(mobject)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mplugin.registerCommand(commandName,cmdCreator)<span class="comment">#mayaCore handle</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sys.stderr.write(<span class="string">&quot;Failed to register command:&quot;</span> + commandName)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uninitializePlugin</span>(<span class="params">mobject</span>):</span><br><span class="line">    mplugin = OpenMayaMPx.MFnPlugin(mobject)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mplugin.deregisterCommand(commandName)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sys.stderr.write(<span class="string">&quot;Failed to deregister command&quot;</span> + commandName)</span><br></pre></td></tr></table></figure>

<p>保存脚本后，在maya中加载插件</p>
<p>Mel，python，mayaUI三种方法</p>
<p>window-setting preferences-pluginManager</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220627222747095.png" alt="image-20220627222747095"></p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220627222850467.png" alt="image-20220627222850467"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmds.loadPlugin(&quot;./pluginCommand.py&quot;)</span><br></pre></td></tr></table></figure>



<h3 id="5-Maya-API-Iterators"><a href="#5-Maya-API-Iterators" class="headerlink" title="5. Maya API Iterators"></a><strong>5. Maya API Iterators</strong></h3><p>Iterator是一个对象，对数据结构进行遍历</p>
<ul>
<li>MItDag<ul>
<li>Dag上的iterator</li>
<li>深度优先</li>
<li>广度优先</li>
</ul>
</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220627230758404.png" alt="image-20220627230758404" style="zoom:50%;" />



<ul>
<li>MItDependencyGraph</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220627230836150.png" alt="image-20220627230836150" style="zoom:50%;" />

<ul>
<li>MItMeshEdge</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220627230927076.png" alt="image-20220627230927076" style="zoom:50%;" />

<ul>
<li>MItMeshVertex</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220627231006974.png" alt="image-20220627231006974" style="zoom:50%;" />

<ul>
<li>MItMeshPolygon(face)</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220627231033010.png" alt="image-20220627231033010" style="zoom:50%;" />

<ul>
<li>MItSurfaceCV(CVs of Nurbs)</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220627231104357.png" alt="image-20220627231104357" style="zoom:50%;" />

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.OpenMaya <span class="keyword">as</span> OpenMaya</span><br><span class="line"></span><br><span class="line">dagIterator = OpenMaya.MItDag(OpenMaya.MItDag.kDepthFirst, OpenMaya.MFn.kInvalid)<span class="comment">#arg1=树搜索算法,arg2 = Filtering</span></span><br><span class="line">dagNodeFn = OpenMaya.MFnDagNode()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">not</span> dagIterator.isDone()):</span><br><span class="line">    currentObj = dagIterator.currentItem()<span class="comment">#return dagNode</span></span><br><span class="line">    depth = dagIterator.depth()</span><br><span class="line">    dagNodeFn.setObject(currentObj)</span><br><span class="line">    </span><br><span class="line">    name = dagNodeFn.name()</span><br><span class="line">    <span class="built_in">type</span> = currentObj.apiTypeStr()</span><br><span class="line">    path = dagNodeFn.fullPathName()</span><br><span class="line">    </span><br><span class="line">    printOut = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,depth):</span><br><span class="line">        printOut += <span class="string">&quot;-----&gt;&quot;</span></span><br><span class="line">    printOut += name + <span class="string">&quot; : &quot;</span> + <span class="built_in">type</span></span><br><span class="line">    <span class="built_in">print</span>(printOut)</span><br><span class="line">    dagIterator.<span class="built_in">next</span>()</span><br><span class="line">    </span><br><span class="line">===========</span><br><span class="line">World : kWorld</span><br><span class="line">-----&gt;persp : kTransform</span><br><span class="line">-----&gt;-----&gt;perspShape : kCamera</span><br><span class="line">-----&gt;top : kTransform</span><br><span class="line">-----&gt;-----&gt;topShape : kCamera</span><br><span class="line">-----&gt;front : kTransform</span><br><span class="line">-----&gt;-----&gt;frontShape : kCamera</span><br><span class="line">-----&gt;side : kTransform</span><br><span class="line">-----&gt;-----&gt;sideShape : kCamera</span><br><span class="line">-----&gt;pCube1 : kTransform</span><br><span class="line">-----&gt;-----&gt;pCubeShape1 : kMesh</span><br><span class="line">-----&gt;-----&gt;pCylinder1 : kTransform</span><br><span class="line">-----&gt;-----&gt;-----&gt;pCylinderShape1 : kMesh</span><br><span class="line">-----&gt;-----&gt;-----&gt;pCone1 : kTransform</span><br><span class="line">-----&gt;-----&gt;-----&gt;-----&gt;pConeShape1 : kMesh</span><br><span class="line">-----&gt;-----&gt;-----&gt;-----&gt;pPlane1 : kTransform</span><br><span class="line">-----&gt;-----&gt;-----&gt;-----&gt;-----&gt;pPlaneShape1 : kMesh</span><br><span class="line">-----&gt;-----&gt;-----&gt;-----&gt;-----&gt;pPipe1 : kTransform</span><br><span class="line">-----&gt;-----&gt;-----&gt;-----&gt;-----&gt;-----&gt;pPipeShape1 : kMesh</span><br></pre></td></tr></table></figure>

<p>放到插件的doIt方法里面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.OpenMaya <span class="keyword">as</span> OpenMaya</span><br><span class="line"><span class="keyword">import</span> maya.OpenMayaMPx <span class="keyword">as</span> OpenMayaMPx</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">commandName = <span class="string">&quot;printHierarchy&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">pluginCommand</span>(OpenMayaMPx.MPxCommand):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        OpenMayaMPx.MPxCommand.__init__(<span class="variable language_">self</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">doIt</span>(<span class="params">self,argList</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Scene Heirarchy&quot;</span>)</span><br><span class="line">        dagIterator = OpenMaya.MItDag(OpenMaya.MItDag.kDepthFirst, OpenMaya.MFn.kInvalid)<span class="comment">#arg1=树搜索算法,arg2 = Filtering</span></span><br><span class="line">        dagNodeFn = OpenMaya.MFnDagNode()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">not</span> dagIterator.isDone()):</span><br><span class="line">            currentObj = dagIterator.currentItem()<span class="comment">#return dagNode</span></span><br><span class="line">            depth = dagIterator.depth()</span><br><span class="line">            dagNodeFn.setObject(currentObj)</span><br><span class="line">            </span><br><span class="line">            name = dagNodeFn.name()</span><br><span class="line">            <span class="built_in">type</span> = currentObj.apiTypeStr()</span><br><span class="line">            path = dagNodeFn.fullPathName()</span><br><span class="line">            </span><br><span class="line">            printOut = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,depth):</span><br><span class="line">                printOut += <span class="string">&quot;-----&gt;&quot;</span></span><br><span class="line">            printOut += name + <span class="string">&quot; : &quot;</span> + <span class="built_in">type</span></span><br><span class="line">            <span class="built_in">print</span>(printOut)</span><br><span class="line">            dagIterator.<span class="built_in">next</span>()</span><br><span class="line"><span class="comment">#创建实例并添加指针</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmdCreator</span>():</span><br><span class="line">    <span class="keyword">return</span> OpenMayaMPx.asMPxPtr(pluginCommand())</span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initializePlugin</span>(<span class="params">mobject</span>):</span><br><span class="line">    mplugin = OpenMayaMPx.MFnPlugin(mobject)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mplugin.registerCommand(commandName,cmdCreator)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sys.stderr.write(<span class="string">&quot;Failed to register command:&quot;</span> + commandName)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uninitializePlugin</span>(<span class="params">mobject</span>):</span><br><span class="line">    mplugin = OpenMayaMPx.MFnPlugin(mobject)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mplugin.deregisterCommand(commandName)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sys.stderr.write(<span class="string">&quot;Failed to deregister command&quot;</span> + commandName)</span><br></pre></td></tr></table></figure>

<p>保存脚本然后</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.cmds <span class="keyword">as</span> cmds</span><br><span class="line">cmds.loadPlugin(<span class="string">&quot;c:\\Users\\XZYW\\Desktop\\printHierarchy.py&quot;</span>)</span><br><span class="line">cmds.printHierarchy()</span><br></pre></td></tr></table></figure>

<p>插件就可用了，这就是编写插件的方式。</p>
<h3 id="6-Command-with-Arguments"><a href="#6-Command-with-Arguments" class="headerlink" title="6. Command with Arguments"></a><strong>6. Command with Arguments</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmds.polySphere(<span class="string">&quot;mySphere&quot;</span>,q = <span class="literal">True</span>,sx = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220628205624179.png" alt="image-20220628205624179"></p>
<ul>
<li>MSyntax<ul>
<li>flags</li>
<li>Args</li>
<li>Object</li>
</ul>
</li>
<li>MArgDatabase<ul>
<li>是MArgParser的派生类</li>
<li>Parsing</li>
<li>Storing</li>
<li>Retreving</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.OpenMaya <span class="keyword">as</span> OpenMaya</span><br><span class="line"><span class="keyword">import</span> maya.OpenMayaMPx <span class="keyword">as</span> OpenMayaMPx</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> maya.OpenMayaFX <span class="keyword">as</span> OpenMayaFX</span><br><span class="line"><span class="comment">#使用粒子系统</span></span><br><span class="line"></span><br><span class="line">commandName = <span class="string">&quot;vertexParticle&quot;</span></span><br><span class="line">kHelpFlag = <span class="string">&quot;-h&quot;</span></span><br><span class="line">kHelpLongFlag = <span class="string">&quot;-help&quot;</span></span><br><span class="line">kSparseFlag = <span class="string">&quot;-s&quot;</span></span><br><span class="line">kSparseLongFlag = <span class="string">&quot;-sparse&quot;</span></span><br><span class="line">helpMessage = <span class="string">&quot;This command is used to attach a particle on each Vertex of a poly mesh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">pluginCommand</span>(OpenMayaMPx.MPxCommand):</span><br><span class="line">    sparse = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        OpenMayaMPx.MPxCommand.__init__(<span class="variable language_">self</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">argumentParser</span>(<span class="params">self,argList</span>):</span><br><span class="line">        syntax = <span class="variable language_">self</span>.syntax()<span class="comment">#MSyntax Object</span></span><br><span class="line">        parsedArguments = OpenMaya.MArgDatabase(syntax,argList)</span><br><span class="line">        <span class="keyword">if</span> parsedArguments.isFlagSet(kSparseFlag):</span><br><span class="line">            <span class="variable language_">self</span>.sparse = parsedArguments.flagArgumentDouble(kSparseFlag,<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> parsedArguments.isFlagSet(kSparseLongFlag):</span><br><span class="line">            <span class="variable language_">self</span>.sparse = parsedArguments.flagArgumentDouble(kSparseLongFlag,<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> parsedArguments.isFlagSet(kHelpFlag):</span><br><span class="line">            <span class="variable language_">self</span>.setResult(helpMessage)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> parsedArguments.isFlagSet(kHelpLongFlag):</span><br><span class="line">            <span class="variable language_">self</span>.setResult(helpMessage)</span><br><span class="line">            <span class="keyword">return</span><span class="comment"># OpenMaya.MStatus.kSuccess这个方法已经被取消了，其实不用返回任何东西</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">isUndoable</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">undoIt</span>(<span class="params">self</span>):</span><br><span class="line">    	<span class="built_in">print</span>(<span class="string">&quot;Undo&quot;</span>)</span><br><span class="line">        mFnDagNode = OpenMaya.MFnDagNode(<span class="variable language_">self</span>.mObj_particle)</span><br><span class="line">        </span><br><span class="line">        mDagMod = OpenMaya.MDagModifier()</span><br><span class="line">        mDagMod.deleteNode(mFnDagNode.parent(<span class="number">0</span>))<span class="comment">#粒子系统创建是带有Transform的</span></span><br><span class="line">        </span><br><span class="line">        mDagMod.doIt()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">redoIt</span>(<span class="params">self</span>):</span><br><span class="line">        mSel = OpenMaya.MSelectionList()</span><br><span class="line">        mDagPath = OpenMaya.MDagPath()</span><br><span class="line">        mFnMesh = OpenMaya.MFnMesh()</span><br><span class="line">        OpenMaya.MGlobal.getActiveSelectionList(mSel)<span class="comment">#处理所有主动选择的对象，并添加到提供的选择列表中</span></span><br><span class="line">        <span class="keyword">if</span> mSel.length() &gt;=<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                mSel.getDagPath(<span class="number">0</span>,mDagPath)</span><br><span class="line">                mFnMesh.setObject(mDagPath)</span><br><span class="line">            <span class="keyword">except</span>:<span class="comment">#如果选中的不是polymesh</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Select a poly mesh&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span>:<span class="comment">#如果没选东西</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Select a poly mesh&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        mPointArray = OpenMaya.MPointArray()</span><br><span class="line">        mFnMesh.getPoints(mPointArray, OpenMaya.MSpace.kWorld)<span class="comment">#提供所有顶点世界坐标</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># create a particle system</span></span><br><span class="line">        mFnParticle = OpenMayaFX.MFnParticleSystem()</span><br><span class="line">        <span class="variable language_">self</span>.mObj_particle = mFnParticle.create()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Fix Maya Bug</span></span><br><span class="line">        mFnParticle = OpenMayaFX.MFnParticleSystem(<span class="variable language_">self</span>.mObj_particle)</span><br><span class="line">        </span><br><span class="line">        counter = <span class="number">0</span></span><br><span class="line">        <span class="comment"># attach particle to vertex</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(mPointArray.length()):</span><br><span class="line">            <span class="keyword">if</span> i%<span class="variable language_">self</span>.sparse == <span class="number">0</span>:</span><br><span class="line">                mFnParticle.emit(mPointArray[i])</span><br><span class="line">                counter += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Total Points:&quot;</span> + <span class="built_in">str</span>(counter))</span><br><span class="line">        mFnParticle.saveInitialState()<span class="comment">#如果应用动力学，确保粒子在原来位置上去应用</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">doIt</span>(<span class="params">self,argList</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;doIt&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.argumentParser(argList)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.sparse != <span class="literal">None</span>:</span><br><span class="line">            <span class="variable language_">self</span>.redoIt()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">#创建实例并添加指针</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmdCreator</span>():</span><br><span class="line">    <span class="keyword">return</span> OpenMayaMPx.asMPxPtr(pluginCommand())</span><br><span class="line"><span class="comment">#创建命令语法</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">syntaxCreator</span>():</span><br><span class="line">    <span class="comment"># create MSyntax object</span></span><br><span class="line">    syntax = OpenMaya.MSyntax()</span><br><span class="line">    <span class="comment"># collect/add the flags</span></span><br><span class="line">    syntax.addFlag(kHelpFlag,kHelpLongFlag)<span class="comment">#short name,long name,data type</span></span><br><span class="line">    syntax.addFlag(kSparseFlag,kSparseLongFlag,OpenMaya.MSyntax.kDouble)</span><br><span class="line">    <span class="comment"># return MSyntax</span></span><br><span class="line">    <span class="keyword">return</span> syntax</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initializePlugin</span>(<span class="params">mobject</span>):</span><br><span class="line">    mplugin = OpenMayaMPx.MFnPlugin(mobject)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mplugin.registerCommand(commandName,cmdCreator,syntaxCreator)<span class="comment">#同时注册语法</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sys.stderr.write(<span class="string">&quot;Failed to register command:&quot;</span> + commandName)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uninitializePlugin</span>(<span class="params">mobject</span>):</span><br><span class="line">    mplugin = OpenMayaMPx.MFnPlugin(mobject)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mplugin.deregisterCommand(commandName)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sys.stderr.write(<span class="string">&quot;Failed to deregister command&quot;</span> + commandName)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">range 是生成一个列表</span><br><span class="line">xrange用法与range完全相同，不同的是生成的不是一个list对象，而是一个生成器</span><br><span class="line">在生成很大的数字序列时候，用xrange会比range性能优很多，因为不需要一上来就开辟一块很大的内存空间</span><br><span class="line">xrange和range都在循环的时候使用。</span><br></pre></td></tr></table></figure>



<ul>
<li>Command Execution</li>
<li>Undo</li>
<li>Redo</li>
</ul>
<p>每执行一个Command Execution，都会把对应的命令添加到Undo队列</p>
<p>如果Command Execution使用Undo命令，就会把Undo队列中最后面的移到Redo队列上</p>
<p>如果Command Execution使用Redo命令，就会把Redo队列中最后面的移到Undo队列上</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220628211342017.png" alt="image-20220628211342017" style="zoom:50%;" />

<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220628213019559.png" alt="image-20220628213019559"></p>
<p>好了，写完了这个脚本，看完这集教程，终于发现，它是过时的版本，作者用的还是maya2013，非常恐怖</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/18/TA/Maya/Python%20For%20Maya%EF%BC%88OpenMaya%EF%BC%89%EF%BC%88%E4%B8%80%EF%BC%89/" data-id="cmfe9guip001gewuh314dbvsk" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Maya/" rel="tag">Maya</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/OpenGL/C++ learning_03" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/18/TA/OpenGL/C++%20learning_03/">【笔记】Cherno C++ Tutorial note 03</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/18/TA/OpenGL/C++%20learning_03/" class="article-date">
  <time datetime="2022-08-18T09:31:33.000Z" itemprop="datePublished">2022-08-18</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h3 id="Templates模板"><a href="#Templates模板" class="headerlink" title="Templates模板"></a><strong>Templates模板</strong></h3><p>模板就像一个蓝图</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Print</span><span class="params">(<span class="type">int</span> value)</span> </span>&#123;</span><br><span class="line">	std::cout&lt;&lt;value&lt;&lt;std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Print</span><span class="params">(std::string value)</span> </span>&#123;</span><br><span class="line">	std::cout&lt;&lt;value&lt;&lt;std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">print</span>(<span class="number">5</span>)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;Hellow&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">5.0f</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种不断重复重载的函数可以用一个函数包裹，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Print</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">	std::cout&lt;&lt;value&lt;&lt;std::endl;</span><br><span class="line">&#125;<span class="comment">//这个函数是一个模板，只有当调用时，它才创建一个对应的函数</span></span><br><span class="line"><span class="comment">//它不参与编译，只有它创建的函数才参与编译</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">print</span>(<span class="number">5</span>)</span><br><span class="line">    <span class="built_in">print</span>&lt;<span class="type">int</span>&gt;(<span class="number">5</span>)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;Hellow&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">5.0f</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c++的标准模板库STL就是templates</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="type">int</span> N&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Array</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T m_Array[N];</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">GetSize</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> N;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Array&lt;<span class="type">int</span>,<span class="number">5</span>&gt; array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Stack-vs-Heap-Memory堆内存与栈内存"><a href="#Stack-vs-Heap-Memory堆内存与栈内存" class="headerlink" title="Stack vs Heap Memory堆内存与栈内存"></a><strong>Stack vs Heap Memory堆内存与栈内存</strong></h3><p>stack和heap地址都是RAM上的两部分区域</p>
<p>stack定好了区域大小 2MegaBytes</p>
<p>heap的大小是动态改变的</p>
<p>区别在于他们如何分配内存</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Vector3</span> &#123;</span><br><span class="line">    <span class="type">float</span> x,y,z;</span><br><span class="line">    <span class="built_in">Vector3</span>()</span><br><span class="line">        : <span class="built_in">x</span>(<span class="number">10</span>),<span class="built_in">y</span>(<span class="number">5</span>),<span class="built_in">z</span>(<span class="number">1</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//stack分配</span></span><br><span class="line">    <span class="type">int</span> value = <span class="number">5</span>;</span><br><span class="line">    <span class="type">int</span> array[<span class="number">5</span>];</span><br><span class="line">    array[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    array[<span class="number">1</span>] = <span class="number">2</span>;</span><br><span class="line">    array[<span class="number">2</span>] = <span class="number">3</span>;</span><br><span class="line">    array[<span class="number">3</span>] = <span class="number">4</span>;</span><br><span class="line">    array[<span class="number">4</span>] = <span class="number">5</span>;</span><br><span class="line">    Vector3 vector;</span><br><span class="line">    <span class="comment">//观察内存可以发现，stack所有的分配，都在stack的指针位置进行，分配出多少，stack指针就往后移多少，并返回这个指针</span></span><br><span class="line">    <span class="comment">//scope结束，栈内存销毁</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//heap分配</span></span><br><span class="line">    <span class="type">int</span>* hvalue = <span class="keyword">new</span> <span class="type">int</span>;</span><br><span class="line">    *hvalue = <span class="number">5</span>;</span><br><span class="line">    <span class="type">int</span>* harray = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">5</span>];</span><br><span class="line">    harray[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    harray[<span class="number">1</span>] = <span class="number">2</span>;</span><br><span class="line">    harray[<span class="number">2</span>] = <span class="number">3</span>;</span><br><span class="line">    harray[<span class="number">3</span>] = <span class="number">4</span>;</span><br><span class="line">    harray[<span class="number">4</span>] = <span class="number">5</span>;</span><br><span class="line">    Vector3* hvector = <span class="keyword">new</span> <span class="built_in">Vector3</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">delete</span> havlue;</span><br><span class="line">    <span class="keyword">delete</span>[] harray;</span><br><span class="line">    <span class="keyword">delete</span> hvector;</span><br><span class="line">    <span class="comment">//heap分配</span></span><br><span class="line">    <span class="comment">//new其实就是调用malloc</span></span><br><span class="line">    <span class="comment">//当malloc分配内存时，会根据所需要的内存大小，在内存上寻找足够的一块大小的位置分配，并提供这个地址的指针</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用堆分配可能造成Cache Miss缓存丢失，少数的缓存丢失没有影响</p>
<p>堆栈分配最大的区别就是在分配方式上。</p>
<p>堆分配会更慢。</p>
<p>只有无法在栈上分配，如需要更多的生命周期、更大的数据，再使用堆分配，一般没事最好栈分配，毕竟快很多。</p>
<p>（所以内存碎片大概就是指堆上各个内存之间存在的小间隙？）</p>
<h3 id="Macros宏指令"><a href="#Macros宏指令" class="headerlink" title="Macros宏指令"></a><strong>Macros宏指令</strong></h3><p>预处理过程的宏</p>
<p>编译C++时</p>
<ul>
<li>首先是预处理pass<ul>
<li>带#符号的语句</li>
<li>实际是文本编辑阶段，进行文本替换</li>
<li>控制哪些程序语句进入编译器</li>
</ul>
</li>
</ul>
<p>并不是总是要用宏</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WAIT std::cin.get()<span class="comment">//只在当前文档中生效</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG(x) std::cout&lt;&lt; x &lt;&lt; std::endl</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG</span>(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">    WAIT;<span class="comment">// 根据define进行文本替换</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你可以在项目设置的预处理命令看到一些定义</p>
<p>Debug </p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220701143548474.png" alt="image-20220701143548474"></p>
<p>Release</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220701143602730.png" alt="image-20220701143602730"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WAIT std::cin.get()</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _DEBUG<span class="comment">//也可以在预处理命令上赋值，#ifdef _DEBUG == 1,</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG(x) std::cout&lt;&lt; x &lt;&lt; std::endl</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span><span class="comment">//也有elif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG(x)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAIN int main() \<span class="comment">//反斜杠可以在宏命令中换行</span></span></span><br><span class="line">&#123;\</span><br><span class="line">	std::cin.<span class="built_in">get</span>();\</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//这样只有debug模式才会log</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG</span>(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">    WAIT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="待补充："><a href="#待补充：" class="headerlink" title="待补充："></a><strong>待补充：</strong></h3><h3 id="auto关键字"><a href="#auto关键字" class="headerlink" title="auto关键字"></a>auto关键字</h3><h3 id="Static-Arrays（std-array）静态数组"><a href="#Static-Arrays（std-array）静态数组" class="headerlink" title="Static Arrays（std::array）静态数组"></a>Static Arrays（std::array）静态数组</h3><h3 id="Functions-Pointers函数指针"><a href="#Functions-Pointers函数指针" class="headerlink" title="Functions Pointers函数指针"></a>Functions Pointers函数指针</h3><h3 id="Lambdas"><a href="#Lambdas" class="headerlink" title="Lambdas"></a>Lambdas</h3><h3 id="using-namespace-std"><a href="#using-namespace-std" class="headerlink" title="using namespace std"></a>using namespace std</h3><h3 id="Namespaces命名空间"><a href="#Namespaces命名空间" class="headerlink" title="Namespaces命名空间"></a>Namespaces命名空间</h3><h3 id="Threads线程"><a href="#Threads线程" class="headerlink" title="Threads线程"></a>Threads线程</h3><h3 id="Timing计时器"><a href="#Timing计时器" class="headerlink" title="Timing计时器"></a>Timing计时器</h3><h3 id="Multidimensional-Arrays（2D-arrays）多维数组"><a href="#Multidimensional-Arrays（2D-arrays）多维数组" class="headerlink" title="Multidimensional Arrays（2D arrays）多维数组"></a>Multidimensional Arrays（2D arrays）多维数组</h3><h3 id="Sorting"><a href="#Sorting" class="headerlink" title="Sorting"></a>Sorting</h3><h3 id="Type-Punning类型双关"><a href="#Type-Punning类型双关" class="headerlink" title="Type Punning类型双关"></a>Type Punning类型双关</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/18/TA/OpenGL/C++%20learning_03/" data-id="cmfe9guis001zewuh6rmn23b9" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
  </article>
  

  
  <nav class="page-nav">
    <a class="extend prev" rel="prev" href="/page/2/">Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/">Next</a>
  </nav>
  
</section>
</div>
    <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>XZYW7&#39;s Blog &copy; 2025</li>
      
        <li>
          
            <a href="https://beian.miit.gov.cn/" target="_blank"></a>
            
        </li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
    <p><ul class="list-inline">
  
  <li><i class="fe fe-bar-chart tooltip" data-tooltip="PV"></i> <span id="busuanzi_value_site_pv"></span></li>
  
  <li><i class="fe fe-smile-alt tooltip" data-tooltip="UV"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul></p>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="XZYW7&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">Home</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">Gallery</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">About</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">Archives</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>






<script src="/js/ocean.js"></script>

</body>

</html>