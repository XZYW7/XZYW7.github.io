<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <title>
    
    XZYW7&#39;s Blog
  </title>
  <!-- Icon -->
  
    <link rel="shortcut icon" href="/favicon.ico">
    
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <main class="content">
    <section class="jumbotron">
  <div class="video">
    
    <div class="video-frame">
      <img src="/images/ocean/overlay-hero.png" alt="Decorative image frame">
    </div>
    
    <div class="video-media">
      <video playsinline="" autoplay="" loop="" muted="" data-autoplay="" poster="/images/ocean/ocean.png"
        x5-video-player-type="h5">
        <source src="/images/ocean/ocean.mp4" type="video/mp4">
        <source src="/images/ocean/ocean.ogv" type="video/ogg">
        <source src="/images/ocean/ocean.webm" type="video/webm">
        <p>Your user agent does not support the HTML5 Video element.</p>
      </video>
      <div class="video-overlay"></div>
    </div>
    <div class="video-inner text-center text-white">
      <h1><a href="/">XZYW7&#39;s Blog</a></h1>
      <p></p>
      <div><img src="/images/hexo-inverted.svg" class="brand" alt="XZYW7&#39;s Blog"></div>
    </div>
    <div class="video-learn-more">
      <a class="anchor" href="#landingpage"><i class="fe fe-mouse"></i></a>
    </div>
  </div>
</section>
<div id="landingpage">
  <section class="outer">
  <article class="articles">
    
    <h1 class="page-type-title"></h1>
    
    
    <article id="post-TA/Maya/cmds（四）" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/18/TA/Maya/cmds%EF%BC%88%E5%9B%9B%EF%BC%89/">【笔记】【Maya工具】Python For Maya（Cmds）（四）Controller Library &amp; LightManager</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/18/TA/Maya/cmds%EF%BC%88%E5%9B%9B%EF%BC%89/" class="article-date">
  <time datetime="2022-08-18T09:27:08.000Z" itemprop="datePublished">2022-08-18</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="一、Controller-Library"><a href="#一、Controller-Library" class="headerlink" title="一、Controller Library"></a><strong>一、Controller Library</strong></h2><h3 id="1-1-Qt-Environment"><a href="#1-1-Qt-Environment" class="headerlink" title="1.1 Qt Environment"></a><strong>1.1 Qt Environment</strong></h3><p>使用QT创建controller lib</p>
<p>和Maya cmdsUi相比，更推荐使用qt</p>
<p>CMDS是为MEL设计的，UI函数只有qt的一小部分</p>
<p>直接(mayapy -m )pip install Qt.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Qt</span><br><span class="line">win = Qt.QtWidgets.QDialog()</span><br><span class="line">win.show()</span><br></pre></td></tr></table></figure>

<p>在maya上这样就直接运行了</p>
<p>但是在正常的python上，根据文档要这样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtWidgets</span><br><span class="line"></span><br><span class="line">app = QtWidgets.QApplication(sys.argv)</span><br><span class="line">button = QtWidgets.QPushButton(<span class="string">&quot;Hello World&quot;</span>)</span><br><span class="line">button.show()</span><br><span class="line">app.exec_()</span><br></pre></td></tr></table></figure>

<p>好像是现代maya版本就是Qt管理窗口，所以已经有QtApp了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtWidgets,QtCore,QtGui</span><br><span class="line"><span class="keyword">from</span> PySide2 <span class="keyword">import</span> QtWidgets,QtCore,QtGui</span><br><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtWidgets,QtCore,QtGui</span><br></pre></td></tr></table></figure>

<p>甚至我只mayapy安装了Qt.py，这三个命令都能用了</p>
<h3 id="1-2-Controller-Library"><a href="#1-2-Controller-Library" class="headerlink" title="1.2 Controller Library"></a><strong>1.2 Controller Library</strong></h3><p>controllerLibrary.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pprint</span><br><span class="line"></span><br><span class="line">USERAPPDIR = cmds.internalVar(userAppDir = <span class="literal">True</span>)</span><br><span class="line"><span class="built_in">print</span>(USERAPPDIR)</span><br><span class="line">DIRECTORY = os.path.join(USERAPPDIR,<span class="string">&#x27;controllerLibrary&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createDirectory</span>(<span class="params">directory = DIRECTORY</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Creates the given directory</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        directory(str):The directory to create</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(directory):</span><br><span class="line">        os.mkdir(directory)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ControllerLibrary</span>(<span class="title class_ inherited__">dict</span>):<span class="comment"># stm继承了个字典……</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self, name, directory = DIRECTORY,screenshot = <span class="literal">True</span>, **info</span>):</span><br><span class="line">        createDirectory(directory)<span class="comment"># 不存在路径则创建文件夹路径</span></span><br><span class="line"></span><br><span class="line">        path = os.path.join(directory,<span class="string">&quot;&#123;&#125;.ma&quot;</span>.<span class="built_in">format</span>(name))</span><br><span class="line">        infoFile = os.path.join(directory,<span class="string">&#x27;&#123;&#125;.json&#x27;</span>.<span class="built_in">format</span>(name))<span class="comment"># 保存数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ========保存文件========</span></span><br><span class="line">        cmds.file(rename = path)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> cmds.ls(selection = <span class="literal">True</span>):<span class="comment"># 有选择则只保存选择</span></span><br><span class="line">            cmds.file(force = <span class="literal">True</span>, <span class="built_in">type</span> = <span class="string">&#x27;mayaAscii&#x27;</span>, exportSelected = <span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">else</span>:<span class="comment"># 无选择则全部保存</span></span><br><span class="line">            cmds.file(save = <span class="literal">True</span>, <span class="built_in">type</span> = <span class="string">&#x27;mayaAscii&#x27;</span>, force = <span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ========保存屏幕快照========</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> screenshot:</span><br><span class="line">            info[<span class="string">&#x27;screenshot&#x27;</span>] = <span class="variable language_">self</span>.saveScreenShot(name,directory = directory)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ========输出json========</span></span><br><span class="line">        info[<span class="string">&#x27;name&#x27;</span>] = name</span><br><span class="line">        info[<span class="string">&#x27;path&#x27;</span>] = path</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(infoFile, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            json.dump(info, f, indent = <span class="number">4</span>)<span class="comment"># 把输入的info储存为json</span></span><br><span class="line">        <span class="variable language_">self</span>[name] = info</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find</span>(<span class="params">self, directory = DIRECTORY</span>):</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.clear()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;1&#x27;</span>,directory)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(directory):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        files = os.listdir(directory)<span class="comment"># 当前路径下所有文件</span></span><br><span class="line">        mayaFiles = [f <span class="keyword">for</span> f <span class="keyword">in</span> files <span class="keyword">if</span> f.endswith(<span class="string">&#x27;.ma&#x27;</span>)]</span><br><span class="line">        <span class="built_in">print</span>(files)</span><br><span class="line">        <span class="keyword">for</span> ma <span class="keyword">in</span> mayaFiles:</span><br><span class="line">            name,ext = os.path.splitext(ma)<span class="comment"># 分离文件名和扩展名</span></span><br><span class="line">            path = os.path.join(directory,ma)</span><br><span class="line">            </span><br><span class="line">            infoFile = <span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(name)</span><br><span class="line">            <span class="keyword">if</span> infoFile <span class="keyword">in</span> files:</span><br><span class="line">                infoFile = os.path.join(directory, infoFile)</span><br><span class="line">            </span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(infoFile, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    info = json.load(f)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;No info file found&#x27;</span>)</span><br><span class="line">                info = &#123;&#125;</span><br><span class="line">                </span><br><span class="line">            screenshot = <span class="string">&#x27;&#123;&#125;.jpg&#x27;</span>.<span class="built_in">format</span>(name)</span><br><span class="line">            <span class="keyword">if</span> screenshot <span class="keyword">in</span> files:</span><br><span class="line">                info[<span class="string">&#x27;screenshot&#x27;</span>] = os.path.join(directory,name)</span><br><span class="line">            info[<span class="string">&#x27;name&#x27;</span>] = name</span><br><span class="line">            info[<span class="string">&#x27;path&#x27;</span>] = path</span><br><span class="line">            <span class="variable language_">self</span>[name] = info</span><br><span class="line">        pprint.pprint(<span class="variable language_">self</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self, name</span>):</span><br><span class="line">        path = <span class="variable language_">self</span>[name][<span class="string">&#x27;path&#x27;</span>]</span><br><span class="line">        cmds.file(path, i = <span class="literal">True</span>, usingNamespace = <span class="literal">False</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">saveScreenShot</span>(<span class="params">self, name, directory = DIRECTORY</span>):</span><br><span class="line">        path = os.path.join(directory, <span class="string">&#x27;&#123;&#125;.jpg&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line">        cmds.viewFit()</span><br><span class="line">        cmds.setAttr(<span class="string">&#x27;defaultRenderGlobals.imageFormat&#x27;</span>, <span class="number">8</span>)<span class="comment"># jpeg</span></span><br><span class="line">        <span class="comment">#cmds.setAttr(&quot;defaultArnoldDriver.aiTranslator&quot;,&#x27;png&#x27;,type = &quot;string&quot;) 阿诺德渲染器</span></span><br><span class="line">        </span><br><span class="line">        cmds.playblast(completeFilename = path, forceOverwrite = <span class="literal">True</span>, <span class="built_in">format</span> = <span class="string">&#x27;image&#x27;</span>, width = <span class="number">200</span>, height = <span class="number">200</span>, showOrnaments = <span class="literal">False</span>, startTime = <span class="number">1</span>, endTime = <span class="number">1</span>, viewer = <span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/tian0000hai/article/details/116952413%E9%98%BF%E8%AF%BA%E5%BE%B7%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E6%B8%B2%E6%9F%93%E8%BE%93%E5%87%BA%E8%AE%BE%E7%BD%AE">https://blog.csdn.net/tian0000hai/article/details/116952413阿诺德渲染器的渲染输出设置</a></p>
<p>libraryUI.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line"><span class="keyword">from</span> PySide2 <span class="keyword">import</span> QtWidgets, QtCore, QtGui</span><br><span class="line"><span class="keyword">import</span> conLibrary.controllerLibrary <span class="keyword">as</span> controllerLibrary</span><br><span class="line"><span class="keyword">import</span> pprint</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line">importlib.reload(controllerLibrary)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ControllerLibraryUI</span>(QtWidgets.QDialog):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The ControllerLibraryUI is a dialog that lets us save and import controllers</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment">#super(ControllerLibraryUI, self).__init__()</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment">#super是一个，用于调用父类方法，用于多继承，而这里是为了不用考虑继承的父类是什么</span></span><br><span class="line">        <span class="comment">#QtWidgets.QDialog.__init__(self)因为是单继承，和这个相等</span></span><br><span class="line">        <span class="variable language_">self</span>.setWindowTitle(<span class="string">&#x27;Controller LibraryUI&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.library = controllerLibrary.ControllerLibrary()</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.buildUI()</span><br><span class="line">        <span class="variable language_">self</span>.populate()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUI</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        This method builds out the UI</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;bulding UI&#x27;</span>)</span><br><span class="line">        <span class="comment"># 整体行分布</span></span><br><span class="line">        layout = QtWidgets.QVBoxLayout(<span class="variable language_">self</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 行分布中的一行，提供纵向分布，编辑栏view</span></span><br><span class="line">        saveWidget = QtWidgets.QWidget()</span><br><span class="line">        saveLayout = QtWidgets.QHBoxLayout(saveWidget)</span><br><span class="line">        layout.addWidget(saveWidget)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 行内组件</span></span><br><span class="line">        <span class="variable language_">self</span>.saveNameField = QtWidgets.QLineEdit()</span><br><span class="line">        saveLayout.addWidget(<span class="variable language_">self</span>.saveNameField)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 行内组件</span></span><br><span class="line">        saveBtn = QtWidgets.QPushButton(<span class="string">&#x27;Save&#x27;</span>)</span><br><span class="line">        saveBtn.clicked.connect(<span class="variable language_">self</span>.save)</span><br><span class="line">        saveLayout.addWidget(saveBtn)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 新的一行，缩略图view</span></span><br><span class="line">        size = <span class="number">64</span></span><br><span class="line">        buffer = <span class="number">12</span></span><br><span class="line">        <span class="comment"># create a grid list Widget to display our controller thumbnails</span></span><br><span class="line">        <span class="variable language_">self</span>.listWidget = QtWidgets.QListWidget()</span><br><span class="line">        <span class="variable language_">self</span>.listWidget.setViewMode(QtWidgets.QListWidget.IconMode)</span><br><span class="line">        <span class="variable language_">self</span>.listWidget.setIconSize(QtCore.QSize(size,size))</span><br><span class="line">        <span class="variable language_">self</span>.listWidget.setResizeMode(QtWidgets.QListWidget.Adjust)</span><br><span class="line">        <span class="variable language_">self</span>.listWidget.setGridSize(QtCore.QSize(size+buffer,size+buffer))</span><br><span class="line">        layout.addWidget(<span class="variable language_">self</span>.listWidget)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 新的一行button view</span></span><br><span class="line">        btnWidget = QtWidgets.QWidget()</span><br><span class="line">        btnLayout = QtWidgets.QHBoxLayout(btnWidget)</span><br><span class="line">        layout.addWidget(btnWidget)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># button view组件</span></span><br><span class="line">        importBtn = QtWidgets.QPushButton(<span class="string">&#x27;Import&#x27;</span>)</span><br><span class="line">        importBtn.clicked.connect(<span class="variable language_">self</span>.load)</span><br><span class="line">        btnLayout.addWidget(importBtn)</span><br><span class="line">        </span><br><span class="line">        refreshBtn = QtWidgets.QPushButton(<span class="string">&#x27;Refresh&#x27;</span>)</span><br><span class="line">        refreshBtn.clicked.connect(<span class="variable language_">self</span>.populate)<span class="comment">#注意只提供方法名，没有括号，括号代表调用</span></span><br><span class="line">        btnLayout.addWidget(refreshBtn)</span><br><span class="line">        </span><br><span class="line">        closeBtn = QtWidgets.QPushButton(<span class="string">&#x27;Close&#x27;</span>)</span><br><span class="line">        closeBtn.clicked.connect(<span class="variable language_">self</span>.close)<span class="comment"># self.close继承于QDialog</span></span><br><span class="line">        btnLayout.addWidget(closeBtn)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">populate</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;This clears the listWidget and then repopulates it with the content of our library&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.listWidget.clear()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;populating&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.library.find()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> name, info <span class="keyword">in</span> <span class="variable language_">self</span>.library.items():</span><br><span class="line">            item = QtWidgets.QListWidgetItem(name)</span><br><span class="line">            <span class="variable language_">self</span>.listWidget.addItem(item)</span><br><span class="line">            </span><br><span class="line">            screenshot = info.get(<span class="string">&#x27;screenshot&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> screenshot:</span><br><span class="line">                icon = QtGui.QIcon(screenshot)</span><br><span class="line">                item.setIcon(icon)</span><br><span class="line">                </span><br><span class="line">            item.setToolTip(pprint.pformat(info))</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;This loads the currently selected controller&quot;&quot;&quot;</span></span><br><span class="line">        currentItem = <span class="variable language_">self</span>.listWidget.currentItem()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> currentItem:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        name = currentItem.text()</span><br><span class="line">        <span class="variable language_">self</span>.library.load(name)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;This saves the controller with the given file name&quot;&quot;&quot;</span></span><br><span class="line">        name = <span class="variable language_">self</span>.saveNameField.text()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> name.strip():</span><br><span class="line">            cmds.warning(<span class="string">&quot;You must give a name!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="variable language_">self</span>.library.save(name)</span><br><span class="line">        <span class="variable language_">self</span>.populate()</span><br><span class="line">        <span class="variable language_">self</span>.saveNameField.setText(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">showUI</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This shows and returns a handle to the UI</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        Qdialog</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    ui = ControllerLibraryUI()</span><br><span class="line">    ui.show()</span><br><span class="line">    <span class="keyword">return</span> ui</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="二、Light-Manager"><a href="#二、Light-Manager" class="headerlink" title="二、Light Manager"></a><strong>二、Light Manager</strong></h2><p>创建一个场景的灯光管理窗口，并且可以和maya的窗口融合</p>
<h3 id="2-1-PyMel"><a href="#2-1-PyMel" class="headerlink" title="2.1 PyMel"></a><strong>2.1 PyMel</strong></h3><p>pymel包含了cmds、openmaya</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymel.core <span class="keyword">as</span> pm</span><br><span class="line">cube = pm.polyCube()</span><br><span class="line"><span class="built_in">print</span>(cube)</span><br><span class="line"><span class="comment">#[nt.Transform(&#x27;pCube1&#x27;), nt.PolyCube(&#x27;polyCube1&#x27;)]</span></span><br></pre></td></tr></table></figure>

<p>哥们试了半天，maya2023只有pymel&#x3D;&#x3D;1.3.0a1能用</p>
<p>可以看到pyme创建的polyCube是和openmaya一样附带Node的，并且有一个nt来封装</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cmds.rename(cube[0],&#x27;newName&#x27;)</span></span><br><span class="line">cube[<span class="number">0</span>].rename(<span class="string">&#x27;Foo&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220703154445036.png" alt="image-20220703154445036"></p>
<p>pymel返回的对象不像cmds里面直接是string，是有一个nt对象封装（&#x3D;&#x3D;PyNode class&#x3D;&#x3D;）的，因此使用rename方法也需要调用这个nt对象内部的方法</p>
<p>这就和OpenMaya是差不多的</p>
<ul>
<li>mayatool使用cmd是很常见的</li>
<li>pymel一些情况会很慢，因为它封装了Node对象，不想cmd使用string</li>
<li>pymel也不被Audodesk直接支持，官方文档里也写了这一点</li>
</ul>
<h3 id="2-2-UI-and-Partial-funcitons"><a href="#2-2-UI-and-Partial-funcitons" class="headerlink" title="2.2 UI and Partial funcitons"></a><strong>2.2 UI and Partial funcitons</strong></h3><p>lightingManager.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtWidgets,QtCore,QtGui</span><br><span class="line"><span class="keyword">import</span> pymel.core <span class="keyword">as</span> pm</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="keyword">import</span> Qt</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> OpenMayaUI <span class="keyword">as</span> omui</span><br><span class="line"></span><br><span class="line">logging.basicConfig()</span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;LightingManager&#x27;</span>)</span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> Qt.__binding__ == <span class="string">&#x27;PySide&#x27;</span>:</span><br><span class="line">    logger.debug(<span class="string">&#x27;Using Pyside with shiboken&#x27;</span>)</span><br><span class="line">    <span class="keyword">from</span> shiboken <span class="keyword">import</span> warpInstance</span><br><span class="line">    <span class="keyword">from</span> Qt.QtCore <span class="keyword">import</span> Signal</span><br><span class="line"><span class="keyword">elif</span> Qt.__binding__.startswith(<span class="string">&#x27;PyQt&#x27;</span>):</span><br><span class="line">    logger.debug(<span class="string">&#x27;Using PyQt with sip&#x27;</span>)</span><br><span class="line">    <span class="keyword">from</span> sip <span class="keyword">import</span> warpInstance <span class="keyword">as</span> warpInstance</span><br><span class="line">    <span class="keyword">from</span> Qt.QtCore <span class="keyword">import</span> pyqtSignal <span class="keyword">as</span> Signal</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    logger.debug(<span class="string">&#x27;Using PySide2 with shiboken&#x27;</span>)</span><br><span class="line">    <span class="keyword">import</span> shiboken2</span><br><span class="line">    <span class="keyword">from</span> Qt.QtCore <span class="keyword">import</span> Signal</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getMayaMainWindow</span>():</span><br><span class="line">    win = omui.MQtUtil_mainWindow()</span><br><span class="line">    ptr = shiboken2.wrapInstance(<span class="built_in">int</span>(win),QtWidgets.QMainWindow)<span class="comment"># long是python2</span></span><br><span class="line">    <span class="comment"># 并且 shiboken2有改动，不能直接import warpInstance</span></span><br><span class="line">    <span class="keyword">return</span> ptr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getDock</span>(<span class="params">name = <span class="string">&#x27;LightingManagerDock&#x27;</span></span>):</span><br><span class="line">    deleteDock(name)</span><br><span class="line">    ctrl = pm.workspaceControl(name, dockToMainWindow = (<span class="string">&#x27;right&#x27;</span>,<span class="number">1</span>), label = <span class="string">&quot;LightingManager&quot;</span>)</span><br><span class="line">    qtCtrl = omui.MQtUtil_findControl(ctrl)</span><br><span class="line">    ptr = shiboken2.wrapInstance(<span class="built_in">int</span>(qtCtrl),QtWidgets.QWidget)</span><br><span class="line">    <span class="keyword">return</span> ptr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deleteDock</span>(<span class="params">name = <span class="string">&#x27;LightingManagerDock&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">if</span> pm.workspaceControl(name, query = <span class="literal">True</span>, exists = <span class="literal">True</span>):</span><br><span class="line">        pm.deleteUI(name)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LightManager</span>(QtWidgets.QWidget):<span class="comment"># QtWidgets.QDialog</span></span><br><span class="line">    </span><br><span class="line">    lightTypes = &#123;</span><br><span class="line">        <span class="string">&quot;Point Light&quot;</span>: pm.pointLight,</span><br><span class="line">        <span class="string">&quot;Spot Light&quot;</span>: pm.spotLight,</span><br><span class="line">        <span class="string">&quot;Directional Light&quot;</span>: pm.directionalLight,</span><br><span class="line">        <span class="string">&quot;Area Light&quot;</span>: partial(pm.shadingNode, <span class="string">&#x27;areaLight&#x27;</span>, asLight = <span class="literal">True</span>),</span><br><span class="line">        <span class="string">&quot;Volume Light&quot;</span>: partial(pm.shadingNode, <span class="string">&#x27;volumeLight&#x27;</span>, asLight = <span class="literal">True</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, dock = <span class="literal">True</span></span>):</span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        <span class="keyword">if</span> dock:</span><br><span class="line">            parent = getDock()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            deleteDock()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                pm.deleteUI(<span class="string">&#x27;LightingManager&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                logger.debug(<span class="string">&quot;No previous LightManagerUI exists&quot;</span>)</span><br><span class="line">                </span><br><span class="line">            <span class="comment">#parent = getMayaMainWindow()</span></span><br><span class="line">            parent = QtWidgets.QDialog(parent = getMayaMainWindow())</span><br><span class="line">            </span><br><span class="line">            parent.setObjectName(<span class="string">&#x27;lightingManager&#x27;</span>)</span><br><span class="line">            parent.setWindowTitle(<span class="string">&#x27;Lighting Manager&#x27;</span>)</span><br><span class="line">            layout = QtWidgets.QVBoxLayout(parent)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">super</span>().__init__(parent = parent)<span class="comment"># 把这个窗口的父节点设为maya窗口</span></span><br><span class="line">        <span class="comment">#self.setWindowTitle(&#x27;Lighting Manager&#x27;)</span></span><br><span class="line">        <span class="variable language_">self</span>.buildUI()</span><br><span class="line">        <span class="variable language_">self</span>.populate()</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.parent().layout().addWidget(<span class="variable language_">self</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> dock:</span><br><span class="line">            parent.show()</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">populate</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="variable language_">self</span>.scrollLayout.count():</span><br><span class="line">            widget = <span class="variable language_">self</span>.scrollLayout.takeAt(<span class="number">0</span>).widget()</span><br><span class="line">            <span class="keyword">if</span> widget:</span><br><span class="line">                widget.setVisible(<span class="literal">False</span>)</span><br><span class="line">                widget.deleteLater()</span><br><span class="line">        <span class="keyword">for</span> light <span class="keyword">in</span> pm.ls(<span class="built_in">type</span>=[<span class="string">&#x27;areaLight&#x27;</span>,<span class="string">&#x27;spotLight&#x27;</span>,<span class="string">&#x27;pointLight&#x27;</span>,<span class="string">&#x27;directionalLight&#x27;</span>,<span class="string">&#x27;volumeLight&#x27;</span>]):</span><br><span class="line">            <span class="variable language_">self</span>.addLight(light)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUI</span>(<span class="params">self</span>):</span><br><span class="line">        layout = QtWidgets.QGridLayout(<span class="variable language_">self</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.lightTypeCB = QtWidgets.QComboBox()<span class="comment"># 下拉菜单</span></span><br><span class="line">        <span class="keyword">for</span> lightType <span class="keyword">in</span> <span class="built_in">sorted</span>(<span class="variable language_">self</span>.lightTypes):</span><br><span class="line">            <span class="variable language_">self</span>.lightTypeCB.addItem(lightType)</span><br><span class="line">        layout.addWidget(<span class="variable language_">self</span>.lightTypeCB, <span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        createBtn = QtWidgets.QPushButton(<span class="string">&#x27;Create&#x27;</span>)</span><br><span class="line">        createBtn.clicked.connect(<span class="variable language_">self</span>.createLight)</span><br><span class="line">        layout.addWidget(createBtn, <span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        scrollWidget = QtWidgets.QWidget()</span><br><span class="line">        scrollWidget.setSizePolicy(QtWidgets.QSizePolicy.Maximum,QtWidgets.QSizePolicy.Maximum)</span><br><span class="line">        <span class="variable language_">self</span>.scrollLayout = QtWidgets.QVBoxLayout(scrollWidget)</span><br><span class="line">        </span><br><span class="line">        scrollArea = QtWidgets.QScrollArea()</span><br><span class="line">        scrollArea.setWidgetResizable(<span class="literal">True</span>)</span><br><span class="line">        scrollArea.setWidget(scrollWidget)</span><br><span class="line">        layout.addWidget(scrollArea,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>)<span class="comment"># 位于layout第二行第一列，占据1行2列</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        refreshBtn = QtWidgets.QPushButton(<span class="string">&#x27;Refresh&#x27;</span>)</span><br><span class="line">        refreshBtn.clicked.connect(<span class="variable language_">self</span>.populate)</span><br><span class="line">        layout.addWidget(refreshBtn, <span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">createLight</span>(<span class="params">self</span>):</span><br><span class="line">        lightType = <span class="variable language_">self</span>.lightTypeCB.currentText()</span><br><span class="line">        func = <span class="variable language_">self</span>.lightTypes[lightType]</span><br><span class="line">        </span><br><span class="line">        light = func()</span><br><span class="line">        <span class="variable language_">self</span>.addLight(light)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">addLight</span>(<span class="params">self, light</span>):</span><br><span class="line">        widget = LightWidget(light)</span><br><span class="line">        <span class="variable language_">self</span>.scrollLayout.addWidget(widget)</span><br><span class="line">        widget.onSolo.connect(<span class="variable language_">self</span>.onSolo)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">onSolo</span>(<span class="params">self, value</span>):</span><br><span class="line">        lightWidgets = <span class="variable language_">self</span>.findChildren(LightWidget)</span><br><span class="line">        <span class="keyword">for</span> widget <span class="keyword">in</span> lightWidgets:</span><br><span class="line">            <span class="keyword">if</span> widget != <span class="variable language_">self</span>.sender():</span><br><span class="line">                widget.disableLight(value)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LightWidget</span>(QtWidgets.QWidget):</span><br><span class="line">    </span><br><span class="line">    onSolo = Signal(<span class="built_in">bool</span>)<span class="comment">#QtCore.pyqtSignal 使用pyqt；QtCore.Singal使用pyside2</span></span><br><span class="line">    <span class="comment"># 在我们后面的定义中，对不同版本的Qt进行了判断，可以统一使用</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, light</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(light, <span class="built_in">str</span>):</span><br><span class="line">            light = pm.PyNode(light)</span><br><span class="line">        <span class="variable language_">self</span>.light = light</span><br><span class="line">        <span class="variable language_">self</span>.buildUI()</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUI</span>(<span class="params">self</span>):</span><br><span class="line">        layout = QtWidgets.QGridLayout(<span class="variable language_">self</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 可见性选择框</span></span><br><span class="line">        <span class="variable language_">self</span>.name = QtWidgets.QCheckBox(<span class="built_in">str</span>(<span class="variable language_">self</span>.light.getTransform()))</span><br><span class="line">        <span class="variable language_">self</span>.name.setChecked(<span class="variable language_">self</span>.light.visibility.get())</span><br><span class="line">        <span class="variable language_">self</span>.name.toggled.connect(<span class="keyword">lambda</span> val: <span class="variable language_">self</span>.light.getTransform().visibility.<span class="built_in">set</span>(val))</span><br><span class="line">        <span class="comment">#def setLightVisibility(val):</span></span><br><span class="line">        <span class="comment">#    self.light.visibility.set(val)</span></span><br><span class="line">        <span class="comment"># self.light 只表示shapeNode,因此需要在transofrm上设置可见项</span></span><br><span class="line">        layout.addWidget(<span class="variable language_">self</span>.name, <span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Solo按钮</span></span><br><span class="line">        soloBtn = QtWidgets.QPushButton(<span class="string">&#x27;Solo&#x27;</span>)</span><br><span class="line">        soloBtn.setCheckable(<span class="literal">True</span>)</span><br><span class="line">        soloBtn.toggled.connect(<span class="keyword">lambda</span> val: <span class="variable language_">self</span>.onSolo.emit(val))</span><br><span class="line">        </span><br><span class="line">        layout.addWidget(soloBtn, <span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">        <span class="comment"># 删除按钮</span></span><br><span class="line">        deleteBtn = QtWidgets.QPushButton(<span class="string">&#x27;X&#x27;</span>)</span><br><span class="line">        deleteBtn.clicked.connect(<span class="variable language_">self</span>.deleteLight)</span><br><span class="line">        deleteBtn.setMaximumWidth(<span class="number">10</span>)</span><br><span class="line">        layout.addWidget(deleteBtn,<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#灯光强度</span></span><br><span class="line">        intensity = QtWidgets.QSlider(QtCore.Qt.Horizontal)</span><br><span class="line">        intensity.setMinimum(<span class="number">1</span>)</span><br><span class="line">        intensity.setMaximum(<span class="number">1000</span>)</span><br><span class="line">        intensity.setValue(<span class="variable language_">self</span>.light.intensity.get())</span><br><span class="line">        intensity.valueChanged.connect(<span class="keyword">lambda</span> val:<span class="variable language_">self</span>.light.intensity.<span class="built_in">set</span>(val))</span><br><span class="line">        layout.addWidget(intensity, <span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="variable language_">self</span>.colorBtn = QtWidgets.QPushButton()</span><br><span class="line">        <span class="variable language_">self</span>.colorBtn.setMaximumWidth(<span class="number">20</span>)</span><br><span class="line">        <span class="variable language_">self</span>.colorBtn.setMaximumHeight(<span class="number">20</span>)</span><br><span class="line">        <span class="variable language_">self</span>.setButtonColor()</span><br><span class="line">        <span class="variable language_">self</span>.colorBtn.clicked.connect(<span class="variable language_">self</span>.setColor)</span><br><span class="line">        layout.addWidget(<span class="variable language_">self</span>.colorBtn, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setButtonColor</span>(<span class="params">self,color = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> color:</span><br><span class="line">            color = <span class="variable language_">self</span>.light.color.get()</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(color) == <span class="number">3</span>, <span class="string">&quot;You must provide a list of 3 Color&quot;</span></span><br><span class="line">        </span><br><span class="line">        r,g,b = [c*<span class="number">255</span> <span class="keyword">for</span> c <span class="keyword">in</span> color]</span><br><span class="line">        <span class="variable language_">self</span>.colorBtn.setStyleSheet(<span class="string">&#x27;background-color: rgba(&#123;&#125;,&#123;&#125;,&#123;&#125;,1.0)&#x27;</span>.<span class="built_in">format</span>(r,g,b))</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setColor</span>(<span class="params">self</span>):</span><br><span class="line">        lightColor = <span class="variable language_">self</span>.light.color.get()</span><br><span class="line">        color = pm.colorEditor(rgbValue = lightColor)</span><br><span class="line">        <span class="comment">#print(color) maya编辑器给返回的是个字符串</span></span><br><span class="line">        r,g,b,a = [<span class="built_in">float</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> color.split()]</span><br><span class="line">        color = (r,g,b)</span><br><span class="line">        <span class="comment"># 改变灯光颜色</span></span><br><span class="line">        <span class="variable language_">self</span>.light.color.<span class="built_in">set</span>(color)</span><br><span class="line">        <span class="comment"># 改变UI上的颜色</span></span><br><span class="line">        <span class="variable language_">self</span>.setButtonColor(color)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">disableLight</span>(<span class="params">self,value</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name.setChecked(<span class="keyword">not</span> value)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deleteLight</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 删除UI</span></span><br><span class="line">        <span class="variable language_">self</span>.setParent(<span class="literal">None</span>)</span><br><span class="line">        <span class="variable language_">self</span>.setVisible(<span class="literal">False</span>)</span><br><span class="line">        <span class="variable language_">self</span>.deleteLater()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 删除灯光</span></span><br><span class="line">        pm.delete(<span class="variable language_">self</span>.light.getTransform())</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">showUI</span>():</span><br><span class="line">    ui = LightManager()</span><br><span class="line">    ui.show()</span><br><span class="line">    <span class="keyword">return</span> ui</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lightingManager</span><br><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line">importlib.reload(lightingManager)</span><br><span class="line"></span><br><span class="line">ui = lightingManager.LightManager().show()</span><br></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220703181152950.png" alt="image-20220703181152950"></p>
<p>将窗口设为maya窗口的子窗口后，窗口和maya工作区成为一个整体，在maya工作区工作不会让组件窗口消失了，在任务栏也不会看到额外的maya窗口</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lightingManager</span><br><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line">importlib.reload(lightingManager)</span><br><span class="line"></span><br><span class="line"><span class="comment">#ui = lightingManager.LightManager().show()</span></span><br><span class="line"><span class="comment">#lightingManager.LightManager().show()</span></span><br><span class="line">lightingManager.getDock()</span><br></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220703181632027.png" alt="image-20220703181632027"></p>
<h3 id="2-3-Handle-error"><a href="#2-3-Handle-error" class="headerlink" title="2.3 Handle error"></a><strong>2.3 Handle error</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#raise &quot;message&quot;#raise会停止后面的语句</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do</span>():</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="comment">#用try except来处理，当出现错误又不希望程序停止时</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    do()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;There was an Error&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Goodbye&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Hello</span></span><br><span class="line"><span class="comment">#There was an Error</span></span><br><span class="line"><span class="comment">#Goodbye</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError()<span class="comment">#IOError(),Exception()</span></span><br><span class="line"><span class="keyword">except</span> RuntimeError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;RuntimeError&quot;</span>)</span><br><span class="line"><span class="keyword">except</span>:<span class="comment">#else也可以用</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;other error&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Running&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> RuntimeError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;RuntimeError&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;no error&quot;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;done&quot;</span>)</span><br><span class="line"><span class="comment">#Running</span></span><br><span class="line"><span class="comment">#no error</span></span><br><span class="line"><span class="comment">#done</span></span><br><span class="line"><span class="comment">#执行try后，else一定会被执行(except 可以看作一种if)</span></span><br></pre></td></tr></table></figure>



<h3 id="2-4-Exporting-and-Importing-Our-Lights"><a href="#2-4-Exporting-and-Importing-Our-Lights" class="headerlink" title="2.4 Exporting and Importing Our Lights"></a><strong>2.4 Exporting and Importing Our Lights</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">saveBtn = QtWidgets.QPushButton(<span class="string">&#x27;Save&#x27;</span>)</span><br><span class="line">saveBtn.clicked.connect(<span class="variable language_">self</span>.saveLights)</span><br><span class="line">layout.addWidget(saveBtn,<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">saveLights</span>(<span class="params">self</span>):</span><br><span class="line">    properties = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> lightWidget <span class="keyword">in</span> <span class="variable language_">self</span>.findChildren(LightWidget):</span><br><span class="line">        light = lightWidget.light</span><br><span class="line">        transform = light.getTransform()</span><br><span class="line"></span><br><span class="line">        properties[<span class="built_in">str</span>(transform)] = &#123;</span><br><span class="line">            <span class="string">&quot;translate&quot;</span>: <span class="built_in">list</span>(transform.translate.get()),</span><br><span class="line">            <span class="string">&quot;rotation&quot;</span>: <span class="built_in">list</span>(transform.rotate.get()),</span><br><span class="line">            <span class="string">&quot;lightType&quot;</span>: pm.objectType(light),</span><br><span class="line">            <span class="string">&quot;intensity&quot;</span>: light.intensity.get(),</span><br><span class="line">            <span class="string">&quot;color&quot;</span>: light.color.get()</span><br><span class="line">        &#125;</span><br><span class="line">    directory = os.path.join(pm.internalVar(userAppDir = <span class="literal">True</span>),<span class="string">&#x27;lightManager&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(directory):</span><br><span class="line">        os.mkdir(directory)</span><br><span class="line">    lightFile = os.path.join(directory,<span class="string">&#x27;lightFile_&#123;&#125;.json&#x27;</span>.<span class="built_in">format</span>(time.strftime(<span class="string">&#x27;%m%d&#x27;</span>)))</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(lightFile, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        json.dump(properties, f, indent = <span class="number">4</span>)</span><br><span class="line">    logger.info(<span class="string">&quot;Saving file to &#123;&#125;&quot;</span>.<span class="built_in">format</span>(lightFile))</span><br><span class="line">        </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">importBtn = QtWidgets.QPushButton(<span class="string">&#x27;Import&#x27;</span>)</span><br><span class="line">importBtn.clicked.connect(<span class="variable language_">self</span>.importLights)</span><br><span class="line">layout.addWidget(importBtn,<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">importLights</span>(<span class="params">self</span>):</span><br><span class="line">    directory = <span class="variable language_">self</span>.getDirectory()</span><br><span class="line">    fileName = QtWidgets.QFileDialog.getOpenFileName(<span class="variable language_">self</span>, <span class="string">&quot;Light Browser&quot;</span>, directory)</span><br><span class="line">    <span class="comment">#print(fileName)#(&#x27;C:/Users/XZYW/文档/maya/lightManager/lightFile_0703.json&#x27;, &#x27;所有文件 (*)&#x27;)</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(fileName[<span class="number">0</span>], <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        properties = json.load(f)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">for</span> light, info <span class="keyword">in</span> properties.items():</span><br><span class="line">        lightType = info.get(<span class="string">&#x27;lightType&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> lt <span class="keyword">in</span> <span class="variable language_">self</span>.lightTypes:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;&#123;&#125;Light&quot;</span>.<span class="built_in">format</span>(lt.split()[<span class="number">0</span>].lower()) == lightType:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.info(<span class="string">&quot;Cannot find a corresponding lightType for &#123;&#125; (&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(light, lightType))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        light = <span class="variable language_">self</span>.createLight(lightType = lt)</span><br><span class="line">        light.intensity.<span class="built_in">set</span>(info.get(<span class="string">&#x27;intensity&#x27;</span>))</span><br><span class="line">        light.color.<span class="built_in">set</span>(info.get(<span class="string">&#x27;color&#x27;</span>))</span><br><span class="line">        transform = light.getTransform()</span><br><span class="line">        transform.translate.<span class="built_in">set</span>(info.get(<span class="string">&#x27;translate&#x27;</span>))</span><br><span class="line">        transform.rotate.<span class="built_in">set</span>(info.get(<span class="string">&#x27;rotation&#x27;</span>))</span><br><span class="line">        </span><br><span class="line">    <span class="variable language_">self</span>.populate()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createLight</span>(<span class="params">self, lightType = <span class="literal">None</span>, add = <span class="literal">True</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> lightType:</span><br><span class="line">        lightType = <span class="variable language_">self</span>.lightTypeCB.currentText()</span><br><span class="line">    func = <span class="variable language_">self</span>.lightTypes[lightType]</span><br><span class="line">    </span><br><span class="line">    light = func()</span><br><span class="line">    <span class="keyword">if</span> add:</span><br><span class="line">        <span class="variable language_">self</span>.addLight(light)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> light</span><br></pre></td></tr></table></figure>



<h2 id="三、补充"><a href="#三、补充" class="headerlink" title="三、补充"></a><strong>三、补充</strong></h2><h3 id="3-1-命令行-文件重命名"><a href="#3-1-命令行-文件重命名" class="headerlink" title="3.1 命令行 文件重命名"></a><strong>3.1 命令行 文件重命名</strong></h3><p>cliRenamer.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description = <span class="string">&quot;This is a batch renamer&quot;</span>, usage = <span class="string">&quot;To replace all files with hello with goodbye instead: python clirenamer.py hello goodbye&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;inString&#x27;</span>, <span class="built_in">help</span> = <span class="string">&quot;The world to replace&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;outString&#x27;</span>, <span class="built_in">help</span> = <span class="string">&quot;The world to replace it with&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-d&#x27;</span>, <span class="string">&#x27;--duplicate&#x27;</span>, <span class="built_in">help</span> = <span class="string">&quot;Whether to duplicate or replace in spot&quot;</span>, action = <span class="string">&#x27;store_true&#x27;</span>)<span class="comment">#默认为False</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;--regex&#x27;</span>,</span><br><span class="line">                       <span class="built_in">help</span> = <span class="string">&quot;Whether the patterns are regex or not&quot;</span>,</span><br><span class="line">                       action = <span class="string">&quot;store_true&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;--out&#x27;</span>,</span><br><span class="line">                       <span class="built_in">help</span> = <span class="string">&quot;The output location. Defaults to here&quot;</span>)</span><br><span class="line">    args = parser.parser_args()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(args)</span><br><span class="line">	rename(args.inString,args.outString, duplicate = args.duplicate,</span><br><span class="line">          outDirectory = args.out, regex = args.regex)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rename</span>(<span class="params">inString, outString, duplicate = <span class="literal">True</span>, inDirectory = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">           outDirectory = <span class="literal">None</span>, regex = <span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> inDirectory:</span><br><span class="line">        inDirectory = os.getcwd()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> outDirectory:</span><br><span class="line">        outDIrectory = inDirectory</span><br><span class="line">    outDirectory = os.path.abspath(outDirectory)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(outDirectory):</span><br><span class="line">        <span class="keyword">raise</span> IOError(<span class="string">&#x27;&#123;&#125; does not exist&#x27;</span>.<span class="built_in">format</span>(outDirectory))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(inDirectory):</span><br><span class="line">        <span class="keyword">raise</span> IOError(<span class="string">&#x27;&#123;&#125; does not exist&#x27;</span>.<span class="built_in">format</span>(inDirectory))</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(inDirectory):</span><br><span class="line">        <span class="keyword">if</span> .startwith(<span class="string">&#x27;.&#x27;</span>):<span class="comment">#linux,mac中.开头表示隐藏文件</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">         </span><br><span class="line">        <span class="keyword">if</span> regex:</span><br><span class="line">            name = re.sub(inString, outString, f)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">        	name = f.replace(inString, outString)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(name)</span><br><span class="line">        <span class="keyword">if</span> name == f:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        src = os.path.join(inDirectory, f)</span><br><span class="line">        dest = os.path.join(outDirectory, name)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> duplicate:</span><br><span class="line">            shutil.copy2(src, dest)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            os.rename(src, dest)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:z</span><br><span class="line">    main()<span class="comment">#分离命名空间，只有当这个文件命名空间是main的时候才运行</span></span><br></pre></td></tr></table></figure>



<h3 id="3-2-sys模块"><a href="#3-2-sys模块" class="headerlink" title="3.2 sys模块"></a><strong>3.2 sys模块</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> subprocess<span class="comment">#子进程</span></span><br><span class="line">subprocess.call([<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;../cliRenamer.py&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>])</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/18/TA/Maya/cmds%EF%BC%88%E5%9B%9B%EF%BC%89/" data-id="cmfe9guir001vewuhhbnsecui" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Maya/" rel="tag">Maya</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Maya/cmds（三）" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/18/TA/Maya/cmds%EF%BC%88%E4%B8%89%EF%BC%89/">【笔记】【Maya工具】Python For Maya（Cmds）（三）The Animation Tweener</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/18/TA/Maya/cmds%EF%BC%88%E4%B8%89%EF%BC%89/" class="article-date">
  <time datetime="2022-08-18T09:22:18.000Z" itemprop="datePublished">2022-08-18</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h3 id="一、UI-library"><a href="#一、UI-library" class="headerlink" title="一、UI library"></a><strong>一、UI library</strong></h3><ul>
<li><p>QT</p>
<ul>
<li>maya的UI就是用QT建立的</li>
</ul>
</li>
<li><p>PySide</p>
</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220630000053014.png" alt="image-20220630000053014" style="zoom:50%;" />

<p>选取某一帧进行百分比插值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tween</span>(<span class="params">percentage, obj = <span class="literal">None</span>, attrs = <span class="literal">None</span>, selection = <span class="literal">True</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> obj <span class="keyword">and</span> <span class="keyword">not</span> selection:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;No object given to tween&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> obj:</span><br><span class="line">        obj = cmds.ls(selection = <span class="literal">True</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> attrs:</span><br><span class="line">        attrs = cmds.listAttr(obj,keyable = <span class="literal">True</span>)</span><br><span class="line">    currentTime = cmds.currentTime(query = <span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> attr <span class="keyword">in</span> attrs:</span><br><span class="line">        <span class="comment"># construct the full name of the attr with its obj</span></span><br><span class="line">        attrFull = <span class="string">&#x27;&#123;&#125;.&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(obj,attr)</span><br><span class="line">        <span class="comment"># get the keyframes of the attr on this obj</span></span><br><span class="line">        keyframes = cmds.keyframe(attrFull, query = <span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> keyframes:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        previousKeyframes = [frame <span class="keyword">for</span> frame <span class="keyword">in</span> keyframes <span class="keyword">if</span> frame &lt; currentTime]</span><br><span class="line">        </span><br><span class="line">        laterKeyframes = [frame <span class="keyword">for</span> frame <span class="keyword">in</span> keyframes <span class="keyword">if</span> frame&gt; currentTime]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> previousKeyframes <span class="keyword">and</span> <span class="keyword">not</span> laterKeyframes:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> previousKeyframes:</span><br><span class="line">            previousFrame = <span class="built_in">max</span>(previousKeyframes)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            previousFrame = <span class="literal">None</span></span><br><span class="line">        nextFrame = <span class="built_in">min</span>(laterKeyframes) <span class="keyword">if</span> laterKeyframes <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> previousFrame <span class="keyword">or</span> <span class="keyword">not</span> nextFrame:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        previousValue = cmds.getAttr(attrFull, time = previousFrame)</span><br><span class="line">        nextValue = cmds.getAttr(attrFull, time = nextFrame)</span><br><span class="line">        </span><br><span class="line">        difference = nextValue - previousValue</span><br><span class="line">        weightedDifference = (difference*percentage) / <span class="number">100.0</span></span><br><span class="line">        currentValue = previousValue + weightedDifference</span><br><span class="line">        <span class="built_in">print</span>(previousValue)</span><br><span class="line">        <span class="built_in">print</span>(nextValue)</span><br><span class="line">        <span class="built_in">print</span>(currentValue)</span><br><span class="line">        cmds.setKeyframe(attrFull, time = currentTime, value = currentValue)</span><br><span class="line">        </span><br><span class="line">tween(<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<h3 id="二、创建窗口"><a href="#二、创建窗口" class="headerlink" title="二、创建窗口"></a><strong>二、创建窗口</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.cmds <span class="keyword">as</span> cmds</span><br><span class="line"></span><br><span class="line"><span class="comment"># Make a new window</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">window = cmds.window( title=<span class="string">&quot;Long Name&quot;</span>, iconName=<span class="string">&#x27;Short Name&#x27;</span>, widthHeight=(<span class="number">200</span>, <span class="number">55</span>) )</span><br><span class="line">cmds.columnLayout( adjustableColumn=<span class="literal">True</span> )</span><br><span class="line">cmds.button( label=<span class="string">&#x27;Do Nothing&#x27;</span> )</span><br><span class="line">cmds.button( label=<span class="string">&#x27;Close&#x27;</span>, command=(<span class="string">&#x27;cmds.deleteUI(\&quot;&#x27;</span> + window + <span class="string">&#x27;\&quot;, window=True)&#x27;</span>) )</span><br><span class="line">cmds.setParent( <span class="string">&#x27;..&#x27;</span> )</span><br><span class="line">cmds.showWindow( window )</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TweenWindow</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    windowName = <span class="string">&quot;TweenerWindow&quot;</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> cmds.window(<span class="variable language_">self</span>.windowName, query = <span class="literal">True</span>, exists = <span class="literal">True</span>):</span><br><span class="line">            cmds.deleteUI(<span class="variable language_">self</span>.windowName)</span><br><span class="line">        cmds.window(<span class="variable language_">self</span>.windowName)</span><br><span class="line">        <span class="variable language_">self</span>.buildUI()</span><br><span class="line">        cmds.showWindow()</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUI</span>(<span class="params">self</span>):</span><br><span class="line">        column = cmds.colunmLayout()</span><br><span class="line">        cmds.text(label = <span class="string">&quot;Use this slider to set the tween amout&quot;</span>)</span><br><span class="line">        row = cmds.rowLayout(numberOfColumns = <span class="number">2</span>)</span><br><span class="line">        <span class="variable language_">self</span>.slider = cmds.floatSlider(<span class="built_in">min</span> = <span class="number">0</span>, <span class="built_in">max</span> = <span class="number">100</span>, value = <span class="number">50</span>,step = <span class="number">1</span>,changeCommand = tween)</span><br><span class="line">        cmds.button(labe = <span class="string">&quot;Reset&quot;</span>,command = <span class="variable language_">self</span>.reset)</span><br><span class="line">        </span><br><span class="line">        cmds.setParent(column)</span><br><span class="line">        cmds.button(label = <span class="string">&quot;Close&quot;</span>, command = <span class="variable language_">self</span>.close)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reset</span>(<span class="params">self,*args</span>):<span class="comment">#button默认传递参数，但不重要</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;resetting UI&quot;</span>)</span><br><span class="line">        cmds.floatSlider(<span class="variable language_">self</span>.slider, edit = <span class="literal">True</span>, value = <span class="number">50</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self,*args</span>):</span><br><span class="line">        cmds.deleteUI(<span class="variable language_">self</span>.windowName)</span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<h3 id="三、Base-UI-for-different-function"><a href="#三、Base-UI-for-different-function" class="headerlink" title="三、Base UI for different function"></a><strong>三、Base UI for different function</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tween</span><br><span class="line"><span class="keyword">import</span> Gear</span><br><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseWindow</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    windowName = <span class="string">&quot;BaseWindow&quot;</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> cmds.window(<span class="variable language_">self</span>.windowName, query = <span class="literal">True</span>, exists = <span class="literal">True</span>):</span><br><span class="line">            cmds.deleteUI(<span class="variable language_">self</span>.windowName)</span><br><span class="line">        cmds.window(<span class="variable language_">self</span>.windowName)</span><br><span class="line">        <span class="variable language_">self</span>.buildUI()</span><br><span class="line">        cmds.showWindow()</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUI</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reset</span>(<span class="params">self,*args</span>):<span class="comment">#button默认传递参数，但不重要</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self,*args</span>):</span><br><span class="line">        cmds.deleteUI(<span class="variable language_">self</span>.windowName)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TweenerUI</span>(<span class="title class_ inherited__">BaseWindow</span>):<span class="comment">#继承basewindow基类</span></span><br><span class="line">    windowName = <span class="string">&quot;TweenerWindow&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUI</span>(<span class="params">self</span>):</span><br><span class="line">        column = cmds.colunmLayout()</span><br><span class="line">        cmds.text(label = <span class="string">&quot;Use this slider to set the tween amout&quot;</span>)</span><br><span class="line">        row = cmds.rowLayout(numberOfColumns = <span class="number">2</span>)</span><br><span class="line">        <span class="variable language_">self</span>.slider = cmds.floatSlider(<span class="built_in">min</span> = <span class="number">0</span>, <span class="built_in">max</span> = <span class="number">100</span>, value = <span class="number">50</span>,step = <span class="number">1</span>,changeCommand = tween)</span><br><span class="line">        cmds.button(labe = <span class="string">&quot;Reset&quot;</span>,command = <span class="variable language_">self</span>.reset)</span><br><span class="line">        </span><br><span class="line">        cmds.setParent(column)</span><br><span class="line">        cmds.button(label = <span class="string">&quot;Close&quot;</span>, command = <span class="variable language_">self</span>.close)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reset</span>(<span class="params">self,*args</span>):<span class="comment">#button默认传递参数，但不重要</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;resetting UI&quot;</span>)</span><br><span class="line">        cmds.floatSlider(<span class="variable language_">self</span>.slider, edit = <span class="literal">True</span>, value = <span class="number">50</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GearUI</span>(<span class="title class_ inherited__">BaseWindow</span>):</span><br><span class="line">    windowName = <span class="string">&quot;GearWindow&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.gear = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUI</span>(<span class="params">self</span>):</span><br><span class="line">        column = cmds.columnLayout()</span><br><span class="line">        cmds.text(label = <span class="string">&quot;Use the silider to modify the gear&quot;</span>)</span><br><span class="line">        cmds.rowLayout(numberOfColumns = <span class="number">4</span>)</span><br><span class="line">        <span class="variable language_">self</span>.label = cmds.text(label = <span class="string">&quot;10&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.slider = cmds.intSlider(<span class="built_in">min</span> = <span class="number">5</span>, <span class="built_in">max</span> = <span class="number">30</span>, value = <span class="number">10</span>,step = <span class="number">1</span>, dragCommand = <span class="variable language_">self</span>.modifyGear)</span><br><span class="line">        cmds.button(label = <span class="string">&quot;Make Gear&quot;</span>, command = <span class="variable language_">self</span>.makeGear)</span><br><span class="line">        cmds.button(label = <span class="string">&quot;Reset&quot;</span>,command = <span class="variable language_">self</span>.reset)</span><br><span class="line">        cmds.setParent(column)</span><br><span class="line">        cmds.button(label = <span class="string">&quot;Close&quot;</span>,command = <span class="variable language_">self</span>.close)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">makeGear</span>(<span class="params">self,*args</span>):</span><br><span class="line">        teeth = cmds.intSlider(<span class="variable language_">self</span>.slider,query = <span class="literal">True</span>, value = <span class="literal">True</span>)</span><br><span class="line">        <span class="variable language_">self</span>.gear = Gear()</span><br><span class="line">        <span class="variable language_">self</span>.gear.createGear(teeth = teeth)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">modifyGear</span>(<span class="params">self,teeth</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.gear:</span><br><span class="line">            <span class="variable language_">self</span>.gear.changeTeeth(teeth = teeth)</span><br><span class="line">        cmds.text(<span class="variable language_">self</span>.label,edit = <span class="literal">True</span>, label = teeth</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reset</span>(<span class="params">self,*args</span>):</span><br><span class="line">        <span class="variable language_">self</span>.gear = <span class="literal">None</span></span><br><span class="line">        cmds.intSlider(<span class="variable language_">self</span>.slider,edit = <span class="literal">True</span>,value = <span class="number">10</span>)</span><br><span class="line">                  cmds.text(<span class="variable language_">self</span>.label,eidt = <span class="literal">True</span>,label = <span class="string">&#x27;10&#x27;</span>)</span><br><span class="line">GearUI().show()</span><br></pre></td></tr></table></figure>

<h3 id="四、Add-script-to-maya-shelf"><a href="#四、Add-script-to-maya-shelf" class="headerlink" title="四、Add script to maya shelf"></a><strong>四、Add script to maya shelf</strong></h3><p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220701001501311.png" alt="image-20220701001501311"></p>
<p>直接选中脚本代码，然后拖到上面，就出现了一个按钮，一点按钮，自动运行，右键可以修改</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/18/TA/Maya/cmds%EF%BC%88%E4%B8%89%EF%BC%89/" data-id="cmfe9guiq001newuhh4njguin" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Maya/" rel="tag">Maya</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Maya/cmds（二）" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/18/TA/Maya/cmds%EF%BC%88%E4%BA%8C%EF%BC%89/">【笔记】【Maya工具】Python For Maya（Cmds）（二）Object Renamer &amp; Create Gear</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/18/TA/Maya/cmds%EF%BC%88%E4%BA%8C%EF%BC%89/" class="article-date">
  <time datetime="2022-08-18T09:16:46.000Z" itemprop="datePublished">2022-08-18</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="一、Object-Renamer"><a href="#一、Object-Renamer" class="headerlink" title="一、Object Renamer"></a><strong>一、Object Renamer</strong></h2>
        
          <p>
            <a class="article-more-link" href="/2022/08/18/TA/Maya/cmds%EF%BC%88%E4%BA%8C%EF%BC%89/">
              Read More...
            </a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/18/TA/Maya/cmds%EF%BC%88%E4%BA%8C%EF%BC%89/" data-id="cmfe9guir001pewuhc7coeasm" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Maya/" rel="tag">Maya</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Maya/cmds（一）" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/18/TA/Maya/cmds%EF%BC%88%E4%B8%80%EF%BC%89/">【笔记】【Maya工具】Python For Maya（Cmds）（一）Introduction</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/18/TA/Maya/cmds%EF%BC%88%E4%B8%80%EF%BC%89/" class="article-date">
  <time datetime="2022-08-18T09:11:48.000Z" itemprop="datePublished">2022-08-18</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h3 id="从零开始"><a href="#从零开始" class="headerlink" title="从零开始"></a>从零开始</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line">cmds.polyCube()</span><br></pre></td></tr></table></figure>

<p>maya创建了一个物体，但是其实在这里maya脚本并没有获取到这个创建的物体</p>
        
          <p>
            <a class="article-more-link" href="/2022/08/18/TA/Maya/cmds%EF%BC%88%E4%B8%80%EF%BC%89/">
              Read More...
            </a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/18/TA/Maya/cmds%EF%BC%88%E4%B8%80%EF%BC%89/" data-id="cmfe9guio001dewuh1bt794fd" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Maya/" rel="tag">Maya</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/百人计划/图形2.8flowmap的实现" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/16/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.8flowmap%E7%9A%84%E5%AE%9E%E7%8E%B0/">【笔记】【百人计划】图形2.8 flowmap的实现</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/16/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.8flowmap%E7%9A%84%E5%AE%9E%E7%8E%B0/" class="article-date">
  <time datetime="2022-08-16T08:41:28.000Z" itemprop="datePublished">2022-08-16</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h3 id="一、Flowmap是什么"><a href="#一、Flowmap是什么" class="headerlink" title="一、Flowmap是什么"></a>一、Flowmap是什么</h3><ul>
<li>Flowmap的实质<ul>
<li>一张记录了2D向量信息的纹理</li>
<li>Flowmap上的颜色（RG）记录该处向量场的方向，让模型上某一点表现出定量流动的特征</li>
<li>通过在shader中偏移uv再对纹理进行采样，来模拟流动效果。</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220806235307299.png" alt="image-20220806235307299"></p>
<p>&#x3D;&#x3D;ue4与unity相比反转了绿通道&#x3D;&#x3D;</p>
<h3 id="二、Flowmap-shader"><a href="#二、Flowmap-shader" class="headerlink" title="二、Flowmap shader"></a>二、Flowmap shader</h3><ol>
<li>采样Flowmap获取向量场信息<ul>
<li>Flowmap不能直接使用，需要从0，1映射到-1，1</li>
</ul>
</li>
<li>用向量场信息，使采样贴图时的uv随时间变化</li>
<li>对同一贴图以半个周期的相位差采集两次，并线性插值，使贴图流动连续</li>
</ol>
<ul>
<li>随着时间进行，变形越来越大，为了把偏移控制在一定范围内</li>
</ul>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> phase = frac(_Time);</span><br><span class="line"><span class="comment">// 解决frac产生的跳变</span></span><br><span class="line"><span class="comment">// 构造周期相同，相位相差半个周期的波形函数</span></span><br><span class="line"><span class="type">float</span> phase0 = frac(_Time * <span class="number">0.1</span> * _TimeSpeed);</span><br><span class="line"><span class="type">float</span> phase1 = frac(_Time * <span class="number">0.1</span> * _TimeSpeed + <span class="number">0.5</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220807000102114.png" alt="image-20220807000102114"></p>
<ul>
<li>用相位差半个周期的两层采样进行加权混合，使纹理流动一个周期重新开始时的不自然情况被另一层采样覆盖</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220807000117694.png" alt="image-20220807000117694"></p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">float2 tiling_uv = i.uv * _MainTex_ST.xy + _MainTex_ST.zw;</span><br><span class="line">half3 tex0 = tex2D(_MainTex, tiling_uv - floatDir.xy * phase0);</span><br><span class="line">half3 tex1 = tex2D(_MainTex, tiling_uv - floatDir.xy * phase1);</span><br><span class="line"><span class="comment">//构造函数计算随波形函数变化的权值，</span></span><br><span class="line"><span class="comment">//使得纹理采样值在接近最大偏移时有权值0，并因此消隐，构造较平滑的循环</span></span><br><span class="line"><span class="type">float</span> flowLerp = <span class="built_in">abs</span>((<span class="number">0.5</span>-phase0)/<span class="number">0.5</span>);</span><br><span class="line">half3 finalColor = lerp(tex0,tex1,flowLerp);</span><br></pre></td></tr></table></figure>



<h3 id="三、Flowmap的制作"><a href="#三、Flowmap的制作" class="headerlink" title="三、Flowmap的制作"></a>三、Flowmap的制作</h3><h4 id="Flowmap-painter"><a href="#Flowmap-painter" class="headerlink" title="Flowmap painter"></a>Flowmap painter</h4><p>Flowmap painter是unity制作的绘制flowmap的工具（用该工具得到的flowmap是线性空间颜色，不需要gamma矫正，在unity中取消勾选sRGB）</p>
<p>本来还以为这种东西要手动在ps里画RG通道。。。有点头疼来着，没想到这个工具这么方便，并且可以支持flow的效果实时可视化。</p>
<h4 id="Houdini-Labs"><a href="#Houdini-Labs" class="headerlink" title="Houdini Labs"></a>Houdini Labs</h4><p>Houdini Labs是内置在Houdini中的一组游戏开发相关的节点，可以在github中搜索sidefx Labs或直接在houdini中安装（在较早版本中的shoudini中无法在shelf内找到，在这些未被内置到houdini的版本中，这组工具名称为gamedev）</p>
<ol>
<li><strong>flowmap相关节点功能</strong></li>
</ol>
<ul>
<li>grid<ul>
<li>细分</li>
</ul>
</li>
<li>flowmap<ul>
<li>初始化向量场</li>
</ul>
</li>
<li>flowmap_brush<ul>
<li>向量场笔刷</li>
</ul>
</li>
<li>flowmap_to_color<ul>
<li>将向量映射到颜色</li>
<li>并添加uv（如有uv则直接沿用）</li>
</ul>
</li>
<li>flowmap_visualize<ul>
<li>可视化flowmap效果</li>
</ul>
</li>
<li>maps_baker<ul>
<li>导出</li>
<li>输出顶点色，并设置gamma（1-线性空间）</li>
</ul>
</li>
<li>flowmap_guide<ul>
<li>输入flowmap field(flowmap向量场)和曲线</li>
<li>利用曲线修改向量场</li>
</ul>
</li>
<li>flowma_obstacle<ul>
<li>输入模型和向量场</li>
<li>以模型和flowmap绘制平面进行检测，模型作为障碍，阻挡flow</li>
</ul>
</li>
</ul>
<h4 id="Flowmap的烘焙和相关设置"><a href="#Flowmap的烘焙和相关设置" class="headerlink" title="Flowmap的烘焙和相关设置"></a>Flowmap的烘焙和相关设置</h4><ul>
<li><p>flowmap贴图设置：</p>
<ul>
<li>无压缩或高质量</li>
<li>确认色彩空间</li>
</ul>
</li>
<li><p>Houdini</p>
<ul>
<li>Labs Map Baker节点</li>
<li>导出时注意gamma矫正选项、uv匹配</li>
<li>用Labs UV transfer节点来匹配高模和低模的UV</li>
</ul>
</li>
</ul>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><h4 id="实现流动效果"><a href="#实现流动效果" class="headerlink" title="实现流动效果"></a>实现流动效果</h4><p>我也是第一次听说flowmap这个概念，然后看看我的桌面壁纸发现：</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220802184553447.png" alt="image-20220802184553447"></p>
<p>这不就是flowmap做的水流效果吗？也是非常有趣。</p>
<p>作业直接拿去年图形学作业用的水面贴图拿过来用了。flowmap是用Flowmap painter画的。</p>
<p>中间平滑插值的一步看到图像其实很想用三角函数来做，但实操发现影响好像不太大，并且这个计算比起教程里的消耗会更大一点，所以还是没什么必要。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">float flowLerp = (cos(2*UNITY_PI * _Time*0.1 * _TimeSpeed)+1)/2;//abs((0.5-phase0)/0.5);//</span><br></pre></td></tr></table></figure>

<p>中间过程中一直发现有锯齿，最后发现是纹理压缩的问题，默认是法线质量压缩，在一些边缘处就会出现奇怪的锯齿</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220816163919751.png" alt="image-20220816163919751"></p>
<p>把压缩模式换成无压缩就好了（这也是为什么人家工具导出的就是png格式）。</p>
<p>感觉flowmap很适合放在球面上，加一点自发光和半透明，做成朝一个方向旋转的水元素效果。一时间想不起来这种效果的案例哪里有了。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/Flowmap.gif" alt="Flowmap"></p>
<p>感觉可以再进一步做一个顶点噪声扰动也许效果更好</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p>[1] <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Zq4y157c9">https://www.bilibili.com/video/BV1Zq4y157c9</a> </p>
<p>【技术美术百人计划】图形 2.8 flowmap的实现——流动效果实现</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/16/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.8flowmap%E7%9A%84%E5%AE%9E%E7%8E%B0/" data-id="cmfe9guj1003hewuhbg34am84" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Computer-Graphics/" rel="tag">Computer Graphics</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/" rel="tag">百人计划</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/" rel="tag">过程记录</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-Diary/2022-08-16" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/16/Diary/2022-08-16/">2022年8月16日 周二</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/16/Diary/2022-08-16/" class="article-date">
  <time datetime="2022-08-15T16:51:05.000Z" itemprop="datePublished">2022-08-16</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <p>现在是00：51，10分钟前提交了笔试邮件。<br>这两周怎么说呢。感觉也积累了学到了一些东西。<br>下次再面对这样的笔试题心里也会有底一点了（前提是知道要求的风格要怎么去做）。<br>这次的认真程度和完成程度综合给自己打个75分吧，毕竟还是有些遗憾的。<br>总得来说最终的结果勉强能让自己满意，虽然大概率达不到要求。</p>
<p>这两天要等一等友塔和不鸣的结果。感觉秋招的终局其实已经注定，剩下半个月，还需要更多更多地提升自己。<br>首先是百人计划，继续往后，一天一个，8月份也只能做完第二页。<br>另外的内容呢？想一想是接着百人还是搞一搞GAMES和Cherno的课程。<br>我感觉可以偏向后者。</p>
<p>记住晚上要练钢琴，以及每周运动一次</p>
        
          <p>
            <a class="article-more-link" href="/2022/08/16/Diary/2022-08-16/">
              Read More...
            </a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/16/Diary/2022-08-16/" data-id="cmfe9guih000kewuhh3qp1aar" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%97%A5%E5%B8%B8/" rel="tag">日常</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/百人计划/图形2.5 BUMP图改进" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/08/02/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.5%20BUMP%E5%9B%BE%E6%94%B9%E8%BF%9B/">【笔记】【百人计划】图形2.5 BUMP图改进</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/08/02/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.5%20BUMP%E5%9B%BE%E6%94%B9%E8%BF%9B/" class="article-date">
  <time datetime="2022-08-02T10:21:24.000Z" itemprop="datePublished">2022-08-02</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h3 id="一、凹凸贴图Bump-Mapping"><a href="#一、凹凸贴图Bump-Mapping" class="headerlink" title="一、凹凸贴图Bump Mapping"></a><strong>一、凹凸贴图Bump Mapping</strong></h3><ul>
<li>把物体的细节分为三种尺度<ul>
<li>宏观尺度（覆盖很多像素）<ul>
<li>由几何图元来表示</li>
</ul>
</li>
<li>中观尺度（覆盖少量像素）<ul>
<li>细节复杂，无法使用单个三角形渲染，并且足够大</li>
</ul>
</li>
<li>微观尺度（可能覆盖小于一个像素）<ul>
<li>在着色模型当中表现，模拟物体表面微观几何形状的相互作用</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>凹凸映射是模拟中观尺度的常用方法之一，能够让观察者感知到比几何模型尺度更小的细节</p>
<p>基本思想：在纹理中把尺度细节相关的信息编码进去，在着色过程中用受到干扰的表面代替真实表面，就让表面看起来具有小尺度的细节。</p>
<p>总之，凹凸贴图是对物体表面贴图进行变化再进行光照计算的一种技术。（增加物体真实感，但不需要额外的几何复杂度）</p>
<ul>
<li>分类<ul>
<li>法线贴图</li>
<li>视差贴图</li>
<li>浮雕贴图</li>
</ul>
</li>
</ul>
<p>在这三种技术中都会用到法线(贴图)</p>
<h3 id="二、法线贴图Normal-Mapping"><a href="#二、法线贴图Normal-Mapping" class="headerlink" title="二、法线贴图Normal Mapping"></a><strong>二、法线贴图Normal Mapping</strong></h3><p>法线贴图是一张存有物体局部表面法线信息的贴图。</p>
<p>计算光照时，程序读取法线图，并获取当前着色点的法线信息，结合光照信息进行光照计算。</p>
<p>法线贴图一般由高模映射到对应的底模上来生成，但像金属、木头等细节丰富的物体，可借助程序化软件如：Photoshop,Substance Designer等生成对应法线贴图</p>
<h4 id="切线空间"><a href="#切线空间" class="headerlink" title="切线空间"></a><strong>切线空间</strong></h4><p>法线的储存一般放在模型的切线空间中</p>
<ul>
<li>切线空间<ul>
<li>物体表面切线、副切线、法线方向为基，组成的几何空间</li>
</ul>
</li>
<li>读取切线空间法线，需要将法线从切线空间转换到世界空间</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220731003919885.png" alt="image-20220731003919885" style="zoom:67%;" />



<h4 id="世界和切线空间转换"><a href="#世界和切线空间转换" class="headerlink" title="世界和切线空间转换"></a><strong>世界和切线空间转换</strong></h4><p>切线空间坐标系的正交基是世界空间下的顶点法线（N）、切线（T）、副切线（B），法线为z轴，切线为x轴，副切线为y轴</p>
<p>构建一个3x3的矩阵做空间向量的坐标系转换。<br>$$<br>TBN &#x3D; \begin{bmatrix}T_x&amp;B_x&amp;N_x\<br>T_y&amp;B_y&amp;N_y\<br>T_z&amp;B_z&amp;N_z\<br>\end{bmatrix}\<br>\ \<br>TBN^{-1}&#x3D;TBN^T&#x3D;\begin{bmatrix}T_x&amp;T_y&amp;T_z\<br>B_x&amp;B_y&amp;B_z\<br>N_x&amp;N_y&amp;N_z\<br>\end{bmatrix}\<br>$$<br>想不清哪个是世界-切线，哪个是切线-世界，考虑一个单位阵，左乘矩阵，看看会变成什么就知道了。</p>
<ul>
<li>切线空间的好处<ul>
<li>切线空间记录的是相对的法线信息，对于一个物体表面记录的法线扰动，可以同样应用到球形物体上（植物的光照处理），但是模型空间记录法线就是绝对的，只能在该物体上用。</li>
<li>方便制作UV动画，贴图采样变化一致</li>
<li>法线纹理可重用</li>
<li>便于计算储存，0-1的储存映射范围，知道两个可以计算另一个</li>
</ul>
</li>
<li>Unity中法线贴图的压缩格式<ul>
<li>非移动平台，unity会把法线贴图转换成DXRT5nm格式，这种格式只有两个有效通道AG通道，可以节省空间<ul>
<li>在DXRT5nm格式中，AG通道分别储存对应法线的x，y分量，z分量需要通过一个简单的计算求得。</li>
</ul>
</li>
<li>移动平台，unity使用传统RGB通道</li>
</ul>
</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/7416ead6-fc7e-4e52-9dba-b56d68996a2a.png" alt="7416ead6-fc7e-4e52-9dba-b56d68996a2a" style="zoom: 33%;" />

<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/8b45fbb7-0987-4b01-9c95-c47166d160b4.png" alt="8b45fbb7-0987-4b01-9c95-c47166d160b4" style="zoom: 67%;" />



<h3 id="三、视差贴图Parallax-Mapping"><a href="#三、视差贴图Parallax-Mapping" class="headerlink" title="三、视差贴图Parallax Mapping"></a><strong>三、视差贴图Parallax Mapping</strong></h3><p>法线贴图只能改变法线而改变光照，无法使模型表面产生遮挡效果</p>
<p>视差贴图Parallax Mapping是一种类似法线贴图的技术。它用于提高模型表面细节并赋予其遮挡关系，可以和法线贴图一起使用。</p>
<p>视差贴图需要引进一张新的贴图——高度图。高度图一般是用于顶点位移使用的（位移&#x2F;置换贴图 Displacement mapping），但性能消耗高，需要大量三角形。视差贴图的核心是改变纹理坐标来改变遮挡关系，视差贴图就利用储存模型信息的高度图，<strong>利用模型表面高度信息来对纹理进行偏移</strong>。</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220731010656743.png" alt="image-20220731010656743" style="zoom: 67%;" />

<p>在着色时，模型在切线空间下所有点都在切平面内（0.0），核心就是对于要计算的片元A时，真正应该计算的点是视线与物体的“实际”交点B点。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220731011441775.png" alt="image-20220731011441775"></p>
<p>要计算B点，就需要AB两点在平面上的UV偏差，为了简便，采取近似计算的方法，根据高（深）度图及切线空间下视角方向，近似求解偏移量，视角方向（v）与切平面的正切值与A点的高度值相乘来近似求解，并通过一个缩放值来控制。（有比较大的误差，必须要用这个scale来调整）<br>$$<br>d &#x3D; \frac{v.xy}{v.z}\cdot ha\cdot scale<br>$$</p>
<h4 id="陡峭视察映射Steep-Parallax-Mapping"><a href="#陡峭视察映射Steep-Parallax-Mapping" class="headerlink" title="陡峭视察映射Steep Parallax Mapping"></a>陡峭视察映射Steep Parallax Mapping</h4><p>陡峭视察映射也是近似，但更准确一些</p>
<p>陡峭视察映射将深度分为等距的若干层，从顶端开始采样，并且每次沿视角方向偏移一定值，若当前层深度大于采样出的深度，则停止检查并返回结果</p>
<p>（有点ray marching的感觉，那其实在优化上也可以借鉴一下分级采样？<a target="_blank" rel="noopener" href="https://xzyw7.github.io/post/CbZTf-uM4/#real-time-global-illuminationscreen-space%EF%BC%89">https://xzyw7.github.io/post/CbZTf-uM4/#real-time-global-illuminationscreen-space）</a></p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220731012950141.png" alt="image-20220731012950141"></p>
<p>也可以根据v和n的角度来对采样层数进行控制</p>
<h3 id="四、浮雕贴图Relief-Mapping"><a href="#四、浮雕贴图Relief-Mapping" class="headerlink" title="四、浮雕贴图Relief Mapping"></a><strong>四、浮雕贴图Relief Mapping</strong></h3><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220731014135800.png" alt="image-20220731014135800" style="zoom:50%;" />

<p>视差贴图在使用较大的uv偏移时存在失真。</p>
<p>浮雕贴图更容易提供更多的深度，还可以做自阴影、AO效果</p>
<h4 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h4><p>浮雕映射一般采用射线步进、二分查找来决定uv偏移量</p>
<p>第一种使用射线步进来查找可能的交点（直接用二分查找可能漏掉较薄的区域导致结果不准确），确定交点位于哪一个步进内。之后在该步进内使用二分查找快速确定交点位置，最后返回结果，偏移贴图。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220731014352296.png" alt="image-20220731014352296"></p>
<ul>
<li>解决最后一步二分查找性能开销问题<ul>
<li>视差闭塞贴图（Parallax Occlusion Mapping）</li>
<li>在步进后，分别对步进两端uv值采样，对结果插值，作为p点的结果（插值导致表面平滑效果更好）</li>
</ul>
</li>
</ul>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a><strong>作业</strong></h3><p>结合先行版基础渲染光照介绍（一）将本次课所讲的案例结合进先前的光照效果</p>
<p>这里就4个案例嘛</p>
<h4 id="法线贴图"><a href="#法线贴图" class="headerlink" title="法线贴图"></a>法线贴图</h4><p>左一：standard shader</p>
<p>左二：custom shader，使用法线贴图</p>
<p>右一：custom shader，无法线贴图</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220801232026790.png" alt="image-20220801232026790"></p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">struct v2f &#123;</span><br><span class="line">    float4 pos : SV_POSITION;</span><br><span class="line">    float3 normal : TEXCOORD0;</span><br><span class="line">    float3 worldPos : TEXCOORD1;</span><br><span class="line">    float2 uv : TEXCOORD2;</span><br><span class="line">    float3 tangent : TEXCOORD3;</span><br><span class="line">    float3 bitangent : TEXCOORD4;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">fixed3 normal = <span class="built_in">normalize</span>(i.normal);</span><br><span class="line">fixed3x3 TBN = fixed3x3(<span class="built_in">normalize</span>(i.tangent),<span class="built_in">normalize</span>(i.bitangent),normal);</span><br><span class="line">TBN = <span class="built_in">transpose</span>(TBN);<span class="comment">//Unity shader的矩阵是行优先的，所以我们要取个转置；</span></span><br><span class="line">fixed3 bump = <span class="built_in">normalize</span>(UnpackNormal(tex2D(_Normal, i.uv)));</span><br><span class="line">normal = <span class="built_in">normalize</span>(mul(TBN,bump));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>不想像入门精要那样传一整个矩阵，我们可以传递的变量也是有限的，甚至可以只传tangent，副切线用叉乘计算。甚至也可以用之前的ddx和ddy的trick来计算。</p>
<p><a target="_blank" rel="noopener" href="https://xzyw7.github.io/post/zezxM-QCJ/#ddxddy%E4%B8%8E%E6%B3%95%E7%BA%BF%E8%B4%B4%E5%9B%BE">https://xzyw7.github.io/post/zezxM-QCJ/#ddxddy%E4%B8%8E%E6%B3%95%E7%BA%BF%E8%B4%B4%E5%9B%BE</a></p>
<p>（Tips：有注意到在learnopengl中有描述，在一些网格较大的时候，出现TBN不互相垂直的情况，可以用施密特正交化来解决。）</p>
<h4 id="视差贴图"><a href="#视差贴图" class="headerlink" title="视差贴图"></a>视差贴图</h4><p>这个时候发现……狮子模型这个素材没有高度图……还得换个素材……</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">fixed3 LightDir = <span class="built_in">normalize</span>(UnityWorldSpaceLightDir(i.worldPos));<span class="comment">//normalize(_WorldSpaceLightPos0.xyz);//</span></span><br><span class="line">fixed3 ViewDir = <span class="built_in">normalize</span>(UnityWorldSpaceViewDir(i.worldPos));<span class="comment">//normalize(_WorldSpaceCameraPos.xyz - i.worldPos);</span></span><br><span class="line">float3 h = <span class="built_in">normalize</span>(LightDir + ViewDir);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fixed3 normal = <span class="built_in">normalize</span>(i.normal);</span><br><span class="line">fixed3 bitangent = <span class="built_in">normalize</span>(<span class="built_in">cross</span>(normal,i.tangent.xyz) * i.tangent.w);</span><br><span class="line">fixed3x3 TBN = fixed3x3(<span class="built_in">normalize</span>(i.tangent.xyz),bitangent,normal);</span><br><span class="line">TBN = <span class="built_in">transpose</span>(TBN);</span><br><span class="line"></span><br><span class="line"><span class="comment">//视差贴图</span></span><br><span class="line"><span class="type">float</span> height = tex2D(_heightMap,i.uv).r;</span><br><span class="line">float3 ViewDirTS = <span class="built_in">normalize</span>(mul(<span class="built_in">transpose</span>(TBN),ViewDir));</span><br><span class="line">float2 offUV = ViewDirTS.xy/ViewDirTS.z * height * _heightScale;</span><br><span class="line">i.uv -= offUV;</span><br><span class="line"></span><br><span class="line"><span class="comment">//法线贴图</span></span><br><span class="line">fixed3 bump = <span class="built_in">normalize</span>(UnpackNormal(tex2D(_Normal, i.uv)));</span><br><span class="line">normal = <span class="built_in">normalize</span>(mul(TBN,bump));</span><br></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220802000836213.png" alt="image-20220802000836213"></p>
<p>视差贴图在视线接近垂直的时候效果还是很好的，但是正如learnopengl中所说，当从一个角度看过去的时候，会有一些问题产生（和法线贴图相似），陡峭的地方会产生不正确的结果。并且它的效果非常依赖于_heightScale这一参数</p>
<h4 id="陡峭视差贴图"><a href="#陡峭视差贴图" class="headerlink" title="陡峭视差贴图"></a>陡峭视差贴图</h4><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">float2 steepParallaxMapping (float2 uv, float3 viewDir) &#123;</span><br><span class="line">    <span class="type">float</span> numLayers = <span class="number">20</span>;</span><br><span class="line">    <span class="type">float</span> layerHeight = <span class="number">1.0</span>/numLayers;</span><br><span class="line">    float2 deltaUV = <span class="number">1.0</span>/numLayers * viewDir.xy / viewDir.z * _heightScale;</span><br><span class="line">    float2 currentUV = uv;</span><br><span class="line">    <span class="type">float</span> currentHeight = tex2D(_heightMap,uv).r;</span><br><span class="line">    <span class="type">float</span> currentLayerHeight = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">while</span>(currentLayerHeight &lt; currentHeight)</span><br><span class="line">    &#123;</span><br><span class="line">        currentUV -= deltaUV;</span><br><span class="line">        currentHeight = tex2Dlod(_heightMap, float4(currentUV,<span class="number">0.0</span>,<span class="number">0.0</span>)).r;</span><br><span class="line">        <span class="comment">//currentHeight = tex2Dgrad(_heightMap, currentUV,0.0,0.0).r;  </span></span><br><span class="line">        currentLayerHeight += layerHeight;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> currentUV;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>中间一直出现的报错“unable to unroll loop”，给tex2D改成tex2Dlod或tex2Dgrad就好了</p>
<p>参考</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/391443312">https://zhuanlan.zhihu.com/p/391443312</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/144434084">https://zhuanlan.zhihu.com/p/144434084</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/57994423/why-i-cant-use-tex2d-inside-a-loop-in-unity-shaderlab">https://stackoverflow.com/questions/57994423/why-i-cant-use-tex2d-inside-a-loop-in-unity-shaderlab</a></p>
<p><em>tex2D只能从“均匀控制流”调用，因为它必须通过计算“导数”来计算LOD。tex2Dlod没有，因为您提供了LOD。</em></p>
<p>tex2Dlod和tex2Dgrad都能指定纹理层，所以能够在循环中调用。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220802161513119.png" alt="image-20220802161513119"></p>
<h4 id="浮雕贴图"><a href="#浮雕贴图" class="headerlink" title="浮雕贴图"></a>浮雕贴图</h4><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">float2 steepParallaxMapping (float2 uv, float3 viewDir) &#123;</span><br><span class="line">    <span class="type">float</span> numLayers = <span class="number">20</span>;</span><br><span class="line">    <span class="type">float</span> layerHeight = <span class="number">1.0</span>/numLayers;</span><br><span class="line">    float2 deltaUV = <span class="number">1.0</span>/numLayers * viewDir.xy / viewDir.z * _heightScale;</span><br><span class="line">    float2 currentUV = uv;</span><br><span class="line">    <span class="type">float</span> currentHeight = tex2D(_heightMap,uv).r;</span><br><span class="line">    <span class="type">float</span> currentLayerHeight = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">while</span>(currentLayerHeight &lt; currentHeight)</span><br><span class="line">    &#123;</span><br><span class="line">        currentUV -= deltaUV;</span><br><span class="line">        currentHeight = tex2Dlod(_heightMap, float4(currentUV,<span class="number">0.0</span>,<span class="number">0.0</span>)).r;  </span><br><span class="line">        currentLayerHeight += layerHeight;  </span><br><span class="line">    &#125;</span><br><span class="line">    float2 left = currentUV;</span><br><span class="line">    float2 right = currentUV+deltaUV;</span><br><span class="line">    <span class="type">float</span> dist = <span class="number">1</span>;</span><br><span class="line">    float2 midpoint = (left+right)/<span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i&lt;<span class="number">10</span>) &#123;</span><br><span class="line">        midpoint = (left+right)/<span class="number">2</span>;</span><br><span class="line">        currentHeight = tex2Dlod(_heightMap, float4(midpoint,<span class="number">0.0</span>,<span class="number">0.0</span>)).r;</span><br><span class="line">        currentLayerHeight = <span class="built_in">length</span>(midpoint)/<span class="built_in">length</span>(viewDir.xy) * viewDir.z;</span><br><span class="line">        <span class="keyword">if</span> (currentLayerHeight &lt; currentHeight) &#123;</span><br><span class="line">            right = midpoint;</span><br><span class="line">            dist = currentHeight - currentLayerHeight;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentLayerHeight &gt; currentHeight) &#123;</span><br><span class="line">            left = midpoint;</span><br><span class="line">            dist = -currentHeight + currentLayerHeight;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> midpoint;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="视察闭塞贴图"><a href="#视察闭塞贴图" class="headerlink" title="视察闭塞贴图"></a>视察闭塞贴图</h4><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">float2 left = currentUV;</span><br><span class="line">float2 right = currentUV+deltaUV;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> afterDepth  = currentHeight-currentLayerHeight;</span><br><span class="line"><span class="type">float</span> beforeDepth = tex2D(_heightMap, right).r -currentLayerHeight + layerHeight;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> weight = afterDepth / (afterDepth - beforeDepth);</span><br><span class="line">float2 finalTexCoords = right * weight + left * (<span class="number">1.0</span> - weight);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> finalTexCoords;</span><br></pre></td></tr></table></figure>

<p>POM是肉眼可见的效果不错（上：SPM，中：RPM，下：POM），RPM就不太能看得出变化了，但其实还是有的</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220802175923830.png" alt="image-20220802175923830" style="width:80%;" />

<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220802180825768.png" alt="image-20220802180825768" style="width:80%;" />

<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220802175853495.png" alt="image-20220802175853495" style="width:80%;" />

<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a><strong>参考资料</strong></h4><p>[1] <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Ub4y1Z765">https://www.bilibili.com/video/BV1Ub4y1Z765</a> 【技术美术百人计划】图形 2.5 BUMP图改进</p>
<p>[2] Unity Shader入门精要 p146-155</p>
<p>[3]<br><a target="_blank" rel="noopener" href="https://learnopengl-cn.github.io/05%20Advanced%20Lighting/05%20Parallax%20Mapping/">https://learnopengl-cn.github.io/05%20Advanced%20Lighting/05%20Parallax%20Mapping/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/02/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.5%20BUMP%E5%9B%BE%E6%94%B9%E8%BF%9B/" data-id="cmfe9guiz0038ewuh7dkn22nw" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Computer-Graphics/" rel="tag">Computer Graphics</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/" rel="tag">百人计划</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/" rel="tag">过程记录</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/百人计划/图形2.7LDR与HDR" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/07/31/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.7LDR%E4%B8%8EHDR/">【笔记】【百人计划】图形2.7 LDR与HDR</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/07/31/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.7LDR%E4%B8%8EHDR/" class="article-date">
  <time datetime="2022-07-31T14:43:12.000Z" itemprop="datePublished">2022-07-31</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h3 id="一、基本概念"><a href="#一、基本概念" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><p>HDR &#x3D; High Dynamic Range（高动态范围）</p>
<p>LDR &#x3D; Low Dynamic Range（低动态范围）</p>
<p>动态范围 &#x3D; 最高亮度&#x2F;最低亮度</p>
<ul>
<li><p>对于显示器来说，实际的物理亮度是不同意的。因此需要匹配LDR0-1的范围</p>
</li>
<li><p>自然界中的亮度是HDR的</p>
<ul>
<li>在显示时需要转换到LDR的范围（Tone mapping色调映射）</li>
</ul>
</li>
<li><p>LDR</p>
<ul>
<li>8位精度</li>
<li>单通道0-1（0-255）</li>
<li>常用LDR图片储存格式<ul>
<li>jpg、png等</li>
</ul>
</li>
<li>拾色器、一般图片、电脑屏幕</li>
</ul>
</li>
<li><p>HDR</p>
<ul>
<li>远高于8位精度</li>
<li>单通道可以超过1</li>
<li>常用HDR图片储存格式<ul>
<li>hdr&#x2F;tif&#x2F;exr&#x2F;raw</li>
</ul>
</li>
<li>HDRI、真实世界</li>
</ul>
</li>
</ul>
<h4 id="为什么需要HDR"><a href="#为什么需要HDR" class="headerlink" title="为什么需要HDR"></a>为什么需要HDR</h4><ul>
<li>更好地色彩，更高的动态范围和更丰富的细节，并有效地防止画面国宝，超过亮度值1的色彩也能很好地表现，像素光亮度变得正常，视觉传达更真实。</li>
<li>HDR有超过1的数值，范围更大，能让bloom的表现更好。</li>
</ul>
<h4 id="一些HDR图网站"><a href="#一些HDR图网站" class="headerlink" title="一些HDR图网站"></a>一些HDR图网站</h4><p><a target="_blank" rel="noopener" href="http://www.hdrlabs.com/sibl/archive.html">http://www.hdrlabs.com/sibl/archive.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.openfootage.net/hdri-panorama/">https://www.openfootage.net/hdri-panorama/</a></p>
<h3 id="二、Unity中的HDR"><a href="#二、Unity中的HDR" class="headerlink" title="二、Unity中的HDR"></a>二、Unity中的HDR</h3><h4 id="Camera-HDR设置"><a href="#Camera-HDR设置" class="headerlink" title="Camera-HDR设置"></a>Camera-HDR设置</h4><ul>
<li>场景将渲染为HDR图像缓冲区</li>
<li>后处理：Bloom&amp;Tone mapping</li>
<li>完成转换HDR-&gt;LDR</li>
<li>LDR图像发送给显示器</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730183404967.png" alt="image-20220730183404967" style="zoom:67%;" />

<h4 id="Lightmap-HDR设置"><a href="#Lightmap-HDR设置" class="headerlink" title="Lightmap HDR设置"></a>Lightmap HDR设置</h4><ul>
<li>选择High Quality 将启用HDR光照贴图支持，而Normal Quality将切换为使用RGBM编码</li>
<li>RGBM编码：将颜色存储在RGB通道中，将乘数M储存在Alpha通道中</li>
</ul>
<p>（项目设置-Player-Other settings-Lightmap Encoding）</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730183556522.png" alt="image-20220730183556522" style="zoom:67%;" />

<h4 id="拾色器HDR设置"><a href="#拾色器HDR设置" class="headerlink" title="拾色器HDR设置"></a>拾色器HDR设置</h4><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[HDR] _BackColor(&quot;BackColor&quot;, Color) = (<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>使用Intensity滑动条可调整颜色强度</li>
<li>每增加1，提供的光亮增加一倍</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730183703721.png" alt="image-20220730183703721"></p>
<h4 id="HDR的优缺点"><a href="#HDR的优缺点" class="headerlink" title="HDR的优缺点"></a>HDR的优缺点</h4><ul>
<li>优点<ul>
<li>画面中亮度超过1的部分不会被截为1，增加亮部细节并减少曝光</li>
<li>减少画面较暗部分的色阶感</li>
<li>更好地支持Bloom</li>
</ul>
</li>
<li>缺点<ul>
<li>渲染速度较慢，需要更多显存</li>
<li>不支持硬件AA</li>
<li>部分手机不支持</li>
</ul>
</li>
</ul>
<h3 id="三、HDR与Bloom"><a href="#三、HDR与Bloom" class="headerlink" title="三、HDR与Bloom"></a>三、HDR与Bloom</h3><p>Bloom用于表现高光的晕光效果</p>
<p><em>为实现泛光，我们像平时那样渲染一个有光场景，提取出场景的HDR颜色缓冲以及只有这个场景明亮区域可见的图片。被提取的带有亮度的图片接着被模糊，结果被添加到HDR场景上面。（learnopengl）</em></p>
<h4 id="unity中的BLoom"><a href="#unity中的BLoom" class="headerlink" title="unity中的BLoom"></a>unity中的BLoom</h4><p>Untiy会首先进行下采样（down sample）来计算高光像素，并存在RT中，完成次数由一个参数控制，再up回去，并将下采样的RT加入进去。</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730184829163.png" alt="image-20220730184829163" style="zoom:50%;" />

<p>我对这个操作目前的理解是，和learnopengl中为了完成高斯模糊是一样的</p>
<p><img src="https://learnopengl-cn.github.io/img/05/07/bloom_gaussian.png" alt="img"></p>
<p>在毛星云大佬的  《高品质后处理：十种图像模糊算法的总结与实现》中也可以看到对各种模糊算法的解释，如果说是以多次的Box filtering来近似高斯模糊或者其他模糊效果的话，就很好理解了。</p>
<h3 id="四、HDR与Tone-mapping"><a href="#四、HDR与Tone-mapping" class="headerlink" title="四、HDR与Tone mapping"></a>四、HDR与Tone mapping</h3><p>色调映射就是为了把HDR转化为LDR</p>
<ul>
<li>线性映射效果不好</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730185314765.png" alt="image-20220730185314765" style="zoom:50%;" />



<ul>
<li>把高光区域和阴影区域像中等亮度方向压缩-&gt;S曲线</li>
</ul>
<h4 id="ACES"><a href="#ACES" class="headerlink" title="ACES"></a>ACES</h4><p>ACES（Academy Color Encoding System学院颜色编码系统）</p>
<p>效果：对比度提高，很好地保留暗处和亮出的细节</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730185423773.png" alt="image-20220730185423773" style="zoom:50%;" />

<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ACES</span></span><br><span class="line"><span class="comment">//https://knarkowicz.wordpress.com/2016/01/06/aces-filmic-tone-mapping-curve/</span></span><br><span class="line">float3 ACESToneMapping(float3 color, <span class="type">float</span> adapted_lum)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="type">float</span> A = <span class="number">2.51</span>f;</span><br><span class="line">	<span class="keyword">const</span> <span class="type">float</span> B = <span class="number">0.03</span>f;</span><br><span class="line">	<span class="keyword">const</span> <span class="type">float</span> C = <span class="number">2.43</span>f;</span><br><span class="line">	<span class="keyword">const</span> <span class="type">float</span> D = <span class="number">0.59</span>f;</span><br><span class="line">	<span class="keyword">const</span> <span class="type">float</span> E = <span class="number">0.14</span>f;</span><br><span class="line"></span><br><span class="line">	color *= adapted_lum;</span><br><span class="line">	<span class="keyword">return</span> (color * (A * color + B)) / (color * (C * color + D) + E);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他Tone mapping曲线</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730185538359.png" alt="image-20220730185538359" style="zoom:50%;" />

<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Reinhard</span></span><br><span class="line">float3 ReinhardToneMapping(float3 color, <span class="type">float</span> adapted_lum) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="type">float</span> MIDDLE_GREY = <span class="number">1</span>;</span><br><span class="line">    color *= MIDDLE_GREY / adapted_lum;</span><br><span class="line">    <span class="keyword">return</span> color / (<span class="number">1.0</span>f + color);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// CE</span></span><br><span class="line">float3 CEToneMapping(float3 color, <span class="type">float</span> adapted_lum) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - <span class="built_in">exp</span>(-adapted_lum * color);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Filmic</span></span><br><span class="line">float3 F(float3 x)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="type">float</span> A = <span class="number">0.22</span>f;</span><br><span class="line">	<span class="keyword">const</span> <span class="type">float</span> B = <span class="number">0.30</span>f;</span><br><span class="line">	<span class="keyword">const</span> <span class="type">float</span> C = <span class="number">0.10</span>f;</span><br><span class="line">	<span class="keyword">const</span> <span class="type">float</span> D = <span class="number">0.20</span>f;</span><br><span class="line">	<span class="keyword">const</span> <span class="type">float</span> E = <span class="number">0.01</span>f;</span><br><span class="line">	<span class="keyword">const</span> <span class="type">float</span> F = <span class="number">0.30</span>f;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">return</span> ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - E / F;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float3 Uncharted2ToneMapping(float3 color, <span class="type">float</span> adapted_lum)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="type">float</span> WHITE = <span class="number">11.2</span>f;</span><br><span class="line">	<span class="keyword">return</span> F(<span class="number">1.6</span>f * adapted_lum * color) / F(WHITE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="LUT"><a href="#LUT" class="headerlink" title="LUT"></a>LUT</h4><p>在Color Grading的All None 模式中有一个Lookup Texture（滤镜）</p>
<ul>
<li><p>LUT在LDR之间做变换，Tone mapping是映射HDR到LDR</p>
</li>
<li><p>调整rgb三个通道的LUT被称为3D LUT</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/v2-cc29cf797d187c730f13cfc0bf520714_720w.png" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/v2-c7d19e036fe6edf8df4d5e694874df50_720w.jpg" alt="img"></p>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><h4 id="结合先行版基础渲染光照介绍（一）试试IBL在HDR和LDR的区别"><a href="#结合先行版基础渲染光照介绍（一）试试IBL在HDR和LDR的区别" class="headerlink" title="结合先行版基础渲染光照介绍（一）试试IBL在HDR和LDR的区别"></a>结合先行版基础渲染光照介绍（一）试试IBL在HDR和LDR的区别</h4><p>相机设置HDR</p>
<p>左侧探针设置LDR，右侧探针设置HDR，都是1024的分辨率</p>
<p>在生成的贴图上可以看到，一张是exr后缀的HDR贴图，一张是png后缀的LDR贴图。</p>
<p>把它放在我们的材质上，说实话我没看出来有啥区别……</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220731223034086.png" alt="image-20220731223034086"></p>
<p>但是随着Lod层级的增加，就可以看出来区别了</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220731223343672.png" alt="image-20220731223343672" style="width: 50%;" />

<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220731223409296.png" alt="image-20220731223409296" style="width: 50%;" />

<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220731223432177.png" alt="image-20220731223432177" style="width:50%;" />

<p>非常地合情合理，在HDR中储存的辐射度范围是大于0-1的，在mipmap中也会储存更高动态范围的光照，在ibl里的细节也就更丰富。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p>[1] <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1VA41137Wp">https://www.bilibili.com/video/BV1VA41137Wp</a> ,【技术美术百人计划】图形 2.7  LDR与HDR</p>
<p>[2] <a target="_blank" rel="noopener" href="https://learnopengl-cn.github.io/05%20Advanced%20Lighting/07%20Bloom/">https://learnopengl-cn.github.io/05%20Advanced%20Lighting/07%20Bloom/</a></p>
<p>[3] <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/125744132">https://zhuanlan.zhihu.com/p/125744132</a> ,高品质后处理：十种图像模糊算法的总结与实现</p>
<p>[4] Unity Shader入门精要 p361,362</p>
<p>[5] <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/21983679">https://zhuanlan.zhihu.com/p/21983679</a> ,Tone mapping进化论</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/07/31/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.7LDR%E4%B8%8EHDR/" data-id="cmfe9guj1003lewuhf7eh6x0v" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Computer-Graphics/" rel="tag">Computer Graphics</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/" rel="tag">百人计划</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/" rel="tag">过程记录</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-Diary/2022-07-31" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/07/31/Diary/2022-07-31/">2022年7月31日 周日</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/07/31/Diary/2022-07-31/" class="article-date">
  <time datetime="2022-07-31T13:45:05.000Z" itemprop="datePublished">2022-07-31</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <p>今天刚好是个特别的日子，7月的最后一天，也是这周的最后一天。<br>以7月15日来划分的话，前半个月在上短学期的maya课程，这段时间的状态非常好，准时起床，坚持学习，每天的作息非常规律，也每天能感觉到学到东西。</p>
<p>但是7月15日以后的半个月，稍微有点放纵。没有回家，是希望能冲刺一下，准备秋招。<br>虽然这半个月也有在推进百人计划，但是我觉得完全可以效率更高。每天的有效学习时间也没有达到理想的状况，作息更是稳定的不理想，尤其是今天。</p>
<p>也可以理解吧，毕竟出了一些烦心事，常常陷入自我怀疑，一些提前批的失败，以及出乎意料的需要提前做米哈游的笔试。早知道就晚点投了，主要还是上当了……<br>明天就要开始，但我感觉完全不是准备好的状态。有点不知道怎么做了。</p>
<p>为了减少精神内耗与自我放纵，买了一个电子琴，明天就能到。<br>而接下来的半个月时间里，真的需要进入认真的状态了，就像7月前半个月一样，甚至需要更努力。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/07/31/Diary/2022-07-31/" data-id="cmfe9guig000hewuh1qcsbdzb" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%97%A5%E5%B8%B8/" rel="tag">日常</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/百人计划/图形2.6 伽马校正" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      
  
  <h2 class="article-title" itemprop="name">
    <a href="/2022/07/30/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.6%20%E4%BC%BD%E9%A9%AC%E6%A0%A1%E6%AD%A3/">【笔记】【百人计划】图形2.6 伽马校正</a>
  </h2>
  
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2022/07/30/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.6%20%E4%BC%BD%E9%A9%AC%E6%A0%A1%E6%AD%A3/" class="article-date">
  <time datetime="2022-07-30T09:40:10.000Z" itemprop="datePublished">2022-07-30</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h3 id="Gamma矫正"><a href="#Gamma矫正" class="headerlink" title="Gamma矫正"></a><strong>Gamma矫正</strong></h3><p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730122434969.png" alt="image-20220730122434969"></p>
<h4 id="传递函数"><a href="#传递函数" class="headerlink" title="传递函数"></a><strong>传递函数</strong></h4><ul>
<li>OETF<ul>
<li>光转电传递函数 ，负责把场景线性光转到非线性视频信号值</li>
</ul>
</li>
<li>EOTF<ul>
<li>电转光传递函数，负责把非线性视频信号值转换成显示光亮度</li>
</ul>
</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730122710864.png" alt="image-20220730122710864" style="zoom:50%;" />

<h4 id="Gamma矫正-1"><a href="#Gamma矫正-1" class="headerlink" title="Gamma矫正"></a>Gamma矫正</h4><ul>
<li>Gamma是指对线性三色值和非线性视频信号之间进行编码和解码的操作</li>
<li>图像经过gamma编码储存在硬盘中，将获取到的物理数据做一次gamma值约为0.45(1&#x2F;2.2)的映射，这样的过程叫做gamma编码（此时的图像像素比实际物理像素要更亮——线性空间）</li>
<li>在显示图像时，需要将每个像素做一次gamma值约为2.2的矫正，使最终的结果为正确的物理数据（经过显示的gamma矫正后，之前偏亮的图像亮度降低——gamma空间）</li>
</ul>
<p>$$<br>V_{out}&#x3D;V_{in}^{gamma}<br>$$</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730144948798.png" alt="image-20220730144948798" style="zoom:80%;" />

<h4 id="为什么需要gamma矫正"><a href="#为什么需要gamma矫正" class="headerlink" title="为什么需要gamma矫正"></a><strong>为什么需要gamma矫正</strong></h4><ul>
<li>非线性转换的目的主要是为了优化储存空间和带宽，传递函数能够更好地利用编码空间</li>
<li>显示图像的数据都是8bit，但是人眼对暗部变化更敏感，为了充分利用带宽，那么需要使用更多空间去存储暗部值，也就是说暗部使用更高精度保存，亮部使用更低精度保存。</li>
</ul>
<p>以这张图来说明，对于人眼来说，上面的图像变化更均匀，但实际下面的图像才是物理上亮度均匀变化的。</p>
<p>（上面这张的中间灰度叫做美术中灰，下面的中间灰度叫做物理中灰）</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730145336723.png" alt="image-20220730145336723" style="zoom:50%;" />

<p>将这两种变化进行一个映射，就是gamma曲线 </p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730145547142.png" alt="image-20220730145547142" style="zoom:50%;" />



<h4 id="韦伯定律"><a href="#韦伯定律" class="headerlink" title="韦伯定律"></a><strong>韦伯定律</strong></h4><ul>
<li>感觉的差别阈限随原来刺激量的变化而变化，而且表现为一定的规律性，用公式表达就是$\Delta\Phi&#x2F;\Phi &#x3D; C$ ，其中$\Phi$ 为原刺激量，$\Delta\Phi$ 为此时的差别阈限，C为常数，又称为韦伯率。（所受刺激越大，需要增加的刺激也要足够大才会让人感觉到明显变化，但是只适用于中等强度的刺激）</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h4><ul>
<li>人眼对暗部变化更敏感</li>
<li>我们目前使用的真彩格式RGBA32，每个通道只有8位用于记录信息，为了合理使用带宽和存储空间，需要进行非线性转换</li>
<li>目前我们所普遍使用的sRGB颜色空间标准，他的传递函数gamma值位2.2（2.4）</li>
</ul>
<h3 id="CRT与gamma矫正"><a href="#CRT与gamma矫正" class="headerlink" title="CRT与gamma矫正"></a><strong>CRT与gamma矫正</strong></h3><ul>
<li>CRT<ul>
<li>早期使用的CRT显示器（阴极射线显像管），设备的亮度与电压并不成线性关系，而是gamma值约为2.2类似幂律的关系</li>
<li>这种硬件特性与gamma矫正的需求正好是一种巧合</li>
</ul>
</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730150841828.png" alt="image-20220730150841828" style="zoom: 67%;" />

<p>人眼对于中灰的感受取决于环境</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730151319961.png" alt="image-20220730151319961" style="zoom:50%;" />

<ul>
<li>线性工作流<ul>
<li>在生产各个环境，需要正确使用gamma编码与解码，使最终得到的颜色数据与最初输入的物理数据一致</li>
<li>如果是使用gamma空间的贴图，在传给着色器前需要从gamma空间转到线性空间</li>
</ul>
</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730154948879.png" alt="image-20220730154948879" style="zoom:67%;" />

<p> <img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730155223847.png" alt="image-20220730155223847"></p>
<h3 id="Unity中的颜色空间"><a href="#Unity中的颜色空间" class="headerlink" title="Unity中的颜色空间"></a><strong>Unity中的颜色空间</strong></h3><p>Edit-Project Settings-Player-Other Settings下的Rendering部分，修改Color Space</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730155540487.png" alt="image-20220730155540487"></p>
<ul>
<li>选择Gamma Space，Unity不会做任何处理</li>
<li>选择Linear Space，引擎的渲染流程在线性空间计算，理想情况下项目使用线性空间的贴图，不需要勾选sRGB，勾选sRGB的贴图会通过硬件特性采样时进行线性转换。</li>
</ul>
<h4 id="硬件支持"><a href="#硬件支持" class="headerlink" title="硬件支持"></a><strong>硬件支持</strong></h4><p>线性空间需要图形API的硬件支持，目前支持的平台</p>
<ol>
<li>Windows，Mac OS x和Linux（Standalone）</li>
<li>Xbox One</li>
<li>PS 4</li>
<li>Android（Opengl ES 3.0）</li>
<li>iOS（Metal）</li>
<li>WebGL</li>
</ol>
<h4 id="硬件特性支持"><a href="#硬件特性支持" class="headerlink" title="硬件特性支持"></a><strong>硬件特性支持</strong></h4><p>主要由两个硬件特性来支持</p>
<ul>
<li><p>sRGB Frame Buffer</p>
<ul>
<li>将Shader的计算结果输出到显示器前做Gamma矫正</li>
<li>作为纹理被读取时会自动把储存的颜色从sRGB空间转换到线性空间</li>
<li>调用ReadPixels()、ReadBackImage()时，会直接返回sRGB空间下的颜色</li>
<li>sRGB Frame Buffer只支持每通道8bit的格式，不支持浮点格式</li>
<li>HDR开启后会先把渲染结果绘制到浮点格式的FB中，最后绘制到sRGB FB上</li>
</ul>
</li>
<li><p>sRGB Sampler</p>
<ul>
<li>将sRGB的贴图进行线性采样的转换</li>
</ul>
</li>
</ul>
<p>使用硬件完成sRGB贴图的线性采样和shader计算结果的gamma矫正，比起在shader里对贴图采样和计算结果的矫正要快</p>
<h3 id="贴图制作导出的处理"><a href="#贴图制作导出的处理" class="headerlink" title="贴图制作导出的处理"></a><strong>贴图制作导出的处理</strong></h3><h4 id="Substance-Painter"><a href="#Substance-Painter" class="headerlink" title="Substance Painter"></a><strong>Substance Painter</strong></h4><p>sp贴图导出时，线性的颜色经过gamma变换，颜色被提亮了，所以需要在Unity中勾选sRGB选项，让它在采样时能还原回线性值。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730160341610.png" alt="image-20220730160341610"></p>
<h4 id="Photoshop"><a href="#Photoshop" class="headerlink" title="Photoshop"></a><strong>Photoshop</strong></h4><p>如果使用线性空间，一般来说Photoshop可以什么都不改，导出的贴图只要在Unity中勾上sRGB就可以了。</p>
<p>如果调整Photoshop的gamma值为1，导出的贴图在Unity中也不需要勾选sRGB</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730160653259.png" alt="image-20220730160653259"></p>
<ul>
<li><p>ps对颜色管理特别精确，Unity里看到的颜色要经过显示器的Gamma变换，而ps不会，ps会读取显示器的Color Profile，反向补偿回去。</p>
</li>
<li><p>ps中有第二个Color Profile，叫做Document Color Profile。通常默认为sRGB Color Profile，和显示器的Color Profile一致，颜色被压暗了，所以ps中看到的结果才和Unity一样。</p>
</li>
</ul>
<h5 id="混合"><a href="#混合" class="headerlink" title="混合"></a><strong>混合</strong></h5><p>Unity中的混合是线性的（线性空间模式下），ps图层与图层之间混合时，每个上层图层都经过了gamma变换，才做了混合。需要在设置中更改选择“用灰度系数混合rgb颜色”，参数设置为1，这样图层才是直接混合的结果。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730161152441.png" alt="image-20220730161152441"></p>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a><strong>作业</strong></h3><h4 id="手动尝试伽马校正的几种方法"><a href="#手动尝试伽马校正的几种方法" class="headerlink" title="手动尝试伽马校正的几种方法"></a><strong>手动尝试伽马校正的几种方法</strong></h4><h5 id="1-Unity线性空间"><a href="#1-Unity线性空间" class="headerlink" title="1.Unity线性空间"></a><strong>1.Unity线性空间</strong></h5><p>项目设置使用Linear空间，并且albedo贴图勾选sRGB</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730165247570.png" alt="image-20220730165247570"></p>
<h5 id="2-Unity-Gamma空间"><a href="#2-Unity-Gamma空间" class="headerlink" title="2.Unity Gamma空间"></a><strong>2.Unity Gamma空间</strong></h5><p>在项目设置里选择gamma空间</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730170411814.png" alt="image-20220730170411814"></p>
<p>可以观察到输出的颜色中，高光更亮、范围更大，因为光照是线性计算的，而且直接按照gamma空间输出了；但是直接输出的颜色更暗了。</p>
<h6 id="手动Gamma矫正"><a href="#手动Gamma矫正" class="headerlink" title="手动Gamma矫正"></a><strong>手动Gamma矫正</strong></h6><p>对于输出的radiance，我们进行gamma矫正</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> fixed4(LinearToGammaSpace(color),<span class="number">1.0</span>);</span><br></pre></td></tr></table></figure>

<p>以及采样贴图时，变换到线性空间计算</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fixed3 albedo = GammaToLinearSpace(tex2D(_Albedo, i.uv).rgb) * _Diffuse.rgb;</span><br></pre></td></tr></table></figure>

<p>（理论上来说，albedo这种属性是线性空间的，但是这也关乎到贴图导出的设置，一般制作的都是sRGB的图片，所以还是需要转换一下。）</p>
<p>这两个封装好的函数，也可以手动地去使用2.2次方去计算。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220730171629559.png" alt="image-20220730171629559"></p>
<p>可以看到法线颜色球正常了，中间的我写的shader高光也压下来一些，但是这个Standard的着色器就改不了了。</p>
<p>所以引擎还是很方便的，我们在线性空间工作模式下，很多事情都帮我们做好了。但是需要在贴图的设置上多加注意。</p>
<ul>
<li>麻烦的地方<ul>
<li>在需要手动gamma矫正的平台上，在混合这一步会出现问题（因为在混合之前就进行gamma矫正了）</li>
<li>所以一个解决方法是：在fs颜色输出时不进行gamma矫正，但是需要一步后处理来完成gamma矫正，也造成了一些性能损耗。</li>
</ul>
</li>
</ul>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a><strong>参考资料</strong></h3><p>[1] <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1cU4y1b7UF">https://www.bilibili.com/video/BV1cU4y1b7UF</a> 【技术美术百人计划】图形 2.6  伽马校正</p>
<p>[2] Unity Shader 入门精要 p356-363.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/07/30/TA/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/%E5%9B%BE%E5%BD%A22.6%20%E4%BC%BD%E9%A9%AC%E6%A0%A1%E6%AD%A3/" data-id="cmfe9guiz003bewuhda9a3iax" class="article-share-link">
        Share
      </a>
      
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Computer-Graphics/" rel="tag">Computer Graphics</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%99%BE%E4%BA%BA%E8%AE%A1%E5%88%92/" rel="tag">百人计划</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/" rel="tag">过程记录</a></li></ul>

    </footer>

  </div>

  

  

</article>
    
  </article>
  

  
  <nav class="page-nav">
    <a class="extend prev" rel="prev" href="/page/3/">Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/">Next</a>
  </nav>
  
</section>
</div>
    <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>XZYW7&#39;s Blog &copy; 2025</li>
      
        <li>
          
            <a href="https://beian.miit.gov.cn/" target="_blank"></a>
            
        </li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
    <p><ul class="list-inline">
  
  <li><i class="fe fe-bar-chart tooltip" data-tooltip="PV"></i> <span id="busuanzi_value_site_pv"></span></li>
  
  <li><i class="fe fe-smile-alt tooltip" data-tooltip="UV"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul></p>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="XZYW7&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">Home</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">Gallery</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">About</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">Archives</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>






<script src="/js/ocean.js"></script>

</body>

</html>