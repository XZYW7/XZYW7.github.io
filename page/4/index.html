<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <title>
    
    XZYW7&#39;s Blog
  </title>
  <!-- Icon -->
  
    <link rel="shortcut icon" href="/favicon.ico">
    
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <main class="content">
    <section class="jumbotron">
  <div class="video">
    
    <div class="video-frame">
      <img src="/images/ocean/overlay-hero.png" alt="Decorative image frame">
    </div>
    
    <div class="video-media">
      <video playsinline="" autoplay="" loop="" muted="" data-autoplay="" poster="/images/ocean/ocean.png"
        x5-video-player-type="h5">
        <source src="/images/ocean/ocean.mp4" type="video/mp4">
        <source src="/images/ocean/ocean.ogv" type="video/ogg">
        <source src="/images/ocean/ocean.webm" type="video/webm">
        <p>Your user agent does not support the HTML5 Video element.</p>
      </video>
      <div class="video-overlay"></div>
    </div>
    <div class="video-inner text-center text-white">
      <h1><a href="/">XZYW7&#39;s Blog</a></h1>
      <p></p>
      <div><img src="/images/hexo-inverted.svg" class="brand" alt="XZYW7&#39;s Blog"></div>
    </div>
    <div class="video-learn-more">
      <a class="anchor" href="#landingpage"><i class="fe fe-mouse"></i></a>
    </div>
  </div>
</section>
<div id="landingpage">
  <section class="outer">
  <article class="articles">
    
    <h1 class="page-type-title"></h1>
    
    
    <article id="post-TA/Maya/cmds（一）" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    

    
    <div class="article-meta">
      <a href="/2025/09/10/TA/Maya/cmds%EF%BC%88%E4%B8%80%EF%BC%89/" class="article-date">
  <time datetime="2025-09-10T13:18:14.017Z" itemprop="datePublished">2025-09-10</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="【Maya】Python-For-Maya（Cmds）（一）Introduction"><a href="#【Maya】Python-For-Maya（Cmds）（一）Introduction" class="headerlink" title="【Maya】Python For Maya（Cmds）（一）Introduction"></a>【Maya】Python For Maya（Cmds）（一）Introduction</h2><h3 id="从零开始"><a href="#从零开始" class="headerlink" title="从零开始"></a>从零开始</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line">cmds.polyCube()</span><br></pre></td></tr></table></figure>

<p>maya创建了一个物体，但是其实在这里maya脚本并没有获取到这个创建的物体</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmds.polyCube()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>本身是一个命令command，其实返回了这个物体作为一个list</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cube = cmds.polyCube()</span><br><span class="line"><span class="built_in">print</span>(cube)</span><br><span class="line"><span class="comment">#[&#x27;pCube1&#x27;, &#x27;polyCube1&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>在之前的&#x3D;&#x3D;过期教程&#x3D;&#x3D;我们了解到，一个属于Transform Node，一个属于Shape Node</p>
<p>实际上pCube1是这个立方体的名字，在大纲可以看到，而polyCube1是创建这个立方体的Maya Node的名字</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cubeShape = cube[<span class="number">0</span>]<span class="comment">#这样就把pCube1取出来了</span></span><br><span class="line">circle = cmds.circle()</span><br><span class="line">circleShape = circle[<span class="number">0</span>]</span><br><span class="line">cmds.parent(cubeShape,circleShape)<span class="comment">#child,parent</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220628225129047.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cmds.setAttr(<span class="string">&quot;pCube1.tx&quot;</span>,lock = <span class="literal">True</span>)<span class="comment">#锁定立方体的TranslateX属性</span></span><br><span class="line">cmds.setAttr(cubeShape +<span class="string">&quot;.ty&quot;</span>,lock = <span class="literal">True</span>)</span><br><span class="line">cmds.setAttr(cubeShape +<span class="string">&quot;.translate&quot;</span>,lock = <span class="literal">True</span>)<span class="comment">#同时锁定所有translate属性</span></span><br><span class="line">cmds.setAttr(cubeShape +<span class="string">&quot;.rotate&quot;</span>,lock = <span class="literal">True</span>)<span class="comment">#同时锁定所有translate属性</span></span><br><span class="line">cmds.setAttr(cubeShape +<span class="string">&quot;.scale&quot;</span>,lock = <span class="literal">True</span>)<span class="comment">#同时锁定所有translate属性</span></span><br></pre></td></tr></table></figure>

<p>这样子物体的立方体被锁定了，但是父物体的circle还是正常的，依然会带动子物体变化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmds.select(circleShape)</span><br></pre></td></tr></table></figure>

<h3 id="MayaAPI"><a href="#MayaAPI" class="headerlink" title="MayaAPI"></a>MayaAPI</h3><ul>
<li><p>cmds</p>
<ul>
<li>MEL<ul>
<li>可交互性</li>
<li>会在窗口中打印命令</li>
</ul>
</li>
<li>只能用于脚本</li>
<li>只能在maya中使用</li>
</ul>
</li>
<li><p>OpenMaya</p>
<ul>
<li>C++ &#x2F; C#(only for windows)<ul>
<li>不可交互</li>
<li>需要编译</li>
<li>可以在maya外使用</li>
<li>只能用于插件</li>
<li>性能更优</li>
</ul>
</li>
</ul>
</li>
<li><p>Python</p>
<ul>
<li>两种API均可以使用</li>
<li>可以用于插件或脚本</li>
<li>可以在maya外使用</li>
<li>性能不如C++&#x2F;C#</li>
<li>简单，有社区</li>
</ul>
</li>
</ul>
<p>Maya-python API</p>
<ul>
<li>cmds<ul>
<li>原本是为MEL设计的</li>
<li>语法风格不太python化</li>
<li>性能不错</li>
<li>过于繁杂</li>
<li>物体通过name来处理</li>
</ul>
</li>
<li>OpenMaya<ul>
<li>两种版本<ul>
<li>version1 built for C++</li>
<li>version 2 built for python</li>
</ul>
</li>
<li>原本是为C++设计</li>
<li>语法风格不太python化</li>
<li>非常繁杂</li>
<li>更难使用</li>
<li>高性能</li>
<li>直接处理物体</li>
</ul>
</li>
<li>PyMEL<ul>
<li>warps both cmds and OpenMaya</li>
<li>语法更符合python</li>
<li>不太稳定</li>
<li>直接处理物体</li>
</ul>
</li>
</ul>
<h5 id="Nodes-in-maya"><a href="#Nodes-in-maya" class="headerlink" title="Nodes in maya"></a>Nodes in maya</h5><p>maya主要影响物体属性，属性通过名称获得</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">polyCube1.input</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220628232113093.png" alt="image-20220628232113093"></p>
<p>在api中，attributes被称作plugs，可以给plug赋值</p>
<p>也可以和其他plug进行连接</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/10/TA/Maya/cmds%EF%BC%88%E4%B8%80%EF%BC%89/" data-id="cmfe1u6p6000tscuh6szahbvo" class="article-share-link">
        Share
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Maya/cmds（二）" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    

    
    <div class="article-meta">
      <a href="/2025/09/10/TA/Maya/cmds%EF%BC%88%E4%BA%8C%EF%BC%89/" class="article-date">
  <time datetime="2025-09-10T13:18:14.017Z" itemprop="datePublished">2025-09-10</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="【Maya】Python-For-Maya（Cmds）（二）Object-Renamer-Create-Gear"><a href="#【Maya】Python-For-Maya（Cmds）（二）Object-Renamer-Create-Gear" class="headerlink" title="【Maya】Python For Maya（Cmds）（二）Object Renamer &amp; Create Gear"></a>【Maya】Python For Maya（Cmds）（二）Object Renamer &amp; Create Gear</h2><h2 id="Object-Renamer"><a href="#Object-Renamer" class="headerlink" title="Object Renamer"></a>Object Renamer</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line"><span class="built_in">print</span>(cmds.ls())</span><br></pre></td></tr></table></figure>

<p>返回了场景里面所有物体名称组成一个列表，包括一些隐藏物体和对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">selection = cmds.ls(selection = <span class="literal">True</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(selection)==<span class="number">0</span>:</span><br><span class="line">    selection = cmds.ls(dag=<span class="literal">True</span>,long=<span class="literal">True</span>)</span><br><span class="line">selection.sort(key = <span class="built_in">len</span>,reverse)</span><br><span class="line"><span class="comment">#名称越长越是子物体</span></span><br><span class="line"><span class="comment">#这个排序是为了让遍历列表的时候，子物体先进行改变，再改变父物体。如果先改变父物体，那么子物体会受到同样的影响。</span></span><br><span class="line"><span class="built_in">print</span>(selection)</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220628234233927.png" alt="image-20220628234233927"></p>
<p>这里处理返回完整path name是为了放置不同层级物体同名的情况</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220628234344658.png" alt="image-20220628234344658"></p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220628234428788.png" alt="image-20220628234428788"></p>
<p>Dag参数使得列表返回所有dag对象的物体（大纲中的仅显示Dag对象物体）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> selection:</span><br><span class="line">	shortName = obj.split(<span class="string">&#x27;|&#x27;</span>)[-<span class="number">1</span>]<span class="comment">#取dagpath最后一个，就是物体名字了</span></span><br><span class="line">    <span class="comment">#print(cmds.objectType(obj))#transform我们已经知道它为什么是transform了，实际上在maya大纲中可以右键选择shape可见</span></span><br><span class="line">    children = cmds.listRelatives(obj,children = <span class="literal">True</span>, fullPath = <span class="literal">True</span>) <span class="keyword">or</span> []<span class="comment">#None则直接返回成空列表，因为这个东西很烦，没有东西返回None，不是空列表类型</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">len</span>(children) == <span class="number">1</span>):</span><br><span class="line">        child = children[<span class="number">0</span>]</span><br><span class="line">        objType = cmds.objectType(child)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        objType = cmds.objectType(obj)</span><br><span class="line">    <span class="keyword">if</span> objType == <span class="string">&quot;mesh&quot;</span>:</span><br><span class="line">        suffix = <span class="string">&quot;geo&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> objType == <span class="string">&quot;joint&quot;</span>:</span><br><span class="line">        suffix = <span class="string">&quot;jnt&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> objType == <span class="string">&quot;camera&quot;</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        suffix = <span class="string">&quot;grp&quot;</span></span><br><span class="line">    newName = shortName + <span class="string">&quot;_&quot;</span> + suffix</span><br><span class="line">    </span><br><span class="line">    cmds.rename(obj, newName)</span><br></pre></td></tr></table></figure>

<p>使用函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line">SUFFIXES = &#123;</span><br><span class="line">    <span class="string">&quot;mesh&quot;</span>:<span class="string">&quot;geo&quot;</span>,</span><br><span class="line">	<span class="string">&quot;joint&quot;</span>:<span class="string">&quot;jnt&quot;</span>,</span><br><span class="line">	<span class="string">&quot;camera&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">    <span class="string">&quot;ambientLight&quot;</span>:<span class="string">&quot;lgt&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">DEFAULT_SUFFIX = <span class="string">&quot;grp&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rename</span>(<span class="params">selection = <span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This function will rename any objects to have the correct suffix</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        selection: Whether or not we use the current selections</span></span><br><span class="line"><span class="string">   	</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        A list of all the objects we operated on</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    objects = cmds.ls(selection = selection,dag = <span class="literal">True</span>, long = <span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> selection <span class="keyword">and</span> <span class="keyword">not</span> objects:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;You dont have anything selected&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    objects.sort(key = <span class="built_in">len</span>, reverse = <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> obj <span class="keyword">in</span> objects:</span><br><span class="line">        shortName = obj.split(<span class="string">&#x27;|&#x27;</span>)[-<span class="number">1</span>]<span class="comment">#取dagpath最后一个，就是物体名字了</span></span><br><span class="line">        <span class="comment">#print(cmds.objectType(obj))#transform我们已经知道它为什么是transform了，实际上在maya大纲中可以右键选择shape可见</span></span><br><span class="line">        children = cmds.listRelatives(obj,children = <span class="literal">True</span>, fullPath = <span class="literal">True</span>) <span class="keyword">or</span> []<span class="comment">#None则直接返回成空列表，因为这个东西很烦，没有东西返回None，不是空列表类型</span></span><br><span class="line">        <span class="built_in">print</span>(children)</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">len</span>(children) == <span class="number">1</span>):</span><br><span class="line">            child = children[<span class="number">0</span>]</span><br><span class="line">            objType = cmds.objectType(child)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            objType = cmds.objectType(obj)</span><br><span class="line"></span><br><span class="line">		suffix = SUFFIXES.get(objType, DEFUALT_SUFFIXES)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> suffix:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> obj.endswith(<span class="string">&#x27;_&#x27;</span>+suffix):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        newName = <span class="string">&quot;&#123;&#125;_&#123;&#125;&quot;</span>.<span class="built_in">format</span>(shortName,suffix)</span><br><span class="line"></span><br><span class="line">        cmds.rename(obj, newName)</span><br><span class="line">        index = objects.index(obj)</span><br><span class="line">        objects[index] = obj.replace(shortName,newName)</span><br><span class="line">    <span class="keyword">return</span> objects</span><br></pre></td></tr></table></figure>

<p>在外面改变脚本后，maya不会直接识别到，需要使用reload方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> someModule</span><br><span class="line">reload(someModule)</span><br></pre></td></tr></table></figure>

<h2 id="Create-Gear"><a href="#Create-Gear" class="headerlink" title="Create Gear"></a>Create Gear</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createGear</span>(<span class="params">teeth = <span class="number">10</span>, length = <span class="number">0.3</span></span>):</span><br><span class="line">    <span class="comment"># Teeth are every alternate face, so spans x 2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Creating Gear&quot;</span>, teeth,length)</span><br><span class="line">    spans = teeth * <span class="number">2</span></span><br><span class="line">    </span><br><span class="line">    transform,constructor = cmds.polyPipe(subdivisionsAxis = spans)</span><br><span class="line">    sideFaces = <span class="built_in">range</span>(spans*<span class="number">2</span>,spans*<span class="number">3</span>,<span class="number">2</span>)</span><br><span class="line">    <span class="comment">#因为pipe侧面是从spans*2开始计数的，0-spans是顶面</span></span><br><span class="line">    cmds.select(clear = <span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> face <span class="keyword">in</span> sideFaces:</span><br><span class="line">        cmds.select(<span class="string">&#x27;&#123;&#125;.f[&#123;&#125;]&#x27;</span>.<span class="built_in">format</span>(transform, face), add = <span class="literal">True</span>)<span class="comment">#添加到选择集，而不是重新选择</span></span><br><span class="line">    extrude = cmds.polyExtrudeFacet(localTranslateZ = length)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> transform, constructor, extrude</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">changeTeeth</span>(<span class="params">constructor,extrude,teeth = <span class="number">10</span>, length = <span class="number">0.3</span></span>):</span><br><span class="line">    spans = teeth * <span class="number">2</span></span><br><span class="line">    cmds.polyPipe(constructor, edit = <span class="literal">True</span>, subdivisionsAxis = spans)</span><br><span class="line">    </span><br><span class="line">    sideFaces = <span class="built_in">range</span>(spans*<span class="number">2</span>,spans*<span class="number">3</span>,<span class="number">2</span>)</span><br><span class="line">    faceNames = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> face <span class="keyword">in</span> sideFaces:</span><br><span class="line">        faceName = <span class="string">&#x27;f[&#123;&#125;]&#x27;</span>.<span class="built_in">format</span>(face)</span><br><span class="line">        faceNames.append(faceName)</span><br><span class="line">        </span><br><span class="line">    cmds.setAttr(<span class="string">&#x27;&#123;&#125;.inputComponents&#x27;</span>.<span class="built_in">format</span>(extrude),<span class="built_in">len</span>(faceNames),*faceNames,<span class="built_in">type</span> = <span class="string">&quot;componentList&quot;</span>)</span><br><span class="line">    cmds.polyExtrudeFacet(extrude, edit = <span class="literal">True</span>, ltz = length)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">changeTeeth(constructor,extrude,teeth = <span class="number">40</span>)</span><br></pre></td></tr></table></figure>

<h3 id="使用类"><a href="#使用类" class="headerlink" title="使用类"></a>使用类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Gear</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.transofrm = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.extrude = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.constructor = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">creatGear</span>(<span class="params">self, teeth = <span class="number">10</span>, length = <span class="number">0.3</span></span>):</span><br><span class="line">        spans = teeth * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.transform, <span class="variable language_">self</span>.constructor = cmds.polyPipe(subdivisionsAxis = spans)</span><br><span class="line">        sideFaces = <span class="built_in">range</span>(spans*<span class="number">2</span>,spans*<span class="number">3</span>,<span class="number">2</span>)</span><br><span class="line">        cmds.select(clear = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> face <span class="keyword">in</span> sideFaces:</span><br><span class="line">            cmds.select(<span class="string">&#x27;&#123;&#125;.f[&#123;&#125;]&#x27;</span>.<span class="built_in">format</span>(<span class="variable language_">self</span>.transform, face), add = <span class="literal">True</span>)<span class="comment">#添加到选择集，</span></span><br><span class="line">        <span class="variable language_">self</span>.extrude = cmds.polyExtrudeFacet(localTranslateZ = length)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">changeTeeth</span>(<span class="params">self,teeth = <span class="number">10</span>, length = <span class="number">0.3</span></span>):</span><br><span class="line">        spans = teeth * <span class="number">2</span></span><br><span class="line">        cmds.polyPipe(<span class="variable language_">self</span>.constructor, edit = <span class="literal">True</span>, subdivisionsAxis = spans)</span><br><span class="line"></span><br><span class="line">        sideFaces = <span class="built_in">range</span>(spans*<span class="number">2</span>,spans*<span class="number">3</span>,<span class="number">2</span>)</span><br><span class="line">        faceNames = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> face <span class="keyword">in</span> sideFaces:</span><br><span class="line">            faceName = <span class="string">&#x27;f[&#123;&#125;]&#x27;</span>.<span class="built_in">format</span>(face)</span><br><span class="line">            faceNames.append(faceName)</span><br><span class="line"></span><br><span class="line">        cmds.setAttr(<span class="string">&#x27;&#123;&#125;.inputComponents&#x27;</span>.<span class="built_in">format</span>(<span class="variable language_">self</span>.extrude),<span class="built_in">len</span>(faceNames),*faceNames,<span class="built_in">type</span> = <span class="string">&quot;componentList&quot;</span>)</span><br><span class="line">        cmds.polyExtrudeFacet(<span class="variable language_">self</span>.extrude, edit = <span class="literal">True</span>, ltz = length)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/10/TA/Maya/cmds%EF%BC%88%E4%BA%8C%EF%BC%89/" data-id="cmfe1u6p6000wscuh1l037dy8" class="article-share-link">
        Share
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Maya/cmds（四）" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    

    
    <div class="article-meta">
      <a href="/2025/09/10/TA/Maya/cmds%EF%BC%88%E5%9B%9B%EF%BC%89/" class="article-date">
  <time datetime="2025-09-10T13:18:14.017Z" itemprop="datePublished">2025-09-10</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="【Maya】Python-For-Maya（Cmds）（四）Controller-Library-LightManager"><a href="#【Maya】Python-For-Maya（Cmds）（四）Controller-Library-LightManager" class="headerlink" title="【Maya】Python For Maya（Cmds）（四）Controller Library &amp; LightManager"></a>【Maya】Python For Maya（Cmds）（四）Controller Library &amp; LightManager</h2><h2 id="Controller-Library"><a href="#Controller-Library" class="headerlink" title="Controller Library"></a>Controller Library</h2><h3 id="Qt-Environment"><a href="#Qt-Environment" class="headerlink" title="Qt Environment"></a>Qt Environment</h3><p>使用QT创建controller lib</p>
<p>和Maya cmdsUi相比，更推荐使用qt</p>
<p>CMDS是为MEL设计的，UI函数只有qt的一小部分</p>
<p>直接(mayapy -m )pip install Qt.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Qt</span><br><span class="line">win = Qt.QtWidgets.QDialog()</span><br><span class="line">win.show()</span><br></pre></td></tr></table></figure>

<p>在maya上这样就直接运行了</p>
<p>但是在正常的python上，根据文档要这样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtWidgets</span><br><span class="line"></span><br><span class="line">app = QtWidgets.QApplication(sys.argv)</span><br><span class="line">button = QtWidgets.QPushButton(<span class="string">&quot;Hello World&quot;</span>)</span><br><span class="line">button.show()</span><br><span class="line">app.exec_()</span><br></pre></td></tr></table></figure>

<p>好像是现代maya版本就是Qt管理窗口，所以已经有QtApp了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtWidgets,QtCore,QtGui</span><br><span class="line"><span class="keyword">from</span> PySide2 <span class="keyword">import</span> QtWidgets,QtCore,QtGui</span><br><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtWidgets,QtCore,QtGui</span><br></pre></td></tr></table></figure>

<p>甚至我只mayapy安装了Qt.py，这三个命令都能用了</p>
<h3 id="Controller-Library-1"><a href="#Controller-Library-1" class="headerlink" title="Controller Library"></a>Controller Library</h3><p>controllerLibrary.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pprint</span><br><span class="line"></span><br><span class="line">USERAPPDIR = cmds.internalVar(userAppDir = <span class="literal">True</span>)</span><br><span class="line"><span class="built_in">print</span>(USERAPPDIR)</span><br><span class="line">DIRECTORY = os.path.join(USERAPPDIR,<span class="string">&#x27;controllerLibrary&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createDirectory</span>(<span class="params">directory = DIRECTORY</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Creates the given directory</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        directory(str):The directory to create</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(directory):</span><br><span class="line">        os.mkdir(directory)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ControllerLibrary</span>(<span class="title class_ inherited__">dict</span>):<span class="comment"># stm继承了个字典……</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self, name, directory = DIRECTORY,screenshot = <span class="literal">True</span>, **info</span>):</span><br><span class="line">        createDirectory(directory)<span class="comment"># 不存在路径则创建文件夹路径</span></span><br><span class="line"></span><br><span class="line">        path = os.path.join(directory,<span class="string">&quot;&#123;&#125;.ma&quot;</span>.<span class="built_in">format</span>(name))</span><br><span class="line">        infoFile = os.path.join(directory,<span class="string">&#x27;&#123;&#125;.json&#x27;</span>.<span class="built_in">format</span>(name))<span class="comment"># 保存数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ========保存文件========</span></span><br><span class="line">        cmds.file(rename = path)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> cmds.ls(selection = <span class="literal">True</span>):<span class="comment"># 有选择则只保存选择</span></span><br><span class="line">            cmds.file(force = <span class="literal">True</span>, <span class="built_in">type</span> = <span class="string">&#x27;mayaAscii&#x27;</span>, exportSelected = <span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">else</span>:<span class="comment"># 无选择则全部保存</span></span><br><span class="line">            cmds.file(save = <span class="literal">True</span>, <span class="built_in">type</span> = <span class="string">&#x27;mayaAscii&#x27;</span>, force = <span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ========保存屏幕快照========</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> screenshot:</span><br><span class="line">            info[<span class="string">&#x27;screenshot&#x27;</span>] = <span class="variable language_">self</span>.saveScreenShot(name,directory = directory)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ========输出json========</span></span><br><span class="line">        info[<span class="string">&#x27;name&#x27;</span>] = name</span><br><span class="line">        info[<span class="string">&#x27;path&#x27;</span>] = path</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(infoFile, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            json.dump(info, f, indent = <span class="number">4</span>)<span class="comment"># 把输入的info储存为json</span></span><br><span class="line">        <span class="variable language_">self</span>[name] = info</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find</span>(<span class="params">self, directory = DIRECTORY</span>):</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.clear()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;1&#x27;</span>,directory)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(directory):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        files = os.listdir(directory)<span class="comment"># 当前路径下所有文件</span></span><br><span class="line">        mayaFiles = [f <span class="keyword">for</span> f <span class="keyword">in</span> files <span class="keyword">if</span> f.endswith(<span class="string">&#x27;.ma&#x27;</span>)]</span><br><span class="line">        <span class="built_in">print</span>(files)</span><br><span class="line">        <span class="keyword">for</span> ma <span class="keyword">in</span> mayaFiles:</span><br><span class="line">            name,ext = os.path.splitext(ma)<span class="comment"># 分离文件名和扩展名</span></span><br><span class="line">            path = os.path.join(directory,ma)</span><br><span class="line">            </span><br><span class="line">            infoFile = <span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(name)</span><br><span class="line">            <span class="keyword">if</span> infoFile <span class="keyword">in</span> files:</span><br><span class="line">                infoFile = os.path.join(directory, infoFile)</span><br><span class="line">            </span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(infoFile, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    info = json.load(f)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;No info file found&#x27;</span>)</span><br><span class="line">                info = &#123;&#125;</span><br><span class="line">                </span><br><span class="line">            screenshot = <span class="string">&#x27;&#123;&#125;.jpg&#x27;</span>.<span class="built_in">format</span>(name)</span><br><span class="line">            <span class="keyword">if</span> screenshot <span class="keyword">in</span> files:</span><br><span class="line">                info[<span class="string">&#x27;screenshot&#x27;</span>] = os.path.join(directory,name)</span><br><span class="line">            info[<span class="string">&#x27;name&#x27;</span>] = name</span><br><span class="line">            info[<span class="string">&#x27;path&#x27;</span>] = path</span><br><span class="line">            <span class="variable language_">self</span>[name] = info</span><br><span class="line">        pprint.pprint(<span class="variable language_">self</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self, name</span>):</span><br><span class="line">        path = <span class="variable language_">self</span>[name][<span class="string">&#x27;path&#x27;</span>]</span><br><span class="line">        cmds.file(path, i = <span class="literal">True</span>, usingNamespace = <span class="literal">False</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">saveScreenShot</span>(<span class="params">self, name, directory = DIRECTORY</span>):</span><br><span class="line">        path = os.path.join(directory, <span class="string">&#x27;&#123;&#125;.jpg&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line">        cmds.viewFit()</span><br><span class="line">        cmds.setAttr(<span class="string">&#x27;defaultRenderGlobals.imageFormat&#x27;</span>, <span class="number">8</span>)<span class="comment"># jpeg</span></span><br><span class="line">        <span class="comment">#cmds.setAttr(&quot;defaultArnoldDriver.aiTranslator&quot;,&#x27;png&#x27;,type = &quot;string&quot;) 阿诺德渲染器</span></span><br><span class="line">        </span><br><span class="line">        cmds.playblast(completeFilename = path, forceOverwrite = <span class="literal">True</span>, <span class="built_in">format</span> = <span class="string">&#x27;image&#x27;</span>, width = <span class="number">200</span>, height = <span class="number">200</span>, showOrnaments = <span class="literal">False</span>, startTime = <span class="number">1</span>, endTime = <span class="number">1</span>, viewer = <span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/tian0000hai/article/details/116952413%E9%98%BF%E8%AF%BA%E5%BE%B7%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E6%B8%B2%E6%9F%93%E8%BE%93%E5%87%BA%E8%AE%BE%E7%BD%AE">https://blog.csdn.net/tian0000hai/article/details/116952413阿诺德渲染器的渲染输出设置</a></p>
<p>libraryUI.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line"><span class="keyword">from</span> PySide2 <span class="keyword">import</span> QtWidgets, QtCore, QtGui</span><br><span class="line"><span class="keyword">import</span> conLibrary.controllerLibrary <span class="keyword">as</span> controllerLibrary</span><br><span class="line"><span class="keyword">import</span> pprint</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line">importlib.reload(controllerLibrary)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ControllerLibraryUI</span>(QtWidgets.QDialog):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The ControllerLibraryUI is a dialog that lets us save and import controllers</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment">#super(ControllerLibraryUI, self).__init__()</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment">#super是一个，用于调用父类方法，用于多继承，而这里是为了不用考虑继承的父类是什么</span></span><br><span class="line">        <span class="comment">#QtWidgets.QDialog.__init__(self)因为是单继承，和这个相等</span></span><br><span class="line">        <span class="variable language_">self</span>.setWindowTitle(<span class="string">&#x27;Controller LibraryUI&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.library = controllerLibrary.ControllerLibrary()</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.buildUI()</span><br><span class="line">        <span class="variable language_">self</span>.populate()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUI</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        This method builds out the UI</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;bulding UI&#x27;</span>)</span><br><span class="line">        <span class="comment"># 整体行分布</span></span><br><span class="line">        layout = QtWidgets.QVBoxLayout(<span class="variable language_">self</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 行分布中的一行，提供纵向分布，编辑栏view</span></span><br><span class="line">        saveWidget = QtWidgets.QWidget()</span><br><span class="line">        saveLayout = QtWidgets.QHBoxLayout(saveWidget)</span><br><span class="line">        layout.addWidget(saveWidget)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 行内组件</span></span><br><span class="line">        <span class="variable language_">self</span>.saveNameField = QtWidgets.QLineEdit()</span><br><span class="line">        saveLayout.addWidget(<span class="variable language_">self</span>.saveNameField)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 行内组件</span></span><br><span class="line">        saveBtn = QtWidgets.QPushButton(<span class="string">&#x27;Save&#x27;</span>)</span><br><span class="line">        saveBtn.clicked.connect(<span class="variable language_">self</span>.save)</span><br><span class="line">        saveLayout.addWidget(saveBtn)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 新的一行，缩略图view</span></span><br><span class="line">        size = <span class="number">64</span></span><br><span class="line">        buffer = <span class="number">12</span></span><br><span class="line">        <span class="comment"># create a grid list Widget to display our controller thumbnails</span></span><br><span class="line">        <span class="variable language_">self</span>.listWidget = QtWidgets.QListWidget()</span><br><span class="line">        <span class="variable language_">self</span>.listWidget.setViewMode(QtWidgets.QListWidget.IconMode)</span><br><span class="line">        <span class="variable language_">self</span>.listWidget.setIconSize(QtCore.QSize(size,size))</span><br><span class="line">        <span class="variable language_">self</span>.listWidget.setResizeMode(QtWidgets.QListWidget.Adjust)</span><br><span class="line">        <span class="variable language_">self</span>.listWidget.setGridSize(QtCore.QSize(size+buffer,size+buffer))</span><br><span class="line">        layout.addWidget(<span class="variable language_">self</span>.listWidget)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 新的一行button view</span></span><br><span class="line">        btnWidget = QtWidgets.QWidget()</span><br><span class="line">        btnLayout = QtWidgets.QHBoxLayout(btnWidget)</span><br><span class="line">        layout.addWidget(btnWidget)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># button view组件</span></span><br><span class="line">        importBtn = QtWidgets.QPushButton(<span class="string">&#x27;Import&#x27;</span>)</span><br><span class="line">        importBtn.clicked.connect(<span class="variable language_">self</span>.load)</span><br><span class="line">        btnLayout.addWidget(importBtn)</span><br><span class="line">        </span><br><span class="line">        refreshBtn = QtWidgets.QPushButton(<span class="string">&#x27;Refresh&#x27;</span>)</span><br><span class="line">        refreshBtn.clicked.connect(<span class="variable language_">self</span>.populate)<span class="comment">#注意只提供方法名，没有括号，括号代表调用</span></span><br><span class="line">        btnLayout.addWidget(refreshBtn)</span><br><span class="line">        </span><br><span class="line">        closeBtn = QtWidgets.QPushButton(<span class="string">&#x27;Close&#x27;</span>)</span><br><span class="line">        closeBtn.clicked.connect(<span class="variable language_">self</span>.close)<span class="comment"># self.close继承于QDialog</span></span><br><span class="line">        btnLayout.addWidget(closeBtn)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">populate</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;This clears the listWidget and then repopulates it with the content of our library&quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.listWidget.clear()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;populating&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.library.find()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> name, info <span class="keyword">in</span> <span class="variable language_">self</span>.library.items():</span><br><span class="line">            item = QtWidgets.QListWidgetItem(name)</span><br><span class="line">            <span class="variable language_">self</span>.listWidget.addItem(item)</span><br><span class="line">            </span><br><span class="line">            screenshot = info.get(<span class="string">&#x27;screenshot&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> screenshot:</span><br><span class="line">                icon = QtGui.QIcon(screenshot)</span><br><span class="line">                item.setIcon(icon)</span><br><span class="line">                </span><br><span class="line">            item.setToolTip(pprint.pformat(info))</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;This loads the currently selected controller&quot;&quot;&quot;</span></span><br><span class="line">        currentItem = <span class="variable language_">self</span>.listWidget.currentItem()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> currentItem:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        name = currentItem.text()</span><br><span class="line">        <span class="variable language_">self</span>.library.load(name)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;This saves the controller with the given file name&quot;&quot;&quot;</span></span><br><span class="line">        name = <span class="variable language_">self</span>.saveNameField.text()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> name.strip():</span><br><span class="line">            cmds.warning(<span class="string">&quot;You must give a name!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="variable language_">self</span>.library.save(name)</span><br><span class="line">        <span class="variable language_">self</span>.populate()</span><br><span class="line">        <span class="variable language_">self</span>.saveNameField.setText(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">showUI</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This shows and returns a handle to the UI</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        Qdialog</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    ui = ControllerLibraryUI()</span><br><span class="line">    ui.show()</span><br><span class="line">    <span class="keyword">return</span> ui</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Light-Manager"><a href="#Light-Manager" class="headerlink" title="Light Manager"></a>Light Manager</h2><p>创建一个场景的灯光管理窗口，并且可以和maya的窗口融合</p>
<h3 id="PyMel"><a href="#PyMel" class="headerlink" title="PyMel"></a>PyMel</h3><p>pymel包含了cmds、openmaya</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymel.core <span class="keyword">as</span> pm</span><br><span class="line">cube = pm.polyCube()</span><br><span class="line"><span class="built_in">print</span>(cube)</span><br><span class="line"><span class="comment">#[nt.Transform(&#x27;pCube1&#x27;), nt.PolyCube(&#x27;polyCube1&#x27;)]</span></span><br></pre></td></tr></table></figure>

<p>哥们试了半天，maya2023只有pymel&#x3D;&#x3D;1.3.0a1能用</p>
<p>可以看到pyme创建的polyCube是和openmaya一样附带Node的，并且有一个nt来封装</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cmds.rename(cube[0],&#x27;newName&#x27;)</span></span><br><span class="line">cube[<span class="number">0</span>].rename(<span class="string">&#x27;Foo&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../../%25E5%25AD%25A6%25E4%25B9%25A0/%25E6%25B5%2599%25E5%25A4%25A7/Python%2520in%2520Maya/note/Class5/image-20220703154445036.png" alt="image-20220703154445036"></p>
<p>pymel返回的对象不像cmds里面直接是string，是有一个nt对象封装（&#x3D;&#x3D;PyNode class&#x3D;&#x3D;）的，因此使用rename方法也需要调用这个nt对象内部的方法</p>
<p>这就和OpenMaya是差不多的</p>
<ul>
<li>mayatool使用cmd是很常见的</li>
<li>pymel一些情况会很慢，因为它封装了Node对象，不想cmd使用string</li>
<li>pymel也不被Audodesk直接支持，官方文档里也写了这一点</li>
</ul>
<h3 id="UI-and-Partial-funcitons"><a href="#UI-and-Partial-funcitons" class="headerlink" title="UI and Partial funcitons"></a>UI and Partial funcitons</h3><p>lightingManager.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtWidgets,QtCore,QtGui</span><br><span class="line"><span class="keyword">import</span> pymel.core <span class="keyword">as</span> pm</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="keyword">import</span> Qt</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> OpenMayaUI <span class="keyword">as</span> omui</span><br><span class="line"></span><br><span class="line">logging.basicConfig()</span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;LightingManager&#x27;</span>)</span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> Qt.__binding__ == <span class="string">&#x27;PySide&#x27;</span>:</span><br><span class="line">    logger.debug(<span class="string">&#x27;Using Pyside with shiboken&#x27;</span>)</span><br><span class="line">    <span class="keyword">from</span> shiboken <span class="keyword">import</span> warpInstance</span><br><span class="line">    <span class="keyword">from</span> Qt.QtCore <span class="keyword">import</span> Signal</span><br><span class="line"><span class="keyword">elif</span> Qt.__binding__.startswith(<span class="string">&#x27;PyQt&#x27;</span>):</span><br><span class="line">    logger.debug(<span class="string">&#x27;Using PyQt with sip&#x27;</span>)</span><br><span class="line">    <span class="keyword">from</span> sip <span class="keyword">import</span> warpInstance <span class="keyword">as</span> warpInstance</span><br><span class="line">    <span class="keyword">from</span> Qt.QtCore <span class="keyword">import</span> pyqtSignal <span class="keyword">as</span> Signal</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    logger.debug(<span class="string">&#x27;Using PySide2 with shiboken&#x27;</span>)</span><br><span class="line">    <span class="keyword">import</span> shiboken2</span><br><span class="line">    <span class="keyword">from</span> Qt.QtCore <span class="keyword">import</span> Signal</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getMayaMainWindow</span>():</span><br><span class="line">    win = omui.MQtUtil_mainWindow()</span><br><span class="line">    ptr = shiboken2.wrapInstance(<span class="built_in">int</span>(win),QtWidgets.QMainWindow)<span class="comment"># long是python2</span></span><br><span class="line">    <span class="comment"># 并且 shiboken2有改动，不能直接import warpInstance</span></span><br><span class="line">    <span class="keyword">return</span> ptr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getDock</span>(<span class="params">name = <span class="string">&#x27;LightingManagerDock&#x27;</span></span>):</span><br><span class="line">    deleteDock(name)</span><br><span class="line">    ctrl = pm.workspaceControl(name, dockToMainWindow = (<span class="string">&#x27;right&#x27;</span>,<span class="number">1</span>), label = <span class="string">&quot;LightingManager&quot;</span>)</span><br><span class="line">    qtCtrl = omui.MQtUtil_findControl(ctrl)</span><br><span class="line">    ptr = shiboken2.wrapInstance(<span class="built_in">int</span>(qtCtrl),QtWidgets.QWidget)</span><br><span class="line">    <span class="keyword">return</span> ptr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deleteDock</span>(<span class="params">name = <span class="string">&#x27;LightingManagerDock&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">if</span> pm.workspaceControl(name, query = <span class="literal">True</span>, exists = <span class="literal">True</span>):</span><br><span class="line">        pm.deleteUI(name)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LightManager</span>(QtWidgets.QWidget):<span class="comment"># QtWidgets.QDialog</span></span><br><span class="line">    </span><br><span class="line">    lightTypes = &#123;</span><br><span class="line">        <span class="string">&quot;Point Light&quot;</span>: pm.pointLight,</span><br><span class="line">        <span class="string">&quot;Spot Light&quot;</span>: pm.spotLight,</span><br><span class="line">        <span class="string">&quot;Directional Light&quot;</span>: pm.directionalLight,</span><br><span class="line">        <span class="string">&quot;Area Light&quot;</span>: partial(pm.shadingNode, <span class="string">&#x27;areaLight&#x27;</span>, asLight = <span class="literal">True</span>),</span><br><span class="line">        <span class="string">&quot;Volume Light&quot;</span>: partial(pm.shadingNode, <span class="string">&#x27;volumeLight&#x27;</span>, asLight = <span class="literal">True</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, dock = <span class="literal">True</span></span>):</span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        <span class="keyword">if</span> dock:</span><br><span class="line">            parent = getDock()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            deleteDock()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                pm.deleteUI(<span class="string">&#x27;LightingManager&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                logger.debug(<span class="string">&quot;No previous LightManagerUI exists&quot;</span>)</span><br><span class="line">                </span><br><span class="line">            <span class="comment">#parent = getMayaMainWindow()</span></span><br><span class="line">            parent = QtWidgets.QDialog(parent = getMayaMainWindow())</span><br><span class="line">            </span><br><span class="line">            parent.setObjectName(<span class="string">&#x27;lightingManager&#x27;</span>)</span><br><span class="line">            parent.setWindowTitle(<span class="string">&#x27;Lighting Manager&#x27;</span>)</span><br><span class="line">            layout = QtWidgets.QVBoxLayout(parent)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">super</span>().__init__(parent = parent)<span class="comment"># 把这个窗口的父节点设为maya窗口</span></span><br><span class="line">        <span class="comment">#self.setWindowTitle(&#x27;Lighting Manager&#x27;)</span></span><br><span class="line">        <span class="variable language_">self</span>.buildUI()</span><br><span class="line">        <span class="variable language_">self</span>.populate()</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.parent().layout().addWidget(<span class="variable language_">self</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> dock:</span><br><span class="line">            parent.show()</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">populate</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="variable language_">self</span>.scrollLayout.count():</span><br><span class="line">            widget = <span class="variable language_">self</span>.scrollLayout.takeAt(<span class="number">0</span>).widget()</span><br><span class="line">            <span class="keyword">if</span> widget:</span><br><span class="line">                widget.setVisible(<span class="literal">False</span>)</span><br><span class="line">                widget.deleteLater()</span><br><span class="line">        <span class="keyword">for</span> light <span class="keyword">in</span> pm.ls(<span class="built_in">type</span>=[<span class="string">&#x27;areaLight&#x27;</span>,<span class="string">&#x27;spotLight&#x27;</span>,<span class="string">&#x27;pointLight&#x27;</span>,<span class="string">&#x27;directionalLight&#x27;</span>,<span class="string">&#x27;volumeLight&#x27;</span>]):</span><br><span class="line">            <span class="variable language_">self</span>.addLight(light)</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUI</span>(<span class="params">self</span>):</span><br><span class="line">        layout = QtWidgets.QGridLayout(<span class="variable language_">self</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.lightTypeCB = QtWidgets.QComboBox()<span class="comment"># 下拉菜单</span></span><br><span class="line">        <span class="keyword">for</span> lightType <span class="keyword">in</span> <span class="built_in">sorted</span>(<span class="variable language_">self</span>.lightTypes):</span><br><span class="line">            <span class="variable language_">self</span>.lightTypeCB.addItem(lightType)</span><br><span class="line">        layout.addWidget(<span class="variable language_">self</span>.lightTypeCB, <span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        createBtn = QtWidgets.QPushButton(<span class="string">&#x27;Create&#x27;</span>)</span><br><span class="line">        createBtn.clicked.connect(<span class="variable language_">self</span>.createLight)</span><br><span class="line">        layout.addWidget(createBtn, <span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        scrollWidget = QtWidgets.QWidget()</span><br><span class="line">        scrollWidget.setSizePolicy(QtWidgets.QSizePolicy.Maximum,QtWidgets.QSizePolicy.Maximum)</span><br><span class="line">        <span class="variable language_">self</span>.scrollLayout = QtWidgets.QVBoxLayout(scrollWidget)</span><br><span class="line">        </span><br><span class="line">        scrollArea = QtWidgets.QScrollArea()</span><br><span class="line">        scrollArea.setWidgetResizable(<span class="literal">True</span>)</span><br><span class="line">        scrollArea.setWidget(scrollWidget)</span><br><span class="line">        layout.addWidget(scrollArea,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>)<span class="comment"># 位于layout第二行第一列，占据1行2列</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        refreshBtn = QtWidgets.QPushButton(<span class="string">&#x27;Refresh&#x27;</span>)</span><br><span class="line">        refreshBtn.clicked.connect(<span class="variable language_">self</span>.populate)</span><br><span class="line">        layout.addWidget(refreshBtn, <span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">createLight</span>(<span class="params">self</span>):</span><br><span class="line">        lightType = <span class="variable language_">self</span>.lightTypeCB.currentText()</span><br><span class="line">        func = <span class="variable language_">self</span>.lightTypes[lightType]</span><br><span class="line">        </span><br><span class="line">        light = func()</span><br><span class="line">        <span class="variable language_">self</span>.addLight(light)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">addLight</span>(<span class="params">self, light</span>):</span><br><span class="line">        widget = LightWidget(light)</span><br><span class="line">        <span class="variable language_">self</span>.scrollLayout.addWidget(widget)</span><br><span class="line">        widget.onSolo.connect(<span class="variable language_">self</span>.onSolo)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">onSolo</span>(<span class="params">self, value</span>):</span><br><span class="line">        lightWidgets = <span class="variable language_">self</span>.findChildren(LightWidget)</span><br><span class="line">        <span class="keyword">for</span> widget <span class="keyword">in</span> lightWidgets:</span><br><span class="line">            <span class="keyword">if</span> widget != <span class="variable language_">self</span>.sender():</span><br><span class="line">                widget.disableLight(value)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LightWidget</span>(QtWidgets.QWidget):</span><br><span class="line">    </span><br><span class="line">    onSolo = Signal(<span class="built_in">bool</span>)<span class="comment">#QtCore.pyqtSignal 使用pyqt；QtCore.Singal使用pyside2</span></span><br><span class="line">    <span class="comment"># 在我们后面的定义中，对不同版本的Qt进行了判断，可以统一使用</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, light</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(light, <span class="built_in">str</span>):</span><br><span class="line">            light = pm.PyNode(light)</span><br><span class="line">        <span class="variable language_">self</span>.light = light</span><br><span class="line">        <span class="variable language_">self</span>.buildUI()</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUI</span>(<span class="params">self</span>):</span><br><span class="line">        layout = QtWidgets.QGridLayout(<span class="variable language_">self</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 可见性选择框</span></span><br><span class="line">        <span class="variable language_">self</span>.name = QtWidgets.QCheckBox(<span class="built_in">str</span>(<span class="variable language_">self</span>.light.getTransform()))</span><br><span class="line">        <span class="variable language_">self</span>.name.setChecked(<span class="variable language_">self</span>.light.visibility.get())</span><br><span class="line">        <span class="variable language_">self</span>.name.toggled.connect(<span class="keyword">lambda</span> val: <span class="variable language_">self</span>.light.getTransform().visibility.<span class="built_in">set</span>(val))</span><br><span class="line">        <span class="comment">#def setLightVisibility(val):</span></span><br><span class="line">        <span class="comment">#    self.light.visibility.set(val)</span></span><br><span class="line">        <span class="comment"># self.light 只表示shapeNode,因此需要在transofrm上设置可见项</span></span><br><span class="line">        layout.addWidget(<span class="variable language_">self</span>.name, <span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Solo按钮</span></span><br><span class="line">        soloBtn = QtWidgets.QPushButton(<span class="string">&#x27;Solo&#x27;</span>)</span><br><span class="line">        soloBtn.setCheckable(<span class="literal">True</span>)</span><br><span class="line">        soloBtn.toggled.connect(<span class="keyword">lambda</span> val: <span class="variable language_">self</span>.onSolo.emit(val))</span><br><span class="line">        </span><br><span class="line">        layout.addWidget(soloBtn, <span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">        <span class="comment"># 删除按钮</span></span><br><span class="line">        deleteBtn = QtWidgets.QPushButton(<span class="string">&#x27;X&#x27;</span>)</span><br><span class="line">        deleteBtn.clicked.connect(<span class="variable language_">self</span>.deleteLight)</span><br><span class="line">        deleteBtn.setMaximumWidth(<span class="number">10</span>)</span><br><span class="line">        layout.addWidget(deleteBtn,<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#灯光强度</span></span><br><span class="line">        intensity = QtWidgets.QSlider(QtCore.Qt.Horizontal)</span><br><span class="line">        intensity.setMinimum(<span class="number">1</span>)</span><br><span class="line">        intensity.setMaximum(<span class="number">1000</span>)</span><br><span class="line">        intensity.setValue(<span class="variable language_">self</span>.light.intensity.get())</span><br><span class="line">        intensity.valueChanged.connect(<span class="keyword">lambda</span> val:<span class="variable language_">self</span>.light.intensity.<span class="built_in">set</span>(val))</span><br><span class="line">        layout.addWidget(intensity, <span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="variable language_">self</span>.colorBtn = QtWidgets.QPushButton()</span><br><span class="line">        <span class="variable language_">self</span>.colorBtn.setMaximumWidth(<span class="number">20</span>)</span><br><span class="line">        <span class="variable language_">self</span>.colorBtn.setMaximumHeight(<span class="number">20</span>)</span><br><span class="line">        <span class="variable language_">self</span>.setButtonColor()</span><br><span class="line">        <span class="variable language_">self</span>.colorBtn.clicked.connect(<span class="variable language_">self</span>.setColor)</span><br><span class="line">        layout.addWidget(<span class="variable language_">self</span>.colorBtn, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setButtonColor</span>(<span class="params">self,color = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> color:</span><br><span class="line">            color = <span class="variable language_">self</span>.light.color.get()</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(color) == <span class="number">3</span>, <span class="string">&quot;You must provide a list of 3 Color&quot;</span></span><br><span class="line">        </span><br><span class="line">        r,g,b = [c*<span class="number">255</span> <span class="keyword">for</span> c <span class="keyword">in</span> color]</span><br><span class="line">        <span class="variable language_">self</span>.colorBtn.setStyleSheet(<span class="string">&#x27;background-color: rgba(&#123;&#125;,&#123;&#125;,&#123;&#125;,1.0)&#x27;</span>.<span class="built_in">format</span>(r,g,b))</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setColor</span>(<span class="params">self</span>):</span><br><span class="line">        lightColor = <span class="variable language_">self</span>.light.color.get()</span><br><span class="line">        color = pm.colorEditor(rgbValue = lightColor)</span><br><span class="line">        <span class="comment">#print(color) maya编辑器给返回的是个字符串</span></span><br><span class="line">        r,g,b,a = [<span class="built_in">float</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> color.split()]</span><br><span class="line">        color = (r,g,b)</span><br><span class="line">        <span class="comment"># 改变灯光颜色</span></span><br><span class="line">        <span class="variable language_">self</span>.light.color.<span class="built_in">set</span>(color)</span><br><span class="line">        <span class="comment"># 改变UI上的颜色</span></span><br><span class="line">        <span class="variable language_">self</span>.setButtonColor(color)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">disableLight</span>(<span class="params">self,value</span>):</span><br><span class="line">        <span class="variable language_">self</span>.name.setChecked(<span class="keyword">not</span> value)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deleteLight</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 删除UI</span></span><br><span class="line">        <span class="variable language_">self</span>.setParent(<span class="literal">None</span>)</span><br><span class="line">        <span class="variable language_">self</span>.setVisible(<span class="literal">False</span>)</span><br><span class="line">        <span class="variable language_">self</span>.deleteLater()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 删除灯光</span></span><br><span class="line">        pm.delete(<span class="variable language_">self</span>.light.getTransform())</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">showUI</span>():</span><br><span class="line">    ui = LightManager()</span><br><span class="line">    ui.show()</span><br><span class="line">    <span class="keyword">return</span> ui</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lightingManager</span><br><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line">importlib.reload(lightingManager)</span><br><span class="line"></span><br><span class="line">ui = lightingManager.LightManager().show()</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../../%25E5%25AD%25A6%25E4%25B9%25A0/%25E6%25B5%2599%25E5%25A4%25A7/Python%2520in%2520Maya/note/Class5/image-20220703181152950.png" alt="image-20220703181152950"></p>
<p>将窗口设为maya窗口的子窗口后，窗口和maya工作区成为一个整体，在maya工作区工作不会让组件窗口消失了，在任务栏也不会看到额外的maya窗口</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lightingManager</span><br><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line">importlib.reload(lightingManager)</span><br><span class="line"></span><br><span class="line"><span class="comment">#ui = lightingManager.LightManager().show()</span></span><br><span class="line"><span class="comment">#lightingManager.LightManager().show()</span></span><br><span class="line">lightingManager.getDock()</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../../%25E5%25AD%25A6%25E4%25B9%25A0/%25E6%25B5%2599%25E5%25A4%25A7/Python%2520in%2520Maya/note/Class5/image-20220703181632027.png" alt="image-20220703181632027"></p>
<h3 id="Handle-error"><a href="#Handle-error" class="headerlink" title="Handle error"></a>Handle error</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#raise &quot;message&quot;#raise会停止后面的语句</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do</span>():</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="comment">#用try except来处理，当出现错误又不希望程序停止时</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    do()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;There was an Error&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Goodbye&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Hello</span></span><br><span class="line"><span class="comment">#There was an Error</span></span><br><span class="line"><span class="comment">#Goodbye</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError()<span class="comment">#IOError(),Exception()</span></span><br><span class="line"><span class="keyword">except</span> RuntimeError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;RuntimeError&quot;</span>)</span><br><span class="line"><span class="keyword">except</span>:<span class="comment">#else也可以用</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;other error&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Running&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> RuntimeError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;RuntimeError&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;no error&quot;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;done&quot;</span>)</span><br><span class="line"><span class="comment">#Running</span></span><br><span class="line"><span class="comment">#no error</span></span><br><span class="line"><span class="comment">#done</span></span><br><span class="line"><span class="comment">#执行try后，else一定会被执行(except 可以看作一种if)</span></span><br></pre></td></tr></table></figure>

<h3 id="Exporting-and-Importing-Our-Lights"><a href="#Exporting-and-Importing-Our-Lights" class="headerlink" title="Exporting and Importing Our Lights"></a>Exporting and Importing Our Lights</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">saveBtn = QtWidgets.QPushButton(<span class="string">&#x27;Save&#x27;</span>)</span><br><span class="line">saveBtn.clicked.connect(<span class="variable language_">self</span>.saveLights)</span><br><span class="line">layout.addWidget(saveBtn,<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">saveLights</span>(<span class="params">self</span>):</span><br><span class="line">    properties = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> lightWidget <span class="keyword">in</span> <span class="variable language_">self</span>.findChildren(LightWidget):</span><br><span class="line">        light = lightWidget.light</span><br><span class="line">        transform = light.getTransform()</span><br><span class="line"></span><br><span class="line">        properties[<span class="built_in">str</span>(transform)] = &#123;</span><br><span class="line">            <span class="string">&quot;translate&quot;</span>: <span class="built_in">list</span>(transform.translate.get()),</span><br><span class="line">            <span class="string">&quot;rotation&quot;</span>: <span class="built_in">list</span>(transform.rotate.get()),</span><br><span class="line">            <span class="string">&quot;lightType&quot;</span>: pm.objectType(light),</span><br><span class="line">            <span class="string">&quot;intensity&quot;</span>: light.intensity.get(),</span><br><span class="line">            <span class="string">&quot;color&quot;</span>: light.color.get()</span><br><span class="line">        &#125;</span><br><span class="line">    directory = os.path.join(pm.internalVar(userAppDir = <span class="literal">True</span>),<span class="string">&#x27;lightManager&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(directory):</span><br><span class="line">        os.mkdir(directory)</span><br><span class="line">    lightFile = os.path.join(directory,<span class="string">&#x27;lightFile_&#123;&#125;.json&#x27;</span>.<span class="built_in">format</span>(time.strftime(<span class="string">&#x27;%m%d&#x27;</span>)))</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(lightFile, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        json.dump(properties, f, indent = <span class="number">4</span>)</span><br><span class="line">    logger.info(<span class="string">&quot;Saving file to &#123;&#125;&quot;</span>.<span class="built_in">format</span>(lightFile))</span><br><span class="line">        </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">importBtn = QtWidgets.QPushButton(<span class="string">&#x27;Import&#x27;</span>)</span><br><span class="line">importBtn.clicked.connect(<span class="variable language_">self</span>.importLights)</span><br><span class="line">layout.addWidget(importBtn,<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">importLights</span>(<span class="params">self</span>):</span><br><span class="line">    directory = <span class="variable language_">self</span>.getDirectory()</span><br><span class="line">    fileName = QtWidgets.QFileDialog.getOpenFileName(<span class="variable language_">self</span>, <span class="string">&quot;Light Browser&quot;</span>, directory)</span><br><span class="line">    <span class="comment">#print(fileName)#(&#x27;C:/Users/XZYW/文档/maya/lightManager/lightFile_0703.json&#x27;, &#x27;所有文件 (*)&#x27;)</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(fileName[<span class="number">0</span>], <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        properties = json.load(f)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">for</span> light, info <span class="keyword">in</span> properties.items():</span><br><span class="line">        lightType = info.get(<span class="string">&#x27;lightType&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> lt <span class="keyword">in</span> <span class="variable language_">self</span>.lightTypes:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;&#123;&#125;Light&quot;</span>.<span class="built_in">format</span>(lt.split()[<span class="number">0</span>].lower()) == lightType:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.info(<span class="string">&quot;Cannot find a corresponding lightType for &#123;&#125; (&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(light, lightType))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        light = <span class="variable language_">self</span>.createLight(lightType = lt)</span><br><span class="line">        light.intensity.<span class="built_in">set</span>(info.get(<span class="string">&#x27;intensity&#x27;</span>))</span><br><span class="line">        light.color.<span class="built_in">set</span>(info.get(<span class="string">&#x27;color&#x27;</span>))</span><br><span class="line">        transform = light.getTransform()</span><br><span class="line">        transform.translate.<span class="built_in">set</span>(info.get(<span class="string">&#x27;translate&#x27;</span>))</span><br><span class="line">        transform.rotate.<span class="built_in">set</span>(info.get(<span class="string">&#x27;rotation&#x27;</span>))</span><br><span class="line">        </span><br><span class="line">    <span class="variable language_">self</span>.populate()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createLight</span>(<span class="params">self, lightType = <span class="literal">None</span>, add = <span class="literal">True</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> lightType:</span><br><span class="line">        lightType = <span class="variable language_">self</span>.lightTypeCB.currentText()</span><br><span class="line">    func = <span class="variable language_">self</span>.lightTypes[lightType]</span><br><span class="line">    </span><br><span class="line">    light = func()</span><br><span class="line">    <span class="keyword">if</span> add:</span><br><span class="line">        <span class="variable language_">self</span>.addLight(light)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> light</span><br></pre></td></tr></table></figure>

<h3 id="命令行-文件重命名"><a href="#命令行-文件重命名" class="headerlink" title="命令行 文件重命名"></a>命令行 文件重命名</h3><p>cliRenamer.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description = <span class="string">&quot;This is a batch renamer&quot;</span>, usage = <span class="string">&quot;To replace all files with hello with goodbye instead: python clirenamer.py hello goodbye&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;inString&#x27;</span>, <span class="built_in">help</span> = <span class="string">&quot;The world to replace&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;outString&#x27;</span>, <span class="built_in">help</span> = <span class="string">&quot;The world to replace it with&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-d&#x27;</span>, <span class="string">&#x27;--duplicate&#x27;</span>, <span class="built_in">help</span> = <span class="string">&quot;Whether to duplicate or replace in spot&quot;</span>, action = <span class="string">&#x27;store_true&#x27;</span>)<span class="comment">#默认为False</span></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;--regex&#x27;</span>,</span><br><span class="line">                       <span class="built_in">help</span> = <span class="string">&quot;Whether the patterns are regex or not&quot;</span>,</span><br><span class="line">                       action = <span class="string">&quot;store_true&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;--out&#x27;</span>,</span><br><span class="line">                       <span class="built_in">help</span> = <span class="string">&quot;The output location. Defaults to here&quot;</span>)</span><br><span class="line">    args = parser.parser_args()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(args)</span><br><span class="line">	rename(args.inString,args.outString, duplicate = args.duplicate,</span><br><span class="line">          outDirectory = args.out, regex = args.regex)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rename</span>(<span class="params">inString, outString, duplicate = <span class="literal">True</span>, inDirectory = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">           outDirectory = <span class="literal">None</span>, regex = <span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> inDirectory:</span><br><span class="line">        inDirectory = os.getcwd()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> outDirectory:</span><br><span class="line">        outDIrectory = inDirectory</span><br><span class="line">    outDirectory = os.path.abspath(outDirectory)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(outDirectory):</span><br><span class="line">        <span class="keyword">raise</span> IOError(<span class="string">&#x27;&#123;&#125; does not exist&#x27;</span>.<span class="built_in">format</span>(outDirectory))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(inDirectory):</span><br><span class="line">        <span class="keyword">raise</span> IOError(<span class="string">&#x27;&#123;&#125; does not exist&#x27;</span>.<span class="built_in">format</span>(inDirectory))</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(inDirectory):</span><br><span class="line">        <span class="keyword">if</span> .startwith(<span class="string">&#x27;.&#x27;</span>):<span class="comment">#linux,mac中.开头表示隐藏文件</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">         </span><br><span class="line">        <span class="keyword">if</span> regex:</span><br><span class="line">            name = re.sub(inString, outString, f)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">        	name = f.replace(inString, outString)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(name)</span><br><span class="line">        <span class="keyword">if</span> name == f:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        src = os.path.join(inDirectory, f)</span><br><span class="line">        dest = os.path.join(outDirectory, name)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> duplicate:</span><br><span class="line">            shutil.copy2(src, dest)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            os.rename(src, dest)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:z</span><br><span class="line">    main()<span class="comment">#分离命名空间，只有当这个文件命名空间是main的时候才运行</span></span><br></pre></td></tr></table></figure>



<h3 id="sys模块"><a href="#sys模块" class="headerlink" title="sys模块"></a>sys模块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> subprocess<span class="comment">#子进程</span></span><br><span class="line">subprocess.call([<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;../cliRenamer.py&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>])</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/10/TA/Maya/cmds%EF%BC%88%E5%9B%9B%EF%BC%89/" data-id="cmfe1u6p7000zscuh5cvugri4" class="article-share-link">
        Share
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Maya/cmds（三）" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    

    
    <div class="article-meta">
      <a href="/2025/09/10/TA/Maya/cmds%EF%BC%88%E4%B8%89%EF%BC%89/" class="article-date">
  <time datetime="2025-09-10T13:18:14.017Z" itemprop="datePublished">2025-09-10</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="【Maya】Python-For-Maya（Cmds）（三）The-Animation-Tweener"><a href="#【Maya】Python-For-Maya（Cmds）（三）The-Animation-Tweener" class="headerlink" title="【Maya】Python For Maya（Cmds）（三）The Animation Tweener"></a>【Maya】Python For Maya（Cmds）（三）The Animation Tweener</h2><h3 id="一、UI-library"><a href="#一、UI-library" class="headerlink" title="一、UI library"></a><strong>一、UI library</strong></h3><ul>
<li><p>QT</p>
<ul>
<li>maya的UI就是用QT建立的</li>
</ul>
</li>
<li><p>PySide</p>
</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220630000053014.png" alt="image-20220630000053014" style="zoom:50%;" />

<p>选取某一帧进行百分比插值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tween</span>(<span class="params">percentage, obj = <span class="literal">None</span>, attrs = <span class="literal">None</span>, selection = <span class="literal">True</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> obj <span class="keyword">and</span> <span class="keyword">not</span> selection:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;No object given to tween&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> obj:</span><br><span class="line">        obj = cmds.ls(selection = <span class="literal">True</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> attrs:</span><br><span class="line">        attrs = cmds.listAttr(obj,keyable = <span class="literal">True</span>)</span><br><span class="line">    currentTime = cmds.currentTime(query = <span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> attr <span class="keyword">in</span> attrs:</span><br><span class="line">        <span class="comment"># construct the full name of the attr with its obj</span></span><br><span class="line">        attrFull = <span class="string">&#x27;&#123;&#125;.&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(obj,attr)</span><br><span class="line">        <span class="comment"># get the keyframes of the attr on this obj</span></span><br><span class="line">        keyframes = cmds.keyframe(attrFull, query = <span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> keyframes:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        previousKeyframes = [frame <span class="keyword">for</span> frame <span class="keyword">in</span> keyframes <span class="keyword">if</span> frame &lt; currentTime]</span><br><span class="line">        </span><br><span class="line">        laterKeyframes = [frame <span class="keyword">for</span> frame <span class="keyword">in</span> keyframes <span class="keyword">if</span> frame&gt; currentTime]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> previousKeyframes <span class="keyword">and</span> <span class="keyword">not</span> laterKeyframes:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> previousKeyframes:</span><br><span class="line">            previousFrame = <span class="built_in">max</span>(previousKeyframes)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            previousFrame = <span class="literal">None</span></span><br><span class="line">        nextFrame = <span class="built_in">min</span>(laterKeyframes) <span class="keyword">if</span> laterKeyframes <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> previousFrame <span class="keyword">or</span> <span class="keyword">not</span> nextFrame:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        previousValue = cmds.getAttr(attrFull, time = previousFrame)</span><br><span class="line">        nextValue = cmds.getAttr(attrFull, time = nextFrame)</span><br><span class="line">        </span><br><span class="line">        difference = nextValue - previousValue</span><br><span class="line">        weightedDifference = (difference*percentage) / <span class="number">100.0</span></span><br><span class="line">        currentValue = previousValue + weightedDifference</span><br><span class="line">        <span class="built_in">print</span>(previousValue)</span><br><span class="line">        <span class="built_in">print</span>(nextValue)</span><br><span class="line">        <span class="built_in">print</span>(currentValue)</span><br><span class="line">        cmds.setKeyframe(attrFull, time = currentTime, value = currentValue)</span><br><span class="line">        </span><br><span class="line">tween(<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<h3 id="二、创建窗口"><a href="#二、创建窗口" class="headerlink" title="二、创建窗口"></a><strong>二、创建窗口</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.cmds <span class="keyword">as</span> cmds</span><br><span class="line"></span><br><span class="line"><span class="comment"># Make a new window</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">window = cmds.window( title=<span class="string">&quot;Long Name&quot;</span>, iconName=<span class="string">&#x27;Short Name&#x27;</span>, widthHeight=(<span class="number">200</span>, <span class="number">55</span>) )</span><br><span class="line">cmds.columnLayout( adjustableColumn=<span class="literal">True</span> )</span><br><span class="line">cmds.button( label=<span class="string">&#x27;Do Nothing&#x27;</span> )</span><br><span class="line">cmds.button( label=<span class="string">&#x27;Close&#x27;</span>, command=(<span class="string">&#x27;cmds.deleteUI(\&quot;&#x27;</span> + window + <span class="string">&#x27;\&quot;, window=True)&#x27;</span>) )</span><br><span class="line">cmds.setParent( <span class="string">&#x27;..&#x27;</span> )</span><br><span class="line">cmds.showWindow( window )</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TweenWindow</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    windowName = <span class="string">&quot;TweenerWindow&quot;</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> cmds.window(<span class="variable language_">self</span>.windowName, query = <span class="literal">True</span>, exists = <span class="literal">True</span>):</span><br><span class="line">            cmds.deleteUI(<span class="variable language_">self</span>.windowName)</span><br><span class="line">        cmds.window(<span class="variable language_">self</span>.windowName)</span><br><span class="line">        <span class="variable language_">self</span>.buildUI()</span><br><span class="line">        cmds.showWindow()</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUI</span>(<span class="params">self</span>):</span><br><span class="line">        column = cmds.colunmLayout()</span><br><span class="line">        cmds.text(label = <span class="string">&quot;Use this slider to set the tween amout&quot;</span>)</span><br><span class="line">        row = cmds.rowLayout(numberOfColumns = <span class="number">2</span>)</span><br><span class="line">        <span class="variable language_">self</span>.slider = cmds.floatSlider(<span class="built_in">min</span> = <span class="number">0</span>, <span class="built_in">max</span> = <span class="number">100</span>, value = <span class="number">50</span>,step = <span class="number">1</span>,changeCommand = tween)</span><br><span class="line">        cmds.button(labe = <span class="string">&quot;Reset&quot;</span>,command = <span class="variable language_">self</span>.reset)</span><br><span class="line">        </span><br><span class="line">        cmds.setParent(column)</span><br><span class="line">        cmds.button(label = <span class="string">&quot;Close&quot;</span>, command = <span class="variable language_">self</span>.close)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reset</span>(<span class="params">self,*args</span>):<span class="comment">#button默认传递参数，但不重要</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;resetting UI&quot;</span>)</span><br><span class="line">        cmds.floatSlider(<span class="variable language_">self</span>.slider, edit = <span class="literal">True</span>, value = <span class="number">50</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self,*args</span>):</span><br><span class="line">        cmds.deleteUI(<span class="variable language_">self</span>.windowName)</span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<h3 id="三、Base-UI-for-different-function"><a href="#三、Base-UI-for-different-function" class="headerlink" title="三、Base UI for different function"></a><strong>三、Base UI for different function</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tween</span><br><span class="line"><span class="keyword">import</span> Gear</span><br><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseWindow</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    windowName = <span class="string">&quot;BaseWindow&quot;</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> cmds.window(<span class="variable language_">self</span>.windowName, query = <span class="literal">True</span>, exists = <span class="literal">True</span>):</span><br><span class="line">            cmds.deleteUI(<span class="variable language_">self</span>.windowName)</span><br><span class="line">        cmds.window(<span class="variable language_">self</span>.windowName)</span><br><span class="line">        <span class="variable language_">self</span>.buildUI()</span><br><span class="line">        cmds.showWindow()</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUI</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reset</span>(<span class="params">self,*args</span>):<span class="comment">#button默认传递参数，但不重要</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self,*args</span>):</span><br><span class="line">        cmds.deleteUI(<span class="variable language_">self</span>.windowName)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TweenerUI</span>(<span class="title class_ inherited__">BaseWindow</span>):<span class="comment">#继承basewindow基类</span></span><br><span class="line">    windowName = <span class="string">&quot;TweenerWindow&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUI</span>(<span class="params">self</span>):</span><br><span class="line">        column = cmds.colunmLayout()</span><br><span class="line">        cmds.text(label = <span class="string">&quot;Use this slider to set the tween amout&quot;</span>)</span><br><span class="line">        row = cmds.rowLayout(numberOfColumns = <span class="number">2</span>)</span><br><span class="line">        <span class="variable language_">self</span>.slider = cmds.floatSlider(<span class="built_in">min</span> = <span class="number">0</span>, <span class="built_in">max</span> = <span class="number">100</span>, value = <span class="number">50</span>,step = <span class="number">1</span>,changeCommand = tween)</span><br><span class="line">        cmds.button(labe = <span class="string">&quot;Reset&quot;</span>,command = <span class="variable language_">self</span>.reset)</span><br><span class="line">        </span><br><span class="line">        cmds.setParent(column)</span><br><span class="line">        cmds.button(label = <span class="string">&quot;Close&quot;</span>, command = <span class="variable language_">self</span>.close)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reset</span>(<span class="params">self,*args</span>):<span class="comment">#button默认传递参数，但不重要</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;resetting UI&quot;</span>)</span><br><span class="line">        cmds.floatSlider(<span class="variable language_">self</span>.slider, edit = <span class="literal">True</span>, value = <span class="number">50</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GearUI</span>(<span class="title class_ inherited__">BaseWindow</span>):</span><br><span class="line">    windowName = <span class="string">&quot;GearWindow&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.gear = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">buildUI</span>(<span class="params">self</span>):</span><br><span class="line">        column = cmds.columnLayout()</span><br><span class="line">        cmds.text(label = <span class="string">&quot;Use the silider to modify the gear&quot;</span>)</span><br><span class="line">        cmds.rowLayout(numberOfColumns = <span class="number">4</span>)</span><br><span class="line">        <span class="variable language_">self</span>.label = cmds.text(label = <span class="string">&quot;10&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.slider = cmds.intSlider(<span class="built_in">min</span> = <span class="number">5</span>, <span class="built_in">max</span> = <span class="number">30</span>, value = <span class="number">10</span>,step = <span class="number">1</span>, dragCommand = <span class="variable language_">self</span>.modifyGear)</span><br><span class="line">        cmds.button(label = <span class="string">&quot;Make Gear&quot;</span>, command = <span class="variable language_">self</span>.makeGear)</span><br><span class="line">        cmds.button(label = <span class="string">&quot;Reset&quot;</span>,command = <span class="variable language_">self</span>.reset)</span><br><span class="line">        cmds.setParent(column)</span><br><span class="line">        cmds.button(label = <span class="string">&quot;Close&quot;</span>,command = <span class="variable language_">self</span>.close)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">makeGear</span>(<span class="params">self,*args</span>):</span><br><span class="line">        teeth = cmds.intSlider(<span class="variable language_">self</span>.slider,query = <span class="literal">True</span>, value = <span class="literal">True</span>)</span><br><span class="line">        <span class="variable language_">self</span>.gear = Gear()</span><br><span class="line">        <span class="variable language_">self</span>.gear.createGear(teeth = teeth)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">modifyGear</span>(<span class="params">self,teeth</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.gear:</span><br><span class="line">            <span class="variable language_">self</span>.gear.changeTeeth(teeth = teeth)</span><br><span class="line">        cmds.text(<span class="variable language_">self</span>.label,edit = <span class="literal">True</span>, label = teeth</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reset</span>(<span class="params">self,*args</span>):</span><br><span class="line">        <span class="variable language_">self</span>.gear = <span class="literal">None</span></span><br><span class="line">        cmds.intSlider(<span class="variable language_">self</span>.slider,edit = <span class="literal">True</span>,value = <span class="number">10</span>)</span><br><span class="line">                  cmds.text(<span class="variable language_">self</span>.label,eidt = <span class="literal">True</span>,label = <span class="string">&#x27;10&#x27;</span>)</span><br><span class="line">GearUI().show()</span><br></pre></td></tr></table></figure>

<h3 id="四、Add-script-to-maya-shelf"><a href="#四、Add-script-to-maya-shelf" class="headerlink" title="四、Add script to maya shelf"></a><strong>四、Add script to maya shelf</strong></h3><p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220701001501311.png" alt="image-20220701001501311"></p>
<p>直接选中脚本代码，然后拖到上面，就出现了一个按钮，一点按钮，自动运行，右键可以修改</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/10/TA/Maya/cmds%EF%BC%88%E4%B8%89%EF%BC%89/" data-id="cmfe1u6p70013scuh1zk18b91" class="article-share-link">
        Share
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Graphics/Sampling" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    

    
    <div class="article-meta">
      <a href="/2025/09/10/TA/Graphics/Sampling/" class="article-date">
  <time datetime="2025-09-10T13:18:14.015Z" itemprop="datePublished">2025-09-10</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="球面均匀采样"><a href="#球面均匀采样" class="headerlink" title="球面均匀采样"></a>球面均匀采样</h2><p>对于一个参数化的单位球面<br>$$<br>x&#x3D;\cos\theta \cos\phi\<br>y&#x3D;\cos\theta \sin\phi\<br>z&#x3D;\sin\theta<br>$$</p>
<p>如果很自然地对$\theta \sim U[0,\pi],\phi \sim U[0,2\pi]$ 均匀采样的话,这张可视化的图可以很容易理解（这里$\theta,\phi $ 和我是反的）</p>
<p><img src="http://corysimon.github.io/images/sphere/incorrect.png" alt="image"></p>
<p>回忆球面到平面参数化的展开图（如HDR图、地图），在顶部和底部的的两条线会被压缩成极点，因此靠近这两个边缘的点的分布会变得非常密集。</p>
<p>那么一般的做法是，因为我们考虑球面均匀采样，是面积均匀，对于某个采样点v，因此我们希望它的概率密度函数$pdf(v) &#x3D; \frac{1}{4\pi}$ ，</p>
<p>然后我们需要将这个采样点参数化，利用概率密度函数在积分域上积分为1<br>$$<br>pdf(v)dA &#x3D; \frac{1}{4\pi}dA &#x3D; pdf(\theta,\phi)d\theta d\phi<br>$$<br>那么这样我们需要找到$dA$ 和$d\theta d\phi$ 的映射关系，而面积微元$dA &#x3D; \sin\theta d\theta d\phi$</p>
<p>所以联合概率密度函数<br>$$<br>pdf(\theta,\phi) &#x3D; \frac{1}{4\pi}\sin\theta<br>$$<br>可以求出边际概率密度函数，由于$\theta,\phi$ 是独立的，其实也就是$\theta,\phi$ 各自的概率密度函数<br>$$<br>pdf(\theta) &#x3D; \int_0^{2\pi}pdf(\theta,\phi)d\phi &#x3D; \frac{\sin\theta}{2}\<br>pdf(\phi)&#x3D;\int_0^\pi pdf(\theta,\phi)d\theta &#x3D; \frac{1}{2\pi}<br>$$<br>概率分布函数&#x2F;累积分布函数<br>$$<br>F(\theta) &#x3D; \int_0^\theta pdf(\theta)d\theta &#x3D; \frac{1-\cos\theta}{2}\<br>F(\phi) &#x3D; \int_0^\phi pdf(\phi)d\phi &#x3D; \frac{\phi}{2\pi}<br>$$<br>也就是说，我们的参数化平面这张图上，$\theta，\phi$ 的分布就应该长这个样子了。</p>
<p>但是如何来获得一个这种分布呢？</p>
<p>方法有很多</p>
<h3 id="逆变换采样"><a href="#逆变换采样" class="headerlink" title="逆变换采样"></a>逆变换采样</h3><p>就实际应用上来说，我们最容易做的random也就是均匀分布。</p>
<p>利用一个均匀分布来得到另外一种分布，我们需要用到一个东西叫做逆变换采样<strong>Inverse_transform_sampling</strong> </p>
<p>维基百科上这张图很形象</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/68/Inverse_transform_sampling.png/360px-Inverse_transform_sampling.png" alt="img"></p>
<p>其实就是假定某种变换$T$,使得$T(U) \sim F(\theta)$<br>$$<br>\因为U是均匀分布，因此有P(U\leq y) &#x3D; y\<br>F(\theta) &#x3D; P(\xi \leq \theta) &#x3D; P(T(U)\leq\theta)&#x3D;P(U\leq T^{-1}(\theta)) &#x3D; T^{-1}(\theta)\<br>那么自然知道，F(\theta) &#x3D; T^{-1}(\theta)\<br>那么这种变换T(U) &#x3D; F^{-1}(U)\<br>取两个随机变量\xi_1,\xi_2 \sim U\<br>F_{\theta}^{-1}(\xi_1) &#x3D; \arccos (1-2\xi_1)\<br>F_{\phi}^{-1}(\xi_2) &#x3D; 2\pi \xi_2<br>$$<br>至此推导完毕。</p>
<h3 id="其他采样方法"><a href="#其他采样方法" class="headerlink" title="其他采样方法"></a>其他采样方法</h3><p>Wolfram MathWorld里面还给了很多神奇的采样方法</p>
<h4 id="Marsaglia（1972）"><a href="#Marsaglia（1972）" class="headerlink" title="Marsaglia（1972）"></a>Marsaglia（1972）</h4><h5 id="1"><a href="#1" class="headerlink" title="(1)"></a>(1)</h5><p>$$<br>选择u &#x3D; \cos\theta 均匀分布，所以du &#x3D; \sin\theta d\theta\<br>x &#x3D; \sqrt{1-u^2}\cos\phi\<br>y &#x3D; \sqrt{1-u^2}\sin\phi\<br>z&#x3D;u<br>$$</p>
<h5 id="2"><a href="#2" class="headerlink" title="(2)"></a>(2)</h5><p>$$<br>选取x_1,x_2\sim U(0,1),进行剔除x_1^2+x_2^2\geq1\<br>x &#x3D; 2x_1\sqrt{1-x_1^2-x_2^2}\<br>y &#x3D; 2x_2\sqrt{1-x_1^2-x_2^2}\<br>z &#x3D; 1-2(x_1^2+x_2^2)<br>$$</p>
<h4 id="Cook-1957，Marsaglia-1972"><a href="#Cook-1957，Marsaglia-1972" class="headerlink" title="Cook 1957，Marsaglia 1972"></a>Cook 1957，Marsaglia 1972</h4><p>$$<br>选取x_0,x_1,x_2,x_3\sim U(-1,1)，拒绝域x_0^2+x_1^2+x_2^2+x_3^2\ge1\<br>利用四元数的变换规则\<br>x &#x3D; \frac{2(x_1x_3+x_0x_2)}{x_0^2+x_1^2+x_2^2+x_3^2}\<br>y &#x3D; \frac{2(x_2x_3-x_0x_1)}{x_0^2+x_1^2+x_2^2+x_3^2}\<br>z &#x3D; \frac{x_0^2+x_3^2-x_1^2-x_2^2}{x_0^2+x_1^2+x_2^2+x_3^2}\<br>$$</p>
<h4 id="Muller-1959，Marsaglia-1972"><a href="#Muller-1959，Marsaglia-1972" class="headerlink" title="Muller 1959，Marsaglia 1972"></a>Muller 1959，Marsaglia 1972</h4><p>$$<br>生成三个高斯随机变量x,y,z\<br>向量\frac{1}{\sqrt{x^2+y^2+z^2}}\left[\begin{array}{} x\y\z\end{array}{}\right]<br>\在表面S^2上是均匀的<br>$$</p>
<h3 id="【参考资料】"><a href="#【参考资料】" class="headerlink" title="【参考资料】"></a>【参考资料】</h3><p><a target="_blank" rel="noopener" href="http://corysimon.github.io/articles/uniformdistn-on-sphere/">http://corysimon.github.io/articles/uniformdistn-on-sphere/</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/360420413">https://zhuanlan.zhihu.com/p/360420413</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/49746076">https://zhuanlan.zhihu.com/p/49746076</a></p>
<p><a target="_blank" rel="noopener" href="https://mathworld.wolfram.com/SpherePointPicking.html">球体点拾取 – 来自 Wolfram MathWorld</a></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Inverse_transform_sampling">逆变换采样 - 维基百科，自由的百科全书 (wikipedia.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv5661231/">https://www.bilibili.com/read/cv5661231/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/10/TA/Graphics/Sampling/" data-id="cmfe1u6p5000nscuhbxb01w9f" class="article-share-link">
        Share
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Maya/Maya python工作流" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    

    
    <div class="article-meta">
      <a href="/2025/09/10/TA/Maya/Maya%20python%E5%B7%A5%E4%BD%9C%E6%B5%81/" class="article-date">
  <time datetime="2025-09-10T13:18:14.015Z" itemprop="datePublished">2025-09-10</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="Git-Vscode-Maya-Python-工作流"><a href="#Git-Vscode-Maya-Python-工作流" class="headerlink" title="Git-Vscode-Maya Python 工作流"></a>Git-Vscode-Maya Python 工作流</h2><h3 id="Maya-Python-Vscode"><a href="#Maya-Python-Vscode" class="headerlink" title="Maya Python - Vscode"></a>Maya Python - Vscode</h3><p>在maya python当中的脚本编写与运行都十分麻烦。在vscode中编写则更容易。</p>
<p>也可以搜到一些关于maya python在vscode中使用的教程，但是本文会完善一些细节以及整合更优的工作流选择。</p>
<h4 id="安装VScode"><a href="#安装VScode" class="headerlink" title="安装VScode"></a>安装VScode</h4><p>首先我们要有一个Vscode，嗯，如果没有的话。</p>
<p>这一步很简单，直接在官网上下载就好了。</p>
<p>然后我们要在Vscode中安装python的扩展。第一个就是。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706231339098.png" alt="image-20220706231339098"></p>
<p>因为我们其实没有办法在Vscode中直接执行使用了maya api的python脚本，所以倒也不用指定python路径，但是如果要为了其他的项目写python程序的话，倒也可以设置一下。</p>
<h4 id="安装Maya相关扩展"><a href="#安装Maya相关扩展" class="headerlink" title="安装Maya相关扩展"></a>安装Maya相关扩展</h4><p>接下来我们安装Maya相关的插件</p>
<p>在Vscode的扩展商店中搜索maya，出现以下结果</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706231704583.png" alt="image-20220706231704583"></p>
<p>这里有三个插件，简单说，MayaPy &gt;&#x3D; MayaCode + MayaPort</p>
<p>安装MayaPy的同时，另外两个扩展就自动安装了。</p>
<p>但其实如果只安装MayaCode也够用。但懒得思考那么多，直接安装MayaPy好了，然后三个扩展都会安装好。</p>
<h4 id="扩展设置"><a href="#扩展设置" class="headerlink" title="扩展设置"></a>扩展设置</h4><p>首先我们来看MayaCode</p>
<p>安装好这个插件后，点击这个插件查看主页，从小齿轮进入它的扩展设置</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706225222529.png" alt="image-20220706225222529"></p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706225253173.png" alt="image-20220706225253173" style="zoom: 67%;" />

<p>默认提供了两个端口，一个是Mel的端口7001，一个是Python的端口7002。我就用默认端口了。</p>
<p>在MayaPort插件里的设置也是一模一样的。</p>
<p>然后我们打开Maya，在一个空白的脚本窗口输入：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.cmds <span class="keyword">as</span> cmds</span><br><span class="line"></span><br><span class="line">cmds.commandPort(name=<span class="string">&quot;:7001&quot;</span>, sourceType=<span class="string">&quot;mel&quot;</span>)</span><br><span class="line">cmds.commandPort(name=<span class="string">&quot;:7002&quot;</span>, sourceType=<span class="string">&quot;python&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>并运行。这个时候就建立好了Maya和Vscode的通信了。</p>
<h4 id="执行方法"><a href="#执行方法" class="headerlink" title="执行方法"></a>执行方法</h4><p>接下来如果我们在Vscode中随意打开一个python脚本文件</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706232441023.png" alt="image-20220706232441023" style="zoom: 80%;" />

<p>按住ctrl+shift+p，Vscode会弹出一个输入栏，输入Maya，会看到以下命令</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706232641057.png" alt="image-20220706232641057"></p>
<p>我们直接点击Maya: Send Python Code to Maya，再返回到maya的脚本窗口，如果顺利，就可以看到</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706232754568.png" alt="image-20220706232754568"></p>
<p>并且命令提示栏也说了，Shift+Alt+M就可以执行最近使用的命令，所以下次执行直接用这个快捷键就好了，当然点击旁边这个小齿轮也是可以更改快捷键的。</p>
<p>这是不是比Maya里面先全选还要在ctrl+enter方便很多呢？</p>
<h4 id="通信的自动初始化"><a href="#通信的自动初始化" class="headerlink" title="通信的自动初始化"></a>通信的自动初始化</h4><p>但是基于上面的设置你会发现，在下一次重新打开maya时，这个端口没了，除非重新在maya里运行一遍上面的端口设置代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.cmds <span class="keyword">as</span> cmds</span><br><span class="line"></span><br><span class="line">cmds.commandPort(name=<span class="string">&quot;:7001&quot;</span>, sourceType=<span class="string">&quot;mel&quot;</span>)</span><br><span class="line">cmds.commandPort(name=<span class="string">&quot;:7002&quot;</span>, sourceType=<span class="string">&quot;python&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>我们当然不想每次打开maya都先运行一遍。</p>
<p>这时Maya官网为我们提供了解决方案。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706234227465.png" alt="image-20220706234227465"></p>
<p>因此，我们只需要把上面这段代码保存到userSetup.py文件中，就可以在maya启动时自动执行了。注意userSetup.py文件放置的位置，MAYA_APP_DIR的获取需要在MEL脚本窗口执行getenv(“MAYA_APP_DIR”)，一般这个位置默认为“文档”夹中的maya，因此只需要放在：…&#x2F;文档&#x2F;maya&#x2F;20xx&#x2F;scripts 就好了。</p>
<p>这样所有设置就基本完成了。插件甚至具备代码提示、以及直接查看文档的功能，非常好用。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706235243445.png" alt="image-20220706235243445"></p>
<p>如果出现Vscode和Maya通信正常，但Vscode中使用maya API的代码未能识别（未定义、无代码提示）等问题，则需要按住ctrl+shift+p调出命令栏后，输入settings打开设置的json文件</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707030157538.png" alt="image-20220707030157538"></p>
<p>检查这两段代码是否在其中</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707030349083.png" alt="image-20220707030349083"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;python.autoComplete.extraPaths&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    path<span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;python.analysis.extraPaths&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    path</span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>



<h4 id="其他执行方法"><a href="#其他执行方法" class="headerlink" title="其他执行方法"></a>其他执行方法</h4><p>除了上面的命令执行，我们还可以右键点击代码的编辑栏，我们也可以看到这个命令，直接点击就能运行</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706233141949.png" alt="image-20220706233141949"></p>
<p>如果在Vscode中打开项目文件夹，在资源管理器窗口，右键点击这个python文件，同样可以找到执行的命令。</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706233418285.png" alt="image-20220706233418285" style="zoom:67%;" />

<p>然后是最后一种执行方法，比较复杂，没有特别的用处，可以跳过。</p>
<p>这个功能是MayaPy插件里的，前几天才发现，这个插件的开发者正是我之前关注过的一个TA前辈</p>
<p><a target="_blank" rel="noopener" href="https://blog.l0v0.com/">https://blog.l0v0.com/</a></p>
<p>当然，从他的描述可以看到，他也是基于另外两个插件做的开发。</p>
<p>这次我们主要会用到下面这个命令。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706233921163.png" alt="image-20220706233921163"></p>
<p>执行后，如果顺利的话，我们应该在maya中看到这样的输出</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706235620477.png" alt="image-20220706235620477"></p>
<p>如果不顺利，那么可能就会一直卡在运行阶段</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706235656773.png" alt="image-20220706235656773"></p>
<p>当然，如果这个时候点击红色方框来中断运行的话，maya中依然可以得到输出。会发现这次只有前面两行</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706235751957.png" alt="image-20220706235751957"></p>
<p>同时在控制台出现了这样一些问题。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220706235828788.png" alt="image-20220706235828788"></p>
<p>对于第三个reload的未定义问题很好理解，因为我这里用的是Maya2023，对于reload方法，Maya2023使用的python版本进行了一个封装，需要</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib.reload <span class="keyword">as</span> reload</span><br></pre></td></tr></table></figure>

<p>才能使用，但是低版本的Maya是没有这个问题的。所以合理猜想sys这个库所出现的问题可能也是由于我使用的Maya版本问题所引起的，如果大家使用低一点的Maya版本也许是能正常使用。</p>
<p>毕竟，用这个执行方法的话，是可以在Vscode的代码中设置断点的，能方便很多调试。</p>
<p>那么到这里Maya python到Vscode的工作流就结束了，大家也可以愉快地写代码了</p>
<h3 id="Vscode-Git"><a href="#Vscode-Git" class="headerlink" title="Vscode - Git"></a>Vscode - Git</h3><p>这一部分主要用于项目管理。</p>
<h4 id="Git安装"><a href="#Git安装" class="headerlink" title="Git安装"></a>Git安装</h4><p>Git安装不是github安装。git是一个工具，而github是一个网站。</p>
<p>要使用git，我们首先电脑上要有一个git。直接在官网下载就好了</p>
<p><a target="_blank" rel="noopener" href="https://git-scm.com/downloads/">https://git-scm.com/downloads/</a></p>
<p>这里我们下载Standalone的版本，选择合适的32位或64位环境就好了（我也没有用过Portable版，不知道这是干嘛的）</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707000633874.png" alt="image-20220707000633874"></p>
<p>安装过程中会出现一大堆选项，其实都不需要看，直接全部确认跳过就好了。当然，这里会出现一些关于GUI和git bash以及桌面图标这样的选择，其实大多用不上，想装就装，不想装也没影响。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707000937349.png" alt="image-20220707000937349"></p>
<p>然后这里我们选择默认编辑器的时候当然已经有了一个VScode编辑器，就不选别的了。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707001033292.png" alt="image-20220707001033292"></p>
<p>然后等待安装就好了。</p>
<p>安装完成后，我们按住键盘 win+R, 输入cmd打开命令提示符窗口，然后输入git，如果顺利，就会看到一些帮助信息了</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707001647831.png" alt="image-20220707001647831"></p>
<h4 id="在项目中使用Git"><a href="#在项目中使用Git" class="headerlink" title="在项目中使用Git"></a>在项目中使用Git</h4><p>因为我这两段写完了才想起来要用Vscode，因此如果对这个不感兴趣可以直接看后面的<strong>Vscode中的git</strong></p>
<p>但是把这里的内容看完的话也有助于理解git的使用。</p>
<h5 id="项目初始化"><a href="#项目初始化" class="headerlink" title="项目初始化"></a>项目初始化</h5><p>Git的用途是项目管理，那肯定要有一个项目。</p>
<p>既然有项目，我们肯定还要有一个项目文件夹。git管理项目都是以项目文件夹为单位的。</p>
<p>假设我们建立好了一个空文件夹准备用于我们的项目。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707001858456.png" alt="image-20220707001858456"></p>
<p>点击上面的文件资源地址，或者直接按alt+D，然后输入cmd回车运行</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707002323304.png" alt="image-20220707002323304"></p>
<p>我们就可以从当前的文件夹打开命令窗口。（当然也可以win+R输入cmd后从默认环境进入，然后通过cd 命令进入文件夹）</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707002441106.png" alt="image-20220707002441106"></p>
<p>然后在这里输入git init </p>
<p>我们就完成了一个本地仓库的初始化。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707002652658.png" alt="image-20220707002652658"></p>
<p>新生成的这个.git 文件夹是一个隐藏文件夹，一般来说，项目里的所有本地仓库管理都是在这个.git文件夹中进行的。每个项目都会有自己的.git 文件夹。</p>
<p>如果把这个文件夹删掉，本地的仓库也就没了，项目的所有git设置也就没了。</p>
<h5 id="代理设置"><a href="#代理设置" class="headerlink" title="代理设置"></a>代理设置</h5><p>由于git的服务器不在国内，访问git是非常不稳定的。为了舒适地访问git，想必大家都会使用代理服务器。</p>
<p>开启代理服务以后，打开网络和Internet设置，在最底部的代理设置中可以看到代理服务器的地址和端口</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707003407079.png" alt="image-20220707003407079" style="zoom: 67%;" />

<p>在命令提示符中输入下面这两行代码，当然地址和端口就是用上面的设置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global https.proxy http://127.0.0.1:端口</span><br><span class="line">git config --global https.proxy https://127.0.0.1:端口</span><br></pre></td></tr></table></figure>

<p>git的代理设置就完成了。</p>
<p>可以注意到这上面的代码中有一段 –global，它表示全局的意思。</p>
<p>因为每一个项目都有一个git本地仓库。加上–global，那么表示所有的项目都是用了这个设置，如果只希望当前的项目使用这个设置，那就不要加–global。</p>
<h5 id="远程仓库"><a href="#远程仓库" class="headerlink" title="远程仓库"></a>远程仓库</h5><p>除了本地仓库，还有许多远程仓库，如最熟知的github，就是一个远程仓库管理平台。事实上，除了github还有很多远程git仓库管理网站，国内熟知的gitee，好处是不会卡，也不用开代理。</p>
<p>我们已经有了远程仓库的账号（github账号），那么接下来需要让本地仓库知道这个账号</p>
<p>所以我们注册这个项目的使用者名称和邮箱，也就是你的github的名称和邮箱。这里的–global当然与前面是一个道理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name “李三”</span><br><span class="line">git config --global user.email &quot;xxxx@xx&quot;</span><br></pre></td></tr></table></figure>

<p>这个过程中，还可能在浏览器中弹出窗口需要你输入密码提供权限，这个时候顺着做就行了。</p>
<p>然后我们还要让git知道，这个本地仓库管理的项目，是远程仓库上的哪个项目。</p>
<p>我们打开github上的项目网站，点击右边的小按钮把地址复制下来。</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707002057771.png" alt="image-20220707002057771" style="zoom: 67%;" />



<p>然后在命令提示符中输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin https://xxx/xxx.git</span><br></pre></td></tr></table></figure>

<p>这样本地仓库和远程仓库就关联上了。</p>
<h5 id="Pulls"><a href="#Pulls" class="headerlink" title="Pulls"></a>Pulls</h5><p>首先我们的远程仓库已经有了项目内容，我们就先把它拉取（pull）到我们的本地仓库上</p>
<p>输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull origin main</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707004740536.png" alt="image-20220707004740536"></p>
<p>再打开我们的项目，就可以看到项目的所有内容都出现在我们的项目文件夹里了。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707004749157.png" alt="image-20220707004749157"></p>
<h5 id="Push"><a href="#Push" class="headerlink" title="Push"></a>Push</h5><p>我们在本地编写或者修改了代码，当然要把它上传到远程仓库。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m &quot;对当前修改的描述&quot;</span><br><span class="line">git push -u origin main</span><br></pre></td></tr></table></figure>

<p>这三行代码就可以搞定了。注意add后面是空格加小点，表示把当前所有修改的文件添加到git本地仓库中，commit命令确认这次修改。只add不commit是不行的。最后的push会将本地仓库上传到远程仓库。</p>
<h5 id="Vscode中的Git"><a href="#Vscode中的Git" class="headerlink" title="Vscode中的Git"></a>Vscode中的Git</h5><p>实际上Vscode里面就可以写命令行，所以上面的内容也可以在Vscode中直接写。</p>
<p><strong>代理设置这一步建议还是做一下</strong></p>
<p>但是Vscode也提供了很好的git管理工具，我们只需要可视化的操作就可以完成git管理。</p>
<p>首先在Vscode中还是打开我们的项目文件夹</p>
<p>可以看到这里的源代码管理栏。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707010649073.png" alt="image-20220707010649073"></p>
<p>点击这个初始化储存库就能进行git仓库的初始化（相当于git init）</p>
<p>然后在源代码管理这里点击右边的三个小点可以看到这个操作界面，所有的按钮都相当于一个git命令。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707011051015.png" alt="image-20220707011051015"></p>
<p>我们点击添加远程仓库，（在弹出的输入栏中他让我们提供存储库URL，当然可以参照上面<strong>远程仓库</strong>的做法，复制地址然后粘贴到这里），我们也可以选择更直观的方式，可以看到下面有一行小字，从GitHub添加远程存储库</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707011553673.png" alt="image-20220707011553673"></p>
<p>我们点击它，会弹出一个网页，让我们登录输入github的密码，并提供权限，我们直接照做。</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707011827029.png" alt="image-20220707011827029" style="zoom:50%;" />

<p>当这些完成后，我们就可以在Vscode刚才的这个输入栏看到让我们选择远程仓库，列出了所有我们的github仓库，我们直接选择PythonInMaya这个项目</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707012018881.png" alt="image-20220707012018881"></p>
<p>点击后它让我们输入远程仓库名字，直接输PythonInMaya就好了</p>
<p>然后还是在这个命令面板，我们选择拉取（git pull）</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707012347590.png" alt="image-20220707012347590"></p>
<p>可以发现这是不行的。会出现这样的问题</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707012432977.png" alt="image-20220707012432977"></p>
<p>这是因为，git的主分支是main</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707012509461.png" alt="image-20220707012509461" style="zoom:50%;" />

<p>而Vscode默认的主分支叫master，如果我在github上建项目的时候就把github的主分支名字叫做master，也就不存在这个问题了。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707012532283.png" alt="image-20220707012532283"></p>
<p>这个问题有很多解决方法</p>
<h6 id="治标"><a href="#治标" class="headerlink" title="治标"></a>治标</h6><p>最直接的方法，是我们让git知道，从远程的main仓库拉取到本地master仓库，我们在这里找到拉取自…命令，</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707012743905.png" alt="image-20220707012743905" style="zoom: 67%;" />

<p>选择我们项目的远程位置</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707012834615.png" alt="image-20220707012834615"></p>
<p>当然也只有一个main分支</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707012900834.png" alt="image-20220707012900834"></p>
<p>选择完成后，我们就可以在我们的项目文件夹中看到，已经下载好了远程仓库的所有文件。</p>
<h6 id="治本"><a href="#治本" class="headerlink" title="治本"></a>治本</h6><p>这个问题的根源是本地仓库和远程仓库的分支不同，远程仓库我们改不了了，但是本地仓库的分支还是可以改的。</p>
<p>解决的手段有很多</p>
<p>最简单的是我们选择这个签出到命令</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707014246495.png" alt="image-20220707014246495"></p>
<p>然后就完成了。</p>
<h6 id="Vscode中的push"><a href="#Vscode中的push" class="headerlink" title="Vscode中的push"></a>Vscode中的push</h6><p>当我们在本地的代码中做了一些修改后，我们用Vscode来进行push，把代码上传到远程仓库就非常简单了。</p>
<p>我们可以在更改栏中看到我们的修改过的文件，点击它还会在工作树中展示我们修改的内容</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707014918194.png" alt="image-20220707014918194"></p>
<p>右键点击这个绿色的更改提示，也可以看到一些git的快捷功能。比如暂存就相当于git add 和commit，添加到本地仓库，只不过这里并不是添加所有文件的修改，而是选择的范围中的修改而已。当然也可还原，这样修改就清除掉变成左边的了。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707014951219.png" alt="image-20220707014951219"></p>
<p>而“更改”后面的加号按钮则可以暂存更改目录下的所有文件，或者使用文件旁边的加号按钮暂存这一个文件。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707015833709.png" alt="image-20220707015833709"></p>
<p>可以看到暂存后，git将文件从更改目录移到了暂存更改，点击旁边的减号，可以把它再移回去。</p>
<p>暂存完毕后就可以上面的小勾提交，提交完毕，就可以去github的项目地址看看远程仓库上有没有更新自己的代码了。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707020125680.png" alt="image-20220707020125680"></p>
<p>当然也可以在更改后直接点小勾进行提交</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707020257480.png" alt="image-20220707020257480"></p>
<p>它会很贴心地问你是否暂存所有更改直接提交。选总是固然很方便，但为保险起见，我们还是每次都选一次是，防止出现意外。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220707020313485.png" alt="image-20220707020313485"></p>
<p>这种关于修改的快捷操作在项目合并的时候是非常有用的。比如B在本地对一段代码进行了修改并推送push到远程后，A将远程的代码再拉取pull下来，就可以看到B所做的修改。并且如果A同时也有修改，<strong>只要A将修改暂存进本地仓库</strong>，A的修改就能和B合并。即便有冲突，在修改代码高亮的帮助下，也能非常快速地解决。</p>
<p>如果A在pull之前没有把他的工作暂存，那么很不幸，A的工作就被覆盖掉了。</p>
<p>因为git会在pull的时候，将远程仓库和本地仓库进行比较。把本地仓库和远程仓库不一样的地方换掉。如果没有把工作内容存进本地仓库那就惨了……很多人刚接触git时都会有这样的经历……包括我……</p>
<p>好了，到这里我们的Git-Vscode-Maya Python工作流的整个教程就完全结束了，由于不是专门的Git教程，还有很多内容，在这里就不讲解了，有兴趣可以自行学习。</p>
<p>感谢浏览！</p>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/10/TA/Maya/Maya%20python%E5%B7%A5%E4%BD%9C%E6%B5%81/" data-id="cmfe1u6p5000qscuh5it2f0mr" class="article-share-link">
        Share
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Graphics/GAMES/过程记录PRT" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    

    
    <div class="article-meta">
      <a href="/2025/09/10/TA/Graphics/GAMES/%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95PRT/" class="article-date">
  <time datetime="2025-09-10T13:18:14.015Z" itemprop="datePublished">2025-09-10</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="【过程记录】【GAMES202】PRT"><a href="#【过程记录】【GAMES202】PRT" class="headerlink" title="【过程记录】【GAMES202】PRT"></a>【过程记录】【GAMES202】PRT</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/337319903">https://zhuanlan.zhihu.com/p/337319903</a></p>
<p>离线渲染的书籍：<br> \1. Physically Based Rendering (third edition)，这个不用多说了<br> \2. Advanced Global Illumination，整本书只有300多页，却基本覆盖了所有的Light Transport Method<br> \3. Robust Monte Carlo Methods for Light Transport Simulation，离线渲染必读: <a target="_blank" rel="noopener" href="http://graphics.stanford.edu/papers/veach_thesis/">http://graphics.stanford.edu/papers/veach_thesis/</a></p>
<p>课程：<br> UWaterloo蜂须贺先生的CS888: <a target="_blank" rel="noopener" href="https://cs.uwaterloo.ca/~thachisu/CS888_W21/%EF%BC%8C%E9%87%8D%E7%82%B9%E6%98%AF%E9%A1%B5%E9%9D%A2%E4%B8%AD%E7%9A%84paper">https://cs.uwaterloo.ca/~thachisu/CS888_W21/，重点是页面中的paper</a> list</p>
<p>不建议：<br> \1. Ray Traing三部曲 (in One Weekend, …) ，没啥用（默认已经从101之类的课程学到了基本的Monte Carlo方法和Path tracing的话）<br> \2. SmallPT，这个学懂了来看着玩可以，不懂的不要妄想从这个来学习离线渲染（本末倒置了属于是）</p>
<p>首先作业分成两部分</p>
<ol>
<li>预计算部分（cpp）</li>
<li>实时环境光照部分（webgl）</li>
</ol>
<p>这次的作业离线预计算部分使用了nori的光线追踪框架（既然这么巧遇到，正好202结束，渲染方向就做这个吧）</p>
<h3 id="预计算部分"><a href="#预计算部分" class="headerlink" title="预计算部分"></a>预计算部分</h3><p>首先是项目构建，就cmake构建。</p>
<p>在编译时就遇到了问题</p>
<p><img src="/%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95PRT/image-20221006012253027.png" alt="image-20221006012253027"></p>
<p>但是这儿明明啥都没有</p>
<p><img src="/%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95PRT/image-20221006012301544.png" alt="image-20221006012301544"></p>
<p>解决方法如下，这是由于MSVC对中文字符编码的支持问题。</p>
<p><a target="_blank" rel="noopener" href="https://games-cn.org/forums/topic/guanyuzuoye2kaitoubianyidekunhuo/">https://games-cn.org/forums/topic/guanyuzuoye2kaitoubianyidekunhuo/</a></p>
<p>编译成功后是这样的输出</p>
<p><img src="/%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95PRT/image-20221006013619106.png" alt="image-20221006013619106"></p>
<p><img src="/%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95PRT/image-20221006013558409.png" alt="image-20221006013558409"></p>
<p>这里输出的信息有一些值得关注的</p>
<p>主要是这里讲光照的信息</p>
<p><img src="/%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95PRT/image-20221006013929438.png" alt="image-20221006013929438"></p>
<p>来自于这个light.txt</p>
<p>而我们的SH系数最后输出到了transport.txt里面</p>
<p><img src="/%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95PRT/image-20221006014056237.png" alt="image-20221006014056237"></p>
<p>根据作业说明，我们知道这次的环境光照也还是来源于环境贴图，也就是说，我们这次其实不是完全计算的环境光，其实只是把环境贴图的环境光照转化成SH的表达而已。</p>
<p>3.54535 3.54535 3.54535<br>4.92763e-07 4.92763e-07 4.92763e-07<br>-1.9416e-07 -1.9416e-07 -1.9416e-07<br>2.29642e-07 2.29642e-07 2.29642e-07<br>0 0 0<br>0 0 0<br>0 0 0<br>0 0 0<br>0 0 0</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/10/TA/Graphics/GAMES/%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95PRT/" data-id="cmfe1u6pw004wscuhgzym8ome" class="article-share-link">
        Share
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Graphics/GAMES/Real-time Ray Tracing" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    

    
    <div class="article-meta">
      <a href="/2025/09/10/TA/Graphics/GAMES/Real-time%20Ray%20Tracing/" class="article-date">
  <time datetime="2025-09-10T13:18:14.014Z" itemprop="datePublished">2025-09-10</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="Real-time-Ray-Tracing实时光线追踪"><a href="#Real-time-Ray-Tracing实时光线追踪" class="headerlink" title="Real-time Ray Tracing实时光线追踪"></a><strong>Real-time Ray Tracing实时光线追踪</strong></h2><h3 id="1-Real-time-Ray-Tracing实时光线追踪"><a href="#1-Real-time-Ray-Tracing实时光线追踪" class="headerlink" title="1. Real-time Ray Tracing实时光线追踪"></a><strong>1. Real-time Ray Tracing实时光线追踪</strong></h3><p>2018年，NVIDIA发布GeForce RTX系列（Turing架构）</p>
<p>RTX在硬件上可以发射10 Giga rays per second（RT core）</p>
<p>但是在实际应用中只能做到 1 sample per pixel。</p>
<p>1SPP path tracing &#x3D;</p>
<ul>
<li>1 rasterization(primary) + (实际用光栅化方法来代替第一条光线)</li>
<li>1ray(primary visibility)  +</li>
<li>1ray(secondary bounce)+</li>
<li>1ray(secondary visibility)</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531004928902.png" alt="image-20220531004928902"></p>
<p>1SPP存在极大噪声，RTRT关键部分在于&#x3D;&#x3D;Denoising降噪&#x3D;&#x3D; 。</p>
<h4 id="Basic-idea"><a href="#Basic-idea" class="headerlink" title="Basic idea"></a><strong>Basic idea</strong></h4><p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531005843306.png" alt="image-20220531005843306"></p>
<p>工业界的解决方案中最重要的是Temporal滤波</p>
<ul>
<li>关键思路：<ul>
<li>假设当前帧的前一阵是降噪的，因此可以复用。</li>
<li>使用motion vectors来找到前一帧的对应位置。</li>
<li>用上一帧的结果来计算当前帧结果。</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531010312714.png" alt="image-20220531010312714"></p>
<h4 id="Motion-Vector"><a href="#Motion-Vector" class="headerlink" title="Motion Vector"></a><strong>Motion Vector</strong></h4><h5 id="G-Buffers（Geometry-buffer）"><a href="#G-Buffers（Geometry-buffer）" class="headerlink" title="G-Buffers（Geometry buffer）"></a><strong>G-Buffers（Geometry buffer）</strong></h5><p>在渲染过程中，可以获得一些额外的信息，如每像素的深度、法线、世界坐标等。生成G-buffer是比较容易的，只有屏幕空间信息。</p>
<h5 id="Back-Projection"><a href="#Back-Projection" class="headerlink" title="Back Projection"></a><strong>Back Projection</strong></h5><p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531010731693.png" alt="image-20220531010731693"></p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531011038829.png" alt="image-20220531011038829" style="zoom:100%;" />

<p>x’就是当前帧像素对应的世界坐标位置对应到上一帧该位置所在的像素。</p>
<h4 id="Temporal-accumulation-filtering"><a href="#Temporal-accumulation-filtering" class="headerlink" title="Temporal accumulation&#x2F;filtering"></a><strong>Temporal accumulation&#x2F;filtering</strong></h4><p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531011719293.png" alt="image-20220531011719293"></p>
<p>在这种1spp的结果下，回顾蒙特卡洛路径追踪，它的结果应该是无偏的，之所以看起来暗，是因为有很多的采样点原本的值是非常大的，但在显示器的clamp下，变成了1（255），因此看起来暗了。</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531011848928.png" alt="image-20220531011848928" style="zoom:67%;" />

<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531012013416.png" alt="image-20220531012013416" style="zoom:67%;" />

<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531012109486.png" alt="image-20220531012109486" style="zoom:67%;" />

<h4 id="Failure-cases"><a href="#Failure-cases" class="headerlink" title="Failure cases"></a><strong>Failure cases</strong></h4><h5 id="Switching-scenes（burn-in-period）"><a href="#Switching-scenes（burn-in-period）" class="headerlink" title="Switching scenes（burn-in period）"></a><strong>Switching scenes（burn-in period）</strong></h5><p>切换场景、快速的镜头切换</p>
<h5 id="Walking-backwards-in-a-hallway（screen-space-issue）"><a href="#Walking-backwards-in-a-hallway（screen-space-issue）" class="headerlink" title="Walking backwards in a hallway（screen space issue）"></a><strong>Walking backwards in a hallway（screen space issue）</strong></h5><p>镜头中的信息是增加的</p>
<h5 id="Suddenly-appearing-background（disocclusion）"><a href="#Suddenly-appearing-background（disocclusion）" class="headerlink" title="Suddenly appearing background（disocclusion）"></a><strong>Suddenly appearing background（disocclusion）</strong></h5><p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531012552050.png" alt="image-20220531012552050"></p>
<p>造成拖尾（Lagging）的结果</p>
<h5 id="More-Temporal-Failure"><a href="#More-Temporal-Failure" class="headerlink" title="More Temporal Failure"></a><strong>More Temporal Failure</strong></h5><p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531013222285.png" alt="image-20220531013222285"></p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531013349160.png" alt="image-20220531013349160"></p>
<h4 id="Adjustments-to-Temp-Failure"><a href="#Adjustments-to-Temp-Failure" class="headerlink" title="Adjustments to Temp. Failure"></a><strong>Adjustments to Temp. Failure</strong></h4><p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531012830984.png" alt="image-20220531012830984"></p>
<h3 id="2-Filtering-techniques-and-implementation"><a href="#2-Filtering-techniques-and-implementation" class="headerlink" title="2. Filtering techniques and implementation"></a><strong>2. Filtering techniques and implementation</strong></h3><h4 id="Implementation-of-filtering"><a href="#Implementation-of-filtering" class="headerlink" title="Implementation of filtering"></a><strong>Implementation of filtering</strong></h4><ul>
<li>图像低通滤波<ul>
<li>消除了高频信号</li>
<li>只关注频域（Spatial domain）</li>
</ul>
</li>
<li>图像+滤波器（filter kernel）-&gt;输出图像</li>
<li>Gaussian filter<ul>
<li>对于任何像素取周围范围的贡献，基于像素和周围的距离</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531142014296.png" alt="image-20220531142014296"></p>
<ul>
<li>Bilateral FIltering<ul>
<li>背景<ul>
<li>Gaussian filtering 出现的问题是整体模糊，包括边缘</li>
<li>但是我们希望边界能够保持高频</li>
<li>边界&lt;-&gt;理解为颜色剧烈变化的部分</li>
</ul>
</li>
<li>思路<ul>
<li>如何保留边界</li>
<li>如果像素j和i相差特别大，就让j对i的贡献减少</li>
<li>只需要控制kernel</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531144557877.png" alt="image-20220531144557877"></p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221002143754221.png" alt="image-20221002143754221"></p>
<p>问题：如果噪声本来颜色差异就比较大，无法区分这部分噪声和边界。</p>
<h4 id="Cross-Joint-bilateral-filtering"><a href="#Cross-Joint-bilateral-filtering" class="headerlink" title="Cross &#x2F; Joint bilateral filtering"></a><strong>Cross &#x2F; Joint bilateral filtering</strong></h4><ul>
<li>Gaussian filtering以距离作为标准</li>
<li>Bilateral filtering用位置距离、颜色距离作为标准</li>
<li>联合双边滤波采用更多的标准<ul>
<li>G-buffers<ul>
<li>Normal,depth,position,object ID,etc</li>
</ul>
</li>
<li>G-buffers是没有噪声的。</li>
</ul>
</li>
<li>特别适用于路径追踪的降噪</li>
<li>Gaussian函数不是唯一的选择，任何随“距离”衰减的函数都可以，如Exponential（absolute），cosine（clamped）</li>
</ul>
<p><img src="/Real-time%20Ray%20Tracing/image-20221002145335668.png" alt="image-20221002145335668"></p>
<h4 id="Implementing-Large-filters"><a href="#Implementing-Large-filters" class="headerlink" title="Implementing Large filters"></a><strong>Implementing Large filters</strong></h4><p>对于Kernel过大的情况</p>
<ul>
<li>Separate Passes<ul>
<li>对于2D Gaussian filter</li>
<li>将它分成水平的pass和竖直的pass(N^2 -&gt;N+N)</li>
<li>2D Gaussian filter kernel is separable</li>
<li>$G_{2D}(x,y)&#x3D;G_{1D}(x) \cdot G_{1D}(y)$</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531152145590.png" alt="image-20220531152145590"></p>
<p>理论上双边滤波不能拆分实现。</p>
<ul>
<li>Progressively Growing Size<ul>
<li>用逐步增大filter进行多次滤波</li>
<li>为什么要用逐步增大的filter   <ul>
<li>去除更低的频率</li>
</ul>
</li>
<li>为什么可以跳过一些samples<ul>
<li>Sampling&#x3D; repeating the spectrum</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531152445354.png" alt="image-20220531152445354"></p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531153055367.png" alt="image-20220531153055367"></p>
<h4 id="Outlier-removal（and-temporal-clamping）"><a href="#Outlier-removal（and-temporal-clamping）" class="headerlink" title="Outlier removal（and temporal clamping）"></a><strong>Outlier removal（and temporal clamping）</strong></h4><p>滤波后结果中还是会有一些特别亮的outlier（本来需要等更多的sample）</p>
<ul>
<li>在滤波前去除outlier</li>
<li>Outlier detection<ul>
<li>计算像素neighbor的均值和方差</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531154410403.png" alt="image-20220531154410403"></p>
<ul>
<li>Outlier removal</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531154735195.png" alt="image-20220531154735195"></p>
<ul>
<li>Temporal Clamping</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220531155436586.png" alt="image-20220531155436586"></p>
<h3 id="3-Specific-filtering-approaches-for-RTRT"><a href="#3-Specific-filtering-approaches-for-RTRT" class="headerlink" title="3. Specific filtering approaches for RTRT"></a><strong>3. Specific filtering approaches for RTRT</strong></h3><h4 id="Spatiotemporal-Variance-Guided-Filtering（SVGF）"><a href="#Spatiotemporal-Variance-Guided-Filtering（SVGF）" class="headerlink" title="Spatiotemporal Variance-Guided Filtering（SVGF）"></a><strong>Spatiotemporal Variance-Guided Filtering（SVGF）</strong></h4><ul>
<li>similar to the basic spatio-temporal denoising scheme</li>
<li>with some additional variance analysis and tricks</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221002154314018.png" alt="image-20221002154314018"></p>
<ul>
<li><p>Joint Bilateral Filtering</p>
</li>
<li><p>3 factors</p>
<ul>
<li><p>Depth</p>
<ul>
<li>$w_z&#x3D;\exp(-\frac{|z(p)-z(q)|}{\sigma_z|\nabla z(p)\cdot(p-q)|+\epsilon})$</li>
<li><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221002154947127.png" alt="image-20221002154947127"></li>
</ul>
</li>
<li><p>Normal</p>
<ul>
<li>$$<br>w_n&#x3D;\max(0,n(p)\cdot n(q))^{\sigma_n}<br>$$</li>
</ul>
</li>
<li><p>Luminance(grayscale color value)</p>
<ul>
<li><p>$$<br>w_l&#x3D;\exp(-\frac{|l_i(p)-l_i(q)|}{\sigma_l\sqrt{g_{3\times3}(Var(l_i(p)))}+\epsilon})<br>$$</p>
</li>
<li><p>Variance</p>
<ul>
<li>Calculate spatially in 7x7</li>
<li>Also averaged over time using motion vectors</li>
<li>Take another 3x3 spatial filter before use</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Recurrent-AutoEncoder-RAE"><a href="#Recurrent-AutoEncoder-RAE" class="headerlink" title="Recurrent AutoEncoder(RAE)"></a><strong>Recurrent AutoEncoder(RAE)</strong></h4><p>Interactive Reconstruction of Monte Carlo Image Sequences using a Recurrent denoising Auto Encoder</p>
<ul>
<li>A post-processing network that does denoising</li>
<li>with the help of G-buffers</li>
<li>The network automatically performs temporal accumulation</li>
</ul>
<p>Key architecture design</p>
<ul>
<li><p>Auto Encoder(or U-Net) structure</p>
</li>
<li><p>Recurrent convolutional block</p>
</li>
</ul>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221002175327278.png" alt="image-20221002175327278" style="zoom:50%;" />


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/10/TA/Graphics/GAMES/Real-time%20Ray%20Tracing/" data-id="cmfe1u6pm0031scuhf61idhur" class="article-share-link">
        Share
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Graphics/GAMES/作业过程记录" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    

    
    <div class="article-meta">
      <a href="/2025/09/10/TA/Graphics/GAMES/%E4%BD%9C%E4%B8%9A%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/" class="article-date">
  <time datetime="2025-09-10T13:18:14.014Z" itemprop="datePublished">2025-09-10</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="【过程记录】【GAMES202】环境配置与实时阴影"><a href="#【过程记录】【GAMES202】环境配置与实时阴影" class="headerlink" title="【过程记录】【GAMES202】环境配置与实时阴影"></a>【过程记录】【GAMES202】环境配置与实时阴影</h2><h3 id="作业0"><a href="#作业0" class="headerlink" title="作业0"></a><strong>作业0</strong></h3><p>作业0就配置下环境，但是会遇到模型有时候加载不出来的问题，论坛里说得很清楚。</p>
<p><a target="_blank" rel="noopener" href="https://games-cn.org/forums/topic/zuoye0-jieguobuwendingyoushimoxingxianshibuquan/">https://games-cn.org/forums/topic/zuoye0-jieguobuwendingyoushimoxingxianshibuquan/</a></p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221003152423968.png" alt="image-20221003152423968" style="zoom:50%;" />

<img src="%E4%BD%9C%E4%B8%9A%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/image-20221003152437594.png" alt="image-20221003152437594" style="zoom:50%;" />

<p>由于异步处理，如果这张材质图片是后加载的就看不见了，因此解决操作是把它预先加载。</p>
<p>其次是在框架上编写Phong模型的shader，跟着说明做就行了。</p>
<h3 id="作业1"><a href="#作业1" class="headerlink" title="作业1"></a><strong>作业1</strong></h3><h4 id="CalcLightMVP"><a href="#CalcLightMVP" class="headerlink" title="CalcLightMVP"></a><strong>CalcLightMVP</strong></h4><p>第一步需要完成shadow mapping的部分，计算方向光下的MVP矩阵。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">CalcLightMVP</span>(translate, scale) &#123;</span><br><span class="line">    <span class="keyword">let</span> lightMVP = mat4.<span class="title function_">create</span>();</span><br><span class="line">    <span class="keyword">let</span> modelMatrix = mat4.<span class="title function_">create</span>();</span><br><span class="line">    <span class="keyword">let</span> viewMatrix = mat4.<span class="title function_">create</span>();</span><br><span class="line">    <span class="keyword">let</span> projectionMatrix = mat4.<span class="title function_">create</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Model transform</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// View transform</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Projection transform</span></span><br><span class="line"></span><br><span class="line">    mat4.<span class="title function_">multiply</span>(lightMVP, projectionMatrix, viewMatrix);</span><br><span class="line">    mat4.<span class="title function_">multiply</span>(lightMVP, lightMVP, modelMatrix);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lightMVP;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里提供了translate和scale的参数，没有rotation，那就不用。</p>
<p>并且我们在Mesh Render当中可以找到camera计算MVP的部分</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221003161324505.png" alt="image-20221003161324505"></p>
<p>Model的部分可以直接照抄了，这里也是没有Rotation的，可见估计是为了方便，省去了四元数等等的旋转计算，就没有做旋转变换。</p>
<p>接下来是View矩阵的部分。在方向光的构造函数中，提供了一些东西，有lightPos和focalPoint，我们就可以计算出front，有up，那么view矩阵就很好算出来了。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221003161532352.png" alt="image-20221003161532352"></p>
<p>但是我一直没有找到这个框架矩阵运算的api，只能看里面已经有的怎么用我就怎么用……上面有个lookAt的方法，那就用它了。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221003161736551.png" alt="image-20221003161736551"></p>
<p>猜也很好猜（输出，相机位置，focal位置，up向量）</p>
<p>还是给找到了，矩阵运算的api用了一个gl-matrix-min的库，这个东西就来自于gl-matrix，百度搜到文档</p>
<p><a target="_blank" rel="noopener" href="https://glmatrix.net/docs/module-mat4.html">https://glmatrix.net/docs/module-mat4.html</a></p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221003163223666.png" alt="image-20221003163223666"></p>
<p>最后变成就这么几行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  <span class="title class_">CalcLightMVP</span>(translate, scale) &#123;</span><br><span class="line">      <span class="keyword">let</span> lightMVP = mat4.<span class="title function_">create</span>();</span><br><span class="line">      <span class="keyword">let</span> modelMatrix = mat4.<span class="title function_">create</span>();</span><br><span class="line">      <span class="keyword">let</span> viewMatrix = mat4.<span class="title function_">create</span>();</span><br><span class="line">      <span class="keyword">let</span> projectionMatrix = mat4.<span class="title function_">create</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Model transform</span></span><br><span class="line"><span class="comment">//mat4.identity(modelMatrix);</span></span><br><span class="line">mat4.<span class="title function_">translate</span>(modelMatrix, modelMatrix, translate);</span><br><span class="line">mat4.<span class="title function_">scale</span>(modelMatrix, modelMatrix, scale);</span><br><span class="line"><span class="comment">// View transform</span></span><br><span class="line">      <span class="comment">//mat4.identity(viewMatrix);</span></span><br><span class="line">      mat4.<span class="title function_">lookAt</span>(viewMatrix, <span class="variable language_">this</span>.<span class="property">lightPos</span>, <span class="variable language_">this</span>.<span class="property">focalPoint</span>, <span class="variable language_">this</span>.<span class="property">lightUp</span>);</span><br><span class="line"><span class="comment">// Projection transform</span></span><br><span class="line"><span class="comment">//mat4.identity(projectionMatrix);</span></span><br><span class="line">      mat4.<span class="title function_">ortho</span>(projectionMatrix,-<span class="number">150</span>, <span class="number">150</span>, -<span class="number">80</span>, <span class="number">80</span>, <span class="number">0</span>, <span class="number">400</span>);</span><br><span class="line"></span><br><span class="line">      mat4.<span class="title function_">multiply</span>(lightMVP, projectionMatrix, viewMatrix);</span><br><span class="line">      mat4.<span class="title function_">multiply</span>(lightMVP, lightMVP, modelMatrix);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> lightMVP;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="useShadowMap"><a href="#useShadowMap" class="headerlink" title="useShadowMap"></a><strong>useShadowMap</strong></h4><p>下一步就是完成fs中的可见性计算，框架给我们准备得很好，可以看到包括后面进阶部分的PCF和PCSS，都封装好了，只需要填函数就可以了。</p>
<p>首先需要完成的是useShadowMap来做一个简单的shadow map</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221003163729535.png" alt="image-20221003163729535"></p>
<p>首先我们要用shadow Coord去采样shadow Map来获得着色点在灯光视角下的该位置的最小深度。因此采样我们应该在灯光的齐次裁剪空间坐标下。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221003164831105.png" alt="image-20221003164831105"></p>
<p>顶点着色器已经把它做好了，就是vPositionFromLight。</p>
<p>我们也可以在shadowFragment当中看到在light pass中对深度的处理</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221003174719233.png" alt="image-20221003174719233"></p>
<p>将片元的深度进行了pack。注意这里的深度，是在片元着色器阶段，因此，齐次裁剪空间的坐标需要经过透视除法。（虽然正交投影没有影响）</p>
<p>还要注意，采样贴图需要在0-1完成，这使得我们需要做一个映射操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vec3 shadowCoord = (vPositionFromLight.xyz/vPositionFromLight.w) * 0.5+vec3(0.5);</span><br></pre></td></tr></table></figure>

<p>但是问题来了，在learnopengl中，因为深度贴图储存范围在0-1，所以深度也需要做这个映射，我们这里把深度用pack的方法保存存了，为什么还要做这个映射呢？不是只需要映射xy就行了吗？</p>
<p>问题的根节是，framebuffer中存储的深度到底是什么深度？pack暂且不管，也就是说，gl_FragCoord.z到底是什么？首先像上面说的，肯定是在NDC空间的z经过了透视除法之后，但这一部分也是在[-1,1]^3中，（由于平台差异，如D3D的NDC空间的z就是[0,1]）那么为了写入深度缓冲，Opengl自己做了这一部分的映射</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/66175070">https://zhuanlan.zhihu.com/p/66175070</a></p>
<p>这一点只要记住就行了，总得来说，gl_FragCoord.z就是深度缓冲中的值，也就是[-1,1]&#x3D;&gt;[0,1]变换过后的NDC的z值。总之，这里虽然整体*0.5+0.5，做了变换，但意义是不同的。</p>
<p>那么最后在shadow map的部分，提取出深度拿来比较一下就好了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">float <span class="title function_">useShadowMap</span>(<span class="params">sampler2D shadowMap, vec4 shadowCoord</span>)&#123;</span><br><span class="line">  float depth = <span class="title function_">unpack</span>(<span class="title function_">texture2D</span>(shadowMap, shadowCoord.<span class="property">xy</span>));</span><br><span class="line">  float currentDepth = shadowCoord.<span class="property">z</span>;</span><br><span class="line">  float bias = <span class="number">0.005</span>;</span><br><span class="line">  <span class="keyword">return</span> depth&lt;currentDepth - bias ? <span class="number">0.0</span> : <span class="number">1.0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221004003325365.png" alt="image-20221004003325365"></p>
<p>这一部分算是完成了。</p>
<h4 id="PCF"><a href="#PCF" class="headerlink" title="PCF"></a><strong>PCF</strong></h4><p>这一部分也很容易，跟着learnopengl也能做，不过作业框架中提出，我们可以对比一下两种采样的区别</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">uniformDiskSamples</span>(<span class="params"> <span class="keyword">const</span> <span class="keyword">in</span> vec2 randomSeed </span>) &#123;</span><br><span class="line"></span><br><span class="line">  float randNum = <span class="title function_">rand_2to1</span>(randomSeed);</span><br><span class="line">  float sampleX = <span class="title function_">rand_1to1</span>( randNum ) ;</span><br><span class="line">  float sampleY = <span class="title function_">rand_1to1</span>( sampleX ) ;</span><br><span class="line"></span><br><span class="line">  float angle = sampleX * <span class="title class_">PI2</span>;</span><br><span class="line">  float radius = <span class="title function_">sqrt</span>(sampleY);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>( int i = <span class="number">0</span>; i &lt; <span class="variable constant_">NUM_SAMPLES</span>; i ++ ) &#123;</span><br><span class="line">    poissonDisk[i] = <span class="title function_">vec2</span>( radius * <span class="title function_">cos</span>(angle) , radius * <span class="title function_">sin</span>(angle)  );</span><br><span class="line"></span><br><span class="line">    sampleX = <span class="title function_">rand_1to1</span>( sampleY ) ;</span><br><span class="line">    sampleY = <span class="title function_">rand_1to1</span>( sampleX ) ;</span><br><span class="line"></span><br><span class="line">    angle = sampleX * <span class="title class_">PI2</span>;</span><br><span class="line">    radius = <span class="title function_">sqrt</span>(sampleY);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float <span class="title function_">findBlocker</span>(<span class="params"> sampler2D shadowMap,  vec2 uv, float zReceiver </span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1.0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里做的是单位圆盘上的随机采样，把一个vec2储存到了poisonDisk的数组上。那么我们只需要在采样shadowmap的纹理坐标上，增加一个这个位置的样本即可。要注意的是我们的纹理采样是在0-1范围上的，因此这个位置也应该根据纹素大小进行放缩（如果把纹素大小看作单位长度的话）。这一部分learnopengl直接用了textureSize的API，但我们使用的opengl ES版本似乎不支持这个api，但是能够在engine.js中找到对framebuffer的定义</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221004010329214.png" alt="image-20221004010329214"></p>
<p>因此只需要除以2048即可。我们也可以通过对这个采样范围进行任意的放缩，相当于不同size的kernel。（比较喜欢这个框架的采样的处理方式，learnopengl中的遍历纹素就太笨重了）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">float <span class="title function_">PCF</span>(<span class="params">sampler2D shadowMap, vec4 coords</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">poissonDiskSamples</span>(coords.<span class="property">xy</span>);</span><br><span class="line">  float currentDepth = coords.<span class="property">z</span>;</span><br><span class="line">  float bias = <span class="number">0.005</span>;</span><br><span class="line">  float shadow = <span class="number">0.0</span>;</span><br><span class="line">  float texelSize = <span class="number">1.0</span> / <span class="number">2048.0</span>;</span><br><span class="line">  <span class="keyword">for</span>(int i =<span class="number">0</span>; i &lt;<span class="variable constant_">NUM_SAMPLES</span>;i++) &#123;</span><br><span class="line">    float depth = <span class="title function_">unpack</span>(<span class="title function_">texture2D</span>(shadowMap, coords.<span class="property">xy</span> + poissonDisk[i] * texelSize * <span class="number">10.0</span>));</span><br><span class="line">    shadow += depth&lt;currentDepth - bias ? <span class="number">0.0</span> : <span class="number">1.0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  shadow = shadow/<span class="title function_">float</span>(<span class="variable constant_">NUM_SAMPLES</span>);</span><br><span class="line">  <span class="keyword">return</span> shadow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221004010532040.png" alt="image-20221004010532040" style="zoom:50%;" />

<p>边缘是被模糊了，但是如果我们想要更多的模糊，会发现模型其他部分也受到了影响，出现一些噪声。</p>
<p><strong>Uniform：</strong></p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221004010749880.png" alt="image-20221004010749880" style="zoom: 80%;" />

<p><strong>Poisson：</strong></p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221004010801969.png" alt="image-20221004010801969"></p>
<p>关于泊松圆盘采样，这里说得很好，一张图就可以解释</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/484414050">https://zhuanlan.zhihu.com/p/484414050</a></p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/v2-b8033730c574ca0b7b24944011bb893d_720w.webp" alt="img"></p>
<h4 id="PCSS"><a href="#PCSS" class="headerlink" title="PCSS"></a><strong>PCSS</strong></h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">float</span> <span class="title">findBlocker</span><span class="params">( sampler2D shadowMap,  vec2 uv, <span class="type">float</span> zReceiver )</span> </span>&#123;</span><br><span class="line">  <span class="built_in">poissonDiskSamples</span>(uv);</span><br><span class="line">  <span class="type">float</span> texelSize = <span class="number">1.0</span> / <span class="number">2048.0</span>;</span><br><span class="line">  <span class="type">float</span> blockDepth = <span class="number">0.0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="type">float</span> radius =<span class="number">40.0</span>;</span><br><span class="line">  <span class="type">float</span> bias = <span class="number">0.005</span>;</span><br><span class="line">  <span class="type">int</span> blockNum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i &lt; BLOCKER_SEARCH_NUM_SAMPLES; i++) &#123;</span><br><span class="line">    <span class="type">float</span> depth = <span class="built_in">unpack</span>(<span class="built_in">texture2D</span>(shadowMap, uv + poissonDisk[i] * texelSize * radius));</span><br><span class="line">    <span class="keyword">if</span> (depth &lt; zReceiver - bias) &#123;</span><br><span class="line">      blockDepth += depth;</span><br><span class="line">      blockNum += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (blockNum == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1.0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  blockDepth /= <span class="built_in">float</span>(blockNum);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> blockDepth;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">PCSS</span><span class="params">(sampler2D shadowMap, vec4 coords)</span></span>&#123;</span><br><span class="line">  <span class="built_in">poissonDiskSamples</span>(coords.xy);</span><br><span class="line">  <span class="type">float</span> receiverDepth = coords.z;</span><br><span class="line">  <span class="type">float</span> LightSize =<span class="number">40.0</span>;</span><br><span class="line">  <span class="type">float</span> texelSize = <span class="number">1.0</span> / <span class="number">2048.0</span>;</span><br><span class="line">  <span class="comment">// STEP 1: avgblocker depth</span></span><br><span class="line">  <span class="type">float</span> blockDepth = <span class="built_in">findBlocker</span>(shadowMap, coords.xy, receiverDepth);</span><br><span class="line">  <span class="comment">/*if (abs(blockDepth - receiverDepth) &lt;0.010) &#123;</span></span><br><span class="line"><span class="comment">    return -1.0;</span></span><br><span class="line"><span class="comment">  &#125;*/</span></span><br><span class="line">  <span class="comment">// STEP 2: penumbra size</span></span><br><span class="line">  <span class="type">float</span> penumbraSize = (receiverDepth - blockDepth)  / blockDepth* LightSize;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// STEP 3: filtering</span></span><br><span class="line">  </span><br><span class="line">  <span class="type">float</span> shadow = <span class="number">0.0</span>;</span><br><span class="line">  <span class="type">float</span> bias = <span class="number">0.005</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i =<span class="number">0</span>; i &lt;PCF_NUM_SAMPLES;i++) &#123;</span><br><span class="line">    <span class="type">float</span> depth = <span class="built_in">unpack</span>(<span class="built_in">texture2D</span>(shadowMap, coords.xy + poissonDisk[i] * texelSize * penumbraSize));</span><br><span class="line">    shadow += depth&lt;receiverDepth - bias ? <span class="number">0.0</span> : <span class="number">1.0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  shadow = shadow/<span class="built_in">float</span>(PCF_NUM_SAMPLES);</span><br><span class="line">  <span class="keyword">return</span> shadow;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一些小小的filterSize的可视化</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221005174516925.png" alt="image-20221005174516925"></p>
<p>可以注意到这种边缘的地方实际上存在artifacts</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221005174555733.png" alt="image-20221005174555733"></p>
<p>解决方法如下</p>
<p><a target="_blank" rel="noopener" href="https://games-cn.org/forums/topic/zuoye1-dibanbianyuanjianbianhuisejiejuefangfa/">https://games-cn.org/forums/topic/zuoye1-dibanbianyuanjianbianhuisejiejuefangfa/</a></p>
<p><a target="_blank" rel="noopener" href="https://games-cn.org/forums/topic/zuoye1guanyuplanebianjiezaodiandecaiceyujiejue/">https://games-cn.org/forums/topic/zuoye1guanyuplanebianjiezaodiandecaiceyujiejue/</a></p>
<p>（但也不能完全解决）</p>
<p>Shadow的可视化</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221005174914204.png" alt="image-20221005174914204"></p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221005175747835.png" alt="image-20221005175747835"></p>
<p>增加一点高质量的</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20221005194550816.png" alt="image-20221005194550816"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/10/TA/Graphics/GAMES/%E4%BD%9C%E4%B8%9A%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/" data-id="cmfe1u6pm0033scuh50jf7upi" class="article-share-link">
        Share
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-TA/Graphics/GAMES/Real-time Shadows" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    

    
    <div class="article-meta">
      <a href="/2025/09/10/TA/Graphics/GAMES/Real-time%20Shadows/" class="article-date">
  <time datetime="2025-09-10T13:18:14.014Z" itemprop="datePublished">2025-09-10</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
        <h2 id="Real-time-Shadows"><a href="#Real-time-Shadows" class="headerlink" title="Real-time Shadows"></a>Real-time Shadows</h2><h3 id="Shadow-Mapping"><a href="#Shadow-Mapping" class="headerlink" title="Shadow Mapping"></a>Shadow Mapping</h3><p>2-pass Algorithm</p>
<ul>
<li>The light pass generates the SM</li>
<li>The camera pass uses the SM</li>
</ul>
<p>Image-space algorithm</p>
<ul>
<li>不需要场景的几何信息</li>
<li>自遮挡、走样</li>
</ul>
<p>Pass1:Render from Light</p>
<p>Pass2:Render from Eye</p>
<h4 id="Issues-Self-occlusion"><a href="#Issues-Self-occlusion" class="headerlink" title="Issues: Self occlusion"></a>Issues: Self occlusion</h4><p>一个像素内记录一个深度，在场景中，属于一个像素的一片区域，光源深度并不相同，更远的就被认为成阴影了。</p>
<h5 id="解决方式：Bias"><a href="#解决方式：Bias" class="headerlink" title="解决方式：Bias"></a>解决方式：Bias</h5><p>Adding a bias to reduce self occlusion，</p>
<p>比较深度时，增加bias，距离“明显”更远时才记为阴影。</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220501231928346.png" alt="image-20220501231928346"></p>
<h5 id="新的问题：Bias引发的悬浮Peter-Panning"><a href="#新的问题：Bias引发的悬浮Peter-Panning" class="headerlink" title="新的问题：Bias引发的悬浮Peter Panning"></a>新的问题：Bias引发的悬浮Peter Panning</h5><p>（找一个合适的Bias）或：</p>
<h5 id="Second-depth-shadow-mapping"><a href="#Second-depth-shadow-mapping" class="headerlink" title="Second-depth shadow mapping"></a>Second-depth shadow mapping</h5><p>用最小深度和次小深度的中间深度做最终的比较。（可用性不高）</p>
<h4 id="Issues-Aliasing"><a href="#Issues-Aliasing" class="headerlink" title="Issues: Aliasing"></a>Issues: Aliasing</h4><h3 id="Math-behind-shadow-mapping数学解释"><a href="#Math-behind-shadow-mapping数学解释" class="headerlink" title="Math behind shadow mapping数学解释"></a>Math behind shadow mapping数学解释</h3><p>$$<br>\int_{\Omega}f(x)g(x)dx \simeq\frac{\int_{\Omega}f(x)dx}{\int_{\Omega}dx}\cdot \int_{\Omega}g(x)dx<br>$$</p>
<p>当g(x)足够光滑，g(x)的support较小，二者满足一个，该近似比较准确。</p>
<p>在Esp的IBL-Specular中讲述了同样的&#x3D;&#x3D;split sum approximate&#x3D;&#x3D;，<br>$$<br>L_o(p,\omega_o) &#x3D; \int_{\Omega^+}L_i(p,\omega_i)f_r(p,\omega_i,\omega_o)\cos \theta_iV(p,\omega_i)d\omega_i<br>\\simeq\frac{\int_{\Omega^+}V(p,\omega_i)d\omega_i}{\int_{\Omega^+}d\omega_i}\cdot\int_{\Omega^+}L_i(p,\omega_i)f_r(p,\omega_i,\omega_o)\cos \theta_id\omega_i<br>$$<br>右边代表正常的着色，左边的可见项代表阴影，分开来算再乘起来，正是shadow mapping的思想。</p>
<p>Small support: point &#x2F; directional lighting</p>
<p>Smooth integrand: diffuse bsdf &#x2F; constant radiance area lighting</p>
<p>面光源、环境光照、glossy会不太准确</p>
<h3 id="Percentage-closer-soft-shadows-PCSS"><a href="#Percentage-closer-soft-shadows-PCSS" class="headerlink" title="Percentage closer soft shadows(PCSS)"></a>Percentage closer soft shadows(PCSS)</h3><h4 id="Percentage-Closer-Filtering-PCF"><a href="#Percentage-Closer-Filtering-PCF" class="headerlink" title="Percentage Closer Filtering(PCF)"></a>Percentage Closer Filtering(PCF)</h4><ul>
<li><p>用于阴影边缘的反走样，并不适用于软阴影</p>
</li>
<li><p>阴影比较的结果进行滤波</p>
</li>
<li><p>不能将shadow map滤波，因为记录的是深度。</p>
</li>
</ul>
<p>对于世界空间的点，判断比较深度不光查找shadow map对应的一个像素，而是周围的局部区域的像素，每一个深度都进行比较，将这些值作平均</p>
<p>（如果是在阴影边缘，那么对应深度图上有阴影部分，也有照亮部分，这样能达到滤波效果）</p>
<p>Filter Size:</p>
<ul>
<li>Small-&gt;sharper</li>
<li>Large-&gt;softer</li>
</ul>
<p>将一个较大的PCF应用于硬阴影，就类似于软阴影效果 </p>
<h4 id="Percentage-closer-soft-shadows"><a href="#Percentage-closer-soft-shadows" class="headerlink" title="Percentage closer soft shadows"></a>Percentage closer soft shadows</h4><p>Filter size &lt;-&gt; blocker distance</p>
<p>阴影的软硬和遮挡物距离有关,也将决定filter size的不同。<br>$$<br>w_{Penumbra} &#x3D;(d_{Receiver}-d_{Blocker})\cdot w_{Light}&#x2F;d_{Blocker}<br>$$<br><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220502002132527.png" alt="image-20220502002132527"></p>
<p>$w_{Penumbra}$ 即衡量了软阴影的范围</p>
<ul>
<li>blocker size</li>
<li>light size</li>
</ul>
<h5 id="完整流程"><a href="#完整流程" class="headerlink" title="完整流程"></a>完整流程</h5><p>Tips: W_light是指定的，Shadow mapping需要用点光源。</p>
<ul>
<li>Step1：Blocker search(Slow)<ul>
<li>对于一个着色点，在特定区域计算平均blocker深度（类似PCF）</li>
<li>这个区域可以是常量，也可以是启发式:<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220502003207293.png" alt="image-20220502003207293"></li>
</ul>
</li>
<li>Step2: Penumbra estimation<ul>
<li>使用平均blocker深度，决定filter size</li>
</ul>
</li>
<li>Step3：Percentage Closer Filtering(Slow)</li>
<li>可以减少sample的数量来加速，但是会有噪声</li>
</ul>
<h4 id="Deeper-Look-at-PCF"><a href="#Deeper-Look-at-PCF" class="headerlink" title="Deeper Look at PCF"></a>Deeper Look at PCF</h4><p>$V(x) &#x3D; \sum_{q\in N(p)} w(p,q)\cdot\chi^+[D_{SM}(q)-D_{scene}(x)]$ </p>
<p>而不是filter shadow map：</p>
<p>$V(x)\neq\chi^+{<a href="q">w*D_{SM}</a>-D_{scene}(x)}$ </p>
<p>也不是在图像上filter</p>
<p>$V(x)\neq\sum_{q\in N(p)}w(p,q)V(q)$ </p>
<h3 id="Variance-soft-shadow-mapping（VSSM）"><a href="#Variance-soft-shadow-mapping（VSSM）" class="headerlink" title="Variance soft shadow mapping（VSSM）"></a>Variance soft shadow mapping（VSSM）</h3><p>解决PCSS在step1和step3慢的问题</p>
<p>PCSS中做平均，其实就是知道区域内阴影和照亮的比例</p>
<h4 id="Accelerate-PCF"><a href="#Accelerate-PCF" class="headerlink" title="Accelerate PCF"></a>Accelerate PCF</h4><p>将shading point对应周围的点的最近深度看作正态分布</p>
<ul>
<li>计算该区域深度的均值和方差<ul>
<li>均值<ul>
<li>MipMap</li>
<li>Summed Area Tables(SAT)</li>
</ul>
</li>
<li>方差<ul>
<li>$Var(X) &#x3D; E(X^2) - E^2(X)$ </li>
<li>$E(X^2)$ 项需要另外一个shadow map(square-depth map) 记录（总共只需要两个通道）</li>
</ul>
</li>
<li>如果假设是正态分布CDF(x)(只有数值解，没有解析解)<ul>
<li>切比雪夫不等式 $P(x&gt;t)\leq \frac{\sigma^2}{\sigma^2+(t-\mu)^2}$ （甚至不需要知道分布函数）</li>
<li><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220502131303998.png" alt="image-20220502131303998"></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Accelerate-PCSS"><a href="#Accelerate-PCSS" class="headerlink" title="Accelerate PCSS"></a>Accelerate PCSS</h4><p>计算遮挡物的平均深度</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220502132700742.png" alt="image-20220502132700742" style="zoom: 67%;" />

 
<p>$$<br>\frac{N_1}{N}z_{unocc}+\frac{N_2}{N}z_{occ}&#x3D;z_{Avg}<br>$$<br>Approximation:N1&#x2F;N &#x3D; P(x&gt;t) -&gt; Chebyshev</p>
<p>需要 $Z_{unocc}$ 将其假设为t（shading point的深度-&gt;导致只有阴影接收物为平面时效果比较好）</p>
<h4 id="MipMap-and-Summed-Area-Variance-Shadow-Maps"><a href="#MipMap-and-Summed-Area-Variance-Shadow-Maps" class="headerlink" title="MipMap and Summed-Area Variance Shadow Maps"></a>MipMap and Summed-Area Variance Shadow Maps</h4><h5 id="构建SAT范围查询"><a href="#构建SAT范围查询" class="headerlink" title="构建SAT范围查询"></a>构建SAT范围查询</h5><p>前缀和算法</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220502134821180.png" alt="image-20220502134821180"> </p>
<p>2D情况：</p>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220502135327231.png" alt="image-20220502135327231"></p>
<h3 id="Moment-shadow-mapping"><a href="#Moment-shadow-mapping" class="headerlink" title="Moment shadow mapping"></a>Moment shadow mapping</h3><p>VSSM：在一些特定的遮挡物场景，分布与假设差别太大，可能偏黑，也可能过亮</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220502140118793.png" alt="image-20220502140118793" style="zoom: 67%;" />

<p>切比雪夫不等式只有t&gt;z_avg时有效</p>
<p>解决方式：Moment（矩） Shadow Mapping</p>
<p>VSSM只用了前二阶矩</p>
<p>用前m阶矩描述，可以恢复有m&#x2F;2个阶跃的CDF</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220502140821983.png" alt="image-20220502140821983" style="zoom:67%;" />

<p>4阶也正好可以用4个通道存储。</p>
<p>问题：主要在于利用Moment的Reconstruction需要比较大的开销，至于如何reconstruction，比较复杂，如果要深入了解，去看论文。</p>
<h3 id="Distance-field-soft-shadows距离场阴影"><a href="#Distance-field-soft-shadows距离场阴影" class="headerlink" title="Distance field soft shadows距离场阴影"></a>Distance field soft shadows距离场阴影</h3><ul>
<li>Distance functions：（Optimal transform）<ul>
<li>空间任何一个点到物体表面的最小距离</li>
</ul>
</li>
</ul>
<h4 id="Usage1：Ray-marching"><a href="#Usage1：Ray-marching" class="headerlink" title="Usage1：Ray marching"></a>Usage1：Ray marching</h4><ul>
<li>Ray marching（sphere tracing） to perform ray-SDF intersection<ul>
<li>在任意一点，到物体最小距离之内，不会和物体相交</li>
<li>因此在任何一点P，都可以走SDF(P)的距离</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220502154558204.png" alt="image-20220502154558204"></p>
<h4 id="Usage2：Approximate-percentage-of-occlusion"><a href="#Usage2：Approximate-percentage-of-occlusion" class="headerlink" title="Usage2：Approximate percentage of occlusion"></a>Usage2：Approximate percentage of occlusion</h4><p>软阴影始终定义在面光源下</p>
<img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220502160104196.png" alt="image-20220502160104196" style="zoom:67%;" />

<ul>
<li><p>During ray marching</p>
<ul>
<li>任意一点的SDF，能够提供一个“safe angle”<ul>
<li>Safe angle越小，能够看到的东西越少</li>
</ul>
</li>
<li>在每一个step，计算眼睛出发的safe angle<ul>
<li>$\arcsin \frac{SDF(p)}{p-o}$ 运算量较大</li>
<li>$min{\frac{k\cdot SDF(p)}{p-o},1.0}$ ，k越大，earlier cutoff of penumbra，阴影越硬</li>
<li><img src="https://raw.githubusercontent.com/XZYW7/PicGo/main/img/image-20220502155552433.png" alt="image-20220502155552433"></li>
</ul>
</li>
<li>保留最小的safe angle，用来决定阴影软硬</li>
</ul>
</li>
<li><p>特点</p>
<ul>
<li>快速</li>
<li>高质量</li>
</ul>
</li>
<li><p>问题</p>
<ul>
<li>需要预计算</li>
<li>大量的存储空间</li>
<li>Artifact</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/09/10/TA/Graphics/GAMES/Real-time%20Shadows/" data-id="cmfe1u6pu004vscuh93sb5pw6" class="article-share-link">
        Share
      </a>
      
    </footer>

  </div>

  

  

</article>
    
  </article>
  

  
  <nav class="page-nav">
    <a class="extend prev" rel="prev" href="/page/3/">Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/">Next</a>
  </nav>
  
</section>
</div>
    <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>XZYW7&#39;s Blog &copy; 2025</li>
      
        <li>
          
            <a href="https://beian.miit.gov.cn/" target="_blank"></a>
            
        </li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
    <p><ul class="list-inline">
  
  <li><i class="fe fe-bar-chart tooltip" data-tooltip="PV"></i> <span id="busuanzi_value_site_pv"></span></li>
  
  <li><i class="fe fe-smile-alt tooltip" data-tooltip="UV"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul></p>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="XZYW7&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">Home</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">Archives</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">Gallery</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">About</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>






<script src="/js/ocean.js"></script>

</body>

</html>